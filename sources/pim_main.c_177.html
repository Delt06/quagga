
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>pim_main.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">  PIM for Quagga</a>
<a name="ln3">  Copyright (C) 2008  Everton da Silva Marques</a>
<a name="ln4"> </a>
<a name="ln5">  This program is free software; you can redistribute it and/or modify</a>
<a name="ln6">  it under the terms of the GNU General Public License as published by</a>
<a name="ln7">  the Free Software Foundation; either version 2 of the License, or</a>
<a name="ln8">  (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">  This program is distributed in the hope that it will be useful, but</a>
<a name="ln11">  WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln13">  General Public License for more details.</a>
<a name="ln14">  </a>
<a name="ln15">  You should have received a copy of the GNU General Public License</a>
<a name="ln16">  along with this program; see the file COPYING; if not, write to the</a>
<a name="ln17">  Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston,</a>
<a name="ln18">  MA 02110-1301 USA</a>
<a name="ln19">  </a>
<a name="ln20">  $QuaggaId: $Format:%an, %ai, %h$ $</a>
<a name="ln21">*/</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;zebra.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &quot;log.h&quot;</a>
<a name="ln26">#include &quot;privs.h&quot; </a>
<a name="ln27">#include &quot;version.h&quot;</a>
<a name="ln28">#include &lt;getopt.h&gt;</a>
<a name="ln29">#include &quot;command.h&quot;</a>
<a name="ln30">#include &quot;thread.h&quot;</a>
<a name="ln31">#include &lt;signal.h&gt;</a>
<a name="ln32"> </a>
<a name="ln33">#include &quot;memory.h&quot;</a>
<a name="ln34">#include &quot;vrf.h&quot;</a>
<a name="ln35">#include &quot;filter.h&quot;</a>
<a name="ln36">#include &quot;vty.h&quot;</a>
<a name="ln37">#include &quot;sigevent.h&quot;</a>
<a name="ln38">#include &quot;version.h&quot;</a>
<a name="ln39">#include &quot;prefix.h&quot;</a>
<a name="ln40">#include &quot;plist.h&quot;</a>
<a name="ln41"> </a>
<a name="ln42">#include &quot;pimd.h&quot;</a>
<a name="ln43">#include &quot;pim_version.h&quot;</a>
<a name="ln44">#include &quot;pim_signals.h&quot;</a>
<a name="ln45">#include &quot;pim_zebra.h&quot;</a>
<a name="ln46"> </a>
<a name="ln47">#ifdef PIM_ZCLIENT_DEBUG</a>
<a name="ln48">extern int zclient_debug;</a>
<a name="ln49">#endif</a>
<a name="ln50"> </a>
<a name="ln51">extern struct host host;</a>
<a name="ln52"> </a>
<a name="ln53">char config_default[] = SYSCONFDIR PIMD_DEFAULT_CONFIG;</a>
<a name="ln54"> </a>
<a name="ln55">struct option longopts[] = {</a>
<a name="ln56">  { &quot;daemon&quot;,        no_argument,       NULL, 'd'},</a>
<a name="ln57">  { &quot;config_file&quot;,   required_argument, NULL, 'f'},</a>
<a name="ln58">  { &quot;pid_file&quot;,      required_argument, NULL, 'i'},</a>
<a name="ln59">  { &quot;vty_addr&quot;,      required_argument, NULL, 'A'},</a>
<a name="ln60">  { &quot;vty_port&quot;,      required_argument, NULL, 'P'},</a>
<a name="ln61">  { &quot;version&quot;,       no_argument,       NULL, 'v'},</a>
<a name="ln62">  { &quot;debug_zclient&quot;, no_argument,       NULL, 'Z'},</a>
<a name="ln63">  { &quot;help&quot;,          no_argument,       NULL, 'h'},</a>
<a name="ln64">  { 0 }</a>
<a name="ln65">};</a>
<a name="ln66"> </a>
<a name="ln67">/* pimd privileges */</a>
<a name="ln68">zebra_capabilities_t _caps_p [] = </a>
<a name="ln69">{</a>
<a name="ln70">  ZCAP_NET_ADMIN,</a>
<a name="ln71">  ZCAP_SYS_ADMIN,</a>
<a name="ln72">  ZCAP_NET_RAW,</a>
<a name="ln73">};</a>
<a name="ln74"> </a>
<a name="ln75">/* pimd privileges to run with */</a>
<a name="ln76">struct zebra_privs_t pimd_privs =</a>
<a name="ln77">{</a>
<a name="ln78">#if defined(QUAGGA_USER) &amp;&amp; defined(QUAGGA_GROUP)</a>
<a name="ln79">  .user = QUAGGA_USER,</a>
<a name="ln80">  .group = QUAGGA_GROUP,</a>
<a name="ln81">#endif</a>
<a name="ln82">#ifdef VTY_GROUP</a>
<a name="ln83">  .vty_group = VTY_GROUP,</a>
<a name="ln84">#endif</a>
<a name="ln85">  .caps_p = _caps_p,</a>
<a name="ln86">  .cap_num_p = sizeof(_caps_p)/sizeof(_caps_p[0]),</a>
<a name="ln87">  .cap_num_i = 0</a>
<a name="ln88">};</a>
<a name="ln89"> </a>
<a name="ln90">char* progname;</a>
<a name="ln91">const char *pid_file = PATH_PIMD_PID;</a>
<a name="ln92"> </a>
<a name="ln93">static void usage(int status)</a>
<a name="ln94">{</a>
<a name="ln95">  if (status != 0)</a>
<a name="ln96">    fprintf (stderr, &quot;Try `%s --help' for more information.\n&quot;, progname);</a>
<a name="ln97">  else {    </a>
<a name="ln98">    printf (&quot;Usage : %s [OPTION...]\n\</a>
<a name="ln99">Daemon which manages PIM.\n\n\</a>
<a name="ln100">-d, --daemon         Run in daemon mode\n\</a>
<a name="ln101">-f, --config_file    Set configuration file name\n\</a>
<a name="ln102">-i, --pid_file       Set process identifier file name\n\</a>
<a name="ln103">-z, --socket         Set path of zebra socket\n\</a>
<a name="ln104">-A, --vty_addr       Set vty's bind address\n\</a>
<a name="ln105">-P, --vty_port       Set vty's port number\n\</a>
<a name="ln106">-v, --version        Print program version\n\</a>
<a name="ln107">&quot;</a>
<a name="ln108"> </a>
<a name="ln109">#ifdef PIM_ZCLIENT_DEBUG</a>
<a name="ln110">&quot;\</a>
<a name="ln111">-Z, --debug_zclient  Enable zclient debugging\n\</a>
<a name="ln112">&quot;</a>
<a name="ln113">#endif</a>
<a name="ln114"> </a>
<a name="ln115">&quot;\</a>
<a name="ln116">-h, --help           Display this help and exit\n\</a>
<a name="ln117">\n\</a>
<a name="ln118">Report bugs to %s\n&quot;, progname, PIMD_BUG_ADDRESS);</a>
<a name="ln119">  }</a>
<a name="ln120"> </a>
<a name="ln121">  exit (status);</a>
<a name="ln122">}</a>
<a name="ln123"> </a>
<a name="ln124"> </a>
<a name="ln125">int main(int argc, char** argv, char** envp) {</a>
<a name="ln126">  char *p;</a>
<a name="ln127">  char *vty_addr = NULL;</a>
<a name="ln128">  int vty_port = -1;</a>
<a name="ln129">  int daemon_mode = 0;</a>
<a name="ln130">  char *config_file = NULL;</a>
<a name="ln131">  char *zebra_sock_path = NULL;</a>
<a name="ln132">          </a>
<a name="ln133">  umask(0027);</a>
<a name="ln134"> </a>
<a name="ln135">  progname = ((p = strrchr(argv[0], '/')) ? ++p : argv[0]);</a>
<a name="ln136"> </a>
<a name="ln137">  zlog_default = openzlog(progname, ZLOG_PIM,</a>
<a name="ln138">			  LOG_CONS|LOG_NDELAY|LOG_PID, LOG_DAEMON);</a>
<a name="ln139">     </a>
<a name="ln140">  /* this while just reads the options */                       </a>
<a name="ln141">  while (1) {</a>
<a name="ln142">    int opt;</a>
<a name="ln143">            </a>
<a name="ln144">    opt = getopt_long (argc, argv, &quot;df:i:z:A:P:vZh&quot;, longopts, 0);</a>
<a name="ln145">                      </a>
<a name="ln146">    if (opt == EOF)</a>
<a name="ln147">      break;</a>
<a name="ln148">    </a>
<a name="ln149">    switch (opt) {</a>
<a name="ln150">    case 0:</a>
<a name="ln151">      break;</a>
<a name="ln152">    case 'd':</a>
<a name="ln153">      daemon_mode = 1;</a>
<a name="ln154">      break;</a>
<a name="ln155">    case 'f':</a>
<a name="ln156">      config_file = optarg;</a>
<a name="ln157">      break;</a>
<a name="ln158">    case 'i':</a>
<a name="ln159">      pid_file = optarg;</a>
<a name="ln160">      break;</a>
<a name="ln161">    case 'z':</a>
<a name="ln162">      zebra_sock_path = optarg;</a>
<a name="ln163">      break;</a>
<a name="ln164">    case 'A':</a>
<a name="ln165">      vty_addr = optarg;</a>
<a name="ln166">      break;</a>
<a name="ln167">    case 'P':</a>
<a name="ln168">      vty_port = atoi (optarg);</a>
<a name="ln169">      break;</a>
<a name="ln170">    case 'v':</a>
<a name="ln171">      printf(PIMD_PROGNAME &quot; version %s\n&quot;, PIMD_VERSION);</a>
<a name="ln172">      print_version(QUAGGA_PROGNAME);</a>
<a name="ln173">      exit (0);</a>
<a name="ln174">      break;</a>
<a name="ln175">#ifdef PIM_ZCLIENT_DEBUG</a>
<a name="ln176">    case 'Z':</a>
<a name="ln177">      zclient_debug = 1;</a>
<a name="ln178">      break;</a>
<a name="ln179">#endif</a>
<a name="ln180">    case 'h':</a>
<a name="ln181">      usage (0);</a>
<a name="ln182">      break;</a>
<a name="ln183">    default:</a>
<a name="ln184">      usage (1);</a>
<a name="ln185">      break;</a>
<a name="ln186">    }</a>
<a name="ln187">  }</a>
<a name="ln188"> </a>
<a name="ln189">  master = thread_master_create();</a>
<a name="ln190"> </a>
<a name="ln191">  zlog_notice(&quot;Quagga %s &quot; PIMD_PROGNAME &quot; %s starting&quot;,</a>
<a name="ln192">	      QUAGGA_VERSION, PIMD_VERSION);</a>
<a name="ln193"> </a>
<a name="ln194">  /* </a>
<a name="ln195">   * Initializations</a>
<a name="ln196">   */</a>
<a name="ln197">  zprivs_init (&amp;pimd_privs);</a>
<a name="ln198">  pim_signals_init();</a>
<a name="ln199">  cmd_init(1);</a>
<a name="ln200">  vty_init(master);</a>
<a name="ln201">  memory_init();</a>
<a name="ln202">  vrf_init();</a>
<a name="ln203">  access_list_init();</a>
<a name="ln204">  prefix_list_init ();</a>
<a name="ln205">  pim_route_map_init ();</a>
<a name="ln206">  pim_init();</a>
<a name="ln207"> </a>
<a name="ln208">  /*</a>
<a name="ln209">   * Initialize zclient &quot;update&quot; and &quot;lookup&quot; sockets</a>
<a name="ln210">   */</a>
<a name="ln211">  pim_zebra_init (master, zebra_sock_path);</a>
<a name="ln212"> </a>
<a name="ln213">  zlog_notice(&quot;Loading configuration - begin&quot;);</a>
<a name="ln214"> </a>
<a name="ln215">  /* Get configuration file. */</a>
<a name="ln216">  vty_read_config(config_file, config_default);</a>
<a name="ln217"> </a>
<a name="ln218">  /*</a>
<a name="ln219">    Starting from here zlog_* functions will log according configuration</a>
<a name="ln220">   */</a>
<a name="ln221"> </a>
<a name="ln222">  zlog_notice(&quot;Loading configuration - end&quot;);</a>
<a name="ln223"> </a>
<a name="ln224">  /* Change to the daemon program. */</a>
<a name="ln225">  if (daemon_mode) {</a>
<a name="ln226">    if (daemon(0, 0)) {</a>
<a name="ln227">      zlog_warn(&quot;failed to daemonize&quot;);</a>
<a name="ln228">    }</a>
<a name="ln229">  }</a>
<a name="ln230"> </a>
<a name="ln231">  /* Process ID file creation. */</a>
<a name="ln232">  pid_output(pid_file);</a>
<a name="ln233"> </a>
<a name="ln234">  /* Create pimd VTY socket */</a>
<a name="ln235">  if (vty_port &lt; 0)</a>
<a name="ln236">    vty_port = PIMD_VTY_PORT;</a>
<a name="ln237">  vty_serv_sock(vty_addr, vty_port, PIM_VTYSH_PATH);</a>
<a name="ln238"> </a>
<a name="ln239">  zlog_notice(&quot;Quagga %s &quot; PIMD_PROGNAME &quot; %s starting, VTY interface at port TCP %d&quot;,</a>
<a name="ln240">	      QUAGGA_VERSION, PIMD_VERSION, vty_port);</a>
<a name="ln241"> </a>
<a name="ln242">#ifdef PIM_DEBUG_BYDEFAULT</a>
<a name="ln243">  zlog_notice(&quot;PIM_DEBUG_BYDEFAULT: Enabling all debug commands&quot;);</a>
<a name="ln244">  PIM_DO_DEBUG_PIM_EVENTS;</a>
<a name="ln245">  PIM_DO_DEBUG_PIM_PACKETS;</a>
<a name="ln246">  PIM_DO_DEBUG_PIM_TRACE;</a>
<a name="ln247">  PIM_DO_DEBUG_IGMP_EVENTS;</a>
<a name="ln248">  PIM_DO_DEBUG_IGMP_PACKETS;</a>
<a name="ln249">  PIM_DO_DEBUG_IGMP_TRACE;</a>
<a name="ln250">  PIM_DO_DEBUG_ZEBRA;</a>
<a name="ln251">#endif</a>
<a name="ln252"> </a>
<a name="ln253">#ifdef PIM_ZCLIENT_DEBUG</a>
<a name="ln254">  zlog_notice(&quot;PIM_ZCLIENT_DEBUG: zclient debugging is supported, mode is %s (see option -Z)&quot;,</a>
<a name="ln255">	      zclient_debug ? &quot;ON&quot; : &quot;OFF&quot;);</a>
<a name="ln256">#endif</a>
<a name="ln257"> </a>
<a name="ln258">#ifdef PIM_CHECK_RECV_IFINDEX_SANITY</a>
<a name="ln259">  zlog_notice(&quot;PIM_CHECK_RECV_IFINDEX_SANITY: will match sock/recv ifindex&quot;);</a>
<a name="ln260">#ifdef PIM_REPORT_RECV_IFINDEX_MISMATCH</a>
<a name="ln261">  zlog_notice(&quot;PIM_REPORT_RECV_IFINDEX_MISMATCH: will report sock/recv ifindex mismatch&quot;);</a>
<a name="ln262">#endif</a>
<a name="ln263">#endif</a>
<a name="ln264"> </a>
<a name="ln265">#ifdef PIM_UNEXPECTED_KERNEL_UPCALL</a>
<a name="ln266">  zlog_notice(&quot;PIM_UNEXPECTED_KERNEL_UPCALL: report unexpected kernel upcall&quot;);</a>
<a name="ln267">#endif</a>
<a name="ln268"> </a>
<a name="ln269">#ifdef HAVE_CLOCK_MONOTONIC</a>
<a name="ln270">  zlog_notice(&quot;HAVE_CLOCK_MONOTONIC&quot;);</a>
<a name="ln271">#else</a>
<a name="ln272">  zlog_notice(&quot;!HAVE_CLOCK_MONOTONIC&quot;);</a>
<a name="ln273">#endif</a>
<a name="ln274"> </a>
<a name="ln275">  thread_main (master);</a>
<a name="ln276"> </a>
<a name="ln277">  zlog_err(&quot;%s %s: thread_fetch() returned NULL, exiting&quot;,</a>
<a name="ln278">	   __FILE__, __PRETTY_FUNCTION__);</a>
<a name="ln279"> </a>
<a name="ln280">  /* never reached */</a>
<a name="ln281">  return 0;</a>
<a name="ln282">}</a>

</code></pre>
<div class="balloon" rel="6"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
