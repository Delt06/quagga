
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ospf6_neighbor.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright (C) 2003 Yasuhiro Ohara</a>
<a name="ln3"> *</a>
<a name="ln4"> * This file is part of GNU Zebra.</a>
<a name="ln5"> *</a>
<a name="ln6"> * GNU Zebra is free software; you can redistribute it and/or modify it</a>
<a name="ln7"> * under the terms of the GNU General Public License as published by the</a>
<a name="ln8"> * Free Software Foundation; either version 2, or (at your option) any</a>
<a name="ln9"> * later version.</a>
<a name="ln10"> *</a>
<a name="ln11"> * GNU Zebra is distributed in the hope that it will be useful, but</a>
<a name="ln12"> * WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln13"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln14"> * General Public License for more details.</a>
<a name="ln15"> *</a>
<a name="ln16"> * You should have received a copy of the GNU General Public License</a>
<a name="ln17"> * along with GNU Zebra; see the file COPYING.  If not, write to the </a>
<a name="ln18"> * Free Software Foundation, Inc., 59 Temple Place - Suite 330, </a>
<a name="ln19"> * Boston, MA 02111-1307, USA.  </a>
<a name="ln20"> */</a>
<a name="ln21"> </a>
<a name="ln22">#include &lt;zebra.h&gt;</a>
<a name="ln23"> </a>
<a name="ln24">#include &quot;log.h&quot;</a>
<a name="ln25">#include &quot;memory.h&quot;</a>
<a name="ln26">#include &quot;thread.h&quot;</a>
<a name="ln27">#include &quot;linklist.h&quot;</a>
<a name="ln28">#include &quot;vty.h&quot;</a>
<a name="ln29">#include &quot;command.h&quot;</a>
<a name="ln30"> </a>
<a name="ln31">#include &quot;ospf6_proto.h&quot;</a>
<a name="ln32">#include &quot;ospf6_lsa.h&quot;</a>
<a name="ln33">#include &quot;ospf6_lsdb.h&quot;</a>
<a name="ln34">#include &quot;ospf6_message.h&quot;</a>
<a name="ln35">#include &quot;ospf6_top.h&quot;</a>
<a name="ln36">#include &quot;ospf6_area.h&quot;</a>
<a name="ln37">#include &quot;ospf6_interface.h&quot;</a>
<a name="ln38">#include &quot;ospf6_neighbor.h&quot;</a>
<a name="ln39">#include &quot;ospf6_intra.h&quot;</a>
<a name="ln40">#include &quot;ospf6_flood.h&quot;</a>
<a name="ln41">#include &quot;ospf6_snmp.h&quot;</a>
<a name="ln42">#include &quot;ospf6d.h&quot;</a>
<a name="ln43"> </a>
<a name="ln44">unsigned char conf_debug_ospf6_neighbor = 0;</a>
<a name="ln45"> </a>
<a name="ln46">const char *ospf6_neighbor_state_str[] =</a>
<a name="ln47">{ &quot;None&quot;, &quot;Down&quot;, &quot;Attempt&quot;, &quot;Init&quot;, &quot;Twoway&quot;, &quot;ExStart&quot;, &quot;ExChange&quot;,</a>
<a name="ln48">  &quot;Loading&quot;, &quot;Full&quot;, NULL };</a>
<a name="ln49"> </a>
<a name="ln50">static const char *ospf6_neighbor_event_str[] =</a>
<a name="ln51">  {</a>
<a name="ln52">    &quot;NoEvent&quot;,</a>
<a name="ln53">    &quot;HelloReceived&quot;,</a>
<a name="ln54">    &quot;2-WayReceived&quot;,</a>
<a name="ln55">    &quot;NegotiationDone&quot;,</a>
<a name="ln56">    &quot;ExchangeDone&quot;,</a>
<a name="ln57">    &quot;LoadingDone&quot;,</a>
<a name="ln58">    &quot;AdjOK?&quot;,</a>
<a name="ln59">    &quot;SeqNumberMismatch&quot;,</a>
<a name="ln60">    &quot;BadLSReq&quot;,</a>
<a name="ln61">    &quot;1-WayReceived&quot;,</a>
<a name="ln62">    &quot;InactivityTimer&quot;,</a>
<a name="ln63">  };</a>
<a name="ln64"> </a>
<a name="ln65">static const char *</a>
<a name="ln66">ospf6_neighbor_event_string (int event)</a>
<a name="ln67">{</a>
<a name="ln68">  #define OSPF6_NEIGHBOR_UNKNOWN_EVENT_STRING &quot;UnknownEvent&quot;</a>
<a name="ln69"> </a>
<a name="ln70">  if (event &lt; OSPF6_NEIGHBOR_EVENT_MAX_EVENT)</a>
<a name="ln71">      return ospf6_neighbor_event_str[event];</a>
<a name="ln72">  return OSPF6_NEIGHBOR_UNKNOWN_EVENT_STRING;</a>
<a name="ln73">}</a>
<a name="ln74"> </a>
<a name="ln75">int</a>
<a name="ln76">ospf6_neighbor_cmp (void *va, void *vb)</a>
<a name="ln77">{</a>
<a name="ln78">  struct ospf6_neighbor *ona = (struct ospf6_neighbor *) va;</a>
<a name="ln79">  struct ospf6_neighbor *onb = (struct ospf6_neighbor *) vb;</a>
<a name="ln80">  return (ntohl (ona-&gt;router_id) &lt; ntohl (onb-&gt;router_id) ? -1 : 1);</a>
<a name="ln81">}</a>
<a name="ln82"> </a>
<a name="ln83">struct ospf6_neighbor *</a>
<a name="ln84">ospf6_neighbor_lookup (u_int32_t router_id,</a>
<a name="ln85">                       struct ospf6_interface *oi)</a>
<a name="ln86">{</a>
<a name="ln87">  struct listnode *n;</a>
<a name="ln88">  struct ospf6_neighbor *on;</a>
<a name="ln89"> </a>
<a name="ln90">  for (ALL_LIST_ELEMENTS_RO (oi-&gt;neighbor_list, n, on))</a>
<a name="ln91">    if (on-&gt;router_id == router_id)</a>
<a name="ln92">      return on;</a>
<a name="ln93">  </a>
<a name="ln94">  return (struct ospf6_neighbor *) NULL;</a>
<a name="ln95">}</a>
<a name="ln96"> </a>
<a name="ln97">/* create ospf6_neighbor */</a>
<a name="ln98">struct ospf6_neighbor *</a>
<a name="ln99">ospf6_neighbor_create (u_int32_t router_id, struct ospf6_interface *oi)</a>
<a name="ln100">{</a>
<a name="ln101">  struct ospf6_neighbor *on;</a>
<a name="ln102">  char buf[16];</a>
<a name="ln103"> </a>
<a name="ln104">  on = (struct ospf6_neighbor *)</a>
<a name="ln105">    XMALLOC (MTYPE_OSPF6_NEIGHBOR, sizeof (struct ospf6_neighbor));</a>
<a name="ln106">  if (on == NULL)</a>
<a name="ln107">    {</a>
<a name="ln108">      zlog_warn (&quot;neighbor: malloc failed&quot;);</a>
<a name="ln109">      return NULL;</a>
<a name="ln110">    }</a>
<a name="ln111"> </a>
<a name="ln112">  memset (on, 0, sizeof (struct ospf6_neighbor));</a>
<a name="ln113">  inet_ntop (AF_INET, &amp;router_id, buf, sizeof (buf));</a>
<a name="ln114">  snprintf (on-&gt;name, sizeof (on-&gt;name), &quot;%s%%%s&quot;,</a>
<a name="ln115">            buf, oi-&gt;interface-&gt;name);</a>
<a name="ln116">  on-&gt;ospf6_if = oi;</a>
<a name="ln117">  on-&gt;state = OSPF6_NEIGHBOR_DOWN;</a>
<a name="ln118">  on-&gt;state_change = 0;</a>
<a name="ln119">  quagga_gettime (QUAGGA_CLK_MONOTONIC, &amp;on-&gt;last_changed);</a>
<a name="ln120">  on-&gt;router_id = router_id;</a>
<a name="ln121"> </a>
<a name="ln122">  on-&gt;summary_list = ospf6_lsdb_create (on);</a>
<a name="ln123">  on-&gt;request_list = ospf6_lsdb_create (on);</a>
<a name="ln124">  on-&gt;retrans_list = ospf6_lsdb_create (on);</a>
<a name="ln125"> </a>
<a name="ln126">  on-&gt;dbdesc_list = ospf6_lsdb_create (on);</a>
<a name="ln127">  on-&gt;lsupdate_list = ospf6_lsdb_create (on);</a>
<a name="ln128">  on-&gt;lsack_list = ospf6_lsdb_create (on);</a>
<a name="ln129"> </a>
<a name="ln130">  listnode_add_sort (oi-&gt;neighbor_list, on);</a>
<a name="ln131">  return on;</a>
<a name="ln132">}</a>
<a name="ln133"> </a>
<a name="ln134">void</a>
<a name="ln135">ospf6_neighbor_delete (struct ospf6_neighbor *on)</a>
<a name="ln136">{</a>
<a name="ln137">  struct ospf6_lsa *lsa;</a>
<a name="ln138"> </a>
<a name="ln139">  ospf6_lsdb_remove_all (on-&gt;summary_list);</a>
<a name="ln140">  ospf6_lsdb_remove_all (on-&gt;request_list);</a>
<a name="ln141">  for (lsa = ospf6_lsdb_head (on-&gt;retrans_list); lsa;</a>
<a name="ln142">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln143">    {</a>
<a name="ln144">      ospf6_decrement_retrans_count (lsa);</a>
<a name="ln145">      ospf6_lsdb_remove (lsa, on-&gt;retrans_list);</a>
<a name="ln146">    }</a>
<a name="ln147"> </a>
<a name="ln148">  ospf6_lsdb_remove_all (on-&gt;dbdesc_list);</a>
<a name="ln149">  ospf6_lsdb_remove_all (on-&gt;lsupdate_list);</a>
<a name="ln150">  ospf6_lsdb_remove_all (on-&gt;lsack_list);</a>
<a name="ln151"> </a>
<a name="ln152">  ospf6_lsdb_delete (on-&gt;summary_list);</a>
<a name="ln153">  ospf6_lsdb_delete (on-&gt;request_list);</a>
<a name="ln154">  ospf6_lsdb_delete (on-&gt;retrans_list);</a>
<a name="ln155"> </a>
<a name="ln156">  ospf6_lsdb_delete (on-&gt;dbdesc_list);</a>
<a name="ln157">  ospf6_lsdb_delete (on-&gt;lsupdate_list);</a>
<a name="ln158">  ospf6_lsdb_delete (on-&gt;lsack_list);</a>
<a name="ln159"> </a>
<a name="ln160">  THREAD_OFF (on-&gt;inactivity_timer);</a>
<a name="ln161"> </a>
<a name="ln162">  THREAD_OFF (on-&gt;thread_send_dbdesc);</a>
<a name="ln163">  THREAD_OFF (on-&gt;thread_send_lsreq);</a>
<a name="ln164">  THREAD_OFF (on-&gt;thread_send_lsupdate);</a>
<a name="ln165">  THREAD_OFF (on-&gt;thread_send_lsack);</a>
<a name="ln166"> </a>
<a name="ln167">  XFREE (MTYPE_OSPF6_NEIGHBOR, on);</a>
<a name="ln168">}</a>
<a name="ln169"> </a>
<a name="ln170">static void</a>
<a name="ln171">ospf6_neighbor_state_change (u_char next_state, struct ospf6_neighbor *on, int event)</a>
<a name="ln172">{</a>
<a name="ln173">  u_char prev_state;</a>
<a name="ln174"> </a>
<a name="ln175">  prev_state = on-&gt;state;</a>
<a name="ln176">  on-&gt;state = next_state;</a>
<a name="ln177"> </a>
<a name="ln178">  if (prev_state == next_state)</a>
<a name="ln179">    return;</a>
<a name="ln180"> </a>
<a name="ln181">  on-&gt;state_change++;</a>
<a name="ln182">  quagga_gettime (QUAGGA_CLK_MONOTONIC, &amp;on-&gt;last_changed);</a>
<a name="ln183"> </a>
<a name="ln184">  /* log */</a>
<a name="ln185">  if (IS_OSPF6_DEBUG_NEIGHBOR (STATE))</a>
<a name="ln186">    {</a>
<a name="ln187">      zlog_debug (&quot;Neighbor state change %s: [%s]-&gt;[%s] (%s)&quot;, on-&gt;name,</a>
<a name="ln188">		  ospf6_neighbor_state_str[prev_state],</a>
<a name="ln189">		  ospf6_neighbor_state_str[next_state],</a>
<a name="ln190">		  ospf6_neighbor_event_string(event));</a>
<a name="ln191">    }</a>
<a name="ln192"> </a>
<a name="ln193">  /* Optionally notify about adjacency changes */</a>
<a name="ln194">  if (CHECK_FLAG(on-&gt;ospf6_if-&gt;area-&gt;ospf6-&gt;config_flags,</a>
<a name="ln195">		 OSPF6_LOG_ADJACENCY_CHANGES) &amp;&amp;</a>
<a name="ln196">      (CHECK_FLAG(on-&gt;ospf6_if-&gt;area-&gt;ospf6-&gt;config_flags,</a>
<a name="ln197">		  OSPF6_LOG_ADJACENCY_DETAIL) ||</a>
<a name="ln198">       (next_state == OSPF6_NEIGHBOR_FULL) || (next_state &lt; prev_state)))</a>
<a name="ln199">    zlog_notice(&quot;AdjChg: Nbr %s: %s -&gt; %s (%s)&quot;, on-&gt;name,</a>
<a name="ln200">		ospf6_neighbor_state_str[prev_state],</a>
<a name="ln201">		ospf6_neighbor_state_str[next_state],</a>
<a name="ln202">		ospf6_neighbor_event_string(event));</a>
<a name="ln203"> </a>
<a name="ln204">  if (prev_state == OSPF6_NEIGHBOR_FULL || next_state == OSPF6_NEIGHBOR_FULL)</a>
<a name="ln205">    {</a>
<a name="ln206">      OSPF6_ROUTER_LSA_SCHEDULE (on-&gt;ospf6_if-&gt;area);</a>
<a name="ln207">      if (on-&gt;ospf6_if-&gt;state == OSPF6_INTERFACE_DR)</a>
<a name="ln208">        {</a>
<a name="ln209">          OSPF6_NETWORK_LSA_SCHEDULE (on-&gt;ospf6_if);</a>
<a name="ln210">          OSPF6_INTRA_PREFIX_LSA_SCHEDULE_TRANSIT (on-&gt;ospf6_if);</a>
<a name="ln211">        }</a>
<a name="ln212">      OSPF6_INTRA_PREFIX_LSA_SCHEDULE_STUB (on-&gt;ospf6_if-&gt;area);</a>
<a name="ln213">    }</a>
<a name="ln214"> </a>
<a name="ln215">  if ((prev_state == OSPF6_NEIGHBOR_EXCHANGE ||</a>
<a name="ln216">       prev_state == OSPF6_NEIGHBOR_LOADING) &amp;&amp;</a>
<a name="ln217">      (next_state != OSPF6_NEIGHBOR_EXCHANGE &amp;&amp;</a>
<a name="ln218">       next_state != OSPF6_NEIGHBOR_LOADING))</a>
<a name="ln219">    ospf6_maxage_remove (on-&gt;ospf6_if-&gt;area-&gt;ospf6);</a>
<a name="ln220"> </a>
<a name="ln221">#ifdef HAVE_SNMP</a>
<a name="ln222">  /* Terminal state or regression */ </a>
<a name="ln223">  if ((next_state == OSPF6_NEIGHBOR_FULL)  ||</a>
<a name="ln224">      (next_state == OSPF6_NEIGHBOR_TWOWAY) ||</a>
<a name="ln225">      (next_state &lt; prev_state))</a>
<a name="ln226">    ospf6TrapNbrStateChange (on);</a>
<a name="ln227">#endif</a>
<a name="ln228"> </a>
<a name="ln229">}</a>
<a name="ln230"> </a>
<a name="ln231">/* RFC2328 section 10.4 */</a>
<a name="ln232">static int</a>
<a name="ln233">need_adjacency (struct ospf6_neighbor *on)</a>
<a name="ln234">{</a>
<a name="ln235">  if (on-&gt;ospf6_if-&gt;state == OSPF6_INTERFACE_POINTTOPOINT ||</a>
<a name="ln236">      on-&gt;ospf6_if-&gt;state == OSPF6_INTERFACE_DR ||</a>
<a name="ln237">      on-&gt;ospf6_if-&gt;state == OSPF6_INTERFACE_BDR)</a>
<a name="ln238">    return 1;</a>
<a name="ln239"> </a>
<a name="ln240">  if (on-&gt;ospf6_if-&gt;drouter == on-&gt;router_id ||</a>
<a name="ln241">      on-&gt;ospf6_if-&gt;bdrouter == on-&gt;router_id)</a>
<a name="ln242">    return 1;</a>
<a name="ln243"> </a>
<a name="ln244">  return 0;</a>
<a name="ln245">}</a>
<a name="ln246"> </a>
<a name="ln247">int</a>
<a name="ln248">hello_received (struct thread *thread)</a>
<a name="ln249">{</a>
<a name="ln250">  struct ospf6_neighbor *on;</a>
<a name="ln251"> </a>
<a name="ln252">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln253">  assert (on);</a>
<a name="ln254"> </a>
<a name="ln255">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln256">    zlog_debug (&quot;Neighbor Event %s: *HelloReceived*&quot;, on-&gt;name);</a>
<a name="ln257"> </a>
<a name="ln258">  /* reset Inactivity Timer */</a>
<a name="ln259">  THREAD_OFF (on-&gt;inactivity_timer);</a>
<a name="ln260">  on-&gt;inactivity_timer = thread_add_timer (master, inactivity_timer, on,</a>
<a name="ln261">                                           on-&gt;ospf6_if-&gt;dead_interval);</a>
<a name="ln262"> </a>
<a name="ln263">  if (on-&gt;state &lt;= OSPF6_NEIGHBOR_DOWN)</a>
<a name="ln264">    ospf6_neighbor_state_change (OSPF6_NEIGHBOR_INIT, on,</a>
<a name="ln265">				 OSPF6_NEIGHBOR_EVENT_HELLO_RCVD);</a>
<a name="ln266"> </a>
<a name="ln267">  return 0;</a>
<a name="ln268">}</a>
<a name="ln269"> </a>
<a name="ln270">int</a>
<a name="ln271">twoway_received (struct thread *thread)</a>
<a name="ln272">{</a>
<a name="ln273">  struct ospf6_neighbor *on;</a>
<a name="ln274"> </a>
<a name="ln275">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln276">  assert (on);</a>
<a name="ln277"> </a>
<a name="ln278">  if (on-&gt;state &gt; OSPF6_NEIGHBOR_INIT)</a>
<a name="ln279">    return 0;</a>
<a name="ln280"> </a>
<a name="ln281">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln282">    zlog_debug (&quot;Neighbor Event %s: *2Way-Received*&quot;, on-&gt;name);</a>
<a name="ln283"> </a>
<a name="ln284">  thread_add_event (master, neighbor_change, on-&gt;ospf6_if, 0);</a>
<a name="ln285"> </a>
<a name="ln286">  if (! need_adjacency (on))</a>
<a name="ln287">    {</a>
<a name="ln288">      ospf6_neighbor_state_change (OSPF6_NEIGHBOR_TWOWAY, on,</a>
<a name="ln289">				   OSPF6_NEIGHBOR_EVENT_TWOWAY_RCVD);</a>
<a name="ln290">      return 0;</a>
<a name="ln291">    }</a>
<a name="ln292"> </a>
<a name="ln293">  ospf6_neighbor_state_change (OSPF6_NEIGHBOR_EXSTART, on,</a>
<a name="ln294">			       OSPF6_NEIGHBOR_EVENT_TWOWAY_RCVD);</a>
<a name="ln295">  SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MSBIT);</a>
<a name="ln296">  SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MBIT);</a>
<a name="ln297">  SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_IBIT);</a>
<a name="ln298"> </a>
<a name="ln299">  THREAD_OFF (on-&gt;thread_send_dbdesc);</a>
<a name="ln300">  on-&gt;thread_send_dbdesc =</a>
<a name="ln301">    thread_add_event (master, ospf6_dbdesc_send, on, 0);</a>
<a name="ln302"> </a>
<a name="ln303">  return 0;</a>
<a name="ln304">}</a>
<a name="ln305"> </a>
<a name="ln306">int</a>
<a name="ln307">negotiation_done (struct thread *thread)</a>
<a name="ln308">{</a>
<a name="ln309">  struct ospf6_neighbor *on;</a>
<a name="ln310">  struct ospf6_lsa *lsa;</a>
<a name="ln311"> </a>
<a name="ln312">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln313">  assert (on);</a>
<a name="ln314"> </a>
<a name="ln315">  if (on-&gt;state != OSPF6_NEIGHBOR_EXSTART)</a>
<a name="ln316">    return 0;</a>
<a name="ln317"> </a>
<a name="ln318">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln319">    zlog_debug (&quot;Neighbor Event %s: *NegotiationDone*&quot;, on-&gt;name);</a>
<a name="ln320"> </a>
<a name="ln321">  /* clear ls-list */</a>
<a name="ln322">  ospf6_lsdb_remove_all (on-&gt;summary_list);</a>
<a name="ln323">  ospf6_lsdb_remove_all (on-&gt;request_list);</a>
<a name="ln324">  for (lsa = ospf6_lsdb_head (on-&gt;retrans_list); lsa;</a>
<a name="ln325">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln326">    {</a>
<a name="ln327">      ospf6_decrement_retrans_count (lsa);</a>
<a name="ln328">      ospf6_lsdb_remove (lsa, on-&gt;retrans_list);</a>
<a name="ln329">    }</a>
<a name="ln330"> </a>
<a name="ln331">  /* Interface scoped LSAs */</a>
<a name="ln332">  for (lsa = ospf6_lsdb_head (on-&gt;ospf6_if-&gt;lsdb); lsa;</a>
<a name="ln333">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln334">    {</a>
<a name="ln335">      if (OSPF6_LSA_IS_MAXAGE (lsa))</a>
<a name="ln336">        {</a>
<a name="ln337">          ospf6_increment_retrans_count (lsa);</a>
<a name="ln338">          ospf6_lsdb_add (ospf6_lsa_copy (lsa), on-&gt;retrans_list);</a>
<a name="ln339">        }</a>
<a name="ln340">      else</a>
<a name="ln341">        ospf6_lsdb_add (ospf6_lsa_copy (lsa), on-&gt;summary_list);</a>
<a name="ln342">    }</a>
<a name="ln343"> </a>
<a name="ln344">  /* Area scoped LSAs */</a>
<a name="ln345">  for (lsa = ospf6_lsdb_head (on-&gt;ospf6_if-&gt;area-&gt;lsdb); lsa;</a>
<a name="ln346">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln347">    {</a>
<a name="ln348">      if (OSPF6_LSA_IS_MAXAGE (lsa))</a>
<a name="ln349">        {</a>
<a name="ln350">          ospf6_increment_retrans_count (lsa);</a>
<a name="ln351">          ospf6_lsdb_add (ospf6_lsa_copy (lsa), on-&gt;retrans_list);</a>
<a name="ln352">        }</a>
<a name="ln353">      else</a>
<a name="ln354">        ospf6_lsdb_add (ospf6_lsa_copy (lsa), on-&gt;summary_list);</a>
<a name="ln355">    }</a>
<a name="ln356"> </a>
<a name="ln357">  /* AS scoped LSAs */</a>
<a name="ln358">  for (lsa = ospf6_lsdb_head (on-&gt;ospf6_if-&gt;area-&gt;ospf6-&gt;lsdb); lsa;</a>
<a name="ln359">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln360">    {</a>
<a name="ln361">      if (OSPF6_LSA_IS_MAXAGE (lsa))</a>
<a name="ln362">        {</a>
<a name="ln363">          ospf6_increment_retrans_count (lsa);</a>
<a name="ln364">          ospf6_lsdb_add (ospf6_lsa_copy (lsa), on-&gt;retrans_list);</a>
<a name="ln365">        }</a>
<a name="ln366">      else</a>
<a name="ln367">        ospf6_lsdb_add (ospf6_lsa_copy (lsa), on-&gt;summary_list);</a>
<a name="ln368">    }</a>
<a name="ln369"> </a>
<a name="ln370">  UNSET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_IBIT);</a>
<a name="ln371">  ospf6_neighbor_state_change (OSPF6_NEIGHBOR_EXCHANGE, on,</a>
<a name="ln372">			       OSPF6_NEIGHBOR_EVENT_NEGOTIATION_DONE);</a>
<a name="ln373"> </a>
<a name="ln374">  return 0;</a>
<a name="ln375">}</a>
<a name="ln376"> </a>
<a name="ln377">int</a>
<a name="ln378">exchange_done (struct thread *thread)</a>
<a name="ln379">{</a>
<a name="ln380">  struct ospf6_neighbor *on;</a>
<a name="ln381"> </a>
<a name="ln382">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln383">  assert (on);</a>
<a name="ln384"> </a>
<a name="ln385">  if (on-&gt;state != OSPF6_NEIGHBOR_EXCHANGE)</a>
<a name="ln386">    return 0;</a>
<a name="ln387"> </a>
<a name="ln388">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln389">    zlog_debug (&quot;Neighbor Event %s: *ExchangeDone*&quot;, on-&gt;name);</a>
<a name="ln390"> </a>
<a name="ln391">  THREAD_OFF (on-&gt;thread_send_dbdesc);</a>
<a name="ln392">  ospf6_lsdb_remove_all (on-&gt;dbdesc_list);</a>
<a name="ln393"> </a>
<a name="ln394">/* XXX</a>
<a name="ln395">  thread_add_timer (master, ospf6_neighbor_last_dbdesc_release, on,</a>
<a name="ln396">                    on-&gt;ospf6_if-&gt;dead_interval);</a>
<a name="ln397">*/</a>
<a name="ln398"> </a>
<a name="ln399">  if (on-&gt;request_list-&gt;count == 0)</a>
<a name="ln400">    ospf6_neighbor_state_change (OSPF6_NEIGHBOR_FULL, on,</a>
<a name="ln401">				 OSPF6_NEIGHBOR_EVENT_EXCHANGE_DONE);</a>
<a name="ln402">  else</a>
<a name="ln403">    {</a>
<a name="ln404">      ospf6_neighbor_state_change (OSPF6_NEIGHBOR_LOADING, on,</a>
<a name="ln405">				   OSPF6_NEIGHBOR_EVENT_EXCHANGE_DONE);</a>
<a name="ln406"> </a>
<a name="ln407">      if (on-&gt;thread_send_lsreq == NULL)</a>
<a name="ln408">	on-&gt;thread_send_lsreq =</a>
<a name="ln409">	  thread_add_event (master, ospf6_lsreq_send, on, 0);</a>
<a name="ln410">    }</a>
<a name="ln411"> </a>
<a name="ln412">  return 0;</a>
<a name="ln413">}</a>
<a name="ln414"> </a>
<a name="ln415">/* Check loading state. */</a>
<a name="ln416">void</a>
<a name="ln417">ospf6_check_nbr_loading (struct ospf6_neighbor *on)</a>
<a name="ln418">{</a>
<a name="ln419"> </a>
<a name="ln420">  /* RFC2328 Section 10.9: When the neighbor responds to these requests</a>
<a name="ln421">     with the proper Link State Update packet(s), the Link state request</a>
<a name="ln422">     list is truncated and a new Link State Request packet is sent.</a>
<a name="ln423">  */</a>
<a name="ln424">  if ((on-&gt;state == OSPF6_NEIGHBOR_LOADING) ||</a>
<a name="ln425">      (on-&gt;state == OSPF6_NEIGHBOR_EXCHANGE))</a>
<a name="ln426">    {</a>
<a name="ln427">      if (on-&gt;request_list-&gt;count == 0)</a>
<a name="ln428">	thread_add_event (master, loading_done, on, 0);</a>
<a name="ln429">      else if (on-&gt;last_ls_req == NULL)</a>
<a name="ln430">	{</a>
<a name="ln431">	  if (on-&gt;thread_send_lsreq != NULL)</a>
<a name="ln432">	    THREAD_OFF (on-&gt;thread_send_lsreq);</a>
<a name="ln433">	  on-&gt;thread_send_lsreq =</a>
<a name="ln434">	    thread_add_event (master, ospf6_lsreq_send, on, 0);</a>
<a name="ln435">	}</a>
<a name="ln436">    }</a>
<a name="ln437">}</a>
<a name="ln438"> </a>
<a name="ln439">int</a>
<a name="ln440">loading_done (struct thread *thread)</a>
<a name="ln441">{</a>
<a name="ln442">  struct ospf6_neighbor *on;</a>
<a name="ln443"> </a>
<a name="ln444">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln445">  assert (on);</a>
<a name="ln446"> </a>
<a name="ln447">  if (on-&gt;state != OSPF6_NEIGHBOR_LOADING)</a>
<a name="ln448">    return 0;</a>
<a name="ln449"> </a>
<a name="ln450">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln451">    zlog_debug (&quot;Neighbor Event %s: *LoadingDone*&quot;, on-&gt;name);</a>
<a name="ln452"> </a>
<a name="ln453">  assert (on-&gt;request_list-&gt;count == 0);</a>
<a name="ln454"> </a>
<a name="ln455">  ospf6_neighbor_state_change (OSPF6_NEIGHBOR_FULL, on,</a>
<a name="ln456">			       OSPF6_NEIGHBOR_EVENT_LOADING_DONE);</a>
<a name="ln457"> </a>
<a name="ln458">  return 0;</a>
<a name="ln459">}</a>
<a name="ln460"> </a>
<a name="ln461">int</a>
<a name="ln462">adj_ok (struct thread *thread)</a>
<a name="ln463">{</a>
<a name="ln464">  struct ospf6_neighbor *on;</a>
<a name="ln465">  struct ospf6_lsa *lsa;</a>
<a name="ln466"> </a>
<a name="ln467">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln468">  assert (on);</a>
<a name="ln469"> </a>
<a name="ln470">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln471">    zlog_debug (&quot;Neighbor Event %s: *AdjOK?*&quot;, on-&gt;name);</a>
<a name="ln472"> </a>
<a name="ln473">  if (on-&gt;state == OSPF6_NEIGHBOR_TWOWAY &amp;&amp; need_adjacency (on))</a>
<a name="ln474">    {</a>
<a name="ln475">      ospf6_neighbor_state_change (OSPF6_NEIGHBOR_EXSTART, on,</a>
<a name="ln476">				   OSPF6_NEIGHBOR_EVENT_ADJ_OK);</a>
<a name="ln477">      SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MSBIT);</a>
<a name="ln478">      SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MBIT);</a>
<a name="ln479">      SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_IBIT);</a>
<a name="ln480"> </a>
<a name="ln481">      THREAD_OFF (on-&gt;thread_send_dbdesc);</a>
<a name="ln482">      on-&gt;thread_send_dbdesc =</a>
<a name="ln483">        thread_add_event (master, ospf6_dbdesc_send, on, 0);</a>
<a name="ln484"> </a>
<a name="ln485">    }</a>
<a name="ln486">  else if (on-&gt;state &gt;= OSPF6_NEIGHBOR_EXSTART &amp;&amp;</a>
<a name="ln487">           ! need_adjacency (on))</a>
<a name="ln488">    {</a>
<a name="ln489">      ospf6_neighbor_state_change (OSPF6_NEIGHBOR_TWOWAY, on,</a>
<a name="ln490">				   OSPF6_NEIGHBOR_EVENT_ADJ_OK);</a>
<a name="ln491">      ospf6_lsdb_remove_all (on-&gt;summary_list);</a>
<a name="ln492">      ospf6_lsdb_remove_all (on-&gt;request_list);</a>
<a name="ln493">      for (lsa = ospf6_lsdb_head (on-&gt;retrans_list); lsa;</a>
<a name="ln494">           lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln495">        {</a>
<a name="ln496">          ospf6_decrement_retrans_count (lsa);</a>
<a name="ln497">          ospf6_lsdb_remove (lsa, on-&gt;retrans_list);</a>
<a name="ln498">        }</a>
<a name="ln499">    }</a>
<a name="ln500"> </a>
<a name="ln501">  return 0;</a>
<a name="ln502">}</a>
<a name="ln503"> </a>
<a name="ln504">int</a>
<a name="ln505">seqnumber_mismatch (struct thread *thread)</a>
<a name="ln506">{</a>
<a name="ln507">  struct ospf6_neighbor *on;</a>
<a name="ln508">  struct ospf6_lsa *lsa;</a>
<a name="ln509"> </a>
<a name="ln510">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln511">  assert (on);</a>
<a name="ln512"> </a>
<a name="ln513">  if (on-&gt;state &lt; OSPF6_NEIGHBOR_EXCHANGE)</a>
<a name="ln514">    return 0;</a>
<a name="ln515"> </a>
<a name="ln516">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln517">    zlog_debug (&quot;Neighbor Event %s: *SeqNumberMismatch*&quot;, on-&gt;name);</a>
<a name="ln518"> </a>
<a name="ln519">  ospf6_neighbor_state_change (OSPF6_NEIGHBOR_EXSTART, on,</a>
<a name="ln520">			       OSPF6_NEIGHBOR_EVENT_SEQNUMBER_MISMATCH);</a>
<a name="ln521">  SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MSBIT);</a>
<a name="ln522">  SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MBIT);</a>
<a name="ln523">  SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_IBIT);</a>
<a name="ln524"> </a>
<a name="ln525">  ospf6_lsdb_remove_all (on-&gt;summary_list);</a>
<a name="ln526">  ospf6_lsdb_remove_all (on-&gt;request_list);</a>
<a name="ln527">  for (lsa = ospf6_lsdb_head (on-&gt;retrans_list); lsa;</a>
<a name="ln528">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln529">    {</a>
<a name="ln530">      ospf6_decrement_retrans_count (lsa);</a>
<a name="ln531">      ospf6_lsdb_remove (lsa, on-&gt;retrans_list);</a>
<a name="ln532">    }</a>
<a name="ln533"> </a>
<a name="ln534">  THREAD_OFF (on-&gt;thread_send_dbdesc);</a>
<a name="ln535">  on-&gt;dbdesc_seqnum++;		/* Incr seqnum as per RFC2328, sec 10.3 */</a>
<a name="ln536"> </a>
<a name="ln537">  on-&gt;thread_send_dbdesc =</a>
<a name="ln538">    thread_add_event (master, ospf6_dbdesc_send, on, 0);</a>
<a name="ln539"> </a>
<a name="ln540">  return 0;</a>
<a name="ln541">}</a>
<a name="ln542"> </a>
<a name="ln543">int</a>
<a name="ln544">bad_lsreq (struct thread *thread)</a>
<a name="ln545">{</a>
<a name="ln546">  struct ospf6_neighbor *on;</a>
<a name="ln547">  struct ospf6_lsa *lsa;</a>
<a name="ln548"> </a>
<a name="ln549">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln550">  assert (on);</a>
<a name="ln551"> </a>
<a name="ln552">  if (on-&gt;state &lt; OSPF6_NEIGHBOR_EXCHANGE)</a>
<a name="ln553">    return 0;</a>
<a name="ln554"> </a>
<a name="ln555">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln556">    zlog_debug (&quot;Neighbor Event %s: *BadLSReq*&quot;, on-&gt;name);</a>
<a name="ln557"> </a>
<a name="ln558">  ospf6_neighbor_state_change (OSPF6_NEIGHBOR_EXSTART, on,</a>
<a name="ln559">			       OSPF6_NEIGHBOR_EVENT_BAD_LSREQ);</a>
<a name="ln560">  SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MSBIT);</a>
<a name="ln561">  SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MBIT);</a>
<a name="ln562">  SET_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_IBIT);</a>
<a name="ln563"> </a>
<a name="ln564">  ospf6_lsdb_remove_all (on-&gt;summary_list);</a>
<a name="ln565">  ospf6_lsdb_remove_all (on-&gt;request_list);</a>
<a name="ln566">  for (lsa = ospf6_lsdb_head (on-&gt;retrans_list); lsa;</a>
<a name="ln567">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln568">    {</a>
<a name="ln569">      ospf6_decrement_retrans_count (lsa);</a>
<a name="ln570">      ospf6_lsdb_remove (lsa, on-&gt;retrans_list);</a>
<a name="ln571">    }</a>
<a name="ln572"> </a>
<a name="ln573">  THREAD_OFF (on-&gt;thread_send_dbdesc);</a>
<a name="ln574">  on-&gt;dbdesc_seqnum++;		/* Incr seqnum as per RFC2328, sec 10.3 */</a>
<a name="ln575"> </a>
<a name="ln576">  on-&gt;thread_send_dbdesc =</a>
<a name="ln577">    thread_add_event (master, ospf6_dbdesc_send, on, 0);</a>
<a name="ln578"> </a>
<a name="ln579">  return 0;</a>
<a name="ln580">}</a>
<a name="ln581"> </a>
<a name="ln582">int</a>
<a name="ln583">oneway_received (struct thread *thread)</a>
<a name="ln584">{</a>
<a name="ln585">  struct ospf6_neighbor *on;</a>
<a name="ln586">  struct ospf6_lsa *lsa;</a>
<a name="ln587"> </a>
<a name="ln588">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln589">  assert (on);</a>
<a name="ln590"> </a>
<a name="ln591">  if (on-&gt;state &lt; OSPF6_NEIGHBOR_TWOWAY)</a>
<a name="ln592">    return 0;</a>
<a name="ln593"> </a>
<a name="ln594">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln595">    zlog_debug (&quot;Neighbor Event %s: *1Way-Received*&quot;, on-&gt;name);</a>
<a name="ln596"> </a>
<a name="ln597">  ospf6_neighbor_state_change (OSPF6_NEIGHBOR_INIT, on,</a>
<a name="ln598">			       OSPF6_NEIGHBOR_EVENT_ONEWAY_RCVD);</a>
<a name="ln599">  thread_add_event (master, neighbor_change, on-&gt;ospf6_if, 0);</a>
<a name="ln600"> </a>
<a name="ln601">  ospf6_lsdb_remove_all (on-&gt;summary_list);</a>
<a name="ln602">  ospf6_lsdb_remove_all (on-&gt;request_list);</a>
<a name="ln603">  for (lsa = ospf6_lsdb_head (on-&gt;retrans_list); lsa;</a>
<a name="ln604">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln605">    {</a>
<a name="ln606">      ospf6_decrement_retrans_count (lsa);</a>
<a name="ln607">      ospf6_lsdb_remove (lsa, on-&gt;retrans_list);</a>
<a name="ln608">    }</a>
<a name="ln609"> </a>
<a name="ln610">  THREAD_OFF (on-&gt;thread_send_dbdesc);</a>
<a name="ln611">  THREAD_OFF (on-&gt;thread_send_lsreq);</a>
<a name="ln612">  THREAD_OFF (on-&gt;thread_send_lsupdate);</a>
<a name="ln613">  THREAD_OFF (on-&gt;thread_send_lsack);</a>
<a name="ln614"> </a>
<a name="ln615">  return 0;</a>
<a name="ln616">}</a>
<a name="ln617"> </a>
<a name="ln618">int</a>
<a name="ln619">inactivity_timer (struct thread *thread)</a>
<a name="ln620">{</a>
<a name="ln621">  struct ospf6_neighbor *on;</a>
<a name="ln622"> </a>
<a name="ln623">  on = (struct ospf6_neighbor *) THREAD_ARG (thread);</a>
<a name="ln624">  assert (on);</a>
<a name="ln625"> </a>
<a name="ln626">  if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln627">    zlog_debug (&quot;Neighbor Event %s: *InactivityTimer*&quot;, on-&gt;name);</a>
<a name="ln628"> </a>
<a name="ln629">  on-&gt;inactivity_timer = NULL;</a>
<a name="ln630">  on-&gt;drouter = on-&gt;prev_drouter = 0;</a>
<a name="ln631">  on-&gt;bdrouter = on-&gt;prev_bdrouter = 0;</a>
<a name="ln632"> </a>
<a name="ln633">  ospf6_neighbor_state_change (OSPF6_NEIGHBOR_DOWN, on,</a>
<a name="ln634">			       OSPF6_NEIGHBOR_EVENT_INACTIVITY_TIMER);</a>
<a name="ln635">  thread_add_event (master, neighbor_change, on-&gt;ospf6_if, 0);</a>
<a name="ln636"> </a>
<a name="ln637">  listnode_delete (on-&gt;ospf6_if-&gt;neighbor_list, on);</a>
<a name="ln638">  ospf6_neighbor_delete (on);</a>
<a name="ln639"> </a>
<a name="ln640">  return 0;</a>
<a name="ln641">}</a>
<a name="ln642"> </a>
<a name="ln643"> </a>
<a name="ln644"> </a>
<a name="ln645">/* vty functions */</a>
<a name="ln646">/* show neighbor structure */</a>
<a name="ln647">static void</a>
<a name="ln648">ospf6_neighbor_show (struct vty *vty, struct ospf6_neighbor *on)</a>
<a name="ln649">{</a>
<a name="ln650">  char router_id[16];</a>
<a name="ln651">  char duration[16];</a>
<a name="ln652">  struct timeval now, res;</a>
<a name="ln653">  char nstate[16];</a>
<a name="ln654">  char deadtime[16];</a>
<a name="ln655">  long h, m, s;</a>
<a name="ln656"> </a>
<a name="ln657">  /* Router-ID (Name) */</a>
<a name="ln658">  inet_ntop (AF_INET, &amp;on-&gt;router_id, router_id, sizeof (router_id));</a>
<a name="ln659">#ifdef HAVE_GETNAMEINFO</a>
<a name="ln660">  {</a>
<a name="ln661">  }</a>
<a name="ln662">#endif /*HAVE_GETNAMEINFO*/</a>
<a name="ln663"> </a>
<a name="ln664">  quagga_gettime (QUAGGA_CLK_MONOTONIC, &amp;now);</a>
<a name="ln665"> </a>
<a name="ln666">  /* Dead time */</a>
<a name="ln667">  h = m = s = 0;</a>
<a name="ln668">  if (on-&gt;inactivity_timer)</a>
<a name="ln669">    {</a>
<a name="ln670">      s = on-&gt;inactivity_timer-&gt;u.sands.tv_sec - recent_relative_time().tv_sec;</a>
<a name="ln671">      h = s / 3600;</a>
<a name="ln672">      s -= h * 3600;</a>
<a name="ln673">      m = s / 60;</a>
<a name="ln674">      s -= m * 60;</a>
<a name="ln675">    }</a>
<a name="ln676">  snprintf (deadtime, sizeof (deadtime), &quot;%02ld:%02ld:%02ld&quot;, h, m, s);</a>
<a name="ln677"> </a>
<a name="ln678">  /* Neighbor State */</a>
<a name="ln679">  if (if_is_pointopoint (on-&gt;ospf6_if-&gt;interface))</a>
<a name="ln680">    snprintf (nstate, sizeof (nstate), &quot;PointToPoint&quot;);</a>
<a name="ln681">  else</a>
<a name="ln682">    {</a>
<a name="ln683">      if (on-&gt;router_id == on-&gt;drouter)</a>
<a name="ln684">        snprintf (nstate, sizeof (nstate), &quot;DR&quot;);</a>
<a name="ln685">      else if (on-&gt;router_id == on-&gt;bdrouter)</a>
<a name="ln686">        snprintf (nstate, sizeof (nstate), &quot;BDR&quot;);</a>
<a name="ln687">      else</a>
<a name="ln688">        snprintf (nstate, sizeof (nstate), &quot;DROther&quot;);</a>
<a name="ln689">    }</a>
<a name="ln690"> </a>
<a name="ln691">  /* Duration */</a>
<a name="ln692">  timersub (&amp;now, &amp;on-&gt;last_changed, &amp;res);</a>
<a name="ln693">  timerstring (&amp;res, duration, sizeof (duration));</a>
<a name="ln694"> </a>
<a name="ln695">  /*</a>
<a name="ln696">  vty_out (vty, &quot;%-15s %3d %11s %6s/%-12s %11s %s[%s]%s&quot;,</a>
<a name="ln697">           &quot;Neighbor ID&quot;, &quot;Pri&quot;, &quot;DeadTime&quot;, &quot;State&quot;, &quot;&quot;, &quot;Duration&quot;,</a>
<a name="ln698">           &quot;I/F&quot;, &quot;State&quot;, VNL);</a>
<a name="ln699">  */</a>
<a name="ln700"> </a>
<a name="ln701">  vty_out (vty, &quot;%-15s %3d %11s %6s/%-12s %11s %s[%s]%s&quot;,</a>
<a name="ln702">           router_id, on-&gt;priority, deadtime,</a>
<a name="ln703">           ospf6_neighbor_state_str[on-&gt;state], nstate, duration,</a>
<a name="ln704">           on-&gt;ospf6_if-&gt;interface-&gt;name,</a>
<a name="ln705">           ospf6_interface_state_str[on-&gt;ospf6_if-&gt;state], VNL);</a>
<a name="ln706">}</a>
<a name="ln707"> </a>
<a name="ln708">static void</a>
<a name="ln709">ospf6_neighbor_show_drchoice (struct vty *vty, struct ospf6_neighbor *on)</a>
<a name="ln710">{</a>
<a name="ln711">  char router_id[16];</a>
<a name="ln712">  char drouter[16], bdrouter[16];</a>
<a name="ln713">  char duration[16];</a>
<a name="ln714">  struct timeval now, res;</a>
<a name="ln715"> </a>
<a name="ln716">/*</a>
<a name="ln717">    vty_out (vty, &quot;%-15s %6s/%-11s %-15s %-15s %s[%s]%s&quot;,</a>
<a name="ln718">             &quot;RouterID&quot;, &quot;State&quot;, &quot;Duration&quot;, &quot;DR&quot;, &quot;BDR&quot;, &quot;I/F&quot;,</a>
<a name="ln719">             &quot;State&quot;, VNL);</a>
<a name="ln720">*/</a>
<a name="ln721"> </a>
<a name="ln722">  inet_ntop (AF_INET, &amp;on-&gt;router_id, router_id, sizeof (router_id));</a>
<a name="ln723">  inet_ntop (AF_INET, &amp;on-&gt;drouter, drouter, sizeof (drouter));</a>
<a name="ln724">  inet_ntop (AF_INET, &amp;on-&gt;bdrouter, bdrouter, sizeof (bdrouter));</a>
<a name="ln725"> </a>
<a name="ln726">  quagga_gettime (QUAGGA_CLK_MONOTONIC, &amp;now);</a>
<a name="ln727">  timersub (&amp;now, &amp;on-&gt;last_changed, &amp;res);</a>
<a name="ln728">  timerstring (&amp;res, duration, sizeof (duration));</a>
<a name="ln729"> </a>
<a name="ln730">  vty_out (vty, &quot;%-15s %6s/%-11s %-15s %-15s %s[%s]%s&quot;,</a>
<a name="ln731">           router_id, ospf6_neighbor_state_str[on-&gt;state],</a>
<a name="ln732">           duration, drouter, bdrouter, on-&gt;ospf6_if-&gt;interface-&gt;name,</a>
<a name="ln733">           ospf6_interface_state_str[on-&gt;ospf6_if-&gt;state],</a>
<a name="ln734">           VNL);</a>
<a name="ln735">}</a>
<a name="ln736"> </a>
<a name="ln737">static void</a>
<a name="ln738">ospf6_neighbor_show_detail (struct vty *vty, struct ospf6_neighbor *on)</a>
<a name="ln739">{</a>
<a name="ln740">  char drouter[16], bdrouter[16];</a>
<a name="ln741">  char linklocal_addr[64], duration[32];</a>
<a name="ln742">  struct timeval now, res;</a>
<a name="ln743">  struct ospf6_lsa *lsa;</a>
<a name="ln744"> </a>
<a name="ln745">  inet_ntop (AF_INET6, &amp;on-&gt;linklocal_addr, linklocal_addr,</a>
<a name="ln746">             sizeof (linklocal_addr));</a>
<a name="ln747">  inet_ntop (AF_INET, &amp;on-&gt;drouter, drouter, sizeof (drouter));</a>
<a name="ln748">  inet_ntop (AF_INET, &amp;on-&gt;bdrouter, bdrouter, sizeof (bdrouter));</a>
<a name="ln749"> </a>
<a name="ln750">  quagga_gettime (QUAGGA_CLK_MONOTONIC, &amp;now);</a>
<a name="ln751">  timersub (&amp;now, &amp;on-&gt;last_changed, &amp;res);</a>
<a name="ln752">  timerstring (&amp;res, duration, sizeof (duration));</a>
<a name="ln753"> </a>
<a name="ln754">  vty_out (vty, &quot; Neighbor %s%s&quot;, on-&gt;name,</a>
<a name="ln755">           VNL);</a>
<a name="ln756">  vty_out (vty, &quot;    Area %s via interface %s (ifindex %d)%s&quot;,</a>
<a name="ln757">           on-&gt;ospf6_if-&gt;area-&gt;name,</a>
<a name="ln758">           on-&gt;ospf6_if-&gt;interface-&gt;name,</a>
<a name="ln759">           on-&gt;ospf6_if-&gt;interface-&gt;ifindex,</a>
<a name="ln760">           VNL);</a>
<a name="ln761">  vty_out (vty, &quot;    His IfIndex: %d Link-local address: %s%s&quot;,</a>
<a name="ln762">           on-&gt;ifindex, linklocal_addr,</a>
<a name="ln763">           VNL);</a>
<a name="ln764">  vty_out (vty, &quot;    State %s for a duration of %s%s&quot;,</a>
<a name="ln765">           ospf6_neighbor_state_str[on-&gt;state], duration,</a>
<a name="ln766">           VNL);</a>
<a name="ln767">  vty_out (vty, &quot;    His choice of DR/BDR %s/%s, Priority %d%s&quot;,</a>
<a name="ln768">           drouter, bdrouter, on-&gt;priority,</a>
<a name="ln769">           VNL);</a>
<a name="ln770">  vty_out (vty, &quot;    DbDesc status: %s%s%s SeqNum: %#lx%s&quot;,</a>
<a name="ln771">           (CHECK_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_IBIT) ? &quot;Initial &quot; : &quot;&quot;),</a>
<a name="ln772">           (CHECK_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MBIT) ? &quot;More &quot; : &quot;&quot;),</a>
<a name="ln773">           (CHECK_FLAG (on-&gt;dbdesc_bits, OSPF6_DBDESC_MSBIT) ?</a>
<a name="ln774">            &quot;Master&quot; : &quot;Slave&quot;), (u_long) ntohl (on-&gt;dbdesc_seqnum),</a>
<a name="ln775">           VNL);</a>
<a name="ln776"> </a>
<a name="ln777">  vty_out (vty, &quot;    Summary-List: %d LSAs%s&quot;, on-&gt;summary_list-&gt;count,</a>
<a name="ln778">           VNL);</a>
<a name="ln779">  for (lsa = ospf6_lsdb_head (on-&gt;summary_list); lsa;</a>
<a name="ln780">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln781">    vty_out (vty, &quot;      %s%s&quot;, lsa-&gt;name, VNL);</a>
<a name="ln782"> </a>
<a name="ln783">  vty_out (vty, &quot;    Request-List: %d LSAs%s&quot;, on-&gt;request_list-&gt;count,</a>
<a name="ln784">           VNL);</a>
<a name="ln785">  for (lsa = ospf6_lsdb_head (on-&gt;request_list); lsa;</a>
<a name="ln786">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln787">    vty_out (vty, &quot;      %s%s&quot;, lsa-&gt;name, VNL);</a>
<a name="ln788"> </a>
<a name="ln789">  vty_out (vty, &quot;    Retrans-List: %d LSAs%s&quot;, on-&gt;retrans_list-&gt;count,</a>
<a name="ln790">           VNL);</a>
<a name="ln791">  for (lsa = ospf6_lsdb_head (on-&gt;retrans_list); lsa;</a>
<a name="ln792">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln793">    vty_out (vty, &quot;      %s%s&quot;, lsa-&gt;name, VNL);</a>
<a name="ln794"> </a>
<a name="ln795">  timerclear (&amp;res);</a>
<a name="ln796">  if (on-&gt;thread_send_dbdesc)</a>
<a name="ln797">    timersub (&amp;on-&gt;thread_send_dbdesc-&gt;u.sands, &amp;now, &amp;res);</a>
<a name="ln798">  timerstring (&amp;res, duration, sizeof (duration));</a>
<a name="ln799">  vty_out (vty, &quot;    %d Pending LSAs for DbDesc in Time %s [thread %s]%s&quot;,</a>
<a name="ln800">           on-&gt;dbdesc_list-&gt;count, duration,</a>
<a name="ln801">           (on-&gt;thread_send_dbdesc ? &quot;on&quot; : &quot;off&quot;),</a>
<a name="ln802">           VNL);</a>
<a name="ln803">  for (lsa = ospf6_lsdb_head (on-&gt;dbdesc_list); lsa;</a>
<a name="ln804">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln805">    vty_out (vty, &quot;      %s%s&quot;, lsa-&gt;name, VNL);</a>
<a name="ln806"> </a>
<a name="ln807">  timerclear (&amp;res);</a>
<a name="ln808">  if (on-&gt;thread_send_lsreq)</a>
<a name="ln809">    timersub (&amp;on-&gt;thread_send_lsreq-&gt;u.sands, &amp;now, &amp;res);</a>
<a name="ln810">  timerstring (&amp;res, duration, sizeof (duration));</a>
<a name="ln811">  vty_out (vty, &quot;    %d Pending LSAs for LSReq in Time %s [thread %s]%s&quot;,</a>
<a name="ln812">           on-&gt;request_list-&gt;count, duration,</a>
<a name="ln813">           (on-&gt;thread_send_lsreq ? &quot;on&quot; : &quot;off&quot;),</a>
<a name="ln814">           VNL);</a>
<a name="ln815">  for (lsa = ospf6_lsdb_head (on-&gt;request_list); lsa;</a>
<a name="ln816">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln817">    vty_out (vty, &quot;      %s%s&quot;, lsa-&gt;name, VNL);</a>
<a name="ln818"> </a>
<a name="ln819">  timerclear (&amp;res);</a>
<a name="ln820">  if (on-&gt;thread_send_lsupdate)</a>
<a name="ln821">    timersub (&amp;on-&gt;thread_send_lsupdate-&gt;u.sands, &amp;now, &amp;res);</a>
<a name="ln822">  timerstring (&amp;res, duration, sizeof (duration));</a>
<a name="ln823">  vty_out (vty, &quot;    %d Pending LSAs for LSUpdate in Time %s [thread %s]%s&quot;,</a>
<a name="ln824">           on-&gt;lsupdate_list-&gt;count, duration,</a>
<a name="ln825">           (on-&gt;thread_send_lsupdate ? &quot;on&quot; : &quot;off&quot;),</a>
<a name="ln826">           VNL);</a>
<a name="ln827">  for (lsa = ospf6_lsdb_head (on-&gt;lsupdate_list); lsa;</a>
<a name="ln828">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln829">    vty_out (vty, &quot;      %s%s&quot;, lsa-&gt;name, VNL);</a>
<a name="ln830"> </a>
<a name="ln831">  timerclear (&amp;res);</a>
<a name="ln832">  if (on-&gt;thread_send_lsack)</a>
<a name="ln833">    timersub (&amp;on-&gt;thread_send_lsack-&gt;u.sands, &amp;now, &amp;res);</a>
<a name="ln834">  timerstring (&amp;res, duration, sizeof (duration));</a>
<a name="ln835">  vty_out (vty, &quot;    %d Pending LSAs for LSAck in Time %s [thread %s]%s&quot;,</a>
<a name="ln836">           on-&gt;lsack_list-&gt;count, duration,</a>
<a name="ln837">           (on-&gt;thread_send_lsack ? &quot;on&quot; : &quot;off&quot;),</a>
<a name="ln838">           VNL);</a>
<a name="ln839">  for (lsa = ospf6_lsdb_head (on-&gt;lsack_list); lsa;</a>
<a name="ln840">       lsa = ospf6_lsdb_next (lsa))</a>
<a name="ln841">    vty_out (vty, &quot;      %s%s&quot;, lsa-&gt;name, VNL);</a>
<a name="ln842"> </a>
<a name="ln843">}</a>
<a name="ln844"> </a>
<a name="ln845">DEFUN (show_ipv6_ospf6_neighbor,</a>
<a name="ln846">       show_ipv6_ospf6_neighbor_cmd,</a>
<a name="ln847">       &quot;show ipv6 ospf6 neighbor&quot;,</a>
<a name="ln848">       SHOW_STR</a>
<a name="ln849">       IP6_STR</a>
<a name="ln850">       OSPF6_STR</a>
<a name="ln851">       &quot;Neighbor list\n&quot;</a>
<a name="ln852">      )</a>
<a name="ln853">{</a>
<a name="ln854">  struct ospf6_neighbor *on;</a>
<a name="ln855">  struct ospf6_interface *oi;</a>
<a name="ln856">  struct ospf6_area *oa;</a>
<a name="ln857">  struct listnode *i, *j, *k;</a>
<a name="ln858">  void (*showfunc) (struct vty *, struct ospf6_neighbor *);</a>
<a name="ln859"> </a>
<a name="ln860">  OSPF6_CMD_CHECK_RUNNING ();</a>
<a name="ln861">  showfunc = ospf6_neighbor_show;</a>
<a name="ln862"> </a>
<a name="ln863">  if (argc)</a>
<a name="ln864">    {</a>
<a name="ln865">      if (! strncmp (argv[0], &quot;de&quot;, 2))</a>
<a name="ln866">        showfunc = ospf6_neighbor_show_detail;</a>
<a name="ln867">      else if (! strncmp (argv[0], &quot;dr&quot;, 2))</a>
<a name="ln868">        showfunc = ospf6_neighbor_show_drchoice;</a>
<a name="ln869">    }</a>
<a name="ln870"> </a>
<a name="ln871">  if (showfunc == ospf6_neighbor_show)</a>
<a name="ln872">    vty_out (vty, &quot;%-15s %3s %11s %6s/%-12s %11s %s[%s]%s&quot;,</a>
<a name="ln873">             &quot;Neighbor ID&quot;, &quot;Pri&quot;, &quot;DeadTime&quot;, &quot;State&quot;, &quot;IfState&quot;, &quot;Duration&quot;,</a>
<a name="ln874">             &quot;I/F&quot;, &quot;State&quot;, VNL);</a>
<a name="ln875">  else if (showfunc == ospf6_neighbor_show_drchoice)</a>
<a name="ln876">    vty_out (vty, &quot;%-15s %6s/%-11s %-15s %-15s %s[%s]%s&quot;,</a>
<a name="ln877">             &quot;RouterID&quot;, &quot;State&quot;, &quot;Duration&quot;, &quot;DR&quot;, &quot;BDR&quot;, &quot;I/F&quot;,</a>
<a name="ln878">             &quot;State&quot;, VNL);</a>
<a name="ln879"> </a>
<a name="ln880">  for (ALL_LIST_ELEMENTS_RO (ospf6-&gt;area_list, i, oa))</a>
<a name="ln881">    for (ALL_LIST_ELEMENTS_RO (oa-&gt;if_list, j, oi))</a>
<a name="ln882">      for (ALL_LIST_ELEMENTS_RO (oi-&gt;neighbor_list, k, on))</a>
<a name="ln883">        (*showfunc) (vty, on);</a>
<a name="ln884"> </a>
<a name="ln885">  return CMD_SUCCESS;</a>
<a name="ln886">}</a>
<a name="ln887"> </a>
<a name="ln888">ALIAS (show_ipv6_ospf6_neighbor,</a>
<a name="ln889">       show_ipv6_ospf6_neighbor_detail_cmd,</a>
<a name="ln890">       &quot;show ipv6 ospf6 neighbor (detail|drchoice)&quot;,</a>
<a name="ln891">       SHOW_STR</a>
<a name="ln892">       IP6_STR</a>
<a name="ln893">       OSPF6_STR</a>
<a name="ln894">       &quot;Neighbor list\n&quot;</a>
<a name="ln895">       &quot;Display details\n&quot;</a>
<a name="ln896">       &quot;Display DR choices\n&quot;</a>
<a name="ln897">      )</a>
<a name="ln898"> </a>
<a name="ln899">DEFUN (show_ipv6_ospf6_neighbor_one,</a>
<a name="ln900">       show_ipv6_ospf6_neighbor_one_cmd,</a>
<a name="ln901">       &quot;show ipv6 ospf6 neighbor A.B.C.D&quot;,</a>
<a name="ln902">       SHOW_STR</a>
<a name="ln903">       IP6_STR</a>
<a name="ln904">       OSPF6_STR</a>
<a name="ln905">       &quot;Neighbor list\n&quot;</a>
<a name="ln906">       &quot;Specify Router-ID as IPv4 address notation\n&quot;</a>
<a name="ln907">      )</a>
<a name="ln908">{</a>
<a name="ln909">  struct ospf6_neighbor *on;</a>
<a name="ln910">  struct ospf6_interface *oi;</a>
<a name="ln911">  struct ospf6_area *oa;</a>
<a name="ln912">  struct listnode *i, *j, *k;</a>
<a name="ln913">  void (*showfunc) (struct vty *, struct ospf6_neighbor *);</a>
<a name="ln914">  u_int32_t router_id;</a>
<a name="ln915"> </a>
<a name="ln916">  OSPF6_CMD_CHECK_RUNNING ();</a>
<a name="ln917">  showfunc = ospf6_neighbor_show_detail;</a>
<a name="ln918"> </a>
<a name="ln919">  if ((inet_pton (AF_INET, argv[0], &amp;router_id)) != 1)</a>
<a name="ln920">    {</a>
<a name="ln921">      vty_out (vty, &quot;Router-ID is not parsable: %s%s&quot;, argv[0],</a>
<a name="ln922">               VNL);</a>
<a name="ln923">      return CMD_SUCCESS;</a>
<a name="ln924">    }</a>
<a name="ln925"> </a>
<a name="ln926">  for (ALL_LIST_ELEMENTS_RO (ospf6-&gt;area_list, i, oa))</a>
<a name="ln927">    for (ALL_LIST_ELEMENTS_RO (oa-&gt;if_list, j, oi))</a>
<a name="ln928">      for (ALL_LIST_ELEMENTS_RO (oi-&gt;neighbor_list, k, on))</a>
<a name="ln929">        (*showfunc) (vty, on);</a>
<a name="ln930">  </a>
<a name="ln931">  return CMD_SUCCESS;</a>
<a name="ln932">}</a>
<a name="ln933"> </a>
<a name="ln934">void</a>
<a name="ln935">ospf6_neighbor_init (void)</a>
<a name="ln936">{</a>
<a name="ln937">  install_element (VIEW_NODE, &amp;show_ipv6_ospf6_neighbor_cmd);</a>
<a name="ln938">  install_element (VIEW_NODE, &amp;show_ipv6_ospf6_neighbor_detail_cmd);</a>
<a name="ln939">}</a>
<a name="ln940"> </a>
<a name="ln941">DEFUN (debug_ospf6_neighbor,</a>
<a name="ln942">       debug_ospf6_neighbor_cmd,</a>
<a name="ln943">       &quot;debug ospf6 neighbor&quot;,</a>
<a name="ln944">       DEBUG_STR</a>
<a name="ln945">       OSPF6_STR</a>
<a name="ln946">       &quot;Debug OSPFv3 Neighbor\n&quot;</a>
<a name="ln947">      )</a>
<a name="ln948">{</a>
<a name="ln949">  unsigned char level = 0;</a>
<a name="ln950">  if (argc)</a>
<a name="ln951">    {</a>
<a name="ln952">      if (! strncmp (argv[0], &quot;s&quot;, 1))</a>
<a name="ln953">        level = OSPF6_DEBUG_NEIGHBOR_STATE;</a>
<a name="ln954">      if (! strncmp (argv[0], &quot;e&quot;, 1))</a>
<a name="ln955">        level = OSPF6_DEBUG_NEIGHBOR_EVENT;</a>
<a name="ln956">    }</a>
<a name="ln957">  else</a>
<a name="ln958">    level = OSPF6_DEBUG_NEIGHBOR_STATE | OSPF6_DEBUG_NEIGHBOR_EVENT;</a>
<a name="ln959"> </a>
<a name="ln960">  OSPF6_DEBUG_NEIGHBOR_ON (level);</a>
<a name="ln961">  return CMD_SUCCESS;</a>
<a name="ln962">}</a>
<a name="ln963"> </a>
<a name="ln964">ALIAS (debug_ospf6_neighbor,</a>
<a name="ln965">       debug_ospf6_neighbor_detail_cmd,</a>
<a name="ln966">       &quot;debug ospf6 neighbor (state|event)&quot;,</a>
<a name="ln967">       DEBUG_STR</a>
<a name="ln968">       OSPF6_STR</a>
<a name="ln969">       &quot;Debug OSPFv3 Neighbor\n&quot;</a>
<a name="ln970">       &quot;Debug OSPFv3 Neighbor State Change\n&quot;</a>
<a name="ln971">       &quot;Debug OSPFv3 Neighbor Event\n&quot;</a>
<a name="ln972">      )</a>
<a name="ln973"> </a>
<a name="ln974">DEFUN (no_debug_ospf6_neighbor,</a>
<a name="ln975">       no_debug_ospf6_neighbor_cmd,</a>
<a name="ln976">       &quot;no debug ospf6 neighbor&quot;,</a>
<a name="ln977">       NO_STR</a>
<a name="ln978">       DEBUG_STR</a>
<a name="ln979">       OSPF6_STR</a>
<a name="ln980">       &quot;Debug OSPFv3 Neighbor\n&quot;</a>
<a name="ln981">      )</a>
<a name="ln982">{</a>
<a name="ln983">  unsigned char level = 0;</a>
<a name="ln984">  if (argc)</a>
<a name="ln985">    {</a>
<a name="ln986">      if (! strncmp (argv[0], &quot;s&quot;, 1))</a>
<a name="ln987">        level = OSPF6_DEBUG_NEIGHBOR_STATE;</a>
<a name="ln988">      if (! strncmp (argv[0], &quot;e&quot;, 1))</a>
<a name="ln989">        level = OSPF6_DEBUG_NEIGHBOR_EVENT;</a>
<a name="ln990">    }</a>
<a name="ln991">  else</a>
<a name="ln992">    level = OSPF6_DEBUG_NEIGHBOR_STATE | OSPF6_DEBUG_NEIGHBOR_EVENT;</a>
<a name="ln993"> </a>
<a name="ln994">  OSPF6_DEBUG_NEIGHBOR_OFF (level);</a>
<a name="ln995">  return CMD_SUCCESS;</a>
<a name="ln996">}</a>
<a name="ln997"> </a>
<a name="ln998">ALIAS (no_debug_ospf6_neighbor,</a>
<a name="ln999">       no_debug_ospf6_neighbor_detail_cmd,</a>
<a name="ln1000">       &quot;no debug ospf6 neighbor (state|event)&quot;,</a>
<a name="ln1001">       NO_STR</a>
<a name="ln1002">       DEBUG_STR</a>
<a name="ln1003">       OSPF6_STR</a>
<a name="ln1004">       &quot;Debug OSPFv3 Neighbor\n&quot;</a>
<a name="ln1005">       &quot;Debug OSPFv3 Neighbor State Change\n&quot;</a>
<a name="ln1006">       &quot;Debug OSPFv3 Neighbor Event\n&quot;</a>
<a name="ln1007">      )</a>
<a name="ln1008"> </a>
<a name="ln1009">int</a>
<a name="ln1010">config_write_ospf6_debug_neighbor (struct vty *vty)</a>
<a name="ln1011">{</a>
<a name="ln1012">  if (IS_OSPF6_DEBUG_NEIGHBOR (STATE) &amp;&amp;</a>
<a name="ln1013">      IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln1014">    vty_out (vty, &quot;debug ospf6 neighbor%s&quot;, VNL);</a>
<a name="ln1015">  else if (IS_OSPF6_DEBUG_NEIGHBOR (STATE))</a>
<a name="ln1016">    vty_out (vty, &quot;debug ospf6 neighbor state%s&quot;, VNL);</a>
<a name="ln1017">  else if (IS_OSPF6_DEBUG_NEIGHBOR (EVENT))</a>
<a name="ln1018">    vty_out (vty, &quot;debug ospf6 neighbor event%s&quot;, VNL);</a>
<a name="ln1019">  return 0;</a>
<a name="ln1020">}</a>
<a name="ln1021"> </a>
<a name="ln1022">void</a>
<a name="ln1023">install_element_ospf6_debug_neighbor (void)</a>
<a name="ln1024">{</a>
<a name="ln1025">  install_element (ENABLE_NODE, &amp;debug_ospf6_neighbor_cmd);</a>
<a name="ln1026">  install_element (ENABLE_NODE, &amp;debug_ospf6_neighbor_detail_cmd);</a>
<a name="ln1027">  install_element (ENABLE_NODE, &amp;no_debug_ospf6_neighbor_cmd);</a>
<a name="ln1028">  install_element (ENABLE_NODE, &amp;no_debug_ospf6_neighbor_detail_cmd);</a>
<a name="ln1029">  install_element (CONFIG_NODE, &amp;debug_ospf6_neighbor_cmd);</a>
<a name="ln1030">  install_element (CONFIG_NODE, &amp;debug_ospf6_neighbor_detail_cmd);</a>
<a name="ln1031">  install_element (CONFIG_NODE, &amp;no_debug_ospf6_neighbor_cmd);</a>
<a name="ln1032">  install_element (CONFIG_NODE, &amp;no_debug_ospf6_neighbor_detail_cmd);</a>
<a name="ln1033">}</a>
<a name="ln1034"> </a>
<a name="ln1035"> </a>
<a name="ln1036"> </a>

</code></pre>
<div class="balloon" rel="7"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
