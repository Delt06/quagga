
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ripng_zebra.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * RIPngd and zebra interface.</a>
<a name="ln3"> * Copyright (C) 1998, 1999 Kunihiro Ishiguro</a>
<a name="ln4"> *</a>
<a name="ln5"> * This file is part of GNU Zebra.</a>
<a name="ln6"> *</a>
<a name="ln7"> * GNU Zebra is free software; you can redistribute it and/or modify it</a>
<a name="ln8"> * under the terms of the GNU General Public License as published by the</a>
<a name="ln9"> * Free Software Foundation; either version 2, or (at your option) any</a>
<a name="ln10"> * later version.</a>
<a name="ln11"> *</a>
<a name="ln12"> * GNU Zebra is distributed in the hope that it will be useful, but</a>
<a name="ln13"> * WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln14"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln15"> * General Public License for more details.</a>
<a name="ln16"> *</a>
<a name="ln17"> * You should have received a copy of the GNU General Public License</a>
<a name="ln18"> * along with GNU Zebra; see the file COPYING.  If not, write to the Free</a>
<a name="ln19"> * Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</a>
<a name="ln20"> * 02111-1307, USA.  </a>
<a name="ln21"> */</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;zebra.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &quot;command.h&quot;</a>
<a name="ln26">#include &quot;prefix.h&quot;</a>
<a name="ln27">#include &quot;table.h&quot;</a>
<a name="ln28">#include &quot;stream.h&quot;</a>
<a name="ln29">#include &quot;memory.h&quot;</a>
<a name="ln30">#include &quot;routemap.h&quot;</a>
<a name="ln31">#include &quot;zclient.h&quot;</a>
<a name="ln32">#include &quot;log.h&quot;</a>
<a name="ln33"> </a>
<a name="ln34">#include &quot;ripngd/ripngd.h&quot;</a>
<a name="ln35">#include &quot;ripngd/ripng_debug.h&quot;</a>
<a name="ln36"> </a>
<a name="ln37">/* All information about zebra. */</a>
<a name="ln38">struct zclient *zclient = NULL;</a>
<a name="ln39"> </a>
<a name="ln40">/* Send ECMP routes to zebra. */</a>
<a name="ln41">static void</a>
<a name="ln42">ripng_zebra_ipv6_send (struct route_node *rp, u_char cmd)</a>
<a name="ln43">{</a>
<a name="ln44">  static struct in6_addr **nexthops = NULL;</a>
<a name="ln45">  static ifindex_t *ifindexes = NULL;</a>
<a name="ln46">  static unsigned int nexthops_len = 0;</a>
<a name="ln47"> </a>
<a name="ln48">  struct list *list = (struct list *)rp-&gt;info;</a>
<a name="ln49">  struct zapi_ipv6 api;</a>
<a name="ln50">  struct listnode *listnode = NULL;</a>
<a name="ln51">  struct ripng_info *rinfo = NULL;</a>
<a name="ln52">  int count = 0;</a>
<a name="ln53"> </a>
<a name="ln54">  if (vrf_bitmap_check (zclient-&gt;redist[ZEBRA_ROUTE_RIPNG], VRF_DEFAULT))</a>
<a name="ln55">    {</a>
<a name="ln56">      api.vrf_id = VRF_DEFAULT;</a>
<a name="ln57">      api.type = ZEBRA_ROUTE_RIPNG;</a>
<a name="ln58">      api.flags = 0;</a>
<a name="ln59">      api.message = 0;</a>
<a name="ln60">      api.safi = SAFI_UNICAST;</a>
<a name="ln61"> </a>
<a name="ln62">      if (nexthops_len &lt; listcount (list))</a>
<a name="ln63">        {</a>
<a name="ln64">          nexthops_len = listcount (list);</a>
<a name="ln65">          nexthops = XREALLOC (MTYPE_TMP, nexthops,</a>
<a name="ln66">                               nexthops_len * sizeof (struct in6_addr *));</a>
<a name="ln67">          ifindexes = XREALLOC (MTYPE_TMP, ifindexes,</a>
<a name="ln68">                                nexthops_len * sizeof (unsigned int));</a>
<a name="ln69">        }</a>
<a name="ln70"> </a>
<a name="ln71">      SET_FLAG (api.message, ZAPI_MESSAGE_NEXTHOP);</a>
<a name="ln72">      SET_FLAG (api.message, ZAPI_MESSAGE_IFINDEX);</a>
<a name="ln73">      for (ALL_LIST_ELEMENTS_RO (list, listnode, rinfo))</a>
<a name="ln74">        {</a>
<a name="ln75">          nexthops[count] = &amp;rinfo-&gt;nexthop;</a>
<a name="ln76">          ifindexes[count] = rinfo-&gt;ifindex;</a>
<a name="ln77">          count++;</a>
<a name="ln78">          if (cmd == ZEBRA_IPV6_ROUTE_ADD)</a>
<a name="ln79">            SET_FLAG (rinfo-&gt;flags, RIPNG_RTF_FIB);</a>
<a name="ln80">          else</a>
<a name="ln81">            UNSET_FLAG (rinfo-&gt;flags, RIPNG_RTF_FIB);</a>
<a name="ln82">        }</a>
<a name="ln83"> </a>
<a name="ln84">      api.nexthop = nexthops;</a>
<a name="ln85">      api.nexthop_num = count;</a>
<a name="ln86">      api.ifindex = ifindexes;</a>
<a name="ln87">      api.ifindex_num = count;</a>
<a name="ln88"> </a>
<a name="ln89">      rinfo = listgetdata (listhead (list));</a>
<a name="ln90"> </a>
<a name="ln91">      SET_FLAG (api.message, ZAPI_MESSAGE_METRIC);</a>
<a name="ln92">      api.metric = rinfo-&gt;metric;</a>
<a name="ln93"> </a>
<a name="ln94">      if (rinfo-&gt;tag)</a>
<a name="ln95">        {</a>
<a name="ln96">          SET_FLAG (api.message, ZAPI_MESSAGE_TAG);</a>
<a name="ln97">          api.tag = rinfo-&gt;tag;</a>
<a name="ln98">        }</a>
<a name="ln99"> </a>
<a name="ln100">      zapi_ipv6_route (cmd, zclient,</a>
<a name="ln101">                       (struct prefix_ipv6 *)&amp;rp-&gt;p, &amp;api);</a>
<a name="ln102"> </a>
<a name="ln103">      if (IS_RIPNG_DEBUG_ZEBRA)</a>
<a name="ln104">        {</a>
<a name="ln105">          if (ripng-&gt;ecmp)</a>
<a name="ln106">            zlog_debug (&quot;%s: %s/%d nexthops %d&quot;,</a>
<a name="ln107">                        (cmd == ZEBRA_IPV6_ROUTE_ADD) ? \</a>
<a name="ln108">                            &quot;Install into zebra&quot; : &quot;Delete from zebra&quot;,</a>
<a name="ln109">                        inet6_ntoa (rp-&gt;p.u.prefix6), rp-&gt;p.prefixlen, count);</a>
<a name="ln110">          else</a>
<a name="ln111">            zlog_debug (&quot;%s: %s/%d&quot;,</a>
<a name="ln112">                        (cmd == ZEBRA_IPV6_ROUTE_ADD) ? \</a>
<a name="ln113">                            &quot;Install into zebra&quot; : &quot;Delete from zebra&quot;,</a>
<a name="ln114">                        inet6_ntoa (rp-&gt;p.u.prefix6), rp-&gt;p.prefixlen);</a>
<a name="ln115">        }</a>
<a name="ln116">    }</a>
<a name="ln117">}</a>
<a name="ln118"> </a>
<a name="ln119">/* Add/update ECMP routes to zebra. */</a>
<a name="ln120">void</a>
<a name="ln121">ripng_zebra_ipv6_add (struct route_node *rp)</a>
<a name="ln122">{</a>
<a name="ln123">  ripng_zebra_ipv6_send (rp, ZEBRA_IPV6_ROUTE_ADD);</a>
<a name="ln124">}</a>
<a name="ln125"> </a>
<a name="ln126">/* Delete ECMP routes from zebra. */</a>
<a name="ln127">void</a>
<a name="ln128">ripng_zebra_ipv6_delete (struct route_node *rp)</a>
<a name="ln129">{</a>
<a name="ln130">  ripng_zebra_ipv6_send (rp, ZEBRA_IPV6_ROUTE_DELETE);</a>
<a name="ln131">}</a>
<a name="ln132"> </a>
<a name="ln133">/* Zebra route add and delete treatment. */</a>
<a name="ln134">static int</a>
<a name="ln135">ripng_zebra_read_ipv6 (int command, struct zclient *zclient,</a>
<a name="ln136">		       zebra_size_t length, vrf_id_t vrf_id)</a>
<a name="ln137">{</a>
<a name="ln138">  struct stream *s;</a>
<a name="ln139">  struct zapi_ipv6 api;</a>
<a name="ln140">  unsigned long ifindex;</a>
<a name="ln141">  struct in6_addr nexthop;</a>
<a name="ln142">  struct prefix_ipv6 p;</a>
<a name="ln143">  unsigned char plength = 0;</a>
<a name="ln144"> </a>
<a name="ln145">  s = zclient-&gt;ibuf;</a>
<a name="ln146">  ifindex = 0;</a>
<a name="ln147">  memset (&amp;nexthop, 0, sizeof (struct in6_addr));</a>
<a name="ln148"> </a>
<a name="ln149">  /* Type, flags, message. */</a>
<a name="ln150">  api.type = stream_getc (s);</a>
<a name="ln151">  api.flags = stream_getc (s);</a>
<a name="ln152">  api.message = stream_getc (s);</a>
<a name="ln153"> </a>
<a name="ln154">  /* IPv6 prefix. */</a>
<a name="ln155">  memset (&amp;p, 0, sizeof (struct prefix_ipv6));</a>
<a name="ln156">  p.family = AF_INET6;</a>
<a name="ln157">  plength = stream_getc (s);</a>
<a name="ln158">  p.prefixlen = MIN(IPV6_MAX_PREFIXLEN, plength);</a>
<a name="ln159">  stream_get (&amp;p.prefix, s, PSIZE (p.prefixlen));</a>
<a name="ln160"> </a>
<a name="ln161">  /* Nexthop, ifindex, distance, metric. */</a>
<a name="ln162">  if (CHECK_FLAG (api.message, ZAPI_MESSAGE_NEXTHOP))</a>
<a name="ln163">    {</a>
<a name="ln164">      api.nexthop_num = stream_getc (s);</a>
<a name="ln165">      stream_get (&amp;nexthop, s, 16);</a>
<a name="ln166">    }</a>
<a name="ln167">  if (CHECK_FLAG (api.message, ZAPI_MESSAGE_IFINDEX))</a>
<a name="ln168">    {</a>
<a name="ln169">      api.ifindex_num = stream_getc (s);</a>
<a name="ln170">      ifindex = stream_getl (s);</a>
<a name="ln171">    }</a>
<a name="ln172">  if (CHECK_FLAG (api.message, ZAPI_MESSAGE_DISTANCE))</a>
<a name="ln173">    api.distance = stream_getc (s);</a>
<a name="ln174">  else</a>
<a name="ln175">    api.distance = 0;</a>
<a name="ln176">  if (CHECK_FLAG (api.message, ZAPI_MESSAGE_METRIC))</a>
<a name="ln177">    api.metric = stream_getl (s);</a>
<a name="ln178">  else</a>
<a name="ln179">    api.metric = 0;</a>
<a name="ln180"> </a>
<a name="ln181">  if (CHECK_FLAG (api.message, ZAPI_MESSAGE_TAG))</a>
<a name="ln182">    api.tag = stream_getl (s);</a>
<a name="ln183">  else</a>
<a name="ln184">    api.tag = 0;</a>
<a name="ln185"> </a>
<a name="ln186">  if (command == ZEBRA_IPV6_ROUTE_ADD)</a>
<a name="ln187">    ripng_redistribute_add (api.type, RIPNG_ROUTE_REDISTRIBUTE, &amp;p,</a>
<a name="ln188">                            ifindex, &amp;nexthop, api.tag);</a>
<a name="ln189">  else</a>
<a name="ln190">    ripng_redistribute_delete (api.type, RIPNG_ROUTE_REDISTRIBUTE, &amp;p, ifindex);</a>
<a name="ln191"> </a>
<a name="ln192">  return 0;</a>
<a name="ln193">}</a>
<a name="ln194"> </a>
<a name="ln195">void</a>
<a name="ln196">ripng_zclient_reset (void)</a>
<a name="ln197">{</a>
<a name="ln198">  zclient_reset (zclient);</a>
<a name="ln199">}</a>
<a name="ln200"> </a>
<a name="ln201">static int</a>
<a name="ln202">ripng_redistribute_unset (int type)</a>
<a name="ln203">{</a>
<a name="ln204">  if (! vrf_bitmap_check (zclient-&gt;redist[type], VRF_DEFAULT))</a>
<a name="ln205">    return CMD_SUCCESS;</a>
<a name="ln206"> </a>
<a name="ln207">  vrf_bitmap_set (zclient-&gt;redist[type], VRF_DEFAULT);</a>
<a name="ln208"> </a>
<a name="ln209">  if (zclient-&gt;sock &gt; 0)</a>
<a name="ln210">    zebra_redistribute_send (ZEBRA_REDISTRIBUTE_DELETE, zclient, type,</a>
<a name="ln211">                             VRF_DEFAULT);</a>
<a name="ln212"> </a>
<a name="ln213">  ripng_redistribute_withdraw (type);</a>
<a name="ln214">  </a>
<a name="ln215">  return CMD_SUCCESS;</a>
<a name="ln216">}</a>
<a name="ln217"> </a>
<a name="ln218">int</a>
<a name="ln219">ripng_redistribute_check (int type)</a>
<a name="ln220">{</a>
<a name="ln221">  return vrf_bitmap_check (zclient-&gt;redist[type], VRF_DEFAULT);</a>
<a name="ln222">}</a>
<a name="ln223"> </a>
<a name="ln224">static void</a>
<a name="ln225">ripng_redistribute_metric_set (int type, int metric)</a>
<a name="ln226">{</a>
<a name="ln227">  ripng-&gt;route_map[type].metric_config = 1;</a>
<a name="ln228">  ripng-&gt;route_map[type].metric = metric;</a>
<a name="ln229">}</a>
<a name="ln230"> </a>
<a name="ln231">static int</a>
<a name="ln232">ripng_redistribute_metric_unset (int type)</a>
<a name="ln233">{</a>
<a name="ln234">  ripng-&gt;route_map[type].metric_config = 0;</a>
<a name="ln235">  ripng-&gt;route_map[type].metric = 0;</a>
<a name="ln236">  return 0;</a>
<a name="ln237">}</a>
<a name="ln238"> </a>
<a name="ln239">static void</a>
<a name="ln240">ripng_redistribute_routemap_set (int type, const char *name)</a>
<a name="ln241">{</a>
<a name="ln242">  if (ripng-&gt;route_map[type].name)</a>
<a name="ln243">    free (ripng-&gt;route_map[type].name);</a>
<a name="ln244"> </a>
<a name="ln245">  ripng-&gt;route_map[type].name = strdup (name);</a>
<a name="ln246">  ripng-&gt;route_map[type].map = route_map_lookup_by_name (name);</a>
<a name="ln247">}</a>
<a name="ln248"> </a>
<a name="ln249">static void</a>
<a name="ln250">ripng_redistribute_routemap_unset (int type)</a>
<a name="ln251">{</a>
<a name="ln252">  if (ripng-&gt;route_map[type].name)</a>
<a name="ln253">    free (ripng-&gt;route_map[type].name);</a>
<a name="ln254"> </a>
<a name="ln255">  ripng-&gt;route_map[type].name = NULL;</a>
<a name="ln256">  ripng-&gt;route_map[type].map = NULL;</a>
<a name="ln257">}</a>
<a name="ln258"> </a>
<a name="ln259">/* Redistribution types */</a>
<a name="ln260">static struct {</a>
<a name="ln261">  int type;</a>
<a name="ln262">  int str_min_len;</a>
<a name="ln263">  const char *str;</a>
<a name="ln264">} redist_type[] = {</a>
<a name="ln265">  {ZEBRA_ROUTE_KERNEL,  1, &quot;kernel&quot;},</a>
<a name="ln266">  {ZEBRA_ROUTE_CONNECT, 1, &quot;connected&quot;},</a>
<a name="ln267">  {ZEBRA_ROUTE_STATIC,  1, &quot;static&quot;},</a>
<a name="ln268">  {ZEBRA_ROUTE_OSPF6,   1, &quot;ospf6&quot;},</a>
<a name="ln269">  {ZEBRA_ROUTE_BGP,     2, &quot;bgp&quot;},</a>
<a name="ln270">  {ZEBRA_ROUTE_BABEL,   2, &quot;babel&quot;},</a>
<a name="ln271">  {0, 0, NULL}</a>
<a name="ln272">};</a>
<a name="ln273"> </a>
<a name="ln274">void</a>
<a name="ln275">ripng_redistribute_clean ()</a>
<a name="ln276">{</a>
<a name="ln277">  int i;</a>
<a name="ln278"> </a>
<a name="ln279">  for (i = 0; redist_type[i].str; i++)</a>
<a name="ln280">    {</a>
<a name="ln281">      if (vrf_bitmap_check (zclient-&gt;redist[redist_type[i].type], VRF_DEFAULT))</a>
<a name="ln282">        {</a>
<a name="ln283">          if (zclient-&gt;sock &gt; 0)</a>
<a name="ln284">            zebra_redistribute_send (ZEBRA_REDISTRIBUTE_DELETE,</a>
<a name="ln285">                                     zclient, redist_type[i].type,</a>
<a name="ln286">                                     VRF_DEFAULT);</a>
<a name="ln287"> </a>
<a name="ln288">          vrf_bitmap_unset (zclient-&gt;redist[redist_type[i].type], VRF_DEFAULT);</a>
<a name="ln289"> </a>
<a name="ln290">          /* Remove the routes from RIPng table. */</a>
<a name="ln291">          ripng_redistribute_withdraw (redist_type[i].type);</a>
<a name="ln292">        }</a>
<a name="ln293">    }</a>
<a name="ln294">}</a>
<a name="ln295"> </a>
<a name="ln296">DEFUN (router_zebra,</a>
<a name="ln297">       router_zebra_cmd,</a>
<a name="ln298">       &quot;router zebra&quot;,</a>
<a name="ln299">       &quot;Enable a routing process\n&quot;</a>
<a name="ln300">       &quot;Make connection to zebra daemon\n&quot;)</a>
<a name="ln301">{</a>
<a name="ln302">  vty-&gt;node = ZEBRA_NODE;</a>
<a name="ln303">  zclient-&gt;enable = 1;</a>
<a name="ln304">  zclient_start (zclient);</a>
<a name="ln305">  return CMD_SUCCESS;</a>
<a name="ln306">}</a>
<a name="ln307"> </a>
<a name="ln308">DEFUN (no_router_zebra,</a>
<a name="ln309">       no_router_zebra_cmd,</a>
<a name="ln310">       &quot;no router zebra&quot;,</a>
<a name="ln311">       NO_STR</a>
<a name="ln312">       &quot;Disable a routing process\n&quot;</a>
<a name="ln313">       &quot;Stop connection to zebra daemon\n&quot;)</a>
<a name="ln314">{</a>
<a name="ln315">  zclient-&gt;enable = 0;</a>
<a name="ln316">  zclient_stop (zclient);</a>
<a name="ln317">  return CMD_SUCCESS;</a>
<a name="ln318">}</a>
<a name="ln319"> </a>
<a name="ln320">DEFUN (ripng_redistribute_ripng,</a>
<a name="ln321">       ripng_redistribute_ripng_cmd,</a>
<a name="ln322">       &quot;redistribute ripng&quot;,</a>
<a name="ln323">       &quot;Redistribute information from another routing protocol\n&quot;</a>
<a name="ln324">       &quot;RIPng route\n&quot;)</a>
<a name="ln325">{</a>
<a name="ln326">  vrf_bitmap_set (zclient-&gt;redist[ZEBRA_ROUTE_RIPNG], VRF_DEFAULT);</a>
<a name="ln327">  return CMD_SUCCESS;</a>
<a name="ln328">}</a>
<a name="ln329"> </a>
<a name="ln330">DEFUN (no_ripng_redistribute_ripng,</a>
<a name="ln331">       no_ripng_redistribute_ripng_cmd,</a>
<a name="ln332">       &quot;no redistribute ripng&quot;,</a>
<a name="ln333">       NO_STR</a>
<a name="ln334">       &quot;Redistribute information from another routing protocol\n&quot;</a>
<a name="ln335">       &quot;RIPng route\n&quot;)</a>
<a name="ln336">{</a>
<a name="ln337">  vrf_bitmap_unset (zclient-&gt;redist[ZEBRA_ROUTE_RIPNG], VRF_DEFAULT);</a>
<a name="ln338">  return CMD_SUCCESS;</a>
<a name="ln339">}</a>
<a name="ln340"> </a>
<a name="ln341">DEFUN (ripng_redistribute_type,</a>
<a name="ln342">       ripng_redistribute_type_cmd,</a>
<a name="ln343">       &quot;redistribute &quot; QUAGGA_REDIST_STR_RIPNGD,</a>
<a name="ln344">       &quot;Redistribute\n&quot;</a>
<a name="ln345">       QUAGGA_REDIST_HELP_STR_RIPNGD)</a>
<a name="ln346">{</a>
<a name="ln347">  int type;</a>
<a name="ln348"> </a>
<a name="ln349">  type = proto_redistnum(AFI_IP6, argv[0]);</a>
<a name="ln350"> </a>
<a name="ln351">  if (type &lt; 0)</a>
<a name="ln352">    {</a>
<a name="ln353">      vty_out(vty, &quot;Invalid type %s%s&quot;, argv[0], VTY_NEWLINE);</a>
<a name="ln354">      return CMD_WARNING;</a>
<a name="ln355">    }</a>
<a name="ln356"> </a>
<a name="ln357">  zclient_redistribute (ZEBRA_REDISTRIBUTE_ADD, zclient, type, VRF_DEFAULT);</a>
<a name="ln358">  return CMD_SUCCESS;</a>
<a name="ln359">}</a>
<a name="ln360"> </a>
<a name="ln361">DEFUN (no_ripng_redistribute_type,</a>
<a name="ln362">       no_ripng_redistribute_type_cmd,</a>
<a name="ln363">       &quot;no redistribute &quot; QUAGGA_REDIST_STR_RIPNGD,</a>
<a name="ln364">       NO_STR</a>
<a name="ln365">       &quot;Redistribute\n&quot;</a>
<a name="ln366">       QUAGGA_REDIST_HELP_STR_RIPNGD)</a>
<a name="ln367">{</a>
<a name="ln368">  int type;</a>
<a name="ln369"> </a>
<a name="ln370">  type = proto_redistnum(AFI_IP6, argv[0]);</a>
<a name="ln371"> </a>
<a name="ln372">  if (type &lt; 0)</a>
<a name="ln373">    {</a>
<a name="ln374">      vty_out(vty, &quot;Invalid type %s%s&quot;, argv[0], VTY_NEWLINE);</a>
<a name="ln375">      return CMD_WARNING;</a>
<a name="ln376">    }</a>
<a name="ln377"> </a>
<a name="ln378">  ripng_redistribute_metric_unset (type);</a>
<a name="ln379">  ripng_redistribute_routemap_unset (type);</a>
<a name="ln380">  return ripng_redistribute_unset (type);</a>
<a name="ln381">}</a>
<a name="ln382"> </a>
<a name="ln383"> </a>
<a name="ln384">DEFUN (ripng_redistribute_type_metric,</a>
<a name="ln385">       ripng_redistribute_type_metric_cmd,</a>
<a name="ln386">       &quot;redistribute &quot; QUAGGA_REDIST_STR_RIPNGD &quot; metric &lt;0-16&gt;&quot;,</a>
<a name="ln387">       &quot;Redistribute\n&quot;</a>
<a name="ln388">       QUAGGA_REDIST_HELP_STR_RIPNGD</a>
<a name="ln389">       &quot;Metric\n&quot;</a>
<a name="ln390">       &quot;Metric value\n&quot;)</a>
<a name="ln391">{</a>
<a name="ln392">  int type;</a>
<a name="ln393">  int metric;</a>
<a name="ln394"> </a>
<a name="ln395">  metric = atoi (argv[1]);</a>
<a name="ln396">  type = proto_redistnum(AFI_IP6, argv[0]);</a>
<a name="ln397"> </a>
<a name="ln398">  if (type &lt; 0)</a>
<a name="ln399">    {</a>
<a name="ln400">      vty_out(vty, &quot;Invalid type %s%s&quot;, argv[0], VTY_NEWLINE);</a>
<a name="ln401">      return CMD_WARNING;</a>
<a name="ln402">    }</a>
<a name="ln403"> </a>
<a name="ln404">  ripng_redistribute_metric_set (type, metric);</a>
<a name="ln405">  zclient_redistribute (ZEBRA_REDISTRIBUTE_ADD, zclient, type, VRF_DEFAULT);</a>
<a name="ln406">  return CMD_SUCCESS;</a>
<a name="ln407">}</a>
<a name="ln408"> </a>
<a name="ln409">ALIAS (no_ripng_redistribute_type,</a>
<a name="ln410">       no_ripng_redistribute_type_metric_cmd,</a>
<a name="ln411">       &quot;no redistribute &quot; QUAGGA_REDIST_STR_RIPNGD &quot; metric &lt;0-16&gt;&quot;,</a>
<a name="ln412">       NO_STR</a>
<a name="ln413">       &quot;Redistribute\n&quot;</a>
<a name="ln414">       QUAGGA_REDIST_HELP_STR_RIPNGD</a>
<a name="ln415">       &quot;Metric\n&quot;</a>
<a name="ln416">       &quot;Metric value\n&quot;)</a>
<a name="ln417"> </a>
<a name="ln418">DEFUN (ripng_redistribute_type_routemap,</a>
<a name="ln419">       ripng_redistribute_type_routemap_cmd,</a>
<a name="ln420">       &quot;redistribute &quot; QUAGGA_REDIST_STR_RIPNGD &quot; route-map WORD&quot;,</a>
<a name="ln421">       &quot;Redistribute\n&quot;</a>
<a name="ln422">       QUAGGA_REDIST_HELP_STR_RIPNGD</a>
<a name="ln423">       &quot;Route map reference\n&quot;</a>
<a name="ln424">       &quot;Pointer to route-map entries\n&quot;)</a>
<a name="ln425">{</a>
<a name="ln426">  int type;</a>
<a name="ln427"> </a>
<a name="ln428">  type = proto_redistnum(AFI_IP6, argv[0]);</a>
<a name="ln429"> </a>
<a name="ln430">  if (type &lt; 0)</a>
<a name="ln431">    {</a>
<a name="ln432">      vty_out(vty, &quot;Invalid type %s%s&quot;, argv[0], VTY_NEWLINE);</a>
<a name="ln433">      return CMD_WARNING;</a>
<a name="ln434">    }</a>
<a name="ln435"> </a>
<a name="ln436">  ripng_redistribute_routemap_set (type, argv[1]);</a>
<a name="ln437">  zclient_redistribute (ZEBRA_REDISTRIBUTE_ADD, zclient, type, VRF_DEFAULT);</a>
<a name="ln438"> return CMD_SUCCESS;</a>
<a name="ln439">}</a>
<a name="ln440"> </a>
<a name="ln441">ALIAS (no_ripng_redistribute_type,</a>
<a name="ln442">       no_ripng_redistribute_type_routemap_cmd,</a>
<a name="ln443">       &quot;no redistribute &quot; QUAGGA_REDIST_STR_RIPNGD &quot; route-map WORD&quot;,</a>
<a name="ln444">       NO_STR</a>
<a name="ln445">       &quot;Redistribute\n&quot;</a>
<a name="ln446">       QUAGGA_REDIST_HELP_STR_RIPNGD</a>
<a name="ln447">       &quot;Route map reference\n&quot;</a>
<a name="ln448">       &quot;Pointer to route-map entries\n&quot;)</a>
<a name="ln449"> </a>
<a name="ln450">DEFUN (ripng_redistribute_type_metric_routemap,</a>
<a name="ln451">       ripng_redistribute_type_metric_routemap_cmd,</a>
<a name="ln452">       &quot;redistribute &quot; QUAGGA_REDIST_STR_RIPNGD &quot; metric &lt;0-16&gt; route-map WORD&quot;,</a>
<a name="ln453">       &quot;Redistribute\n&quot;</a>
<a name="ln454">       QUAGGA_REDIST_HELP_STR_RIPNGD</a>
<a name="ln455">       &quot;Metric\n&quot;</a>
<a name="ln456">       &quot;Metric value\n&quot;</a>
<a name="ln457">       &quot;Route map reference\n&quot;</a>
<a name="ln458">       &quot;Pointer to route-map entries\n&quot;)</a>
<a name="ln459">{</a>
<a name="ln460">  int type;</a>
<a name="ln461">  int metric;</a>
<a name="ln462"> </a>
<a name="ln463">  type = proto_redistnum(AFI_IP6, argv[0]);</a>
<a name="ln464">  metric = atoi (argv[1]);</a>
<a name="ln465"> </a>
<a name="ln466">  if (type &lt; 0)</a>
<a name="ln467">    {</a>
<a name="ln468">      vty_out(vty, &quot;Invalid type %s%s&quot;, argv[0], VTY_NEWLINE);</a>
<a name="ln469">      return CMD_WARNING;</a>
<a name="ln470">    }</a>
<a name="ln471"> </a>
<a name="ln472">  ripng_redistribute_metric_set (type, metric);</a>
<a name="ln473">  ripng_redistribute_routemap_set (type, argv[2]);</a>
<a name="ln474">  zclient_redistribute (ZEBRA_REDISTRIBUTE_ADD, zclient, type, VRF_DEFAULT);</a>
<a name="ln475">  return CMD_SUCCESS;</a>
<a name="ln476">}</a>
<a name="ln477"> </a>
<a name="ln478">ALIAS (no_ripng_redistribute_type,</a>
<a name="ln479">       no_ripng_redistribute_type_metric_routemap_cmd,</a>
<a name="ln480">       &quot;no redistribute &quot; QUAGGA_REDIST_STR_RIPNGD &quot; metric &lt;0-16&gt; route-map WORD&quot;,</a>
<a name="ln481">       NO_STR</a>
<a name="ln482">       &quot;Redistribute\n&quot;</a>
<a name="ln483">       QUAGGA_REDIST_HELP_STR_RIPNGD</a>
<a name="ln484">       &quot;Route map reference\n&quot;</a>
<a name="ln485">       &quot;Pointer to route-map entries\n&quot;)</a>
<a name="ln486"> </a>
<a name="ln487">void</a>
<a name="ln488">ripng_redistribute_write (struct vty *vty, int config_mode)</a>
<a name="ln489">{</a>
<a name="ln490">  int i;</a>
<a name="ln491"> </a>
<a name="ln492">  for (i = 0; i &lt; ZEBRA_ROUTE_MAX; i++)</a>
<a name="ln493">    if (i != zclient-&gt;redist_default &amp;&amp;</a>
<a name="ln494">        vrf_bitmap_check (zclient-&gt;redist[i], VRF_DEFAULT))</a>
<a name="ln495">      {</a>
<a name="ln496">      if (config_mode)</a>
<a name="ln497">	{</a>
<a name="ln498">	  if (ripng-&gt;route_map[i].metric_config)</a>
<a name="ln499">	    {</a>
<a name="ln500">	      if (ripng-&gt;route_map[i].name)</a>
<a name="ln501">		vty_out (vty, &quot; redistribute %s metric %d route-map %s%s&quot;,</a>
<a name="ln502">			 zebra_route_string(i), ripng-&gt;route_map[i].metric,</a>
<a name="ln503">			ripng-&gt;route_map[i].name, VTY_NEWLINE);</a>
<a name="ln504">	      else</a>
<a name="ln505">		vty_out (vty, &quot; redistribute %s metric %d%s&quot;,</a>
<a name="ln506">			zebra_route_string(i), ripng-&gt;route_map[i].metric,</a>
<a name="ln507">			VTY_NEWLINE);</a>
<a name="ln508">	    }</a>
<a name="ln509">	  else</a>
<a name="ln510">	    {</a>
<a name="ln511">	      if (ripng-&gt;route_map[i].name)</a>
<a name="ln512">		vty_out (vty, &quot; redistribute %s route-map %s%s&quot;,</a>
<a name="ln513">			 zebra_route_string(i), ripng-&gt;route_map[i].name,</a>
<a name="ln514">			 VTY_NEWLINE);</a>
<a name="ln515">	      else</a>
<a name="ln516">		vty_out (vty, &quot; redistribute %s%s&quot;, zebra_route_string(i),</a>
<a name="ln517">			 VTY_NEWLINE);</a>
<a name="ln518">	    }</a>
<a name="ln519">	}</a>
<a name="ln520">      else</a>
<a name="ln521">	vty_out (vty, &quot;    %s&quot;, zebra_route_string(i));</a>
<a name="ln522">      }</a>
<a name="ln523">}</a>
<a name="ln524"> </a>
<a name="ln525">/* RIPng configuration write function. */</a>
<a name="ln526">static int</a>
<a name="ln527">zebra_config_write (struct vty *vty)</a>
<a name="ln528">{</a>
<a name="ln529">  if (! zclient-&gt;enable)</a>
<a name="ln530">    {</a>
<a name="ln531">      vty_out (vty, &quot;no router zebra%s&quot;, VTY_NEWLINE);</a>
<a name="ln532">      return 1;</a>
<a name="ln533">    }</a>
<a name="ln534">  else if (! vrf_bitmap_check (zclient-&gt;redist[ZEBRA_ROUTE_RIPNG], VRF_DEFAULT))</a>
<a name="ln535">    {</a>
<a name="ln536">      vty_out (vty, &quot;router zebra%s&quot;, VTY_NEWLINE);</a>
<a name="ln537">      vty_out (vty, &quot; no redistribute ripng%s&quot;, VTY_NEWLINE);</a>
<a name="ln538">      return 1;</a>
<a name="ln539">    }</a>
<a name="ln540">  return 0;</a>
<a name="ln541">}</a>
<a name="ln542"> </a>
<a name="ln543">/* Zebra node structure. */</a>
<a name="ln544">static struct cmd_node zebra_node =</a>
<a name="ln545">{</a>
<a name="ln546">  ZEBRA_NODE,</a>
<a name="ln547">  &quot;%s(config-router)# &quot;,</a>
<a name="ln548">};</a>
<a name="ln549"> </a>
<a name="ln550">static void</a>
<a name="ln551">ripng_zebra_connected (struct zclient *zclient)</a>
<a name="ln552">{</a>
<a name="ln553">  zclient_send_requests (zclient, VRF_DEFAULT);</a>
<a name="ln554">}</a>
<a name="ln555"> </a>
<a name="ln556">/* Initialize zebra structure and it's commands. */</a>
<a name="ln557">void</a>
<a name="ln558">zebra_init (struct thread_master *master)</a>
<a name="ln559">{</a>
<a name="ln560">  /* Allocate zebra structure. */</a>
<a name="ln561">  zclient = zclient_new (master);</a>
<a name="ln562">  zclient_init (zclient, ZEBRA_ROUTE_RIPNG);</a>
<a name="ln563"> </a>
<a name="ln564">  zclient-&gt;zebra_connected = ripng_zebra_connected;</a>
<a name="ln565">  zclient-&gt;interface_up = ripng_interface_up;</a>
<a name="ln566">  zclient-&gt;interface_down = ripng_interface_down;</a>
<a name="ln567">  zclient-&gt;interface_add = ripng_interface_add;</a>
<a name="ln568">  zclient-&gt;interface_delete = ripng_interface_delete;</a>
<a name="ln569">  zclient-&gt;interface_address_add = ripng_interface_address_add;</a>
<a name="ln570">  zclient-&gt;interface_address_delete = ripng_interface_address_delete;</a>
<a name="ln571">  zclient-&gt;ipv6_route_add = ripng_zebra_read_ipv6;</a>
<a name="ln572">  zclient-&gt;ipv6_route_delete = ripng_zebra_read_ipv6;</a>
<a name="ln573">  </a>
<a name="ln574">  /* Install zebra node. */</a>
<a name="ln575">  install_node (&amp;zebra_node, zebra_config_write);</a>
<a name="ln576"> </a>
<a name="ln577">  /* Install command element for zebra node. */ </a>
<a name="ln578">  install_element (CONFIG_NODE, &amp;router_zebra_cmd);</a>
<a name="ln579">  install_element (CONFIG_NODE, &amp;no_router_zebra_cmd);</a>
<a name="ln580">  install_default (ZEBRA_NODE);</a>
<a name="ln581">  install_element (ZEBRA_NODE, &amp;ripng_redistribute_ripng_cmd);</a>
<a name="ln582">  install_element (ZEBRA_NODE, &amp;no_ripng_redistribute_ripng_cmd);</a>
<a name="ln583"> </a>
<a name="ln584">  /* Install command elements to ripng node */</a>
<a name="ln585">  install_element (RIPNG_NODE, &amp;ripng_redistribute_type_cmd);</a>
<a name="ln586">  install_element (RIPNG_NODE, &amp;ripng_redistribute_type_routemap_cmd);</a>
<a name="ln587">  install_element (RIPNG_NODE, &amp;ripng_redistribute_type_metric_cmd);</a>
<a name="ln588">  install_element (RIPNG_NODE, &amp;ripng_redistribute_type_metric_routemap_cmd);</a>
<a name="ln589">  install_element (RIPNG_NODE, &amp;no_ripng_redistribute_type_cmd);</a>
<a name="ln590">  install_element (RIPNG_NODE, &amp;no_ripng_redistribute_type_routemap_cmd);</a>
<a name="ln591">  install_element (RIPNG_NODE, &amp;no_ripng_redistribute_type_metric_cmd);</a>
<a name="ln592">  install_element (RIPNG_NODE, &amp;no_ripng_redistribute_type_metric_routemap_cmd);</a>
<a name="ln593">}</a>

</code></pre>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>
<div class="balloon" rel="64"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v595/" target="_blank">V595</a> The 'list' pointer was utilized before it was verified against nullptr. Check lines: 64, 73.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
