
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>pim_hello.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">  PIM for Quagga</a>
<a name="ln3">  Copyright (C) 2008  Everton da Silva Marques</a>
<a name="ln4"> </a>
<a name="ln5">  This program is free software; you can redistribute it and/or modify</a>
<a name="ln6">  it under the terms of the GNU General Public License as published by</a>
<a name="ln7">  the Free Software Foundation; either version 2 of the License, or</a>
<a name="ln8">  (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">  This program is distributed in the hope that it will be useful, but</a>
<a name="ln11">  WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln13">  General Public License for more details.</a>
<a name="ln14">  </a>
<a name="ln15">  You should have received a copy of the GNU General Public License</a>
<a name="ln16">  along with this program; see the file COPYING; if not, write to the</a>
<a name="ln17">  Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston,</a>
<a name="ln18">  MA 02110-1301 USA</a>
<a name="ln19">  </a>
<a name="ln20">  $QuaggaId: $Format:%an, %ai, %h$ $</a>
<a name="ln21">*/</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;zebra.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &quot;log.h&quot;</a>
<a name="ln26"> </a>
<a name="ln27">#include &quot;pimd.h&quot;</a>
<a name="ln28">#include &quot;pim_pim.h&quot;</a>
<a name="ln29">#include &quot;pim_str.h&quot;</a>
<a name="ln30">#include &quot;pim_tlv.h&quot;</a>
<a name="ln31">#include &quot;pim_util.h&quot;</a>
<a name="ln32">#include &quot;pim_hello.h&quot;</a>
<a name="ln33">#include &quot;pim_iface.h&quot;</a>
<a name="ln34">#include &quot;pim_neighbor.h&quot;</a>
<a name="ln35">#include &quot;pim_upstream.h&quot;</a>
<a name="ln36"> </a>
<a name="ln37">static void on_trace(const char *label,</a>
<a name="ln38">		     struct interface *ifp, struct in_addr src)</a>
<a name="ln39">{</a>
<a name="ln40">  if (PIM_DEBUG_PIM_TRACE) {</a>
<a name="ln41">    char src_str[100];</a>
<a name="ln42">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src, src_str, sizeof(src_str));</a>
<a name="ln43">    zlog_debug(&quot;%s: from %s on %s&quot;,</a>
<a name="ln44">	       label, src_str, ifp-&gt;name);</a>
<a name="ln45">  }</a>
<a name="ln46">}</a>
<a name="ln47"> </a>
<a name="ln48">static void tlv_trace_bool(const char *label, const char *tlv_name,</a>
<a name="ln49">			   const char *ifname, struct in_addr src_addr,</a>
<a name="ln50">			   int isset, int value)</a>
<a name="ln51">{</a>
<a name="ln52">  if (isset) {</a>
<a name="ln53">    char src_str[100];</a>
<a name="ln54">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln55">    zlog_debug(&quot;%s: PIM hello option from %s on interface %s: %s=%d&quot;,</a>
<a name="ln56">	       label, </a>
<a name="ln57">	       src_str, ifname,</a>
<a name="ln58">	       tlv_name, value);</a>
<a name="ln59">  }</a>
<a name="ln60">}</a>
<a name="ln61"> </a>
<a name="ln62">static void tlv_trace_uint16(const char *label, const char *tlv_name,</a>
<a name="ln63">			     const char *ifname, struct in_addr src_addr,</a>
<a name="ln64">			     int isset, uint16_t value)</a>
<a name="ln65">{</a>
<a name="ln66">  if (isset) {</a>
<a name="ln67">    char src_str[100];</a>
<a name="ln68">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln69">    zlog_debug(&quot;%s: PIM hello option from %s on interface %s: %s=%u&quot;,</a>
<a name="ln70">	       label, </a>
<a name="ln71">	       src_str, ifname,</a>
<a name="ln72">	       tlv_name, value);</a>
<a name="ln73">  }</a>
<a name="ln74">}</a>
<a name="ln75"> </a>
<a name="ln76">static void tlv_trace_uint32(const char *label, const char *tlv_name,</a>
<a name="ln77">			     const char *ifname, struct in_addr src_addr,</a>
<a name="ln78">			     int isset, uint32_t value)</a>
<a name="ln79">{</a>
<a name="ln80">  if (isset) {</a>
<a name="ln81">    char src_str[100];</a>
<a name="ln82">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln83">    zlog_debug(&quot;%s: PIM hello option from %s on interface %s: %s=%u&quot;,</a>
<a name="ln84">	       label, </a>
<a name="ln85">	       src_str, ifname,</a>
<a name="ln86">	       tlv_name, value);</a>
<a name="ln87">  }</a>
<a name="ln88">}</a>
<a name="ln89"> </a>
<a name="ln90">static void tlv_trace_uint32_hex(const char *label, const char *tlv_name,</a>
<a name="ln91">				 const char *ifname, struct in_addr src_addr,</a>
<a name="ln92">				 int isset, uint32_t value)</a>
<a name="ln93">{</a>
<a name="ln94">  if (isset) {</a>
<a name="ln95">    char src_str[100];</a>
<a name="ln96">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln97">    zlog_debug(&quot;%s: PIM hello option from %s on interface %s: %s=%08x&quot;,</a>
<a name="ln98">	       label, </a>
<a name="ln99">	       src_str, ifname,</a>
<a name="ln100">	       tlv_name, value);</a>
<a name="ln101">  }</a>
<a name="ln102">}</a>
<a name="ln103"> </a>
<a name="ln104">#if 0</a>
<a name="ln105">static void tlv_trace(const char *label, const char *tlv_name,</a>
<a name="ln106">		      const char *ifname, struct in_addr src_addr,</a>
<a name="ln107">		      int isset)</a>
<a name="ln108">{</a>
<a name="ln109">  if (isset) {</a>
<a name="ln110">    char src_str[100];</a>
<a name="ln111">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln112">    zlog_debug(&quot;%s: PIM hello option from %s on interface %s: %s&quot;,</a>
<a name="ln113">	       label, </a>
<a name="ln114">	       src_str, ifname,</a>
<a name="ln115">	       tlv_name);</a>
<a name="ln116">  }</a>
<a name="ln117">}</a>
<a name="ln118">#endif</a>
<a name="ln119"> </a>
<a name="ln120">static void tlv_trace_list(const char *label, const char *tlv_name,</a>
<a name="ln121">			   const char *ifname, struct in_addr src_addr,</a>
<a name="ln122">			   int isset, struct list *addr_list)</a>
<a name="ln123">{</a>
<a name="ln124">  if (isset) {</a>
<a name="ln125">    char src_str[100];</a>
<a name="ln126">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln127">    zlog_debug(&quot;%s: PIM hello option from %s on interface %s: %s size=%d list=%p&quot;,</a>
<a name="ln128">	       label, </a>
<a name="ln129">	       src_str, ifname,</a>
<a name="ln130">	       tlv_name,</a>
<a name="ln131">	       addr_list ? ((int) listcount(addr_list)) : -1,</a>
<a name="ln132">	       (void *) addr_list);</a>
<a name="ln133">  }</a>
<a name="ln134">}</a>
<a name="ln135"> </a>
<a name="ln136">#define FREE_ADDR_LIST \</a>
<a name="ln137">  if (hello_option_addr_list) { \</a>
<a name="ln138">    list_delete(hello_option_addr_list); \</a>
<a name="ln139">  }</a>
<a name="ln140"> </a>
<a name="ln141">#define FREE_ADDR_LIST_THEN_RETURN(code) \</a>
<a name="ln142">{ \</a>
<a name="ln143">  FREE_ADDR_LIST \</a>
<a name="ln144">  return (code); \</a>
<a name="ln145">}</a>
<a name="ln146"> </a>
<a name="ln147">int pim_hello_recv(struct interface *ifp,</a>
<a name="ln148">		   struct in_addr src_addr,</a>
<a name="ln149">		   uint8_t *tlv_buf, int tlv_buf_size)</a>
<a name="ln150">{</a>
<a name="ln151">  struct pim_interface *pim_ifp;</a>
<a name="ln152">  struct pim_neighbor *neigh;</a>
<a name="ln153">  uint8_t *tlv_curr;</a>
<a name="ln154">  uint8_t *tlv_pastend;</a>
<a name="ln155">  pim_hello_options hello_options = 0; /* bit array recording options found */</a>
<a name="ln156">  uint16_t hello_option_holdtime = 0;</a>
<a name="ln157">  uint16_t hello_option_propagation_delay = 0;</a>
<a name="ln158">  uint16_t hello_option_override_interval = 0;</a>
<a name="ln159">  uint32_t hello_option_dr_priority = 0;</a>
<a name="ln160">  uint32_t hello_option_generation_id = 0;</a>
<a name="ln161">  struct list *hello_option_addr_list = 0;</a>
<a name="ln162"> </a>
<a name="ln163">  if (PIM_DEBUG_PIM_HELLO)</a>
<a name="ln164">    on_trace(__PRETTY_FUNCTION__, ifp, src_addr);</a>
<a name="ln165"> </a>
<a name="ln166">  pim_ifp = ifp-&gt;info;</a>
<a name="ln167">  zassert(pim_ifp);</a>
<a name="ln168"> </a>
<a name="ln169">  ++pim_ifp-&gt;pim_ifstat_hello_recv;</a>
<a name="ln170"> </a>
<a name="ln171">  /*</a>
<a name="ln172">    Parse PIM hello TLVs</a>
<a name="ln173">   */</a>
<a name="ln174">  zassert(tlv_buf_size &gt;= 0);</a>
<a name="ln175">  tlv_curr = tlv_buf;</a>
<a name="ln176">  tlv_pastend = tlv_buf + tlv_buf_size;</a>
<a name="ln177"> </a>
<a name="ln178">  while (tlv_curr &lt; tlv_pastend) {</a>
<a name="ln179">    uint16_t option_type; </a>
<a name="ln180">    uint16_t option_len;</a>
<a name="ln181">    int remain = tlv_pastend - tlv_curr;</a>
<a name="ln182"> </a>
<a name="ln183">    if (remain &lt; PIM_TLV_MIN_SIZE) {</a>
<a name="ln184">      if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln185">	char src_str[100];</a>
<a name="ln186">	pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln187">	zlog_debug(&quot;%s: short PIM hello TLV size=%d &lt; min=%d from %s on interface %s&quot;,</a>
<a name="ln188">		   __PRETTY_FUNCTION__,</a>
<a name="ln189">		   remain, PIM_TLV_MIN_SIZE,</a>
<a name="ln190">		   src_str, ifp-&gt;name);</a>
<a name="ln191">      }</a>
<a name="ln192">      FREE_ADDR_LIST_THEN_RETURN(-1);</a>
<a name="ln193">    }</a>
<a name="ln194"> </a>
<a name="ln195">    option_type = PIM_TLV_GET_TYPE(tlv_curr);</a>
<a name="ln196">    tlv_curr += PIM_TLV_TYPE_SIZE;</a>
<a name="ln197">    option_len = PIM_TLV_GET_LENGTH(tlv_curr);</a>
<a name="ln198">    tlv_curr += PIM_TLV_LENGTH_SIZE;</a>
<a name="ln199"> </a>
<a name="ln200">    if ((tlv_curr + option_len) &gt; tlv_pastend) {</a>
<a name="ln201">      if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln202">	char src_str[100];</a>
<a name="ln203">	pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln204">	zlog_debug(&quot;%s: long PIM hello TLV type=%d length=%d &gt; left=%td from %s on interface %s&quot;,</a>
<a name="ln205">		   __PRETTY_FUNCTION__,</a>
<a name="ln206">		   option_type, option_len, tlv_pastend - tlv_curr,</a>
<a name="ln207">		   src_str, ifp-&gt;name);</a>
<a name="ln208">      }</a>
<a name="ln209">      FREE_ADDR_LIST_THEN_RETURN(-2);</a>
<a name="ln210">    }</a>
<a name="ln211"> </a>
<a name="ln212">    if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln213">      char src_str[100];</a>
<a name="ln214">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln215">      zlog_debug(&quot;%s: parse left_size=%d: PIM hello TLV type=%d length=%d from %s on %s&quot;,</a>
<a name="ln216">		 __PRETTY_FUNCTION__,</a>
<a name="ln217">		 remain,</a>
<a name="ln218">		 option_type, option_len,</a>
<a name="ln219">		 src_str, ifp-&gt;name);</a>
<a name="ln220">    }</a>
<a name="ln221"> </a>
<a name="ln222">    switch (option_type) {</a>
<a name="ln223">    case PIM_MSG_OPTION_TYPE_HOLDTIME:</a>
<a name="ln224">      if (pim_tlv_parse_holdtime(ifp-&gt;name, src_addr,</a>
<a name="ln225">				 &amp;hello_options,</a>
<a name="ln226">				 &amp;hello_option_holdtime,</a>
<a name="ln227">				 option_len,</a>
<a name="ln228">				 tlv_curr)) {</a>
<a name="ln229">	FREE_ADDR_LIST_THEN_RETURN(-3);</a>
<a name="ln230">      }</a>
<a name="ln231">      break;</a>
<a name="ln232">    case PIM_MSG_OPTION_TYPE_LAN_PRUNE_DELAY:</a>
<a name="ln233">      if (pim_tlv_parse_lan_prune_delay(ifp-&gt;name, src_addr,</a>
<a name="ln234">					&amp;hello_options,</a>
<a name="ln235">					&amp;hello_option_propagation_delay,</a>
<a name="ln236">					&amp;hello_option_override_interval,</a>
<a name="ln237">					option_len,</a>
<a name="ln238">					tlv_curr)) {</a>
<a name="ln239">	FREE_ADDR_LIST_THEN_RETURN(-4);</a>
<a name="ln240">      }</a>
<a name="ln241">      break;</a>
<a name="ln242">    case PIM_MSG_OPTION_TYPE_DR_PRIORITY:</a>
<a name="ln243">      if (pim_tlv_parse_dr_priority(ifp-&gt;name, src_addr,</a>
<a name="ln244">				    &amp;hello_options,</a>
<a name="ln245">				    &amp;hello_option_dr_priority,</a>
<a name="ln246">				    option_len,</a>
<a name="ln247">				    tlv_curr)) {</a>
<a name="ln248">	FREE_ADDR_LIST_THEN_RETURN(-5);</a>
<a name="ln249">      }</a>
<a name="ln250">      break;</a>
<a name="ln251">    case PIM_MSG_OPTION_TYPE_GENERATION_ID:</a>
<a name="ln252">      if (pim_tlv_parse_generation_id(ifp-&gt;name, src_addr,</a>
<a name="ln253">				      &amp;hello_options,</a>
<a name="ln254">				      &amp;hello_option_generation_id,</a>
<a name="ln255">				      option_len,</a>
<a name="ln256">				      tlv_curr)) {</a>
<a name="ln257">	FREE_ADDR_LIST_THEN_RETURN(-6);</a>
<a name="ln258">      }</a>
<a name="ln259">      break;</a>
<a name="ln260">    case PIM_MSG_OPTION_TYPE_ADDRESS_LIST:</a>
<a name="ln261">      if (pim_tlv_parse_addr_list(ifp-&gt;name, src_addr,</a>
<a name="ln262">				  &amp;hello_options,</a>
<a name="ln263">				  &amp;hello_option_addr_list,</a>
<a name="ln264">				  option_len,</a>
<a name="ln265">				  tlv_curr)) {</a>
<a name="ln266">	return -7;</a>
<a name="ln267">      }</a>
<a name="ln268">      break;</a>
<a name="ln269">    case PIM_MSG_OPTION_TYPE_DM_STATE_REFRESH:</a>
<a name="ln270">      if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln271">	char src_str[100];</a>
<a name="ln272">	pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln273">	zlog_debug(&quot;%s: ignoring PIM hello dense-mode state refresh TLV option type=%d length=%d from %s on interface %s&quot;,</a>
<a name="ln274">		   __PRETTY_FUNCTION__,</a>
<a name="ln275">		   option_type, option_len,</a>
<a name="ln276">		   src_str, ifp-&gt;name);</a>
<a name="ln277">      }</a>
<a name="ln278">      break;</a>
<a name="ln279">    default:</a>
<a name="ln280">      if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln281">	char src_str[100];</a>
<a name="ln282">	pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln283">	zlog_debug(&quot;%s: ignoring unknown PIM hello TLV type=%d length=%d from %s on interface %s&quot;,</a>
<a name="ln284">		   __PRETTY_FUNCTION__,</a>
<a name="ln285">		   option_type, option_len,</a>
<a name="ln286">		   src_str, ifp-&gt;name);</a>
<a name="ln287">      }</a>
<a name="ln288">    }</a>
<a name="ln289"> </a>
<a name="ln290">    tlv_curr += option_len;</a>
<a name="ln291">  }</a>
<a name="ln292"> </a>
<a name="ln293">  /*</a>
<a name="ln294">    Check received PIM hello options</a>
<a name="ln295">  */</a>
<a name="ln296"> </a>
<a name="ln297">  if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln298">    tlv_trace_uint16(__PRETTY_FUNCTION__, &quot;holdtime&quot;,</a>
<a name="ln299">		     ifp-&gt;name, src_addr,</a>
<a name="ln300">		     PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_HOLDTIME),</a>
<a name="ln301">		     hello_option_holdtime);</a>
<a name="ln302">    tlv_trace_uint16(__PRETTY_FUNCTION__, &quot;propagation_delay&quot;,</a>
<a name="ln303">		     ifp-&gt;name, src_addr,</a>
<a name="ln304">		     PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_LAN_PRUNE_DELAY),</a>
<a name="ln305">		     hello_option_propagation_delay);</a>
<a name="ln306">    tlv_trace_uint16(__PRETTY_FUNCTION__, &quot;override_interval&quot;,</a>
<a name="ln307">		     ifp-&gt;name, src_addr,</a>
<a name="ln308">		     PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_LAN_PRUNE_DELAY),</a>
<a name="ln309">		     hello_option_override_interval);</a>
<a name="ln310">    tlv_trace_bool(__PRETTY_FUNCTION__, &quot;can_disable_join_suppression&quot;,</a>
<a name="ln311">		   ifp-&gt;name, src_addr,</a>
<a name="ln312">		   PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_LAN_PRUNE_DELAY),</a>
<a name="ln313">		   PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_CAN_DISABLE_JOIN_SUPPRESSION));</a>
<a name="ln314">    tlv_trace_uint32(__PRETTY_FUNCTION__, &quot;dr_priority&quot;,</a>
<a name="ln315">		     ifp-&gt;name, src_addr,</a>
<a name="ln316">		     PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_DR_PRIORITY),</a>
<a name="ln317">		     hello_option_dr_priority);</a>
<a name="ln318">    tlv_trace_uint32_hex(__PRETTY_FUNCTION__, &quot;generation_id&quot;,</a>
<a name="ln319">			 ifp-&gt;name, src_addr,</a>
<a name="ln320">			 PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_GENERATION_ID),</a>
<a name="ln321">			 hello_option_generation_id);</a>
<a name="ln322">    tlv_trace_list(__PRETTY_FUNCTION__, &quot;address_list&quot;,</a>
<a name="ln323">		   ifp-&gt;name, src_addr,</a>
<a name="ln324">		   PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_ADDRESS_LIST),</a>
<a name="ln325">		   hello_option_addr_list);</a>
<a name="ln326">  }</a>
<a name="ln327"> </a>
<a name="ln328">  if (!PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_HOLDTIME)) {</a>
<a name="ln329">    if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln330">      char src_str[100];</a>
<a name="ln331">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln332">      zlog_debug(&quot;%s: PIM hello missing holdtime from %s on interface %s&quot;,</a>
<a name="ln333">		__PRETTY_FUNCTION__,</a>
<a name="ln334">		src_str, ifp-&gt;name);</a>
<a name="ln335">    }</a>
<a name="ln336">  }</a>
<a name="ln337"> </a>
<a name="ln338">  /*</a>
<a name="ln339">    New neighbor?</a>
<a name="ln340">  */</a>
<a name="ln341"> </a>
<a name="ln342">  neigh = pim_neighbor_find(ifp, src_addr);</a>
<a name="ln343">  if (!neigh) {</a>
<a name="ln344">    /* Add as new neighbor */</a>
<a name="ln345">    </a>
<a name="ln346">    neigh = pim_neighbor_add(ifp, src_addr,</a>
<a name="ln347">			     hello_options,</a>
<a name="ln348">			     hello_option_holdtime,</a>
<a name="ln349">			     hello_option_propagation_delay,</a>
<a name="ln350">			     hello_option_override_interval,</a>
<a name="ln351">			     hello_option_dr_priority,</a>
<a name="ln352">			     hello_option_generation_id,</a>
<a name="ln353">			     hello_option_addr_list);</a>
<a name="ln354">    if (!neigh) {</a>
<a name="ln355">      if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln356">	char src_str[100];</a>
<a name="ln357">	pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln358">	zlog_warn(&quot;%s: failure creating PIM neighbor %s on interface %s&quot;,</a>
<a name="ln359">		  __PRETTY_FUNCTION__,</a>
<a name="ln360">		  src_str, ifp-&gt;name);</a>
<a name="ln361">      }</a>
<a name="ln362">      FREE_ADDR_LIST_THEN_RETURN(-8);</a>
<a name="ln363">    }</a>
<a name="ln364"> </a>
<a name="ln365">    /* actual addr list has been saved under neighbor */</a>
<a name="ln366">    return 0;</a>
<a name="ln367">  }</a>
<a name="ln368"> </a>
<a name="ln369">  /*</a>
<a name="ln370">    Received generation ID ?</a>
<a name="ln371">  */</a>
<a name="ln372">  </a>
<a name="ln373">  if (PIM_OPTION_IS_SET(hello_options, PIM_OPTION_MASK_GENERATION_ID)) {</a>
<a name="ln374">    /* GenID mismatch ? */</a>
<a name="ln375">    if (!PIM_OPTION_IS_SET(neigh-&gt;hello_options, PIM_OPTION_MASK_GENERATION_ID) ||</a>
<a name="ln376">	(hello_option_generation_id != neigh-&gt;generation_id)) {</a>
<a name="ln377"> </a>
<a name="ln378">      /* GenID changed */</a>
<a name="ln379"> </a>
<a name="ln380">      pim_upstream_rpf_genid_changed(neigh-&gt;source_addr);</a>
<a name="ln381"> </a>
<a name="ln382">      /* GenID mismatch, then replace neighbor */</a>
<a name="ln383">      </a>
<a name="ln384">      if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln385">	char src_str[100];</a>
<a name="ln386">	pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln387">	zlog_debug(&quot;%s: GenId mismatch new=%08x old=%08x: replacing neighbor %s on %s&quot;,</a>
<a name="ln388">		   __PRETTY_FUNCTION__,</a>
<a name="ln389">		   hello_option_generation_id,</a>
<a name="ln390">		   neigh-&gt;generation_id,</a>
<a name="ln391">		   src_str, ifp-&gt;name);</a>
<a name="ln392">      }</a>
<a name="ln393"> </a>
<a name="ln394">      pim_upstream_rpf_genid_changed(neigh-&gt;source_addr);</a>
<a name="ln395">      </a>
<a name="ln396">      pim_neighbor_delete(ifp, neigh, &quot;GenID mismatch&quot;);</a>
<a name="ln397">      neigh = pim_neighbor_add(ifp, src_addr,</a>
<a name="ln398">			       hello_options,</a>
<a name="ln399">			       hello_option_holdtime,</a>
<a name="ln400">			       hello_option_propagation_delay,</a>
<a name="ln401">			       hello_option_override_interval,</a>
<a name="ln402">			       hello_option_dr_priority,</a>
<a name="ln403">			       hello_option_generation_id,</a>
<a name="ln404">			       hello_option_addr_list);</a>
<a name="ln405">      if (!neigh) {</a>
<a name="ln406">	if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln407">	  char src_str[100];</a>
<a name="ln408">	  pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln409">	  zlog_debug(&quot;%s: failure re-creating PIM neighbor %s on interface %s&quot;,</a>
<a name="ln410">		     __PRETTY_FUNCTION__,</a>
<a name="ln411">		     src_str, ifp-&gt;name);</a>
<a name="ln412">	}</a>
<a name="ln413">	FREE_ADDR_LIST_THEN_RETURN(-9);</a>
<a name="ln414">      }</a>
<a name="ln415">      /* actual addr list is saved under neighbor */</a>
<a name="ln416">      return 0;</a>
<a name="ln417"> </a>
<a name="ln418">    } /* GenId mismatch: replace neighbor */</a>
<a name="ln419">    </a>
<a name="ln420">  } /* GenId received */</a>
<a name="ln421"> </a>
<a name="ln422">  /*</a>
<a name="ln423">    Update existing neighbor</a>
<a name="ln424">  */</a>
<a name="ln425"> </a>
<a name="ln426">  pim_neighbor_update(neigh,</a>
<a name="ln427">		      hello_options,</a>
<a name="ln428">		      hello_option_holdtime,</a>
<a name="ln429">		      hello_option_dr_priority,</a>
<a name="ln430">		      hello_option_addr_list);</a>
<a name="ln431">  /* actual addr list is saved under neighbor */</a>
<a name="ln432">  return 0;</a>
<a name="ln433">}</a>
<a name="ln434"> </a>
<a name="ln435">int pim_hello_build_tlv(const char *ifname,</a>
<a name="ln436">			uint8_t *tlv_buf, int tlv_buf_size,</a>
<a name="ln437">			uint16_t holdtime,</a>
<a name="ln438">			uint32_t dr_priority,</a>
<a name="ln439">			uint32_t generation_id,</a>
<a name="ln440">			uint16_t propagation_delay,</a>
<a name="ln441">			uint16_t override_interval,</a>
<a name="ln442">			int can_disable_join_suppression,</a>
<a name="ln443">			struct list *ifconnected)</a>
<a name="ln444">{</a>
<a name="ln445">  uint8_t *curr = tlv_buf;</a>
<a name="ln446">  uint8_t *pastend = tlv_buf + tlv_buf_size;</a>
<a name="ln447">  uint8_t *tmp;</a>
<a name="ln448"> </a>
<a name="ln449">  /*</a>
<a name="ln450">   * Append options</a>
<a name="ln451">   */</a>
<a name="ln452"> </a>
<a name="ln453">  /* Holdtime */</a>
<a name="ln454">  curr = pim_tlv_append_uint16(curr,</a>
<a name="ln455">			       pastend,</a>
<a name="ln456">			       PIM_MSG_OPTION_TYPE_HOLDTIME,</a>
<a name="ln457">			       holdtime);</a>
<a name="ln458">  if (!curr) {</a>
<a name="ln459">    if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln460">      zlog_debug(&quot;%s: could not set PIM hello Holdtime option for interface %s&quot;,</a>
<a name="ln461">		 __PRETTY_FUNCTION__, ifname);</a>
<a name="ln462">    }</a>
<a name="ln463">    return -1;</a>
<a name="ln464">  }</a>
<a name="ln465"> </a>
<a name="ln466">  /* LAN Prune Delay */</a>
<a name="ln467">  tmp = pim_tlv_append_2uint16(curr,</a>
<a name="ln468">			       pastend,</a>
<a name="ln469">			       PIM_MSG_OPTION_TYPE_LAN_PRUNE_DELAY,</a>
<a name="ln470">			       propagation_delay,</a>
<a name="ln471">			       override_interval);</a>
<a name="ln472">  if (!tmp) {</a>
<a name="ln473">    if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln474">      zlog_debug(&quot;%s: could not set PIM LAN Prune Delay option for interface %s&quot;,</a>
<a name="ln475">		 __PRETTY_FUNCTION__, ifname);</a>
<a name="ln476">    }</a>
<a name="ln477">    return -1;</a>
<a name="ln478">  }</a>
<a name="ln479">  if (can_disable_join_suppression) {</a>
<a name="ln480">    *((uint8_t*)(curr) + 4) |= 0x80; /* enable T bit */</a>
<a name="ln481">  }</a>
<a name="ln482">  curr = tmp;</a>
<a name="ln483"> </a>
<a name="ln484">  /* DR Priority */</a>
<a name="ln485">  curr = pim_tlv_append_uint32(curr,</a>
<a name="ln486">			       pastend,</a>
<a name="ln487">			       PIM_MSG_OPTION_TYPE_DR_PRIORITY,</a>
<a name="ln488">			       dr_priority);</a>
<a name="ln489">  if (!curr) {</a>
<a name="ln490">    if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln491">      zlog_debug(&quot;%s: could not set PIM hello DR Priority option for interface %s&quot;,</a>
<a name="ln492">		 __PRETTY_FUNCTION__, ifname);</a>
<a name="ln493">    }</a>
<a name="ln494">    return -2;</a>
<a name="ln495">  }</a>
<a name="ln496"> </a>
<a name="ln497">  /* Generation ID */</a>
<a name="ln498">  curr = pim_tlv_append_uint32(curr,</a>
<a name="ln499">			       pastend,</a>
<a name="ln500">			       PIM_MSG_OPTION_TYPE_GENERATION_ID,</a>
<a name="ln501">			       generation_id);</a>
<a name="ln502">  if (!curr) {</a>
<a name="ln503">    if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln504">      zlog_debug(&quot;%s: could not set PIM hello Generation ID option for interface %s&quot;,</a>
<a name="ln505">		 __PRETTY_FUNCTION__, ifname);</a>
<a name="ln506">    }</a>
<a name="ln507">    return -3;</a>
<a name="ln508">  }</a>
<a name="ln509"> </a>
<a name="ln510">  /* Secondary Address List */</a>
<a name="ln511">  if (ifconnected) {</a>
<a name="ln512">    curr = pim_tlv_append_addrlist_ucast(curr,</a>
<a name="ln513">					 pastend,</a>
<a name="ln514">					 ifconnected);</a>
<a name="ln515">    if (!curr) {</a>
<a name="ln516">      if (PIM_DEBUG_PIM_HELLO) {</a>
<a name="ln517">	zlog_debug(&quot;%s: could not set PIM hello Secondary Address List option for interface %s&quot;,</a>
<a name="ln518">		  __PRETTY_FUNCTION__, ifname);</a>
<a name="ln519">      }</a>
<a name="ln520">      return -4;</a>
<a name="ln521">    }</a>
<a name="ln522">  }</a>
<a name="ln523"> </a>
<a name="ln524">  return curr - tlv_buf;</a>
<a name="ln525">}</a>
<a name="ln526"> </a>
<a name="ln527">/*</a>
<a name="ln528">  RFC 4601: 4.3.1.  Sending Hello Messages</a>
<a name="ln529"> </a>
<a name="ln530">  Thus, if a router needs to send a Join/Prune or Assert message on an</a>
<a name="ln531">  interface on which it has not yet sent a Hello message with the</a>
<a name="ln532">  currently configured IP address, then it MUST immediately send the</a>
<a name="ln533">  relevant Hello message without waiting for the Hello Timer to</a>
<a name="ln534">  expire, followed by the Join/Prune or Assert message.</a>
<a name="ln535">*/</a>
<a name="ln536">void pim_hello_require(struct interface *ifp)</a>
<a name="ln537">{</a>
<a name="ln538">  struct pim_interface *pim_ifp;</a>
<a name="ln539"> </a>
<a name="ln540">  zassert(ifp);</a>
<a name="ln541"> </a>
<a name="ln542">  pim_ifp = ifp-&gt;info;</a>
<a name="ln543"> </a>
<a name="ln544">  zassert(pim_ifp);</a>
<a name="ln545"> </a>
<a name="ln546">  if (pim_ifp-&gt;pim_ifstat_hello_sent)</a>
<a name="ln547">    return;</a>
<a name="ln548"> </a>
<a name="ln549">  pim_hello_restart_now(ifp); /* Send hello and restart timer */</a>
<a name="ln550">}</a>

</code></pre>
<div class="balloon" rel="6"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
