
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>isis_events.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * IS-IS Rout(e)ing protocol - isis_events.h   </a>
<a name="ln3"> *</a>
<a name="ln4"> * Copyright (C) 2001,2002   Sampo Saaristo</a>
<a name="ln5"> *                           Tampere University of Technology      </a>
<a name="ln6"> *                           Institute of Communications Engineering</a>
<a name="ln7"> *</a>
<a name="ln8"> * This program is free software; you can redistribute it and/or modify it </a>
<a name="ln9"> * under the terms of the GNU General Public Licenseas published by the Free </a>
<a name="ln10"> * Software Foundation; either version 2 of the License, or (at your option) </a>
<a name="ln11"> * any later version.</a>
<a name="ln12"> *</a>
<a name="ln13"> * This program is distributed in the hope that it will be useful,but WITHOUT </a>
<a name="ln14"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or </a>
<a name="ln15"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for </a>
<a name="ln16"> * more details.</a>
<a name="ln17"> </a>
<a name="ln18"> * You should have received a copy of the GNU General Public License along </a>
<a name="ln19"> * with this program; if not, write to the Free Software Foundation, Inc., </a>
<a name="ln20"> * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</a>
<a name="ln21"> */</a>
<a name="ln22">#include &lt;zebra.h&gt;</a>
<a name="ln23"> </a>
<a name="ln24">#include &quot;log.h&quot;</a>
<a name="ln25">#include &quot;memory.h&quot;</a>
<a name="ln26">#include &quot;if.h&quot;</a>
<a name="ln27">#include &quot;linklist.h&quot;</a>
<a name="ln28">#include &quot;command.h&quot;</a>
<a name="ln29">#include &quot;thread.h&quot;</a>
<a name="ln30">#include &quot;hash.h&quot;</a>
<a name="ln31">#include &quot;prefix.h&quot;</a>
<a name="ln32">#include &quot;stream.h&quot;</a>
<a name="ln33">#include &quot;table.h&quot;</a>
<a name="ln34"> </a>
<a name="ln35">#include &quot;isisd/dict.h&quot;</a>
<a name="ln36">#include &quot;isisd/include-netbsd/iso.h&quot;</a>
<a name="ln37">#include &quot;isisd/isis_constants.h&quot;</a>
<a name="ln38">#include &quot;isisd/isis_common.h&quot;</a>
<a name="ln39">#include &quot;isisd/isis_flags.h&quot;</a>
<a name="ln40">#include &quot;isisd/isis_circuit.h&quot;</a>
<a name="ln41">#include &quot;isisd/isis_tlv.h&quot;</a>
<a name="ln42">#include &quot;isisd/isis_lsp.h&quot;</a>
<a name="ln43">#include &quot;isisd/isis_pdu.h&quot;</a>
<a name="ln44">#include &quot;isisd/isis_network.h&quot;</a>
<a name="ln45">#include &quot;isisd/isis_misc.h&quot;</a>
<a name="ln46">#include &quot;isisd/isis_constants.h&quot;</a>
<a name="ln47">#include &quot;isisd/isis_adjacency.h&quot;</a>
<a name="ln48">#include &quot;isisd/isis_dr.h&quot;</a>
<a name="ln49">#include &quot;isisd/isisd.h&quot;</a>
<a name="ln50">#include &quot;isisd/isis_csm.h&quot;</a>
<a name="ln51">#include &quot;isisd/isis_events.h&quot;</a>
<a name="ln52">#include &quot;isisd/isis_spf.h&quot;</a>
<a name="ln53"> </a>
<a name="ln54">/* debug isis-spf spf-events </a>
<a name="ln55"> 4w4d: ISIS-Spf (tlt): L2 SPF needed, new adjacency, from 0x609229F4</a>
<a name="ln56"> 4w4d: ISIS-Spf (tlt): L2, 0000.0000.0042.01-00 TLV contents changed, code 0x2</a>
<a name="ln57"> 4w4d: ISIS-Spf (tlt): L2, new LSP 0 DEAD.BEEF.0043.00-00</a>
<a name="ln58"> 4w5d: ISIS-Spf (tlt): L1 SPF needed, periodic SPF, from 0x6091C844</a>
<a name="ln59"> 4w5d: ISIS-Spf (tlt): L2 SPF needed, periodic SPF, from 0x6091C844</a>
<a name="ln60">*/</a>
<a name="ln61"> </a>
<a name="ln62">void</a>
<a name="ln63">isis_event_circuit_state_change (struct isis_circuit *circuit,</a>
<a name="ln64">                                 struct isis_area *area, int up)</a>
<a name="ln65">{</a>
<a name="ln66">  area-&gt;circuit_state_changes++;</a>
<a name="ln67"> </a>
<a name="ln68">  if (isis-&gt;debugs &amp; DEBUG_EVENTS)</a>
<a name="ln69">    zlog_debug (&quot;ISIS-Evt (%s) circuit %s&quot;, area-&gt;area_tag,</a>
<a name="ln70">                up ? &quot;up&quot; : &quot;down&quot;);</a>
<a name="ln71"> </a>
<a name="ln72">  /*</a>
<a name="ln73">   * Regenerate LSPs this affects</a>
<a name="ln74">   */</a>
<a name="ln75">  lsp_regenerate_schedule (area, IS_LEVEL_1 | IS_LEVEL_2, 0);</a>
<a name="ln76"> </a>
<a name="ln77">  return;</a>
<a name="ln78">}</a>
<a name="ln79"> </a>
<a name="ln80">static void</a>
<a name="ln81">circuit_commence_level (struct isis_circuit *circuit, int level)</a>
<a name="ln82">{</a>
<a name="ln83">  if (level == 1)</a>
<a name="ln84">    {</a>
<a name="ln85">      if (! circuit-&gt;is_passive)</a>
<a name="ln86">        THREAD_TIMER_ON (master, circuit-&gt;t_send_psnp[0], send_l1_psnp, circuit,</a>
<a name="ln87">		         isis_jitter (circuit-&gt;psnp_interval[0], PSNP_JITTER));</a>
<a name="ln88"> </a>
<a name="ln89">      if (circuit-&gt;circ_type == CIRCUIT_T_BROADCAST)</a>
<a name="ln90">	{</a>
<a name="ln91">	  THREAD_TIMER_ON (master, circuit-&gt;u.bc.t_run_dr[0], isis_run_dr_l1,</a>
<a name="ln92">			   circuit, 2 * circuit-&gt;hello_interval[0]);</a>
<a name="ln93"> </a>
<a name="ln94">	  THREAD_TIMER_ON (master, circuit-&gt;u.bc.t_send_lan_hello[0],</a>
<a name="ln95">			   send_lan_l1_hello, circuit,</a>
<a name="ln96">			   isis_jitter (circuit-&gt;hello_interval[0],</a>
<a name="ln97">					IIH_JITTER));</a>
<a name="ln98"> </a>
<a name="ln99">	  circuit-&gt;u.bc.lan_neighs[0] = list_new ();</a>
<a name="ln100">	}</a>
<a name="ln101">    }</a>
<a name="ln102">  else</a>
<a name="ln103">    {</a>
<a name="ln104">      if (! circuit-&gt;is_passive)</a>
<a name="ln105">        THREAD_TIMER_ON (master, circuit-&gt;t_send_psnp[1], send_l2_psnp, circuit,</a>
<a name="ln106">		         isis_jitter (circuit-&gt;psnp_interval[1], PSNP_JITTER));</a>
<a name="ln107"> </a>
<a name="ln108">      if (circuit-&gt;circ_type == CIRCUIT_T_BROADCAST)</a>
<a name="ln109">	{</a>
<a name="ln110">	  THREAD_TIMER_ON (master, circuit-&gt;u.bc.t_run_dr[1], isis_run_dr_l2,</a>
<a name="ln111">			   circuit, 2 * circuit-&gt;hello_interval[1]);</a>
<a name="ln112"> </a>
<a name="ln113">	  THREAD_TIMER_ON (master, circuit-&gt;u.bc.t_send_lan_hello[1],</a>
<a name="ln114">			   send_lan_l2_hello, circuit,</a>
<a name="ln115">			   isis_jitter (circuit-&gt;hello_interval[1],</a>
<a name="ln116">					IIH_JITTER));</a>
<a name="ln117"> </a>
<a name="ln118">	  circuit-&gt;u.bc.lan_neighs[1] = list_new ();</a>
<a name="ln119">	}</a>
<a name="ln120">    }</a>
<a name="ln121"> </a>
<a name="ln122">  return;</a>
<a name="ln123">}</a>
<a name="ln124"> </a>
<a name="ln125">static void</a>
<a name="ln126">circuit_resign_level (struct isis_circuit *circuit, int level)</a>
<a name="ln127">{</a>
<a name="ln128">  int idx = level - 1;</a>
<a name="ln129"> </a>
<a name="ln130">  THREAD_TIMER_OFF (circuit-&gt;t_send_csnp[idx]);</a>
<a name="ln131">  THREAD_TIMER_OFF (circuit-&gt;t_send_psnp[idx]);</a>
<a name="ln132"> </a>
<a name="ln133">  if (circuit-&gt;circ_type == CIRCUIT_T_BROADCAST)</a>
<a name="ln134">    {</a>
<a name="ln135">      THREAD_TIMER_OFF (circuit-&gt;u.bc.t_send_lan_hello[idx]);</a>
<a name="ln136">      THREAD_TIMER_OFF (circuit-&gt;u.bc.t_run_dr[idx]);</a>
<a name="ln137">      THREAD_TIMER_OFF (circuit-&gt;u.bc.t_refresh_pseudo_lsp[idx]);</a>
<a name="ln138">      circuit-&gt;lsp_regenerate_pending[idx] = 0;</a>
<a name="ln139">      circuit-&gt;u.bc.run_dr_elect[idx] = 0;</a>
<a name="ln140">      if (circuit-&gt;u.bc.lan_neighs[idx] != NULL) {</a>
<a name="ln141">        list_delete (circuit-&gt;u.bc.lan_neighs[idx]);</a>
<a name="ln142">        circuit-&gt;u.bc.lan_neighs[idx] = NULL;</a>
<a name="ln143">      }</a>
<a name="ln144">    }</a>
<a name="ln145"> </a>
<a name="ln146">  return;</a>
<a name="ln147">}</a>
<a name="ln148"> </a>
<a name="ln149">void</a>
<a name="ln150">isis_circuit_is_type_set (struct isis_circuit *circuit, int newtype)</a>
<a name="ln151">{</a>
<a name="ln152">  if (circuit-&gt;state != C_STATE_UP)</a>
<a name="ln153">  {</a>
<a name="ln154">    circuit-&gt;is_type = newtype;</a>
<a name="ln155">    return;</a>
<a name="ln156">  }</a>
<a name="ln157"> </a>
<a name="ln158">  if (isis-&gt;debugs &amp; DEBUG_EVENTS)</a>
<a name="ln159">    zlog_debug (&quot;ISIS-Evt (%s) circuit type change %s -&gt; %s&quot;,</a>
<a name="ln160">	       circuit-&gt;area-&gt;area_tag,</a>
<a name="ln161">	       circuit_t2string (circuit-&gt;is_type),</a>
<a name="ln162">	       circuit_t2string (newtype));</a>
<a name="ln163"> </a>
<a name="ln164">  if (circuit-&gt;is_type == newtype)</a>
<a name="ln165">    return;			/* No change */</a>
<a name="ln166"> </a>
<a name="ln167">  if (!(newtype &amp; circuit-&gt;area-&gt;is_type))</a>
<a name="ln168">    {</a>
<a name="ln169">      zlog_err (&quot;ISIS-Evt (%s) circuit type change - invalid level %s because&quot;</a>
<a name="ln170">		&quot; area is %s&quot;, circuit-&gt;area-&gt;area_tag,</a>
<a name="ln171">		circuit_t2string (newtype),</a>
<a name="ln172">		circuit_t2string (circuit-&gt;area-&gt;is_type));</a>
<a name="ln173">      return;</a>
<a name="ln174">    }</a>
<a name="ln175"> </a>
<a name="ln176">  if (! circuit-&gt;is_passive)</a>
<a name="ln177">    {</a>
<a name="ln178">      switch (circuit-&gt;is_type)</a>
<a name="ln179">        {</a>
<a name="ln180">        case IS_LEVEL_1:</a>
<a name="ln181">          if (newtype == IS_LEVEL_2)</a>
<a name="ln182">            circuit_resign_level (circuit, 1);</a>
<a name="ln183">          circuit_commence_level (circuit, 2);</a>
<a name="ln184">          break;</a>
<a name="ln185">        case IS_LEVEL_1_AND_2:</a>
<a name="ln186">          if (newtype == IS_LEVEL_1)</a>
<a name="ln187">            circuit_resign_level (circuit, 2);</a>
<a name="ln188">          else</a>
<a name="ln189">            circuit_resign_level (circuit, 1);</a>
<a name="ln190">          break;</a>
<a name="ln191">        case IS_LEVEL_2:</a>
<a name="ln192">          if (newtype == IS_LEVEL_1)</a>
<a name="ln193">            circuit_resign_level (circuit, 2);</a>
<a name="ln194">          circuit_commence_level (circuit, 1);</a>
<a name="ln195">          break;</a>
<a name="ln196">        default:</a>
<a name="ln197">          break;</a>
<a name="ln198">        }</a>
<a name="ln199">    }</a>
<a name="ln200"> </a>
<a name="ln201">  circuit-&gt;is_type = newtype;</a>
<a name="ln202">  lsp_regenerate_schedule (circuit-&gt;area, IS_LEVEL_1 | IS_LEVEL_2, 0);</a>
<a name="ln203"> </a>
<a name="ln204">  return;</a>
<a name="ln205">}</a>
<a name="ln206"> </a>
<a name="ln207"> /* 04/18/2002 by Gwak. */</a>
<a name="ln208"> /**************************************************************************</a>
<a name="ln209">  *</a>
<a name="ln210">  * EVENTS for LSP generation</a>
<a name="ln211">  *</a>
<a name="ln212">  * 1) an Adajacency or Circuit Up/Down event</a>
<a name="ln213">  * 2) a chnage in Circuit metric</a>
<a name="ln214">  * 3) a change in Reachable Address metric</a>
<a name="ln215">  * 4) a change in manualAreaAddresses</a>
<a name="ln216">  * 5) a change in systemID</a>
<a name="ln217">  * 6) a change in DIS status</a>
<a name="ln218">  * 7) a chnage in the waiting status</a>
<a name="ln219">  *</a>
<a name="ln220">  * ***********************************************************************</a>
<a name="ln221">  *</a>
<a name="ln222">  * current support event</a>
<a name="ln223">  *</a>
<a name="ln224">  * 1) Adjacency Up/Down event</a>
<a name="ln225">  * 6) a change in DIS status</a>
<a name="ln226">  *</a>
<a name="ln227">  * ***********************************************************************/</a>
<a name="ln228"> </a>
<a name="ln229">void</a>
<a name="ln230">isis_event_adjacency_state_change (struct isis_adjacency *adj, int newstate)</a>
<a name="ln231">{</a>
<a name="ln232">  /* adjacency state change event. </a>
<a name="ln233">   * - the only proto-type was supported */</a>
<a name="ln234"> </a>
<a name="ln235">  /* invalid arguments */</a>
<a name="ln236">  if (!adj || !adj-&gt;circuit || !adj-&gt;circuit-&gt;area)</a>
<a name="ln237">    return;</a>
<a name="ln238"> </a>
<a name="ln239">  if (isis-&gt;debugs &amp; DEBUG_EVENTS)</a>
<a name="ln240">    zlog_debug (&quot;ISIS-Evt (%s) Adjacency State change&quot;,</a>
<a name="ln241">		adj-&gt;circuit-&gt;area-&gt;area_tag);</a>
<a name="ln242"> </a>
<a name="ln243">  /* LSP generation again */</a>
<a name="ln244">  lsp_regenerate_schedule (adj-&gt;circuit-&gt;area, IS_LEVEL_1 | IS_LEVEL_2, 0);</a>
<a name="ln245"> </a>
<a name="ln246">  return;</a>
<a name="ln247">}</a>
<a name="ln248"> </a>
<a name="ln249">/* events supporting code */</a>
<a name="ln250"> </a>
<a name="ln251">int</a>
<a name="ln252">isis_event_dis_status_change (struct thread *thread)</a>
<a name="ln253">{</a>
<a name="ln254">  struct isis_circuit *circuit;</a>
<a name="ln255"> </a>
<a name="ln256">  circuit = THREAD_ARG (thread);</a>
<a name="ln257"> </a>
<a name="ln258">  /* invalid arguments */</a>
<a name="ln259">  if (!circuit || !circuit-&gt;area)</a>
<a name="ln260">    return 0;</a>
<a name="ln261">  if (isis-&gt;debugs &amp; DEBUG_EVENTS)</a>
<a name="ln262">    zlog_debug (&quot;ISIS-Evt (%s) DIS status change&quot;, circuit-&gt;area-&gt;area_tag);</a>
<a name="ln263"> </a>
<a name="ln264">  /* LSP generation again */</a>
<a name="ln265">  lsp_regenerate_schedule (circuit-&gt;area, IS_LEVEL_1 | IS_LEVEL_2, 0);</a>
<a name="ln266"> </a>
<a name="ln267">  return 0;</a>
<a name="ln268">}</a>
<a name="ln269"> </a>
<a name="ln270">void</a>
<a name="ln271">isis_event_auth_failure (char *area_tag, const char *error_string, u_char *sysid)</a>
<a name="ln272">{</a>
<a name="ln273">  if (isis-&gt;debugs &amp; DEBUG_EVENTS)</a>
<a name="ln274">    zlog_debug (&quot;ISIS-Evt (%s) Authentication failure %s from %s&quot;,</a>
<a name="ln275">		area_tag, error_string, sysid_print (sysid));</a>
<a name="ln276"> </a>
<a name="ln277">  return;</a>
<a name="ln278">}</a>

</code></pre>
<div class="balloon" rel="15"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
