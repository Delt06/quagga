
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>nhrp_main.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/* NHRP daemon main functions</a>
<a name="ln2"> * Copyright (c) 2014-2015 Timo Ter√§s</a>
<a name="ln3"> *</a>
<a name="ln4"> * This file is free software: you may copy, redistribute and/or modify</a>
<a name="ln5"> * it under the terms of the GNU General Public License as published by</a>
<a name="ln6"> * the Free Software Foundation, either version 2 of the License, or</a>
<a name="ln7"> * (at your option) any later version.</a>
<a name="ln8"> */</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;unistd.h&gt;</a>
<a name="ln11">#include &lt;libgen.h&gt;</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;zebra.h&quot;</a>
<a name="ln14">#include &quot;privs.h&quot;</a>
<a name="ln15">#include &quot;getopt.h&quot;</a>
<a name="ln16">#include &quot;thread.h&quot;</a>
<a name="ln17">#include &quot;sigevent.h&quot;</a>
<a name="ln18">#include &quot;version.h&quot;</a>
<a name="ln19">#include &quot;log.h&quot;</a>
<a name="ln20">#include &quot;memory.h&quot;</a>
<a name="ln21">#include &quot;command.h&quot;</a>
<a name="ln22"> </a>
<a name="ln23">#include &quot;nhrpd.h&quot;</a>
<a name="ln24">#include &quot;netlink.h&quot;</a>
<a name="ln25"> </a>
<a name="ln26">unsigned int debug_flags = 0;</a>
<a name="ln27"> </a>
<a name="ln28">struct thread_master *master;</a>
<a name="ln29">struct timeval current_time;</a>
<a name="ln30">static const char *pid_file = PATH_NHRPD_PID;</a>
<a name="ln31">static char config_default[] = SYSCONFDIR NHRP_DEFAULT_CONFIG;</a>
<a name="ln32">static char *config_file = NULL;</a>
<a name="ln33">static char *vty_addr = NULL;</a>
<a name="ln34">static int vty_port = NHRP_VTY_PORT;</a>
<a name="ln35">static int do_daemonise = 0;</a>
<a name="ln36"> </a>
<a name="ln37">/* nhrpd options. */</a>
<a name="ln38">struct option longopts[] = {</a>
<a name="ln39">	{ &quot;daemon&quot;,      no_argument,       NULL, 'd'},</a>
<a name="ln40">	{ &quot;config_file&quot;, required_argument, NULL, 'f'},</a>
<a name="ln41">	{ &quot;pid_file&quot;,    required_argument, NULL, 'i'},</a>
<a name="ln42">	{ &quot;socket&quot;,      required_argument, NULL, 'z'},</a>
<a name="ln43">	{ &quot;help&quot;,        no_argument,       NULL, 'h'},</a>
<a name="ln44">	{ &quot;vty_addr&quot;,    required_argument, NULL, 'A'},</a>
<a name="ln45">	{ &quot;vty_port&quot;,    required_argument, NULL, 'P'},</a>
<a name="ln46">	{ &quot;user&quot;,        required_argument, NULL, 'u'},</a>
<a name="ln47">	{ &quot;group&quot;,       required_argument, NULL, 'g'},</a>
<a name="ln48">	{ &quot;version&quot;,     no_argument,       NULL, 'v'},</a>
<a name="ln49">	{ 0 }</a>
<a name="ln50">};</a>
<a name="ln51"> </a>
<a name="ln52">/* nhrpd privileges */</a>
<a name="ln53">static zebra_capabilities_t _caps_p [] = {</a>
<a name="ln54">	ZCAP_NET_RAW,</a>
<a name="ln55">	ZCAP_NET_ADMIN,</a>
<a name="ln56">	ZCAP_DAC_OVERRIDE,	/* for now needed to write to /proc/sys/net/ipv4/&lt;if&gt;/send_redirect */</a>
<a name="ln57">};</a>
<a name="ln58"> </a>
<a name="ln59">static struct zebra_privs_t nhrpd_privs = {</a>
<a name="ln60">#ifdef QUAGGA_USER</a>
<a name="ln61">	.user = QUAGGA_USER,</a>
<a name="ln62">#endif</a>
<a name="ln63">#ifdef QUAGGA_GROUP</a>
<a name="ln64">	.group = QUAGGA_GROUP,</a>
<a name="ln65">#endif</a>
<a name="ln66">#ifdef VTY_GROUP</a>
<a name="ln67">	.vty_group = VTY_GROUP,</a>
<a name="ln68">#endif</a>
<a name="ln69">	.caps_p = _caps_p,</a>
<a name="ln70">	.cap_num_p = ZEBRA_NUM_OF(_caps_p),</a>
<a name="ln71">};</a>
<a name="ln72"> </a>
<a name="ln73">static void usage(const char *progname, int status)</a>
<a name="ln74">{</a>
<a name="ln75">	if (status != 0)</a>
<a name="ln76">		fprintf(stderr, &quot;Try `%s --help' for more information.\n&quot;, progname);</a>
<a name="ln77">	else</a>
<a name="ln78">		printf(</a>
<a name="ln79">&quot;Usage : %s [OPTION...]\n\</a>
<a name="ln80">Daemon which manages NHRP protocol.\n\n\</a>
<a name="ln81">-d, --daemon       Runs in daemon mode\n\</a>
<a name="ln82">-f, --config_file  Set configuration file name\n\</a>
<a name="ln83">-i, --pid_file     Set process identifier file name\n\</a>
<a name="ln84">-z, --socket       Set path of zebra socket\n\</a>
<a name="ln85">-A, --vty_addr     Set vty's bind address\n\</a>
<a name="ln86">-P, --vty_port     Set vty's port number\n\</a>
<a name="ln87">-u, --user         User to run as\n\</a>
<a name="ln88">-g, --group        Group to run as\n\</a>
<a name="ln89">-v, --version      Print program version\n\</a>
<a name="ln90">-h, --help         Display this help and exit\n\</a>
<a name="ln91">\n\</a>
<a name="ln92">Report bugs to %s\n&quot;, progname, ZEBRA_BUG_ADDRESS);</a>
<a name="ln93"> </a>
<a name="ln94">	exit(status);</a>
<a name="ln95">}</a>
<a name="ln96"> </a>
<a name="ln97">static void parse_arguments(const char *progname, int argc, char **argv)</a>
<a name="ln98">{</a>
<a name="ln99">	int opt;</a>
<a name="ln100"> </a>
<a name="ln101">	while (1) {</a>
<a name="ln102">		opt = getopt_long(argc, argv, &quot;df:i:z:hA:P:u:g:v&quot;, longopts, 0);</a>
<a name="ln103">		if(opt &lt; 0) break;</a>
<a name="ln104"> </a>
<a name="ln105">		switch (opt) {</a>
<a name="ln106">		case 0:</a>
<a name="ln107">			break;</a>
<a name="ln108">		case 'd':</a>
<a name="ln109">			do_daemonise = -1;</a>
<a name="ln110">			break;</a>
<a name="ln111">		case 'f':</a>
<a name="ln112">			config_file = optarg;</a>
<a name="ln113">			break;</a>
<a name="ln114">		case 'i':</a>
<a name="ln115">			pid_file = optarg;</a>
<a name="ln116">			break;</a>
<a name="ln117">		case 'z':</a>
<a name="ln118">			zclient_serv_path_set(optarg);</a>
<a name="ln119">			break;</a>
<a name="ln120">		case 'A':</a>
<a name="ln121">			vty_addr = optarg;</a>
<a name="ln122">			break;</a>
<a name="ln123">		case 'P':</a>
<a name="ln124">			vty_port = atoi (optarg);</a>
<a name="ln125">			if (vty_port &lt;= 0 || vty_port &gt; 0xffff)</a>
<a name="ln126">				vty_port = NHRP_VTY_PORT;</a>
<a name="ln127">			break;</a>
<a name="ln128">		case 'u':</a>
<a name="ln129">			nhrpd_privs.user = optarg;</a>
<a name="ln130">			break;</a>
<a name="ln131">		case 'g':</a>
<a name="ln132">			nhrpd_privs.group = optarg;</a>
<a name="ln133">			break;</a>
<a name="ln134">		case 'v':</a>
<a name="ln135">			print_version(progname);</a>
<a name="ln136">			exit(0);</a>
<a name="ln137">			break;</a>
<a name="ln138">		case 'h':</a>
<a name="ln139">			usage(progname, 0);</a>
<a name="ln140">			break;</a>
<a name="ln141">		default:</a>
<a name="ln142">			usage(progname, 1);</a>
<a name="ln143">			break;</a>
<a name="ln144">		}</a>
<a name="ln145">	}</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148">static void nhrp_sigusr1(void)</a>
<a name="ln149">{</a>
<a name="ln150">	zlog_rotate(NULL);</a>
<a name="ln151">}</a>
<a name="ln152"> </a>
<a name="ln153">static void nhrp_request_stop(void)</a>
<a name="ln154">{</a>
<a name="ln155">	debugf(NHRP_DEBUG_COMMON, &quot;Exiting...&quot;);</a>
<a name="ln156"> </a>
<a name="ln157">	nhrp_shortcut_terminate();</a>
<a name="ln158">	nhrp_nhs_terminate();</a>
<a name="ln159">	nhrp_zebra_terminate();</a>
<a name="ln160">	vici_terminate();</a>
<a name="ln161">	evmgr_terminate();</a>
<a name="ln162">	nhrp_vc_terminate();</a>
<a name="ln163">	vrf_terminate();</a>
<a name="ln164">	/* memory_terminate(); */</a>
<a name="ln165">	/* vty_terminate(); */</a>
<a name="ln166">	cmd_terminate();</a>
<a name="ln167">	/* signal_terminate(); */</a>
<a name="ln168">	zprivs_terminate(&amp;nhrpd_privs);</a>
<a name="ln169"> </a>
<a name="ln170">	debugf(NHRP_DEBUG_COMMON, &quot;Remove pid file.&quot;);</a>
<a name="ln171">	if (pid_file) unlink(pid_file);</a>
<a name="ln172">	debugf(NHRP_DEBUG_COMMON, &quot;Done.&quot;);</a>
<a name="ln173"> </a>
<a name="ln174">	closezlog(zlog_default);</a>
<a name="ln175"> </a>
<a name="ln176">	exit(0);</a>
<a name="ln177">}</a>
<a name="ln178"> </a>
<a name="ln179">static struct quagga_signal_t sighandlers[] = {</a>
<a name="ln180">	{ .signal = SIGUSR1, .handler = &amp;nhrp_sigusr1, },</a>
<a name="ln181">	{ .signal = SIGINT,  .handler = &amp;nhrp_request_stop, },</a>
<a name="ln182">	{ .signal = SIGTERM, .handler = &amp;nhrp_request_stop, },</a>
<a name="ln183">};</a>
<a name="ln184"> </a>
<a name="ln185">int main(int argc, char **argv)</a>
<a name="ln186">{</a>
<a name="ln187">	const char *progname;</a>
<a name="ln188"> </a>
<a name="ln189">	/* Set umask before anything for security */</a>
<a name="ln190">	umask(0027);</a>
<a name="ln191">	progname = basename(argv[0]);</a>
<a name="ln192">	zlog_default = openzlog(progname, ZLOG_NHRP, LOG_CONS|LOG_NDELAY|LOG_PID, LOG_DAEMON);</a>
<a name="ln193">	zlog_set_level(NULL, ZLOG_DEST_STDOUT, LOG_WARNING);</a>
<a name="ln194"> </a>
<a name="ln195">	parse_arguments(progname, argc, argv);</a>
<a name="ln196"> </a>
<a name="ln197">	/* Library inits. */</a>
<a name="ln198">	master = thread_master_create();</a>
<a name="ln199">	zprivs_init(&amp;nhrpd_privs);</a>
<a name="ln200">	signal_init(master, array_size(sighandlers), sighandlers);</a>
<a name="ln201">	cmd_init(1);</a>
<a name="ln202">	vty_init(master);</a>
<a name="ln203">	memory_init();</a>
<a name="ln204">	nhrp_interface_init();</a>
<a name="ln205">	vrf_init();</a>
<a name="ln206">	resolver_init();</a>
<a name="ln207"> </a>
<a name="ln208">	/* Run with elevated capabilities, as for all netlink activity</a>
<a name="ln209">	 * we need privileges anyway. */</a>
<a name="ln210">	nhrpd_privs.change(ZPRIVS_RAISE);</a>
<a name="ln211"> </a>
<a name="ln212">	netlink_init();</a>
<a name="ln213">	evmgr_init();</a>
<a name="ln214">	nhrp_vc_init();</a>
<a name="ln215">	nhrp_packet_init();</a>
<a name="ln216">	vici_init();</a>
<a name="ln217">	nhrp_zebra_init();</a>
<a name="ln218">	nhrp_shortcut_init();</a>
<a name="ln219"> </a>
<a name="ln220">	nhrp_config_init();</a>
<a name="ln221"> </a>
<a name="ln222">	/* Get zebra configuration file. */</a>
<a name="ln223">	zlog_set_level(NULL, ZLOG_DEST_STDOUT, do_daemonise ? ZLOG_DISABLED : LOG_DEBUG);</a>
<a name="ln224">	vty_read_config(config_file, config_default);</a>
<a name="ln225"> </a>
<a name="ln226">	if (do_daemonise &amp;&amp; daemon(0, 0) &lt; 0) {</a>
<a name="ln227">		zlog_err(&quot;daemonise: %s&quot;, safe_strerror(errno));</a>
<a name="ln228">		exit (1);</a>
<a name="ln229">	}</a>
<a name="ln230"> </a>
<a name="ln231">	/* write pid file */</a>
<a name="ln232">	if (pid_output(pid_file) &lt; 0) {</a>
<a name="ln233">		zlog_err(&quot;error while writing pidfile&quot;);</a>
<a name="ln234">		exit (1);</a>
<a name="ln235">	}</a>
<a name="ln236"> </a>
<a name="ln237">	/* Create VTY socket */</a>
<a name="ln238">	vty_serv_sock(vty_addr, vty_port, NHRP_VTYSH_PATH);</a>
<a name="ln239">	zlog_notice(&quot;nhrpd starting: vty@%d&quot;, vty_port);</a>
<a name="ln240"> </a>
<a name="ln241">	/* Main loop */</a>
<a name="ln242">	thread_main (master);</a>
<a name="ln243"> </a>
<a name="ln244">	return 0;</a>
<a name="ln245">}</a>

</code></pre>
<div class="balloon" rel="5"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
