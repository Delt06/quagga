
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>netlink_gre.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/* NHRP netlink/GRE tunnel configuration code</a>
<a name="ln2"> * Copyright (c) 2014-2016 Timo Ter√§s</a>
<a name="ln3"> *</a>
<a name="ln4"> * This file is free software: you may copy, redistribute and/or modify</a>
<a name="ln5"> * it under the terms of the GNU General Public License as published by</a>
<a name="ln6"> * the Free Software Foundation, either version 2 of the License, or</a>
<a name="ln7"> * (at your option) any later version.</a>
<a name="ln8"> */</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;sys/socket.h&gt;</a>
<a name="ln11">#include &lt;linux/netlink.h&gt;</a>
<a name="ln12">#include &lt;linux/rtnetlink.h&gt;</a>
<a name="ln13">#include &lt;linux/in.h&gt;</a>
<a name="ln14">#include &lt;linux/if.h&gt;</a>
<a name="ln15">#include &lt;linux/ip.h&gt;</a>
<a name="ln16">#include &lt;linux/ipv6.h&gt;</a>
<a name="ln17">#include &lt;linux/if_tunnel.h&gt;</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;debug.h&quot;</a>
<a name="ln20">#include &quot;netlink.h&quot;</a>
<a name="ln21">#include &quot;znl.h&quot;</a>
<a name="ln22"> </a>
<a name="ln23">static int __netlink_gre_get_data(struct zbuf *zb, struct zbuf *data, int ifindex)</a>
<a name="ln24">{</a>
<a name="ln25">	struct nlmsghdr *n;</a>
<a name="ln26">	struct ifinfomsg *ifi;</a>
<a name="ln27">	struct zbuf payload, rtapayload;</a>
<a name="ln28">	struct rtattr *rta;</a>
<a name="ln29"> </a>
<a name="ln30">	debugf(NHRP_DEBUG_KERNEL, &quot;netlink-link-gre: get-info %u&quot;, ifindex);</a>
<a name="ln31"> </a>
<a name="ln32">	n = znl_nlmsg_push(zb, RTM_GETLINK, NLM_F_REQUEST);</a>
<a name="ln33">	ifi = znl_push(zb, sizeof(*ifi));</a>
<a name="ln34">	*ifi = (struct ifinfomsg) {</a>
<a name="ln35">		.ifi_index = ifindex,</a>
<a name="ln36">	};</a>
<a name="ln37">	znl_nlmsg_complete(zb, n);</a>
<a name="ln38"> </a>
<a name="ln39">	if (zbuf_send(zb, netlink_req_fd) &lt; 0 ||</a>
<a name="ln40">	    zbuf_recv(zb, netlink_req_fd) &lt; 0)</a>
<a name="ln41">		return -1;</a>
<a name="ln42"> </a>
<a name="ln43">	n = znl_nlmsg_pull(zb, &amp;payload);</a>
<a name="ln44">	if (!n) return -1;</a>
<a name="ln45"> </a>
<a name="ln46">	if (n-&gt;nlmsg_type != RTM_NEWLINK)</a>
<a name="ln47">		return -1;</a>
<a name="ln48"> </a>
<a name="ln49">	ifi = znl_pull(&amp;payload, sizeof(struct ifinfomsg));</a>
<a name="ln50">	if (!ifi)</a>
<a name="ln51">		return -1;</a>
<a name="ln52"> </a>
<a name="ln53">	debugf(NHRP_DEBUG_KERNEL, &quot;netlink-link-gre: ifindex %u, receive msg_type %u, msg_flags %u&quot;,</a>
<a name="ln54">		ifi-&gt;ifi_index, n-&gt;nlmsg_type, n-&gt;nlmsg_flags);</a>
<a name="ln55"> </a>
<a name="ln56">	if (ifi-&gt;ifi_index != ifindex)</a>
<a name="ln57">		return -1;</a>
<a name="ln58"> </a>
<a name="ln59">	while ((rta = znl_rta_pull(&amp;payload, &amp;rtapayload)) != NULL)</a>
<a name="ln60">		if (rta-&gt;rta_type == IFLA_LINKINFO)</a>
<a name="ln61">			break;</a>
<a name="ln62">	if (!rta) return -1;</a>
<a name="ln63"> </a>
<a name="ln64">	payload = rtapayload;</a>
<a name="ln65">	while ((rta = znl_rta_pull(&amp;payload, &amp;rtapayload)) != NULL)</a>
<a name="ln66">		if (rta-&gt;rta_type == IFLA_INFO_DATA)</a>
<a name="ln67">			break;</a>
<a name="ln68">	if (!rta) return -1;</a>
<a name="ln69"> </a>
<a name="ln70">	*data = rtapayload;</a>
<a name="ln71">	return 0;</a>
<a name="ln72">}</a>
<a name="ln73"> </a>
<a name="ln74">void netlink_gre_get_info(unsigned int ifindex, uint32_t *gre_key, unsigned int *link_index, struct in_addr *saddr)</a>
<a name="ln75">{</a>
<a name="ln76">	struct zbuf *zb = zbuf_alloc(8192), data, rtapl;</a>
<a name="ln77">	struct rtattr *rta;</a>
<a name="ln78"> </a>
<a name="ln79">	*link_index = 0;</a>
<a name="ln80">	*gre_key = 0;</a>
<a name="ln81">	saddr-&gt;s_addr = 0;</a>
<a name="ln82"> </a>
<a name="ln83">	if (__netlink_gre_get_data(zb, &amp;data, ifindex) &lt; 0)</a>
<a name="ln84">		goto err;</a>
<a name="ln85"> </a>
<a name="ln86">	while ((rta = znl_rta_pull(&amp;data, &amp;rtapl)) != NULL) {</a>
<a name="ln87">		switch (rta-&gt;rta_type) {</a>
<a name="ln88">		case IFLA_GRE_LINK:</a>
<a name="ln89">			*link_index = zbuf_get32(&amp;rtapl);</a>
<a name="ln90">			break;</a>
<a name="ln91">		case IFLA_GRE_IKEY:</a>
<a name="ln92">		case IFLA_GRE_OKEY:</a>
<a name="ln93">			*gre_key = zbuf_get32(&amp;rtapl);</a>
<a name="ln94">			break;</a>
<a name="ln95">		case IFLA_GRE_LOCAL:</a>
<a name="ln96">			saddr-&gt;s_addr = zbuf_get32(&amp;rtapl);</a>
<a name="ln97">			break;</a>
<a name="ln98">		}</a>
<a name="ln99">	}</a>
<a name="ln100">err:</a>
<a name="ln101">	zbuf_free(zb);</a>
<a name="ln102">}</a>
<a name="ln103"> </a>
<a name="ln104">void netlink_gre_set_link(unsigned int ifindex, unsigned int link_index)</a>
<a name="ln105">{</a>
<a name="ln106">	struct nlmsghdr *n;</a>
<a name="ln107">	struct ifinfomsg *ifi;</a>
<a name="ln108">	struct rtattr *rta_info, *rta_data, *rta;</a>
<a name="ln109">	struct zbuf *zr = zbuf_alloc(8192), data, rtapl;</a>
<a name="ln110">	struct zbuf *zb = zbuf_alloc(8192);</a>
<a name="ln111">	size_t len;</a>
<a name="ln112"> </a>
<a name="ln113">	if (__netlink_gre_get_data(zr, &amp;data, ifindex) &lt; 0)</a>
<a name="ln114">		goto err;</a>
<a name="ln115"> </a>
<a name="ln116">	n = znl_nlmsg_push(zb, RTM_NEWLINK, NLM_F_REQUEST);</a>
<a name="ln117">	ifi = znl_push(zb, sizeof(*ifi));</a>
<a name="ln118">	*ifi = (struct ifinfomsg) {</a>
<a name="ln119">		.ifi_index = ifindex,</a>
<a name="ln120">	};</a>
<a name="ln121">	rta_info = znl_rta_nested_push(zb, IFLA_LINKINFO);</a>
<a name="ln122">	znl_rta_push(zb, IFLA_INFO_KIND, &quot;gre&quot;, 3);</a>
<a name="ln123">	rta_data = znl_rta_nested_push(zb, IFLA_INFO_DATA);</a>
<a name="ln124"> </a>
<a name="ln125">	znl_rta_push_u32(zb, IFLA_GRE_LINK, link_index);</a>
<a name="ln126">	while ((rta = znl_rta_pull(&amp;data, &amp;rtapl)) != NULL) {</a>
<a name="ln127">		if (rta-&gt;rta_type == IFLA_GRE_LINK)</a>
<a name="ln128">			continue;</a>
<a name="ln129">		len = zbuf_used(&amp;rtapl);</a>
<a name="ln130">		znl_rta_push(zb, rta-&gt;rta_type, zbuf_pulln(&amp;rtapl, len), len);</a>
<a name="ln131">	}</a>
<a name="ln132"> </a>
<a name="ln133">	znl_rta_nested_complete(zb, rta_data);</a>
<a name="ln134">	znl_rta_nested_complete(zb, rta_info);</a>
<a name="ln135"> </a>
<a name="ln136">	znl_nlmsg_complete(zb, n);</a>
<a name="ln137">	zbuf_send(zb, netlink_req_fd);</a>
<a name="ln138">	zbuf_recv(zb, netlink_req_fd);</a>
<a name="ln139">err:</a>
<a name="ln140">	zbuf_free(zb);</a>
<a name="ln141">	zbuf_free(zr);</a>
<a name="ln142">}</a>

</code></pre>
<div class="balloon" rel="5"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
