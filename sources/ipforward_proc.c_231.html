
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ipforward_proc.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Fetch ipforward value by reading /proc filesystem.</a>
<a name="ln3"> * Copyright (C) 1997 Kunihiro Ishiguro</a>
<a name="ln4"> *</a>
<a name="ln5"> * This file is part of GNU Zebra.</a>
<a name="ln6"> *</a>
<a name="ln7"> * GNU Zebra is free software; you can redistribute it and/or modify it</a>
<a name="ln8"> * under the terms of the GNU General Public License as published by the</a>
<a name="ln9"> * Free Software Foundation; either version 2, or (at your option) any</a>
<a name="ln10"> * later version.</a>
<a name="ln11"> *</a>
<a name="ln12"> * GNU Zebra is distributed in the hope that it will be useful, but</a>
<a name="ln13"> * WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln14"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln15"> * General Public License for more details.</a>
<a name="ln16"> *</a>
<a name="ln17"> * You should have received a copy of the GNU General Public License</a>
<a name="ln18"> * along with GNU Zebra; see the file COPYING.  If not, write to the Free</a>
<a name="ln19"> * Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</a>
<a name="ln20"> * 02111-1307, USA.  </a>
<a name="ln21"> */</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;zebra.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &quot;log.h&quot;</a>
<a name="ln26">#include &quot;privs.h&quot;</a>
<a name="ln27"> </a>
<a name="ln28">#include &quot;zebra/ipforward.h&quot;</a>
<a name="ln29"> </a>
<a name="ln30">extern struct zebra_privs_t zserv_privs;</a>
<a name="ln31"> </a>
<a name="ln32">char proc_net_snmp[] = &quot;/proc/net/snmp&quot;;</a>
<a name="ln33"> </a>
<a name="ln34">static void</a>
<a name="ln35">dropline (FILE *fp)</a>
<a name="ln36">{</a>
<a name="ln37">  int c;</a>
<a name="ln38"> </a>
<a name="ln39">  while ((c = getc (fp)) != '\n')</a>
<a name="ln40">    ;</a>
<a name="ln41">}</a>
<a name="ln42"> </a>
<a name="ln43">int</a>
<a name="ln44">ipforward (void)</a>
<a name="ln45">{</a>
<a name="ln46">  FILE *fp;</a>
<a name="ln47">  int ipforwarding = 0;</a>
<a name="ln48">  char buf[10];</a>
<a name="ln49"> </a>
<a name="ln50">  fp = fopen (proc_net_snmp, &quot;r&quot;);</a>
<a name="ln51"> </a>
<a name="ln52">  if (fp == NULL)</a>
<a name="ln53">    return -1;</a>
<a name="ln54"> </a>
<a name="ln55">  /* We don't care about the first line. */</a>
<a name="ln56">  dropline (fp);</a>
<a name="ln57">  </a>
<a name="ln58">  /* Get ip_statistics.IpForwarding : </a>
<a name="ln59">     1 =&gt; ip forwarding enabled </a>
<a name="ln60">     2 =&gt; ip forwarding off. */</a>
<a name="ln61">  if (fgets (buf, 6, fp))</a>
<a name="ln62">    sscanf (buf, &quot;Ip: %d&quot;, &amp;ipforwarding);</a>
<a name="ln63"> </a>
<a name="ln64">  fclose(fp);</a>
<a name="ln65">  </a>
<a name="ln66">  if (ipforwarding == 1)</a>
<a name="ln67">    return 1;</a>
<a name="ln68"> </a>
<a name="ln69">  return 0;</a>
<a name="ln70">}</a>
<a name="ln71"> </a>
<a name="ln72">/* char proc_ipv4_forwarding[] = &quot;/proc/sys/net/ipv4/conf/all/forwarding&quot;; */</a>
<a name="ln73">char proc_ipv4_forwarding[] = &quot;/proc/sys/net/ipv4/ip_forward&quot;;</a>
<a name="ln74"> </a>
<a name="ln75">int</a>
<a name="ln76">ipforward_on (void)</a>
<a name="ln77">{</a>
<a name="ln78">  FILE *fp;</a>
<a name="ln79">  </a>
<a name="ln80">  if ( zserv_privs.change(ZPRIVS_RAISE) )</a>
<a name="ln81">  	zlog_err (&quot;Can't raise privileges, %s&quot;, safe_strerror (errno) );</a>
<a name="ln82"> </a>
<a name="ln83">  fp = fopen (proc_ipv4_forwarding, &quot;w&quot;);</a>
<a name="ln84"> </a>
<a name="ln85">  if (fp == NULL) {</a>
<a name="ln86">    if ( zserv_privs.change(ZPRIVS_LOWER) )</a>
<a name="ln87">      zlog_err (&quot;Can't lower privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln88">    return -1;</a>
<a name="ln89">  }</a>
<a name="ln90"> </a>
<a name="ln91">  fprintf (fp, &quot;1\n&quot;);</a>
<a name="ln92"> </a>
<a name="ln93">  fclose (fp);</a>
<a name="ln94"> </a>
<a name="ln95">  if ( zserv_privs.change(ZPRIVS_LOWER) )</a>
<a name="ln96">    zlog_err (&quot;Can't lower privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln97"> </a>
<a name="ln98">  return ipforward ();</a>
<a name="ln99">}</a>
<a name="ln100"> </a>
<a name="ln101">int</a>
<a name="ln102">ipforward_off (void)</a>
<a name="ln103">{</a>
<a name="ln104">  FILE *fp;</a>
<a name="ln105"> </a>
<a name="ln106">  if ( zserv_privs.change(ZPRIVS_RAISE) )</a>
<a name="ln107">  	zlog_err (&quot;Can't raise privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln108"> </a>
<a name="ln109">  fp = fopen (proc_ipv4_forwarding, &quot;w&quot;);</a>
<a name="ln110"> </a>
<a name="ln111">  if (fp == NULL) {</a>
<a name="ln112">    if ( zserv_privs.change(ZPRIVS_LOWER) )</a>
<a name="ln113">      zlog_err (&quot;Can't lower privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln114">    return -1;</a>
<a name="ln115">  }</a>
<a name="ln116"> </a>
<a name="ln117">  fprintf (fp, &quot;0\n&quot;);</a>
<a name="ln118"> </a>
<a name="ln119">  fclose (fp);</a>
<a name="ln120"> </a>
<a name="ln121">  if ( zserv_privs.change(ZPRIVS_LOWER) )</a>
<a name="ln122">    zlog_err (&quot;Can't lower privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln123"> </a>
<a name="ln124">  return ipforward ();</a>
<a name="ln125">}</a>
<a name="ln126">#ifdef HAVE_IPV6</a>
<a name="ln127"> </a>
<a name="ln128">char proc_ipv6_forwarding[] = &quot;/proc/sys/net/ipv6/conf/all/forwarding&quot;;</a>
<a name="ln129"> </a>
<a name="ln130">int</a>
<a name="ln131">ipforward_ipv6 (void)</a>
<a name="ln132">{</a>
<a name="ln133">  FILE *fp;</a>
<a name="ln134">  char buf[5];</a>
<a name="ln135">  int ipforwarding = 0;</a>
<a name="ln136"> </a>
<a name="ln137">  fp = fopen (proc_ipv6_forwarding, &quot;r&quot;);</a>
<a name="ln138"> </a>
<a name="ln139">  if (fp == NULL)</a>
<a name="ln140">    return -1;</a>
<a name="ln141"> </a>
<a name="ln142">  if (fgets (buf, 2, fp))</a>
<a name="ln143">    sscanf (buf, &quot;%d&quot;, &amp;ipforwarding);</a>
<a name="ln144"> </a>
<a name="ln145">  fclose (fp);</a>
<a name="ln146">  return ipforwarding;</a>
<a name="ln147">}</a>
<a name="ln148"> </a>
<a name="ln149">int</a>
<a name="ln150">ipforward_ipv6_on (void)</a>
<a name="ln151">{</a>
<a name="ln152">  FILE *fp;</a>
<a name="ln153"> </a>
<a name="ln154">  if ( zserv_privs.change(ZPRIVS_RAISE) )</a>
<a name="ln155">  	zlog_err (&quot;Can't raise privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln156"> </a>
<a name="ln157">  fp = fopen (proc_ipv6_forwarding, &quot;w&quot;);</a>
<a name="ln158"> </a>
<a name="ln159">  if (fp == NULL) {</a>
<a name="ln160">    if ( zserv_privs.change(ZPRIVS_LOWER) )</a>
<a name="ln161">      zlog_err (&quot;Can't lower privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln162">    return -1;</a>
<a name="ln163">  }</a>
<a name="ln164"> </a>
<a name="ln165">  fprintf (fp, &quot;1\n&quot;);</a>
<a name="ln166"> </a>
<a name="ln167">  fclose (fp);</a>
<a name="ln168"> </a>
<a name="ln169">  if ( zserv_privs.change(ZPRIVS_LOWER) )</a>
<a name="ln170">    zlog_err (&quot;Can't lower privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln171"> </a>
<a name="ln172">  return ipforward_ipv6 ();</a>
<a name="ln173">}</a>
<a name="ln174"> </a>
<a name="ln175">int</a>
<a name="ln176">ipforward_ipv6_off (void)</a>
<a name="ln177">{</a>
<a name="ln178">  FILE *fp;</a>
<a name="ln179"> </a>
<a name="ln180">  if ( zserv_privs.change(ZPRIVS_RAISE) )</a>
<a name="ln181">  	zlog_err (&quot;Can't raise privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln182"> </a>
<a name="ln183">  fp = fopen (proc_ipv6_forwarding, &quot;w&quot;);</a>
<a name="ln184"> </a>
<a name="ln185">  if (fp == NULL) {</a>
<a name="ln186">    if ( zserv_privs.change(ZPRIVS_LOWER) )</a>
<a name="ln187">      zlog_err (&quot;Can't lower privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln188">    return -1;</a>
<a name="ln189">  }</a>
<a name="ln190"> </a>
<a name="ln191">  fprintf (fp, &quot;0\n&quot;);</a>
<a name="ln192"> </a>
<a name="ln193">  fclose (fp);</a>
<a name="ln194"> </a>
<a name="ln195">  if ( zserv_privs.change(ZPRIVS_LOWER) )</a>
<a name="ln196">    zlog_err (&quot;Can't lower privileges, %s&quot;, safe_strerror (errno));</a>
<a name="ln197"> </a>
<a name="ln198">  return ipforward_ipv6 ();</a>
<a name="ln199">}</a>
<a name="ln200">#endif /* HAVE_IPV6 */</a>

</code></pre>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
