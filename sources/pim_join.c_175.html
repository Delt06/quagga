
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>pim_join.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">  PIM for Quagga</a>
<a name="ln3">  Copyright (C) 2008  Everton da Silva Marques</a>
<a name="ln4"> </a>
<a name="ln5">  This program is free software; you can redistribute it and/or modify</a>
<a name="ln6">  it under the terms of the GNU General Public License as published by</a>
<a name="ln7">  the Free Software Foundation; either version 2 of the License, or</a>
<a name="ln8">  (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">  This program is distributed in the hope that it will be useful, but</a>
<a name="ln11">  WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln13">  General Public License for more details.</a>
<a name="ln14">  </a>
<a name="ln15">  You should have received a copy of the GNU General Public License</a>
<a name="ln16">  along with this program; see the file COPYING; if not, write to the</a>
<a name="ln17">  Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston,</a>
<a name="ln18">  MA 02110-1301 USA</a>
<a name="ln19">  </a>
<a name="ln20">  $QuaggaId: $Format:%an, %ai, %h$ $</a>
<a name="ln21">*/</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;zebra.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &quot;log.h&quot;</a>
<a name="ln26">#include &quot;prefix.h&quot;</a>
<a name="ln27"> </a>
<a name="ln28">#include &quot;pimd.h&quot;</a>
<a name="ln29">#include &quot;pim_str.h&quot;</a>
<a name="ln30">#include &quot;pim_tlv.h&quot;</a>
<a name="ln31">#include &quot;pim_msg.h&quot;</a>
<a name="ln32">#include &quot;pim_pim.h&quot;</a>
<a name="ln33">#include &quot;pim_join.h&quot;</a>
<a name="ln34">#include &quot;pim_iface.h&quot;</a>
<a name="ln35">#include &quot;pim_hello.h&quot;</a>
<a name="ln36">#include &quot;pim_ifchannel.h&quot;</a>
<a name="ln37"> </a>
<a name="ln38">static void on_trace(const char *label,</a>
<a name="ln39">		     struct interface *ifp, struct in_addr src)</a>
<a name="ln40">{</a>
<a name="ln41">  if (PIM_DEBUG_PIM_TRACE) {</a>
<a name="ln42">    char src_str[100];</a>
<a name="ln43">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src, src_str, sizeof(src_str));</a>
<a name="ln44">    zlog_debug(&quot;%s: from %s on %s&quot;,</a>
<a name="ln45">	       label, src_str, ifp-&gt;name);</a>
<a name="ln46">  }</a>
<a name="ln47">}</a>
<a name="ln48"> </a>
<a name="ln49">static void recv_join(struct interface *ifp,</a>
<a name="ln50">		      struct pim_neighbor *neigh,</a>
<a name="ln51">		      uint16_t holdtime,</a>
<a name="ln52">		      struct in_addr upstream,</a>
<a name="ln53">		      struct in_addr group,</a>
<a name="ln54">		      struct in_addr source,</a>
<a name="ln55">		      uint8_t source_flags)</a>
<a name="ln56">{</a>
<a name="ln57">  if (PIM_DEBUG_PIM_TRACE) {</a>
<a name="ln58">    char up_str[100];</a>
<a name="ln59">    char src_str[100];</a>
<a name="ln60">    char grp_str[100];</a>
<a name="ln61">    char neigh_str[100];</a>
<a name="ln62">    pim_inet4_dump(&quot;&lt;upstream?&gt;&quot;, upstream, up_str, sizeof(up_str));</a>
<a name="ln63">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, source, src_str, sizeof(src_str));</a>
<a name="ln64">    pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, group, grp_str, sizeof(grp_str));</a>
<a name="ln65">    pim_inet4_dump(&quot;&lt;neigh?&gt;&quot;, neigh-&gt;source_addr, neigh_str, sizeof(neigh_str));</a>
<a name="ln66">    zlog_warn(&quot;%s: join (S,G)=(%s,%s) rpt=%d wc=%d upstream=%s holdtime=%d from %s on %s&quot;,</a>
<a name="ln67">	      __PRETTY_FUNCTION__,</a>
<a name="ln68">	      src_str, grp_str,</a>
<a name="ln69">	      source_flags &amp; PIM_RPT_BIT_MASK,</a>
<a name="ln70">	      source_flags &amp; PIM_WILDCARD_BIT_MASK,</a>
<a name="ln71">	      up_str, holdtime, neigh_str, ifp-&gt;name);</a>
<a name="ln72">  }</a>
<a name="ln73">  </a>
<a name="ln74">  /* Restart join expiry timer */</a>
<a name="ln75">  pim_ifchannel_join_add(ifp, neigh-&gt;source_addr, upstream,</a>
<a name="ln76">			 source, group, source_flags, holdtime);</a>
<a name="ln77">}</a>
<a name="ln78"> </a>
<a name="ln79">static void recv_prune(struct interface *ifp,</a>
<a name="ln80">		       struct pim_neighbor *neigh,</a>
<a name="ln81">		       uint16_t holdtime,</a>
<a name="ln82">		       struct in_addr upstream,</a>
<a name="ln83">		       struct in_addr group,</a>
<a name="ln84">		       struct in_addr source,</a>
<a name="ln85">		       uint8_t source_flags)</a>
<a name="ln86">{</a>
<a name="ln87">  if (PIM_DEBUG_PIM_TRACE) {</a>
<a name="ln88">    char up_str[100];</a>
<a name="ln89">    char src_str[100];</a>
<a name="ln90">    char grp_str[100];</a>
<a name="ln91">    char neigh_str[100];</a>
<a name="ln92">    pim_inet4_dump(&quot;&lt;upstream?&gt;&quot;, upstream, up_str, sizeof(up_str));</a>
<a name="ln93">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, source, src_str, sizeof(src_str));</a>
<a name="ln94">    pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, group, grp_str, sizeof(grp_str));</a>
<a name="ln95">    pim_inet4_dump(&quot;&lt;neigh?&gt;&quot;, neigh-&gt;source_addr, neigh_str, sizeof(neigh_str));</a>
<a name="ln96">    zlog_warn(&quot;%s: prune (S,G)=(%s,%s) rpt=%d wc=%d upstream=%s holdtime=%d from %s on %s&quot;,</a>
<a name="ln97">	      __PRETTY_FUNCTION__,</a>
<a name="ln98">	      src_str, grp_str,</a>
<a name="ln99">	      source_flags &amp; PIM_RPT_BIT_MASK,</a>
<a name="ln100">	      source_flags &amp; PIM_WILDCARD_BIT_MASK,</a>
<a name="ln101">	      up_str, holdtime, neigh_str, ifp-&gt;name);</a>
<a name="ln102">  }</a>
<a name="ln103">  </a>
<a name="ln104">  pim_ifchannel_prune(ifp, upstream, source, group, source_flags, holdtime);</a>
<a name="ln105">}</a>
<a name="ln106"> </a>
<a name="ln107">int pim_joinprune_recv(struct interface *ifp,</a>
<a name="ln108">		       struct pim_neighbor *neigh,</a>
<a name="ln109">		       struct in_addr src_addr,</a>
<a name="ln110">		       uint8_t *tlv_buf, int tlv_buf_size)</a>
<a name="ln111">{</a>
<a name="ln112">  struct prefix   msg_upstream_addr;</a>
<a name="ln113">  uint8_t         msg_num_groups;</a>
<a name="ln114">  uint16_t        msg_holdtime;</a>
<a name="ln115">  int             addr_offset;</a>
<a name="ln116">  uint8_t        *buf;</a>
<a name="ln117">  uint8_t        *pastend;</a>
<a name="ln118">  int             remain;</a>
<a name="ln119">  int             group;</a>
<a name="ln120"> </a>
<a name="ln121">  on_trace(__PRETTY_FUNCTION__, ifp, src_addr);</a>
<a name="ln122"> </a>
<a name="ln123">  buf     = tlv_buf;</a>
<a name="ln124">  pastend = tlv_buf + tlv_buf_size;</a>
<a name="ln125"> </a>
<a name="ln126">  /*</a>
<a name="ln127">    Parse ucast addr</a>
<a name="ln128">  */</a>
<a name="ln129">  addr_offset = pim_parse_addr_ucast(ifp-&gt;name, src_addr,</a>
<a name="ln130">				     &amp;msg_upstream_addr,</a>
<a name="ln131">				     buf, pastend - buf);</a>
<a name="ln132">#if 0</a>
<a name="ln133">  zlog_warn(&quot;%s: pim_parse_addr_ucast addr_offset=%d&quot;,</a>
<a name="ln134">            __PRETTY_FUNCTION__,</a>
<a name="ln135">            addr_offset);</a>
<a name="ln136">#endif</a>
<a name="ln137">  if (addr_offset &lt; 1) {</a>
<a name="ln138">    char src_str[100];</a>
<a name="ln139">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln140">    zlog_warn(&quot;%s: pim_parse_addr_ucast() failure: from %s on %s&quot;,</a>
<a name="ln141">	      __PRETTY_FUNCTION__,</a>
<a name="ln142">	      src_str, ifp-&gt;name);</a>
<a name="ln143">    return -1;</a>
<a name="ln144">  }</a>
<a name="ln145">  buf += addr_offset;</a>
<a name="ln146"> </a>
<a name="ln147">  /*</a>
<a name="ln148">    Check upstream address family</a>
<a name="ln149">   */</a>
<a name="ln150">  if (msg_upstream_addr.family != AF_INET) {</a>
<a name="ln151">    if (PIM_DEBUG_PIM_TRACE) {</a>
<a name="ln152">      char src_str[100];</a>
<a name="ln153">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln154">      zlog_warn(&quot;%s: ignoring join/prune directed to unexpected addr family=%d from %s on %s&quot;,</a>
<a name="ln155">		__PRETTY_FUNCTION__,</a>
<a name="ln156">		msg_upstream_addr.family, src_str, ifp-&gt;name);</a>
<a name="ln157">    }</a>
<a name="ln158">    return -2;</a>
<a name="ln159">  }</a>
<a name="ln160"> </a>
<a name="ln161">  remain = pastend - buf;</a>
<a name="ln162">  if (remain &lt; 4) {</a>
<a name="ln163">    char src_str[100];</a>
<a name="ln164">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln165">    zlog_warn(&quot;%s: short join/prune message buffer for group list: size=%d minimum=%d from %s on %s&quot;,</a>
<a name="ln166">	      __PRETTY_FUNCTION__,</a>
<a name="ln167">	      remain, 4, src_str, ifp-&gt;name);</a>
<a name="ln168">    return -4;</a>
<a name="ln169">  }</a>
<a name="ln170"> </a>
<a name="ln171">  ++buf; /* skip reserved byte */</a>
<a name="ln172">  msg_num_groups = *(const uint8_t *) buf;</a>
<a name="ln173">  ++buf;</a>
<a name="ln174">  msg_holdtime = ntohs(*(const uint16_t *) buf);</a>
<a name="ln175">  ++buf;</a>
<a name="ln176">  ++buf;</a>
<a name="ln177"> </a>
<a name="ln178">  if (PIM_DEBUG_PIM_TRACE) {</a>
<a name="ln179">    char src_str[100];</a>
<a name="ln180">    char upstream_str[100];</a>
<a name="ln181">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln182">    pim_inet4_dump(&quot;&lt;addr?&gt;&quot;, msg_upstream_addr.u.prefix4,</a>
<a name="ln183">		   upstream_str, sizeof(upstream_str));</a>
<a name="ln184">    zlog_warn(&quot;%s: join/prune upstream=%s groups=%d holdtime=%d from %s on %s&quot;,</a>
<a name="ln185">	      __PRETTY_FUNCTION__,</a>
<a name="ln186">	      upstream_str, msg_num_groups, msg_holdtime,</a>
<a name="ln187">	      src_str, ifp-&gt;name);</a>
<a name="ln188">  }</a>
<a name="ln189"> </a>
<a name="ln190">  /* Scan groups */</a>
<a name="ln191">  for (group = 0; group &lt; msg_num_groups; ++group) {</a>
<a name="ln192">    struct prefix msg_group_addr;</a>
<a name="ln193">    struct prefix msg_source_addr;</a>
<a name="ln194">    uint8_t       msg_source_flags;</a>
<a name="ln195">    uint16_t      msg_num_joined_sources;</a>
<a name="ln196">    uint16_t      msg_num_pruned_sources;</a>
<a name="ln197">    int           source;</a>
<a name="ln198"> </a>
<a name="ln199">    addr_offset = pim_parse_addr_group(ifp-&gt;name, src_addr,</a>
<a name="ln200">				       &amp;msg_group_addr,</a>
<a name="ln201">				       buf, pastend - buf);</a>
<a name="ln202">#if 0</a>
<a name="ln203">    zlog_warn(&quot;%s: pim_parse_addr_group addr_offset=%d&quot;,</a>
<a name="ln204">              __PRETTY_FUNCTION__,</a>
<a name="ln205">              addr_offset);</a>
<a name="ln206">#endif</a>
<a name="ln207">    if (addr_offset &lt; 1) {</a>
<a name="ln208">      return -5;</a>
<a name="ln209">    }</a>
<a name="ln210">    buf += addr_offset;</a>
<a name="ln211"> </a>
<a name="ln212">    remain = pastend - buf;</a>
<a name="ln213">    if (remain &lt; 4) {</a>
<a name="ln214">      char src_str[100];</a>
<a name="ln215">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln216">      zlog_warn(&quot;%s: short join/prune buffer for source list: size=%d minimum=%d from %s on %s&quot;,</a>
<a name="ln217">		__PRETTY_FUNCTION__,</a>
<a name="ln218">		remain, 4, src_str, ifp-&gt;name);</a>
<a name="ln219">      return -6;</a>
<a name="ln220">    }</a>
<a name="ln221"> </a>
<a name="ln222">    msg_num_joined_sources = ntohs(*(const uint16_t *) buf);</a>
<a name="ln223">    buf += 2;</a>
<a name="ln224">    msg_num_pruned_sources = ntohs(*(const uint16_t *) buf);</a>
<a name="ln225">    buf += 2;</a>
<a name="ln226"> </a>
<a name="ln227">    if (PIM_DEBUG_PIM_TRACE) {</a>
<a name="ln228">      char src_str[100];</a>
<a name="ln229">      char upstream_str[100];</a>
<a name="ln230">      char group_str[100];</a>
<a name="ln231">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, src_addr, src_str, sizeof(src_str));</a>
<a name="ln232">      pim_inet4_dump(&quot;&lt;addr?&gt;&quot;, msg_upstream_addr.u.prefix4,</a>
<a name="ln233">		     upstream_str, sizeof(upstream_str));</a>
<a name="ln234">      pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, msg_group_addr.u.prefix4,</a>
<a name="ln235">		     group_str, sizeof(group_str));</a>
<a name="ln236">      zlog_warn(&quot;%s: join/prune upstream=%s group=%s/%d join_src=%d prune_src=%d from %s on %s&quot;,</a>
<a name="ln237">		__PRETTY_FUNCTION__,</a>
<a name="ln238">		upstream_str, group_str, msg_group_addr.prefixlen,</a>
<a name="ln239">		msg_num_joined_sources, msg_num_pruned_sources,</a>
<a name="ln240">		src_str, ifp-&gt;name);</a>
<a name="ln241">    }</a>
<a name="ln242"> </a>
<a name="ln243">    /* Scan joined sources */</a>
<a name="ln244">    for (source = 0; source &lt; msg_num_joined_sources; ++source) {</a>
<a name="ln245">      addr_offset = pim_parse_addr_source(ifp-&gt;name, src_addr,</a>
<a name="ln246">					  &amp;msg_source_addr,</a>
<a name="ln247">					  &amp;msg_source_flags,</a>
<a name="ln248">					  buf, pastend - buf);</a>
<a name="ln249">#if 0</a>
<a name="ln250">      zlog_warn(&quot;%s: pim_parse_addr_source addr_offset=%d&quot;,</a>
<a name="ln251">                __PRETTY_FUNCTION__,</a>
<a name="ln252">                addr_offset);</a>
<a name="ln253">#endif</a>
<a name="ln254">      if (addr_offset &lt; 1) {</a>
<a name="ln255">	return -7;</a>
<a name="ln256">      }</a>
<a name="ln257"> </a>
<a name="ln258">      buf += addr_offset;</a>
<a name="ln259"> </a>
<a name="ln260">      recv_join(ifp, neigh, msg_holdtime,</a>
<a name="ln261">		msg_upstream_addr.u.prefix4,</a>
<a name="ln262">		msg_group_addr.u.prefix4,</a>
<a name="ln263">		msg_source_addr.u.prefix4,</a>
<a name="ln264">		msg_source_flags);</a>
<a name="ln265">    }</a>
<a name="ln266"> </a>
<a name="ln267">    /* Scan pruned sources */</a>
<a name="ln268">    for (source = 0; source &lt; msg_num_pruned_sources; ++source) {</a>
<a name="ln269">      addr_offset = pim_parse_addr_source(ifp-&gt;name, src_addr,</a>
<a name="ln270">					  &amp;msg_source_addr,</a>
<a name="ln271">					  &amp;msg_source_flags,</a>
<a name="ln272">					  buf, pastend - buf);</a>
<a name="ln273">      if (addr_offset &lt; 1) {</a>
<a name="ln274">	return -8;</a>
<a name="ln275">      }</a>
<a name="ln276"> </a>
<a name="ln277">      buf += addr_offset;</a>
<a name="ln278"> </a>
<a name="ln279">      recv_prune(ifp, neigh, msg_holdtime,</a>
<a name="ln280">		 msg_upstream_addr.u.prefix4,</a>
<a name="ln281">		 msg_group_addr.u.prefix4,</a>
<a name="ln282">		 msg_source_addr.u.prefix4,</a>
<a name="ln283">		 msg_source_flags);</a>
<a name="ln284">    }</a>
<a name="ln285"> </a>
<a name="ln286">  } /* scan groups */</a>
<a name="ln287"> </a>
<a name="ln288">  return 0;</a>
<a name="ln289">}</a>
<a name="ln290"> </a>
<a name="ln291">int pim_joinprune_send(struct interface *ifp,</a>
<a name="ln292">		       struct in_addr upstream_addr,</a>
<a name="ln293">		       struct in_addr source_addr,</a>
<a name="ln294">		       struct in_addr group_addr,</a>
<a name="ln295">		       int send_join)</a>
<a name="ln296">{</a>
<a name="ln297">  struct pim_interface *pim_ifp;</a>
<a name="ln298">  uint8_t pim_msg[1000];</a>
<a name="ln299">  const uint8_t *pastend = pim_msg + sizeof(pim_msg);</a>
<a name="ln300">  uint8_t *pim_msg_curr = pim_msg + PIM_MSG_HEADER_LEN; /* room for pim header */</a>
<a name="ln301">  int pim_msg_size;</a>
<a name="ln302">  int remain;</a>
<a name="ln303"> </a>
<a name="ln304">  zassert(ifp);</a>
<a name="ln305"> </a>
<a name="ln306">  pim_ifp = ifp-&gt;info;</a>
<a name="ln307"> </a>
<a name="ln308">  if (!pim_ifp) {</a>
<a name="ln309">    zlog_warn(&quot;%s: multicast not enabled on interface %s&quot;,</a>
<a name="ln310">	      __PRETTY_FUNCTION__,</a>
<a name="ln311">	      ifp-&gt;name);</a>
<a name="ln312">    return -1;</a>
<a name="ln313">  }</a>
<a name="ln314"> </a>
<a name="ln315">  if (PIM_DEBUG_PIM_TRACE) {</a>
<a name="ln316">    char source_str[100];</a>
<a name="ln317">    char group_str[100];</a>
<a name="ln318">    char dst_str[100];</a>
<a name="ln319">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, source_addr, source_str, sizeof(source_str));</a>
<a name="ln320">    pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, group_addr, group_str, sizeof(group_str));</a>
<a name="ln321">    pim_inet4_dump(&quot;&lt;dst?&gt;&quot;, upstream_addr, dst_str, sizeof(dst_str));</a>
<a name="ln322">    zlog_debug(&quot;%s: sending %s(S,G)=(%s,%s) to upstream=%s on interface %s&quot;,</a>
<a name="ln323">	       __PRETTY_FUNCTION__,</a>
<a name="ln324">	       send_join ? &quot;Join&quot; : &quot;Prune&quot;,</a>
<a name="ln325">	       source_str, group_str, dst_str, ifp-&gt;name);</a>
<a name="ln326">  }</a>
<a name="ln327"> </a>
<a name="ln328">  if (PIM_INADDR_IS_ANY(upstream_addr)) {</a>
<a name="ln329">    if (PIM_DEBUG_PIM_TRACE) {</a>
<a name="ln330">      char source_str[100];</a>
<a name="ln331">      char group_str[100];</a>
<a name="ln332">      char dst_str[100];</a>
<a name="ln333">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, source_addr, source_str, sizeof(source_str));</a>
<a name="ln334">      pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, group_addr, group_str, sizeof(group_str));</a>
<a name="ln335">      pim_inet4_dump(&quot;&lt;dst?&gt;&quot;, upstream_addr, dst_str, sizeof(dst_str));</a>
<a name="ln336">      zlog_debug(&quot;%s: %s(S,G)=(%s,%s): upstream=%s is myself on interface %s&quot;,</a>
<a name="ln337">		 __PRETTY_FUNCTION__,</a>
<a name="ln338">		 send_join ? &quot;Join&quot; : &quot;Prune&quot;,</a>
<a name="ln339">		 source_str, group_str, dst_str, ifp-&gt;name);</a>
<a name="ln340">    }</a>
<a name="ln341">    return 0;</a>
<a name="ln342">  }</a>
<a name="ln343"> </a>
<a name="ln344">  /*</a>
<a name="ln345">    RFC 4601: 4.3.1.  Sending Hello Messages</a>
<a name="ln346"> </a>
<a name="ln347">    Thus, if a router needs to send a Join/Prune or Assert message on</a>
<a name="ln348">    an interface on which it has not yet sent a Hello message with the</a>
<a name="ln349">    currently configured IP address, then it MUST immediately send the</a>
<a name="ln350">    relevant Hello message without waiting for the Hello Timer to</a>
<a name="ln351">    expire, followed by the Join/Prune or Assert message.</a>
<a name="ln352">  */</a>
<a name="ln353">  pim_hello_require(ifp);</a>
<a name="ln354"> </a>
<a name="ln355">  /*</a>
<a name="ln356">    Build PIM message</a>
<a name="ln357">  */</a>
<a name="ln358"> </a>
<a name="ln359">  remain = pastend - pim_msg_curr;</a>
<a name="ln360">  pim_msg_curr = pim_msg_addr_encode_ipv4_ucast(pim_msg_curr,</a>
<a name="ln361">						remain,</a>
<a name="ln362">						upstream_addr);</a>
<a name="ln363">  if (!pim_msg_curr) {</a>
<a name="ln364">    char dst_str[100];</a>
<a name="ln365">    pim_inet4_dump(&quot;&lt;dst?&gt;&quot;, upstream_addr, dst_str, sizeof(dst_str));</a>
<a name="ln366">    zlog_warn(&quot;%s: failure encoding destination address %s: space left=%d&quot;,</a>
<a name="ln367">	      __PRETTY_FUNCTION__, dst_str, remain);</a>
<a name="ln368">    return -3;</a>
<a name="ln369">  }</a>
<a name="ln370"> </a>
<a name="ln371">  remain = pastend - pim_msg_curr;</a>
<a name="ln372">  if (remain &lt; 4) {</a>
<a name="ln373">    zlog_warn(&quot;%s: group will not fit: space left=%d&quot;,</a>
<a name="ln374">	    __PRETTY_FUNCTION__, remain);</a>
<a name="ln375">    return -4;</a>
<a name="ln376">  }</a>
<a name="ln377"> </a>
<a name="ln378">  *pim_msg_curr = 0; /* reserved */</a>
<a name="ln379">  ++pim_msg_curr;</a>
<a name="ln380">  *pim_msg_curr = 1; /* number of groups */</a>
<a name="ln381">  ++pim_msg_curr;</a>
<a name="ln382">  *((uint16_t *) pim_msg_curr) = htons(PIM_JP_HOLDTIME);</a>
<a name="ln383">  ++pim_msg_curr;</a>
<a name="ln384">  ++pim_msg_curr;</a>
<a name="ln385"> </a>
<a name="ln386">  remain = pastend - pim_msg_curr;</a>
<a name="ln387">  pim_msg_curr = pim_msg_addr_encode_ipv4_group(pim_msg_curr,</a>
<a name="ln388">						remain,</a>
<a name="ln389">						group_addr);</a>
<a name="ln390">  if (!pim_msg_curr) {</a>
<a name="ln391">    char group_str[100];</a>
<a name="ln392">    pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, group_addr, group_str, sizeof(group_str));</a>
<a name="ln393">    zlog_warn(&quot;%s: failure encoding group address %s: space left=%d&quot;,</a>
<a name="ln394">	      __PRETTY_FUNCTION__, group_str, remain);</a>
<a name="ln395">    return -5;</a>
<a name="ln396">  }</a>
<a name="ln397"> </a>
<a name="ln398">  remain = pastend - pim_msg_curr;</a>
<a name="ln399">  if (remain &lt; 4) {</a>
<a name="ln400">    zlog_warn(&quot;%s: sources will not fit: space left=%d&quot;,</a>
<a name="ln401">	      __PRETTY_FUNCTION__, remain);</a>
<a name="ln402">    return -6;</a>
<a name="ln403">  }</a>
<a name="ln404"> </a>
<a name="ln405">  /* number of joined sources */</a>
<a name="ln406">  *((uint16_t *) pim_msg_curr) = htons(send_join ? 1 : 0);</a>
<a name="ln407">  ++pim_msg_curr;</a>
<a name="ln408">  ++pim_msg_curr;</a>
<a name="ln409"> </a>
<a name="ln410">  /* number of pruned sources */</a>
<a name="ln411">  *((uint16_t *) pim_msg_curr) = htons(send_join ? 0 : 1);</a>
<a name="ln412">  ++pim_msg_curr;</a>
<a name="ln413">  ++pim_msg_curr;</a>
<a name="ln414"> </a>
<a name="ln415">  remain = pastend - pim_msg_curr;</a>
<a name="ln416">  pim_msg_curr = pim_msg_addr_encode_ipv4_source(pim_msg_curr,</a>
<a name="ln417">						 remain,</a>
<a name="ln418">						 source_addr);</a>
<a name="ln419">  if (!pim_msg_curr) {</a>
<a name="ln420">    char source_str[100];</a>
<a name="ln421">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, source_addr, source_str, sizeof(source_str));</a>
<a name="ln422">    zlog_warn(&quot;%s: failure encoding source address %s: space left=%d&quot;,</a>
<a name="ln423">	      __PRETTY_FUNCTION__, source_str, remain);</a>
<a name="ln424">    return -7;</a>
<a name="ln425">  }</a>
<a name="ln426"> </a>
<a name="ln427">  /* Add PIM header */</a>
<a name="ln428"> </a>
<a name="ln429">  pim_msg_size = pim_msg_curr - pim_msg;</a>
<a name="ln430"> </a>
<a name="ln431">  pim_msg_build_header(pim_msg, pim_msg_size,</a>
<a name="ln432">		       PIM_MSG_TYPE_JOIN_PRUNE);</a>
<a name="ln433"> </a>
<a name="ln434">  if (pim_msg_send(pim_ifp-&gt;pim_sock_fd,</a>
<a name="ln435">		   qpim_all_pim_routers_addr,</a>
<a name="ln436">		   pim_msg,</a>
<a name="ln437">		   pim_msg_size,</a>
<a name="ln438">		   ifp-&gt;name)) {</a>
<a name="ln439">    zlog_warn(&quot;%s: could not send PIM message on interface %s&quot;,</a>
<a name="ln440">	      __PRETTY_FUNCTION__, ifp-&gt;name);</a>
<a name="ln441">    return -8;</a>
<a name="ln442">  }</a>
<a name="ln443"> </a>
<a name="ln444">  return 0;</a>
<a name="ln445">}</a>

</code></pre>
<div class="balloon" rel="6"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
