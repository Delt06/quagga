
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ospf6_intra.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * Copyright (C) 2003 Yasuhiro Ohara</a>
<a name="ln3"> *</a>
<a name="ln4"> * This file is part of GNU Zebra.</a>
<a name="ln5"> *</a>
<a name="ln6"> * GNU Zebra is free software; you can redistribute it and/or modify it</a>
<a name="ln7"> * under the terms of the GNU General Public License as published by the</a>
<a name="ln8"> * Free Software Foundation; either version 2, or (at your option) any</a>
<a name="ln9"> * later version.</a>
<a name="ln10"> *</a>
<a name="ln11"> * GNU Zebra is distributed in the hope that it will be useful, but</a>
<a name="ln12"> * WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln13"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln14"> * General Public License for more details.</a>
<a name="ln15"> *</a>
<a name="ln16"> * You should have received a copy of the GNU General Public License</a>
<a name="ln17"> * along with GNU Zebra; see the file COPYING.  If not, write to the </a>
<a name="ln18"> * Free Software Foundation, Inc., 59 Temple Place - Suite 330, </a>
<a name="ln19"> * Boston, MA 02111-1307, USA.  </a>
<a name="ln20"> */</a>
<a name="ln21"> </a>
<a name="ln22">#include &lt;zebra.h&gt;</a>
<a name="ln23"> </a>
<a name="ln24">#include &quot;log.h&quot;</a>
<a name="ln25">#include &quot;linklist.h&quot;</a>
<a name="ln26">#include &quot;thread.h&quot;</a>
<a name="ln27">#include &quot;memory.h&quot;</a>
<a name="ln28">#include &quot;if.h&quot;</a>
<a name="ln29">#include &quot;prefix.h&quot;</a>
<a name="ln30">#include &quot;table.h&quot;</a>
<a name="ln31">#include &quot;vty.h&quot;</a>
<a name="ln32">#include &quot;command.h&quot;</a>
<a name="ln33"> </a>
<a name="ln34">#include &quot;ospf6_proto.h&quot;</a>
<a name="ln35">#include &quot;ospf6_message.h&quot;</a>
<a name="ln36">#include &quot;ospf6_route.h&quot;</a>
<a name="ln37">#include &quot;ospf6_lsa.h&quot;</a>
<a name="ln38">#include &quot;ospf6_lsdb.h&quot;</a>
<a name="ln39"> </a>
<a name="ln40">#include &quot;ospf6_top.h&quot;</a>
<a name="ln41">#include &quot;ospf6_area.h&quot;</a>
<a name="ln42">#include &quot;ospf6_interface.h&quot;</a>
<a name="ln43">#include &quot;ospf6_neighbor.h&quot;</a>
<a name="ln44">#include &quot;ospf6_intra.h&quot;</a>
<a name="ln45">#include &quot;ospf6_asbr.h&quot;</a>
<a name="ln46">#include &quot;ospf6_abr.h&quot;</a>
<a name="ln47">#include &quot;ospf6_flood.h&quot;</a>
<a name="ln48">#include &quot;ospf6d.h&quot;</a>
<a name="ln49">#include &quot;ospf6_spf.h&quot;</a>
<a name="ln50"> </a>
<a name="ln51">unsigned char conf_debug_ospf6_brouter = 0;</a>
<a name="ln52">u_int32_t conf_debug_ospf6_brouter_specific_router_id;</a>
<a name="ln53">u_int32_t conf_debug_ospf6_brouter_specific_area_id;</a>
<a name="ln54"> </a>
<a name="ln55">/******************************/</a>
<a name="ln56">/* RFC2740 3.4.3.1 Router-LSA */</a>
<a name="ln57">/******************************/</a>
<a name="ln58"> </a>
<a name="ln59">static char *</a>
<a name="ln60">ospf6_router_lsa_get_nbr_id (struct ospf6_lsa *lsa, char *buf, int buflen,</a>
<a name="ln61">			     int pos)</a>
<a name="ln62">{</a>
<a name="ln63">  struct ospf6_router_lsa *router_lsa;</a>
<a name="ln64">  struct ospf6_router_lsdesc *lsdesc;</a>
<a name="ln65">  char *start, *end;</a>
<a name="ln66">  char buf1[INET_ADDRSTRLEN], buf2[INET_ADDRSTRLEN];</a>
<a name="ln67"> </a>
<a name="ln68">  if (lsa)</a>
<a name="ln69">    {</a>
<a name="ln70">      router_lsa = (struct ospf6_router_lsa *)</a>
<a name="ln71">	((char *) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln72">      start = (char *) router_lsa + sizeof (struct ospf6_router_lsa);</a>
<a name="ln73">      end = (char *) lsa-&gt;header + ntohs (lsa-&gt;header-&gt;length);</a>
<a name="ln74"> </a>
<a name="ln75">      lsdesc = (struct ospf6_router_lsdesc *)</a>
<a name="ln76">	(start + pos*(sizeof (struct ospf6_router_lsdesc)));</a>
<a name="ln77">      if ((char *)lsdesc &lt; end)</a>
<a name="ln78">	{</a>
<a name="ln79">	  if (buf &amp;&amp; (buflen &gt; INET_ADDRSTRLEN*2))</a>
<a name="ln80">	    {</a>
<a name="ln81">	      inet_ntop (AF_INET, &amp;lsdesc-&gt;neighbor_interface_id,</a>
<a name="ln82">			 buf1, sizeof(buf1));</a>
<a name="ln83">	      inet_ntop (AF_INET, &amp;lsdesc-&gt;neighbor_router_id,</a>
<a name="ln84">			 buf2, sizeof(buf2));</a>
<a name="ln85">	      sprintf (buf, &quot;%s/%s&quot;, buf2, buf1);</a>
<a name="ln86">	    }</a>
<a name="ln87">	}</a>
<a name="ln88">      else</a>
<a name="ln89">	return NULL;</a>
<a name="ln90">    }</a>
<a name="ln91"> </a>
<a name="ln92">  return buf;</a>
<a name="ln93">}</a>
<a name="ln94"> </a>
<a name="ln95">static int</a>
<a name="ln96">ospf6_router_lsa_show (struct vty *vty, struct ospf6_lsa *lsa)</a>
<a name="ln97">{</a>
<a name="ln98">  char *start, *end, *current;</a>
<a name="ln99">  char buf[32], name[32], bits[16], options[32];</a>
<a name="ln100">  struct ospf6_router_lsa *router_lsa;</a>
<a name="ln101">  struct ospf6_router_lsdesc *lsdesc;</a>
<a name="ln102"> </a>
<a name="ln103">  router_lsa = (struct ospf6_router_lsa *)</a>
<a name="ln104">    ((char *) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln105"> </a>
<a name="ln106">  ospf6_capability_printbuf (router_lsa-&gt;bits, bits, sizeof (bits));</a>
<a name="ln107">  ospf6_options_printbuf (router_lsa-&gt;options, options, sizeof (options));</a>
<a name="ln108">  vty_out (vty, &quot;    Bits: %s Options: %s%s&quot;, bits, options, VNL);</a>
<a name="ln109"> </a>
<a name="ln110">  start = (char *) router_lsa + sizeof (struct ospf6_router_lsa);</a>
<a name="ln111">  end = (char *) lsa-&gt;header + ntohs (lsa-&gt;header-&gt;length);</a>
<a name="ln112">  for (current = start; current + sizeof (struct ospf6_router_lsdesc) &lt;= end;</a>
<a name="ln113">       current += sizeof (struct ospf6_router_lsdesc))</a>
<a name="ln114">    {</a>
<a name="ln115">      lsdesc = (struct ospf6_router_lsdesc *) current;</a>
<a name="ln116"> </a>
<a name="ln117">      if (lsdesc-&gt;type == OSPF6_ROUTER_LSDESC_POINTTOPOINT)</a>
<a name="ln118">        snprintf (name, sizeof (name), &quot;Point-To-Point&quot;);</a>
<a name="ln119">      else if (lsdesc-&gt;type == OSPF6_ROUTER_LSDESC_TRANSIT_NETWORK)</a>
<a name="ln120">        snprintf (name, sizeof (name), &quot;Transit-Network&quot;);</a>
<a name="ln121">      else if (lsdesc-&gt;type == OSPF6_ROUTER_LSDESC_STUB_NETWORK)</a>
<a name="ln122">        snprintf (name, sizeof (name), &quot;Stub-Network&quot;);</a>
<a name="ln123">      else if (lsdesc-&gt;type == OSPF6_ROUTER_LSDESC_VIRTUAL_LINK)</a>
<a name="ln124">        snprintf (name, sizeof (name), &quot;Virtual-Link&quot;);</a>
<a name="ln125">      else</a>
<a name="ln126">        snprintf (name, sizeof (name), &quot;Unknown (%#x)&quot;, lsdesc-&gt;type);</a>
<a name="ln127"> </a>
<a name="ln128">      vty_out (vty, &quot;    Type: %s Metric: %d%s&quot;,</a>
<a name="ln129">               name, ntohs (lsdesc-&gt;metric), VNL);</a>
<a name="ln130">      vty_out (vty, &quot;    Interface ID: %s%s&quot;,</a>
<a name="ln131">               inet_ntop (AF_INET, &amp;lsdesc-&gt;interface_id,</a>
<a name="ln132">                          buf, sizeof (buf)), VNL);</a>
<a name="ln133">      vty_out (vty, &quot;    Neighbor Interface ID: %s%s&quot;,</a>
<a name="ln134">               inet_ntop (AF_INET, &amp;lsdesc-&gt;neighbor_interface_id,</a>
<a name="ln135">                          buf, sizeof (buf)), VNL);</a>
<a name="ln136">      vty_out (vty, &quot;    Neighbor Router ID: %s%s&quot;,</a>
<a name="ln137">               inet_ntop (AF_INET, &amp;lsdesc-&gt;neighbor_router_id,</a>
<a name="ln138">                          buf, sizeof (buf)), VNL);</a>
<a name="ln139">    }</a>
<a name="ln140">  return 0;</a>
<a name="ln141">}</a>
<a name="ln142"> </a>
<a name="ln143">int</a>
<a name="ln144">ospf6_router_is_stub_router (struct ospf6_lsa *lsa)</a>
<a name="ln145">{</a>
<a name="ln146">  struct ospf6_router_lsa *rtr_lsa;</a>
<a name="ln147"> </a>
<a name="ln148">  if (lsa != NULL &amp;&amp; OSPF6_LSA_IS_TYPE (ROUTER, lsa))</a>
<a name="ln149">    {</a>
<a name="ln150">      rtr_lsa = (struct ospf6_router_lsa *)</a>
<a name="ln151">	((caddr_t) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln152"> </a>
<a name="ln153">      if (!OSPF6_OPT_ISSET (rtr_lsa-&gt;options, OSPF6_OPT_R))</a>
<a name="ln154">	{</a>
<a name="ln155">	  return (OSPF6_IS_STUB_ROUTER);</a>
<a name="ln156">	}</a>
<a name="ln157">      else if (!OSPF6_OPT_ISSET (rtr_lsa-&gt;options, OSPF6_OPT_V6))</a>
<a name="ln158">	{</a>
<a name="ln159">	  return (OSPF6_IS_STUB_ROUTER_V6);</a>
<a name="ln160">	}</a>
<a name="ln161">    }</a>
<a name="ln162"> </a>
<a name="ln163">  return (OSPF6_NOT_STUB_ROUTER);</a>
<a name="ln164">}</a>
<a name="ln165"> </a>
<a name="ln166">int</a>
<a name="ln167">ospf6_router_lsa_originate (struct thread *thread)</a>
<a name="ln168">{</a>
<a name="ln169">  struct ospf6_area *oa;</a>
<a name="ln170"> </a>
<a name="ln171">  char buffer [OSPF6_MAX_LSASIZE];</a>
<a name="ln172">  struct ospf6_lsa_header *lsa_header;</a>
<a name="ln173">  struct ospf6_lsa *lsa;</a>
<a name="ln174"> </a>
<a name="ln175">  u_int32_t link_state_id = 0;</a>
<a name="ln176">  struct listnode *node, *nnode;</a>
<a name="ln177">  struct listnode *j;</a>
<a name="ln178">  struct ospf6_interface *oi;</a>
<a name="ln179">  struct ospf6_neighbor *on, *drouter = NULL;</a>
<a name="ln180">  struct ospf6_router_lsa *router_lsa;</a>
<a name="ln181">  struct ospf6_router_lsdesc *lsdesc;</a>
<a name="ln182">  u_int16_t type;</a>
<a name="ln183">  u_int32_t router;</a>
<a name="ln184">  int count;</a>
<a name="ln185"> </a>
<a name="ln186">  oa = (struct ospf6_area *) THREAD_ARG (thread);</a>
<a name="ln187">  oa-&gt;thread_router_lsa = NULL;</a>
<a name="ln188"> </a>
<a name="ln189">  if (IS_OSPF6_DEBUG_ORIGINATE (ROUTER))</a>
<a name="ln190">    zlog_debug (&quot;Originate Router-LSA for Area %s&quot;, oa-&gt;name);</a>
<a name="ln191"> </a>
<a name="ln192">  memset (buffer, 0, sizeof (buffer));</a>
<a name="ln193">  lsa_header = (struct ospf6_lsa_header *) buffer;</a>
<a name="ln194">  router_lsa = (struct ospf6_router_lsa *)</a>
<a name="ln195">    ((caddr_t) lsa_header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln196"> </a>
<a name="ln197">  OSPF6_OPT_SET (router_lsa-&gt;options, OSPF6_OPT_V6);</a>
<a name="ln198">  OSPF6_OPT_SET (router_lsa-&gt;options, OSPF6_OPT_E);</a>
<a name="ln199">  OSPF6_OPT_CLEAR (router_lsa-&gt;options, OSPF6_OPT_MC);</a>
<a name="ln200">  OSPF6_OPT_CLEAR (router_lsa-&gt;options, OSPF6_OPT_N);</a>
<a name="ln201">  OSPF6_OPT_SET (router_lsa-&gt;options, OSPF6_OPT_R);</a>
<a name="ln202">  OSPF6_OPT_CLEAR (router_lsa-&gt;options, OSPF6_OPT_DC);</a>
<a name="ln203"> </a>
<a name="ln204">  if (ospf6_is_router_abr (ospf6))</a>
<a name="ln205">    SET_FLAG (router_lsa-&gt;bits, OSPF6_ROUTER_BIT_B);</a>
<a name="ln206">  else</a>
<a name="ln207">    UNSET_FLAG (router_lsa-&gt;bits, OSPF6_ROUTER_BIT_B);</a>
<a name="ln208">  if (ospf6_asbr_is_asbr (ospf6))</a>
<a name="ln209">    SET_FLAG (router_lsa-&gt;bits, OSPF6_ROUTER_BIT_E);</a>
<a name="ln210">  else</a>
<a name="ln211">    UNSET_FLAG (router_lsa-&gt;bits, OSPF6_ROUTER_BIT_E);</a>
<a name="ln212">  UNSET_FLAG (router_lsa-&gt;bits, OSPF6_ROUTER_BIT_V);</a>
<a name="ln213">  UNSET_FLAG (router_lsa-&gt;bits, OSPF6_ROUTER_BIT_W);</a>
<a name="ln214"> </a>
<a name="ln215">  /* describe links for each interfaces */</a>
<a name="ln216">  lsdesc = (struct ospf6_router_lsdesc *)</a>
<a name="ln217">    ((caddr_t) router_lsa + sizeof (struct ospf6_router_lsa));</a>
<a name="ln218"> </a>
<a name="ln219">  for (ALL_LIST_ELEMENTS (oa-&gt;if_list, node, nnode, oi))</a>
<a name="ln220">    {</a>
<a name="ln221">      /* Interfaces in state Down or Loopback are not described */</a>
<a name="ln222">      if (oi-&gt;state == OSPF6_INTERFACE_DOWN ||</a>
<a name="ln223">          oi-&gt;state == OSPF6_INTERFACE_LOOPBACK)</a>
<a name="ln224">        continue;</a>
<a name="ln225"> </a>
<a name="ln226">      /* Nor are interfaces without any full adjacencies described */</a>
<a name="ln227">      count = 0;</a>
<a name="ln228">      for (ALL_LIST_ELEMENTS_RO (oi-&gt;neighbor_list, j, on))</a>
<a name="ln229">        if (on-&gt;state == OSPF6_NEIGHBOR_FULL)</a>
<a name="ln230">          count++;</a>
<a name="ln231">      </a>
<a name="ln232">      if (count == 0)</a>
<a name="ln233">        continue;</a>
<a name="ln234"> </a>
<a name="ln235">      /* Multiple Router-LSA instance according to size limit setting */</a>
<a name="ln236">      if ( (oa-&gt;router_lsa_size_limit != 0)</a>
<a name="ln237">          &amp;&amp; ((size_t)((char *)lsdesc - buffer)</a>
<a name="ln238">                 + sizeof (struct ospf6_router_lsdesc)</a>
<a name="ln239">               &gt; oa-&gt;router_lsa_size_limit))</a>
<a name="ln240">        {</a>
<a name="ln241">          if ((caddr_t) lsdesc == (caddr_t) router_lsa +</a>
<a name="ln242">                                  sizeof (struct ospf6_router_lsa))</a>
<a name="ln243">            {</a>
<a name="ln244">              if (IS_OSPF6_DEBUG_ORIGINATE (ROUTER))</a>
<a name="ln245">                zlog_debug (&quot;Size limit setting for Router-LSA too short&quot;);</a>
<a name="ln246">              return 0;</a>
<a name="ln247">            }</a>
<a name="ln248"> </a>
<a name="ln249">          link_state_id ++;</a>
<a name="ln250">        }</a>
<a name="ln251"> </a>
<a name="ln252">      /* Point-to-Point interfaces */</a>
<a name="ln253">      if (oi-&gt;type == OSPF_IFTYPE_POINTOPOINT)</a>
<a name="ln254">        {</a>
<a name="ln255">          for (ALL_LIST_ELEMENTS_RO (oi-&gt;neighbor_list, j, on))</a>
<a name="ln256">            {</a>
<a name="ln257">              if (on-&gt;state != OSPF6_NEIGHBOR_FULL)</a>
<a name="ln258">                continue;</a>
<a name="ln259"> </a>
<a name="ln260">              lsdesc-&gt;type = OSPF6_ROUTER_LSDESC_POINTTOPOINT;</a>
<a name="ln261">              lsdesc-&gt;metric = htons (oi-&gt;cost);</a>
<a name="ln262">              lsdesc-&gt;interface_id = htonl (oi-&gt;interface-&gt;ifindex);</a>
<a name="ln263">              lsdesc-&gt;neighbor_interface_id = htonl (on-&gt;ifindex);</a>
<a name="ln264">              lsdesc-&gt;neighbor_router_id = on-&gt;router_id;</a>
<a name="ln265"> </a>
<a name="ln266">              lsdesc++;</a>
<a name="ln267">            }</a>
<a name="ln268">        }</a>
<a name="ln269"> </a>
<a name="ln270">      /* Broadcast and NBMA interfaces */</a>
<a name="ln271">      else if (oi-&gt;type == OSPF_IFTYPE_BROADCAST)</a>
<a name="ln272">        {</a>
<a name="ln273">          /* If this router is not DR,</a>
<a name="ln274">             and If this router not fully adjacent with DR,</a>
<a name="ln275">             this interface is not transit yet: ignore. */</a>
<a name="ln276">          if (oi-&gt;state != OSPF6_INTERFACE_DR)</a>
<a name="ln277">            {</a>
<a name="ln278">              drouter = ospf6_neighbor_lookup (oi-&gt;drouter, oi);</a>
<a name="ln279">              if (drouter == NULL || drouter-&gt;state != OSPF6_NEIGHBOR_FULL)</a>
<a name="ln280">                continue;</a>
<a name="ln281">            }</a>
<a name="ln282"> </a>
<a name="ln283">          lsdesc-&gt;type = OSPF6_ROUTER_LSDESC_TRANSIT_NETWORK;</a>
<a name="ln284">          lsdesc-&gt;metric = htons (oi-&gt;cost);</a>
<a name="ln285">          lsdesc-&gt;interface_id = htonl (oi-&gt;interface-&gt;ifindex);</a>
<a name="ln286">          if (oi-&gt;state != OSPF6_INTERFACE_DR)</a>
<a name="ln287">            {</a>
<a name="ln288">              lsdesc-&gt;neighbor_interface_id = htonl (drouter-&gt;ifindex);</a>
<a name="ln289">              lsdesc-&gt;neighbor_router_id = drouter-&gt;router_id;</a>
<a name="ln290">            }</a>
<a name="ln291">          else</a>
<a name="ln292">            {</a>
<a name="ln293">              lsdesc-&gt;neighbor_interface_id = htonl (oi-&gt;interface-&gt;ifindex);</a>
<a name="ln294">              lsdesc-&gt;neighbor_router_id = oi-&gt;area-&gt;ospf6-&gt;router_id;</a>
<a name="ln295">            }</a>
<a name="ln296"> </a>
<a name="ln297">          lsdesc++;</a>
<a name="ln298">        }</a>
<a name="ln299">      else</a>
<a name="ln300">	{</a>
<a name="ln301">	  assert (0);		/* Unknown interface type */</a>
<a name="ln302">	}</a>
<a name="ln303"> </a>
<a name="ln304">      /* Virtual links */</a>
<a name="ln305">        /* xxx */</a>
<a name="ln306">      /* Point-to-Multipoint interfaces */</a>
<a name="ln307">        /* xxx */</a>
<a name="ln308">    }</a>
<a name="ln309"> </a>
<a name="ln310">  /* Fill LSA Header */</a>
<a name="ln311">  lsa_header-&gt;age = 0;</a>
<a name="ln312">  lsa_header-&gt;type = htons (OSPF6_LSTYPE_ROUTER);</a>
<a name="ln313">  lsa_header-&gt;id = htonl (link_state_id);</a>
<a name="ln314">  lsa_header-&gt;adv_router = oa-&gt;ospf6-&gt;router_id;</a>
<a name="ln315">  lsa_header-&gt;seqnum =</a>
<a name="ln316">    ospf6_new_ls_seqnum (lsa_header-&gt;type, lsa_header-&gt;id,</a>
<a name="ln317">			 lsa_header-&gt;adv_router, oa-&gt;lsdb);</a>
<a name="ln318">  lsa_header-&gt;length = htons ((caddr_t) lsdesc - (caddr_t) buffer);</a>
<a name="ln319"> </a>
<a name="ln320">  /* LSA checksum */</a>
<a name="ln321">  ospf6_lsa_checksum (lsa_header);</a>
<a name="ln322"> </a>
<a name="ln323">  /* create LSA */</a>
<a name="ln324">  lsa = ospf6_lsa_create (lsa_header);</a>
<a name="ln325"> </a>
<a name="ln326">  /* Originate */</a>
<a name="ln327">  ospf6_lsa_originate_area (lsa, oa);</a>
<a name="ln328"> </a>
<a name="ln329">  link_state_id ++;</a>
<a name="ln330"> </a>
<a name="ln331">  /* Do premature-aging of rest, undesired Router-LSAs */</a>
<a name="ln332">  type = ntohs (OSPF6_LSTYPE_ROUTER);</a>
<a name="ln333">  router = oa-&gt;ospf6-&gt;router_id;</a>
<a name="ln334">  for (lsa = ospf6_lsdb_type_router_head (type, router, oa-&gt;lsdb); lsa;</a>
<a name="ln335">       lsa = ospf6_lsdb_type_router_next (type, router, lsa))</a>
<a name="ln336">    {</a>
<a name="ln337">      if (ntohl (lsa-&gt;header-&gt;id) &lt; link_state_id)</a>
<a name="ln338">        continue;</a>
<a name="ln339">      ospf6_lsa_purge (lsa);</a>
<a name="ln340">    }</a>
<a name="ln341"> </a>
<a name="ln342">  return 0;</a>
<a name="ln343">}</a>
<a name="ln344"> </a>
<a name="ln345">/*******************************/</a>
<a name="ln346">/* RFC2740 3.4.3.2 Network-LSA */</a>
<a name="ln347">/*******************************/</a>
<a name="ln348"> </a>
<a name="ln349">static char *</a>
<a name="ln350">ospf6_network_lsa_get_ar_id (struct ospf6_lsa *lsa, char *buf, int buflen,</a>
<a name="ln351">			     int pos)</a>
<a name="ln352">{</a>
<a name="ln353">  char *start, *end, *current;</a>
<a name="ln354">  struct ospf6_network_lsa *network_lsa;</a>
<a name="ln355">  struct ospf6_network_lsdesc *lsdesc;</a>
<a name="ln356"> </a>
<a name="ln357">  if (lsa)</a>
<a name="ln358">    {</a>
<a name="ln359">      network_lsa = (struct ospf6_network_lsa *)</a>
<a name="ln360">	((caddr_t) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln361"> </a>
<a name="ln362">      start = (char *) network_lsa + sizeof (struct ospf6_network_lsa);</a>
<a name="ln363">      end = (char *) lsa-&gt;header + ntohs (lsa-&gt;header-&gt;length);</a>
<a name="ln364">      current = start + pos*(sizeof (struct ospf6_network_lsdesc));</a>
<a name="ln365"> </a>
<a name="ln366">      if ((current + sizeof(struct ospf6_network_lsdesc)) &lt;= end)</a>
<a name="ln367">	{</a>
<a name="ln368">	  lsdesc = (struct ospf6_network_lsdesc *)current;</a>
<a name="ln369">	  if (buf)</a>
<a name="ln370">	    inet_ntop (AF_INET, &amp;lsdesc-&gt;router_id, buf, buflen);</a>
<a name="ln371">	}</a>
<a name="ln372">      else</a>
<a name="ln373">	return NULL;</a>
<a name="ln374">    }</a>
<a name="ln375"> </a>
<a name="ln376">  return (buf);</a>
<a name="ln377">}</a>
<a name="ln378"> </a>
<a name="ln379">static int</a>
<a name="ln380">ospf6_network_lsa_show (struct vty *vty, struct ospf6_lsa *lsa)</a>
<a name="ln381">{</a>
<a name="ln382">  char *start, *end, *current;</a>
<a name="ln383">  struct ospf6_network_lsa *network_lsa;</a>
<a name="ln384">  struct ospf6_network_lsdesc *lsdesc;</a>
<a name="ln385">  char buf[128], options[32];</a>
<a name="ln386"> </a>
<a name="ln387">  network_lsa = (struct ospf6_network_lsa *)</a>
<a name="ln388">    ((caddr_t) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln389"> </a>
<a name="ln390">  ospf6_options_printbuf (network_lsa-&gt;options, options, sizeof (options));</a>
<a name="ln391">  vty_out (vty, &quot;     Options: %s%s&quot;, options, VNL);</a>
<a name="ln392"> </a>
<a name="ln393">  start = (char *) network_lsa + sizeof (struct ospf6_network_lsa);</a>
<a name="ln394">  end = (char *) lsa-&gt;header + ntohs (lsa-&gt;header-&gt;length);</a>
<a name="ln395">  for (current = start; current + sizeof (struct ospf6_network_lsdesc) &lt;= end;</a>
<a name="ln396">       current += sizeof (struct ospf6_network_lsdesc))</a>
<a name="ln397">    {</a>
<a name="ln398">      lsdesc = (struct ospf6_network_lsdesc *) current;</a>
<a name="ln399">      inet_ntop (AF_INET, &amp;lsdesc-&gt;router_id, buf, sizeof (buf));</a>
<a name="ln400">      vty_out (vty, &quot;     Attached Router: %s%s&quot;, buf, VNL);</a>
<a name="ln401">    }</a>
<a name="ln402">  return 0;</a>
<a name="ln403">}</a>
<a name="ln404"> </a>
<a name="ln405">int</a>
<a name="ln406">ospf6_network_lsa_originate (struct thread *thread)</a>
<a name="ln407">{</a>
<a name="ln408">  struct ospf6_interface *oi;</a>
<a name="ln409"> </a>
<a name="ln410">  char buffer [OSPF6_MAX_LSASIZE];</a>
<a name="ln411">  struct ospf6_lsa_header *lsa_header;</a>
<a name="ln412"> </a>
<a name="ln413">  int count;</a>
<a name="ln414">  struct ospf6_lsa *old, *lsa;</a>
<a name="ln415">  struct ospf6_network_lsa *network_lsa;</a>
<a name="ln416">  struct ospf6_network_lsdesc *lsdesc;</a>
<a name="ln417">  struct ospf6_neighbor *on;</a>
<a name="ln418">  struct ospf6_link_lsa *link_lsa;</a>
<a name="ln419">  struct listnode *i;</a>
<a name="ln420">  u_int16_t type;</a>
<a name="ln421"> </a>
<a name="ln422">  oi = (struct ospf6_interface *) THREAD_ARG (thread);</a>
<a name="ln423">  oi-&gt;thread_network_lsa = NULL;</a>
<a name="ln424"> </a>
<a name="ln425">  /* The interface must be enabled until here. A Network-LSA of a</a>
<a name="ln426">     disabled interface (but was once enabled) should be flushed</a>
<a name="ln427">     by ospf6_lsa_refresh (), and does not come here. */</a>
<a name="ln428">  assert (oi-&gt;area);</a>
<a name="ln429"> </a>
<a name="ln430">  old = ospf6_lsdb_lookup (htons (OSPF6_LSTYPE_NETWORK),</a>
<a name="ln431">                           htonl (oi-&gt;interface-&gt;ifindex),</a>
<a name="ln432">                           oi-&gt;area-&gt;ospf6-&gt;router_id, oi-&gt;area-&gt;lsdb);</a>
<a name="ln433"> </a>
<a name="ln434">  /* Do not originate Network-LSA if not DR */</a>
<a name="ln435">  if (oi-&gt;state != OSPF6_INTERFACE_DR)</a>
<a name="ln436">    {</a>
<a name="ln437">      if (old)</a>
<a name="ln438">        ospf6_lsa_purge (old);</a>
<a name="ln439">      return 0;</a>
<a name="ln440">    }</a>
<a name="ln441"> </a>
<a name="ln442">  if (IS_OSPF6_DEBUG_ORIGINATE (NETWORK))</a>
<a name="ln443">    zlog_debug (&quot;Originate Network-LSA for Interface %s&quot;, oi-&gt;interface-&gt;name);</a>
<a name="ln444"> </a>
<a name="ln445">  /* If none of neighbor is adjacent to us */</a>
<a name="ln446">  count = 0;</a>
<a name="ln447">  </a>
<a name="ln448">  for (ALL_LIST_ELEMENTS_RO (oi-&gt;neighbor_list, i, on))</a>
<a name="ln449">    if (on-&gt;state == OSPF6_NEIGHBOR_FULL)</a>
<a name="ln450">      count++;</a>
<a name="ln451">  </a>
<a name="ln452">  if (count == 0)</a>
<a name="ln453">    {</a>
<a name="ln454">      if (IS_OSPF6_DEBUG_ORIGINATE (NETWORK))</a>
<a name="ln455">        zlog_debug (&quot;Interface stub, ignore&quot;);</a>
<a name="ln456">      if (old)</a>
<a name="ln457">        ospf6_lsa_purge (old);</a>
<a name="ln458">      return 0;</a>
<a name="ln459">    }</a>
<a name="ln460"> </a>
<a name="ln461">  /* prepare buffer */</a>
<a name="ln462">  memset (buffer, 0, sizeof (buffer));</a>
<a name="ln463">  lsa_header = (struct ospf6_lsa_header *) buffer;</a>
<a name="ln464">  network_lsa = (struct ospf6_network_lsa *)</a>
<a name="ln465">    ((caddr_t) lsa_header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln466"> </a>
<a name="ln467">  /* Collect the interface's Link-LSAs to describe</a>
<a name="ln468">     network's optional capabilities */</a>
<a name="ln469">  type = htons (OSPF6_LSTYPE_LINK);</a>
<a name="ln470">  for (lsa = ospf6_lsdb_type_head (type, oi-&gt;lsdb); lsa;</a>
<a name="ln471">       lsa = ospf6_lsdb_type_next (type, lsa))</a>
<a name="ln472">    {</a>
<a name="ln473">      link_lsa = (struct ospf6_link_lsa *)</a>
<a name="ln474">        ((caddr_t) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln475">      network_lsa-&gt;options[0] |= link_lsa-&gt;options[0];</a>
<a name="ln476">      network_lsa-&gt;options[1] |= link_lsa-&gt;options[1];</a>
<a name="ln477">      network_lsa-&gt;options[2] |= link_lsa-&gt;options[2];</a>
<a name="ln478">    }</a>
<a name="ln479"> </a>
<a name="ln480">  lsdesc = (struct ospf6_network_lsdesc *)</a>
<a name="ln481">    ((caddr_t) network_lsa + sizeof (struct ospf6_network_lsa));</a>
<a name="ln482"> </a>
<a name="ln483">  /* set Link Description to the router itself */</a>
<a name="ln484">  lsdesc-&gt;router_id = oi-&gt;area-&gt;ospf6-&gt;router_id;</a>
<a name="ln485">  lsdesc++;</a>
<a name="ln486"> </a>
<a name="ln487">  /* Walk through the neighbors */</a>
<a name="ln488">  for (ALL_LIST_ELEMENTS_RO (oi-&gt;neighbor_list, i, on))</a>
<a name="ln489">    {</a>
<a name="ln490">      if (on-&gt;state != OSPF6_NEIGHBOR_FULL)</a>
<a name="ln491">        continue;</a>
<a name="ln492"> </a>
<a name="ln493">      /* set this neighbor's Router-ID to LSA */</a>
<a name="ln494">      lsdesc-&gt;router_id = on-&gt;router_id;</a>
<a name="ln495">      lsdesc++;</a>
<a name="ln496">    }</a>
<a name="ln497"> </a>
<a name="ln498">  /* Fill LSA Header */</a>
<a name="ln499">  lsa_header-&gt;age = 0;</a>
<a name="ln500">  lsa_header-&gt;type = htons (OSPF6_LSTYPE_NETWORK);</a>
<a name="ln501">  lsa_header-&gt;id = htonl (oi-&gt;interface-&gt;ifindex);</a>
<a name="ln502">  lsa_header-&gt;adv_router = oi-&gt;area-&gt;ospf6-&gt;router_id;</a>
<a name="ln503">  lsa_header-&gt;seqnum =</a>
<a name="ln504">    ospf6_new_ls_seqnum (lsa_header-&gt;type, lsa_header-&gt;id,</a>
<a name="ln505">                         lsa_header-&gt;adv_router, oi-&gt;area-&gt;lsdb);</a>
<a name="ln506">  lsa_header-&gt;length = htons ((caddr_t) lsdesc - (caddr_t) buffer);</a>
<a name="ln507"> </a>
<a name="ln508">  /* LSA checksum */</a>
<a name="ln509">  ospf6_lsa_checksum (lsa_header);</a>
<a name="ln510"> </a>
<a name="ln511">  /* create LSA */</a>
<a name="ln512">  lsa = ospf6_lsa_create (lsa_header);</a>
<a name="ln513"> </a>
<a name="ln514">  /* Originate */</a>
<a name="ln515">  ospf6_lsa_originate_area (lsa, oi-&gt;area);</a>
<a name="ln516"> </a>
<a name="ln517">  return 0;</a>
<a name="ln518">}</a>
<a name="ln519"> </a>
<a name="ln520"> </a>
<a name="ln521">/****************************/</a>
<a name="ln522">/* RFC2740 3.4.3.6 Link-LSA */</a>
<a name="ln523">/****************************/</a>
<a name="ln524"> </a>
<a name="ln525">static char *</a>
<a name="ln526">ospf6_link_lsa_get_prefix_str (struct ospf6_lsa *lsa, char *buf, int buflen,</a>
<a name="ln527">			       int pos)</a>
<a name="ln528">{</a>
<a name="ln529">  char *start, *end, *current;</a>
<a name="ln530">  struct ospf6_link_lsa *link_lsa;</a>
<a name="ln531">  struct in6_addr in6;</a>
<a name="ln532">  struct ospf6_prefix *prefix;</a>
<a name="ln533">  int cnt = 0, prefixnum;</a>
<a name="ln534"> </a>
<a name="ln535">  if (lsa)</a>
<a name="ln536">    {</a>
<a name="ln537">      link_lsa = (struct ospf6_link_lsa *)</a>
<a name="ln538">	((caddr_t) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln539"> </a>
<a name="ln540">      if (pos == 0) {</a>
<a name="ln541">	inet_ntop (AF_INET6, &amp;link_lsa-&gt;linklocal_addr, buf, buflen);</a>
<a name="ln542">	return (buf);</a>
<a name="ln543">      }</a>
<a name="ln544"> </a>
<a name="ln545">      prefixnum = ntohl (link_lsa-&gt;prefix_num);</a>
<a name="ln546">      if (pos &gt; prefixnum)</a>
<a name="ln547">	return (NULL);</a>
<a name="ln548"> </a>
<a name="ln549">      start = (char *) link_lsa + sizeof (struct ospf6_link_lsa);</a>
<a name="ln550">      end = (char *) lsa-&gt;header + ntohs (lsa-&gt;header-&gt;length);</a>
<a name="ln551">      current = start;</a>
<a name="ln552"> </a>
<a name="ln553">      do</a>
<a name="ln554">	{</a>
<a name="ln555">	  prefix = (struct ospf6_prefix *) current;</a>
<a name="ln556">	  if (prefix-&gt;prefix_length == 0 ||</a>
<a name="ln557">	      current + OSPF6_PREFIX_SIZE (prefix) &gt; end)</a>
<a name="ln558">	    {</a>
<a name="ln559">	      return (NULL);</a>
<a name="ln560">	    }</a>
<a name="ln561"> </a>
<a name="ln562">	  if (cnt &lt; pos)</a>
<a name="ln563">	    {</a>
<a name="ln564">	      current = start + pos*OSPF6_PREFIX_SIZE(prefix);</a>
<a name="ln565">	      cnt++;</a>
<a name="ln566">	    }</a>
<a name="ln567">	  else</a>
<a name="ln568">	    {</a>
<a name="ln569">	      memset (&amp;in6, 0, sizeof (in6));</a>
<a name="ln570">	      memcpy (&amp;in6, OSPF6_PREFIX_BODY (prefix),</a>
<a name="ln571">		      OSPF6_PREFIX_SPACE (prefix-&gt;prefix_length));</a>
<a name="ln572">	      inet_ntop (AF_INET6, &amp;in6, buf, buflen);</a>
<a name="ln573">	      return (buf);</a>
<a name="ln574">	    }</a>
<a name="ln575">	} while (current &lt;= end);</a>
<a name="ln576">    }</a>
<a name="ln577">  return (NULL);</a>
<a name="ln578">}</a>
<a name="ln579"> </a>
<a name="ln580">static int</a>
<a name="ln581">ospf6_link_lsa_show (struct vty *vty, struct ospf6_lsa *lsa)</a>
<a name="ln582">{</a>
<a name="ln583">  char *start, *end, *current;</a>
<a name="ln584">  struct ospf6_link_lsa *link_lsa;</a>
<a name="ln585">  int prefixnum;</a>
<a name="ln586">  char buf[128], options[32];</a>
<a name="ln587">  struct ospf6_prefix *prefix;</a>
<a name="ln588">  const char *p, *mc, *la, *nu;</a>
<a name="ln589">  struct in6_addr in6;</a>
<a name="ln590"> </a>
<a name="ln591">  link_lsa = (struct ospf6_link_lsa *)</a>
<a name="ln592">    ((caddr_t) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln593"> </a>
<a name="ln594">  ospf6_options_printbuf (link_lsa-&gt;options, options, sizeof (options));</a>
<a name="ln595">  inet_ntop (AF_INET6, &amp;link_lsa-&gt;linklocal_addr, buf, sizeof (buf));</a>
<a name="ln596">  prefixnum = ntohl (link_lsa-&gt;prefix_num);</a>
<a name="ln597"> </a>
<a name="ln598">  vty_out (vty, &quot;     Priority: %d Options: %s%s&quot;,</a>
<a name="ln599">           link_lsa-&gt;priority, options, VNL);</a>
<a name="ln600">  vty_out (vty, &quot;     LinkLocal Address: %s%s&quot;, buf, VNL);</a>
<a name="ln601">  vty_out (vty, &quot;     Number of Prefix: %d%s&quot;, prefixnum, VNL);</a>
<a name="ln602"> </a>
<a name="ln603">  start = (char *) link_lsa + sizeof (struct ospf6_link_lsa);</a>
<a name="ln604">  end = (char *) lsa-&gt;header + ntohs (lsa-&gt;header-&gt;length); </a>
<a name="ln605">  for (current = start; current &lt; end; current += OSPF6_PREFIX_SIZE (prefix))</a>
<a name="ln606">    {</a>
<a name="ln607">      prefix = (struct ospf6_prefix *) current;</a>
<a name="ln608">      if (prefix-&gt;prefix_length == 0 ||</a>
<a name="ln609">          current + OSPF6_PREFIX_SIZE (prefix) &gt; end)</a>
<a name="ln610">        break;</a>
<a name="ln611"> </a>
<a name="ln612">      p = (CHECK_FLAG (prefix-&gt;prefix_options, OSPF6_PREFIX_OPTION_P) ?</a>
<a name="ln613">           &quot;P&quot; : &quot;--&quot;);</a>
<a name="ln614">      mc = (CHECK_FLAG (prefix-&gt;prefix_options, OSPF6_PREFIX_OPTION_MC) ?</a>
<a name="ln615">           &quot;MC&quot; : &quot;--&quot;);</a>
<a name="ln616">      la = (CHECK_FLAG (prefix-&gt;prefix_options, OSPF6_PREFIX_OPTION_LA) ?</a>
<a name="ln617">           &quot;LA&quot; : &quot;--&quot;);</a>
<a name="ln618">      nu = (CHECK_FLAG (prefix-&gt;prefix_options, OSPF6_PREFIX_OPTION_NU) ?</a>
<a name="ln619">           &quot;NU&quot; : &quot;--&quot;);</a>
<a name="ln620">      vty_out (vty, &quot;     Prefix Options: %s|%s|%s|%s%s&quot;,</a>
<a name="ln621">               p, mc, la, nu, VNL);</a>
<a name="ln622"> </a>
<a name="ln623">      memset (&amp;in6, 0, sizeof (in6));</a>
<a name="ln624">      memcpy (&amp;in6, OSPF6_PREFIX_BODY (prefix),</a>
<a name="ln625">              OSPF6_PREFIX_SPACE (prefix-&gt;prefix_length));</a>
<a name="ln626">      inet_ntop (AF_INET6, &amp;in6, buf, sizeof (buf));</a>
<a name="ln627">      vty_out (vty, &quot;     Prefix: %s/%d%s&quot;,</a>
<a name="ln628">               buf, prefix-&gt;prefix_length, VNL);</a>
<a name="ln629">    }</a>
<a name="ln630"> </a>
<a name="ln631">  return 0;</a>
<a name="ln632">}</a>
<a name="ln633"> </a>
<a name="ln634">int</a>
<a name="ln635">ospf6_link_lsa_originate (struct thread *thread)</a>
<a name="ln636">{</a>
<a name="ln637">  struct ospf6_interface *oi;</a>
<a name="ln638"> </a>
<a name="ln639">  char buffer[OSPF6_MAX_LSASIZE];</a>
<a name="ln640">  struct ospf6_lsa_header *lsa_header;</a>
<a name="ln641">  struct ospf6_lsa *old, *lsa;</a>
<a name="ln642"> </a>
<a name="ln643">  struct ospf6_link_lsa *link_lsa;</a>
<a name="ln644">  struct ospf6_route *route;</a>
<a name="ln645">  struct ospf6_prefix *op;</a>
<a name="ln646"> </a>
<a name="ln647">  oi = (struct ospf6_interface *) THREAD_ARG (thread);</a>
<a name="ln648">  oi-&gt;thread_link_lsa = NULL;</a>
<a name="ln649"> </a>
<a name="ln650">  assert (oi-&gt;area);</a>
<a name="ln651"> </a>
<a name="ln652">  /* find previous LSA */</a>
<a name="ln653">  old = ospf6_lsdb_lookup (htons (OSPF6_LSTYPE_LINK),</a>
<a name="ln654">                           htonl (oi-&gt;interface-&gt;ifindex),</a>
<a name="ln655">                           oi-&gt;area-&gt;ospf6-&gt;router_id, oi-&gt;lsdb);</a>
<a name="ln656"> </a>
<a name="ln657">  if (CHECK_FLAG (oi-&gt;flag, OSPF6_INTERFACE_DISABLE))</a>
<a name="ln658">    {</a>
<a name="ln659">      if (old)</a>
<a name="ln660">        ospf6_lsa_purge (old);</a>
<a name="ln661">      return 0;</a>
<a name="ln662">    }</a>
<a name="ln663"> </a>
<a name="ln664">  if (IS_OSPF6_DEBUG_ORIGINATE (LINK))</a>
<a name="ln665">    zlog_debug (&quot;Originate Link-LSA for Interface %s&quot;, oi-&gt;interface-&gt;name);</a>
<a name="ln666"> </a>
<a name="ln667">  /* can't make Link-LSA if linklocal address not set */</a>
<a name="ln668">  if (oi-&gt;linklocal_addr == NULL)</a>
<a name="ln669">    {</a>
<a name="ln670">      if (IS_OSPF6_DEBUG_ORIGINATE (LINK))</a>
<a name="ln671">        zlog_debug (&quot;No Linklocal address on %s, defer originating&quot;,</a>
<a name="ln672">                   oi-&gt;interface-&gt;name);</a>
<a name="ln673">      if (old)</a>
<a name="ln674">        ospf6_lsa_purge (old);</a>
<a name="ln675">      return 0;</a>
<a name="ln676">    }</a>
<a name="ln677"> </a>
<a name="ln678">  /* prepare buffer */</a>
<a name="ln679">  memset (buffer, 0, sizeof (buffer));</a>
<a name="ln680">  lsa_header = (struct ospf6_lsa_header *) buffer;</a>
<a name="ln681">  link_lsa = (struct ospf6_link_lsa *)</a>
<a name="ln682">    ((caddr_t) lsa_header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln683"> </a>
<a name="ln684">  /* Fill Link-LSA */</a>
<a name="ln685">  link_lsa-&gt;priority = oi-&gt;priority;</a>
<a name="ln686">  memcpy (link_lsa-&gt;options, oi-&gt;area-&gt;options, 3);</a>
<a name="ln687">  memcpy (&amp;link_lsa-&gt;linklocal_addr, oi-&gt;linklocal_addr,</a>
<a name="ln688">          sizeof (struct in6_addr));</a>
<a name="ln689">  link_lsa-&gt;prefix_num = htonl (oi-&gt;route_connected-&gt;count);</a>
<a name="ln690"> </a>
<a name="ln691">  op = (struct ospf6_prefix *)</a>
<a name="ln692">    ((caddr_t) link_lsa + sizeof (struct ospf6_link_lsa));</a>
<a name="ln693"> </a>
<a name="ln694">  /* connected prefix to advertise */</a>
<a name="ln695">  for (route = ospf6_route_head (oi-&gt;route_connected); route;</a>
<a name="ln696">       route = ospf6_route_next (route))</a>
<a name="ln697">    {</a>
<a name="ln698">      op-&gt;prefix_length = route-&gt;prefix.prefixlen;</a>
<a name="ln699">      op-&gt;prefix_options = route-&gt;path.prefix_options;</a>
<a name="ln700">      op-&gt;prefix_metric = htons (0);</a>
<a name="ln701">      memcpy (OSPF6_PREFIX_BODY (op), &amp;route-&gt;prefix.u.prefix6,</a>
<a name="ln702">              OSPF6_PREFIX_SPACE (op-&gt;prefix_length));</a>
<a name="ln703">      op = OSPF6_PREFIX_NEXT (op);</a>
<a name="ln704">    }</a>
<a name="ln705"> </a>
<a name="ln706">  /* Fill LSA Header */</a>
<a name="ln707">  lsa_header-&gt;age = 0;</a>
<a name="ln708">  lsa_header-&gt;type = htons (OSPF6_LSTYPE_LINK);</a>
<a name="ln709">  lsa_header-&gt;id = htonl (oi-&gt;interface-&gt;ifindex);</a>
<a name="ln710">  lsa_header-&gt;adv_router = oi-&gt;area-&gt;ospf6-&gt;router_id;</a>
<a name="ln711">  lsa_header-&gt;seqnum =</a>
<a name="ln712">    ospf6_new_ls_seqnum (lsa_header-&gt;type, lsa_header-&gt;id,</a>
<a name="ln713">                         lsa_header-&gt;adv_router, oi-&gt;lsdb);</a>
<a name="ln714">  lsa_header-&gt;length = htons ((caddr_t) op - (caddr_t) buffer);</a>
<a name="ln715"> </a>
<a name="ln716">  /* LSA checksum */</a>
<a name="ln717">  ospf6_lsa_checksum (lsa_header);</a>
<a name="ln718"> </a>
<a name="ln719">  /* create LSA */</a>
<a name="ln720">  lsa = ospf6_lsa_create (lsa_header);</a>
<a name="ln721"> </a>
<a name="ln722">  /* Originate */</a>
<a name="ln723">  ospf6_lsa_originate_interface (lsa, oi);</a>
<a name="ln724"> </a>
<a name="ln725">  return 0;</a>
<a name="ln726">}</a>
<a name="ln727"> </a>
<a name="ln728"> </a>
<a name="ln729">/*****************************************/</a>
<a name="ln730">/* RFC2740 3.4.3.7 Intra-Area-Prefix-LSA */</a>
<a name="ln731">/*****************************************/</a>
<a name="ln732">static char *</a>
<a name="ln733">ospf6_intra_prefix_lsa_get_prefix_str (struct ospf6_lsa *lsa, char *buf,</a>
<a name="ln734">				       int buflen, int pos)</a>
<a name="ln735">{</a>
<a name="ln736">  char *start, *end, *current;</a>
<a name="ln737">  struct ospf6_intra_prefix_lsa *intra_prefix_lsa;</a>
<a name="ln738">  struct in6_addr in6;</a>
<a name="ln739">  int prefixnum, cnt = 0;</a>
<a name="ln740">  struct ospf6_prefix *prefix;</a>
<a name="ln741"> </a>
<a name="ln742">  if (lsa)</a>
<a name="ln743">    {</a>
<a name="ln744">      intra_prefix_lsa = (struct ospf6_intra_prefix_lsa *)</a>
<a name="ln745">	((caddr_t) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln746"> </a>
<a name="ln747">      prefixnum = ntohs (intra_prefix_lsa-&gt;prefix_num);</a>
<a name="ln748">      if (pos &gt; prefixnum)</a>
<a name="ln749">	return (NULL);</a>
<a name="ln750"> </a>
<a name="ln751">      start = (char *) intra_prefix_lsa + sizeof (struct ospf6_intra_prefix_lsa);</a>
<a name="ln752">      end = (char *) lsa-&gt;header + ntohs (lsa-&gt;header-&gt;length);</a>
<a name="ln753">      current = start;</a>
<a name="ln754"> </a>
<a name="ln755">      do</a>
<a name="ln756">	{</a>
<a name="ln757">	  prefix = (struct ospf6_prefix *) current;</a>
<a name="ln758">	  if (prefix-&gt;prefix_length == 0 ||</a>
<a name="ln759">	      current + OSPF6_PREFIX_SIZE (prefix) &gt; end)</a>
<a name="ln760">	    {</a>
<a name="ln761">	      return NULL;</a>
<a name="ln762">	    }</a>
<a name="ln763"> </a>
<a name="ln764">	  if (cnt &lt; pos)</a>
<a name="ln765">	    {</a>
<a name="ln766">	      current = start + pos*OSPF6_PREFIX_SIZE(prefix);</a>
<a name="ln767">	      cnt++;</a>
<a name="ln768">	    }</a>
<a name="ln769">	  else</a>
<a name="ln770">	    {</a>
<a name="ln771">	      memset (&amp;in6, 0, sizeof (in6));</a>
<a name="ln772">	      memcpy (&amp;in6, OSPF6_PREFIX_BODY (prefix),</a>
<a name="ln773">		      OSPF6_PREFIX_SPACE (prefix-&gt;prefix_length));</a>
<a name="ln774">	      inet_ntop (AF_INET6, &amp;in6, buf, buflen);</a>
<a name="ln775">	      sprintf(&amp;buf[strlen(buf)], &quot;/%d&quot;, prefix-&gt;prefix_length);</a>
<a name="ln776">	      return (buf);</a>
<a name="ln777">	    }</a>
<a name="ln778">	} while (current &lt;= end);</a>
<a name="ln779">    }</a>
<a name="ln780">  return (buf);</a>
<a name="ln781">}</a>
<a name="ln782"> </a>
<a name="ln783">static int</a>
<a name="ln784">ospf6_intra_prefix_lsa_show (struct vty *vty, struct ospf6_lsa *lsa)</a>
<a name="ln785">{</a>
<a name="ln786">  char *start, *end, *current;</a>
<a name="ln787">  struct ospf6_intra_prefix_lsa *intra_prefix_lsa;</a>
<a name="ln788">  int prefixnum;</a>
<a name="ln789">  char buf[128];</a>
<a name="ln790">  struct ospf6_prefix *prefix;</a>
<a name="ln791">  char id[16], adv_router[16];</a>
<a name="ln792">  const char *p, *mc, *la, *nu;</a>
<a name="ln793">  struct in6_addr in6;</a>
<a name="ln794"> </a>
<a name="ln795">  intra_prefix_lsa = (struct ospf6_intra_prefix_lsa *)</a>
<a name="ln796">    ((caddr_t) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln797"> </a>
<a name="ln798">  prefixnum = ntohs (intra_prefix_lsa-&gt;prefix_num);</a>
<a name="ln799"> </a>
<a name="ln800">  vty_out (vty, &quot;     Number of Prefix: %d%s&quot;, prefixnum, VNL);</a>
<a name="ln801"> </a>
<a name="ln802">  inet_ntop (AF_INET, &amp;intra_prefix_lsa-&gt;ref_id, id, sizeof (id));</a>
<a name="ln803">  inet_ntop (AF_INET, &amp;intra_prefix_lsa-&gt;ref_adv_router,</a>
<a name="ln804">             adv_router, sizeof (adv_router));</a>
<a name="ln805">  vty_out (vty, &quot;     Reference: %s Id: %s Adv: %s%s&quot;,</a>
<a name="ln806">           ospf6_lstype_name (intra_prefix_lsa-&gt;ref_type), id, adv_router,</a>
<a name="ln807">           VNL);</a>
<a name="ln808"> </a>
<a name="ln809">  start = (char *) intra_prefix_lsa + sizeof (struct ospf6_intra_prefix_lsa);</a>
<a name="ln810">  end = (char *) lsa-&gt;header + ntohs (lsa-&gt;header-&gt;length); </a>
<a name="ln811">  for (current = start; current &lt; end; current += OSPF6_PREFIX_SIZE (prefix))</a>
<a name="ln812">    {</a>
<a name="ln813">      prefix = (struct ospf6_prefix *) current;</a>
<a name="ln814">      if (prefix-&gt;prefix_length == 0 ||</a>
<a name="ln815">          current + OSPF6_PREFIX_SIZE (prefix) &gt; end)</a>
<a name="ln816">        break;</a>
<a name="ln817"> </a>
<a name="ln818">      p = (CHECK_FLAG (prefix-&gt;prefix_options, OSPF6_PREFIX_OPTION_P) ?</a>
<a name="ln819">           &quot;P&quot; : &quot;--&quot;);</a>
<a name="ln820">      mc = (CHECK_FLAG (prefix-&gt;prefix_options, OSPF6_PREFIX_OPTION_MC) ?</a>
<a name="ln821">           &quot;MC&quot; : &quot;--&quot;);</a>
<a name="ln822">      la = (CHECK_FLAG (prefix-&gt;prefix_options, OSPF6_PREFIX_OPTION_LA) ?</a>
<a name="ln823">           &quot;LA&quot; : &quot;--&quot;);</a>
<a name="ln824">      nu = (CHECK_FLAG (prefix-&gt;prefix_options, OSPF6_PREFIX_OPTION_NU) ?</a>
<a name="ln825">           &quot;NU&quot; : &quot;--&quot;);</a>
<a name="ln826">      vty_out (vty, &quot;     Prefix Options: %s|%s|%s|%s%s&quot;,</a>
<a name="ln827">               p, mc, la, nu, VNL);</a>
<a name="ln828"> </a>
<a name="ln829">      memset (&amp;in6, 0, sizeof (in6));</a>
<a name="ln830">      memcpy (&amp;in6, OSPF6_PREFIX_BODY (prefix),</a>
<a name="ln831">              OSPF6_PREFIX_SPACE (prefix-&gt;prefix_length));</a>
<a name="ln832">      inet_ntop (AF_INET6, &amp;in6, buf, sizeof (buf));</a>
<a name="ln833">      vty_out (vty, &quot;     Prefix: %s/%d%s&quot;,</a>
<a name="ln834">               buf, prefix-&gt;prefix_length, VNL);</a>
<a name="ln835">    }</a>
<a name="ln836"> </a>
<a name="ln837">  return 0;</a>
<a name="ln838">}</a>
<a name="ln839"> </a>
<a name="ln840">int</a>
<a name="ln841">ospf6_intra_prefix_lsa_originate_stub (struct thread *thread)</a>
<a name="ln842">{</a>
<a name="ln843">  struct ospf6_area *oa;</a>
<a name="ln844"> </a>
<a name="ln845">  char buffer[OSPF6_MAX_LSASIZE];</a>
<a name="ln846">  struct ospf6_lsa_header *lsa_header;</a>
<a name="ln847">  struct ospf6_lsa *old, *lsa;</a>
<a name="ln848"> </a>
<a name="ln849">  struct ospf6_intra_prefix_lsa *intra_prefix_lsa;</a>
<a name="ln850">  struct ospf6_interface *oi;</a>
<a name="ln851">  struct ospf6_neighbor *on;</a>
<a name="ln852">  struct ospf6_route *route;</a>
<a name="ln853">  struct ospf6_prefix *op;</a>
<a name="ln854">  struct listnode *i, *j;</a>
<a name="ln855">  int full_count = 0;</a>
<a name="ln856">  unsigned short prefix_num = 0;</a>
<a name="ln857">  char buf[BUFSIZ];</a>
<a name="ln858">  struct ospf6_route_table *route_advertise;</a>
<a name="ln859"> </a>
<a name="ln860">  oa = (struct ospf6_area *) THREAD_ARG (thread);</a>
<a name="ln861">  oa-&gt;thread_intra_prefix_lsa = NULL;</a>
<a name="ln862"> </a>
<a name="ln863">  /* find previous LSA */</a>
<a name="ln864">  old = ospf6_lsdb_lookup (htons (OSPF6_LSTYPE_INTRA_PREFIX),</a>
<a name="ln865">                           htonl (0), oa-&gt;ospf6-&gt;router_id, oa-&gt;lsdb);</a>
<a name="ln866"> </a>
<a name="ln867">  if (! IS_AREA_ENABLED (oa))</a>
<a name="ln868">    {</a>
<a name="ln869">      if (old)</a>
<a name="ln870">        ospf6_lsa_purge (old);</a>
<a name="ln871">      return 0;</a>
<a name="ln872">    }</a>
<a name="ln873"> </a>
<a name="ln874">  if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln875">    zlog_debug (&quot;Originate Intra-Area-Prefix-LSA for area %s's stub prefix&quot;,</a>
<a name="ln876">               oa-&gt;name);</a>
<a name="ln877"> </a>
<a name="ln878">  /* prepare buffer */</a>
<a name="ln879">  memset (buffer, 0, sizeof (buffer));</a>
<a name="ln880">  lsa_header = (struct ospf6_lsa_header *) buffer;</a>
<a name="ln881">  intra_prefix_lsa = (struct ospf6_intra_prefix_lsa *)</a>
<a name="ln882">    ((caddr_t) lsa_header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln883"> </a>
<a name="ln884">  /* Fill Intra-Area-Prefix-LSA */</a>
<a name="ln885">  intra_prefix_lsa-&gt;ref_type = htons (OSPF6_LSTYPE_ROUTER);</a>
<a name="ln886">  intra_prefix_lsa-&gt;ref_id = htonl (0);</a>
<a name="ln887">  intra_prefix_lsa-&gt;ref_adv_router = oa-&gt;ospf6-&gt;router_id;</a>
<a name="ln888"> </a>
<a name="ln889">  route_advertise = ospf6_route_table_create (0, 0);</a>
<a name="ln890"> </a>
<a name="ln891">  for (ALL_LIST_ELEMENTS_RO (oa-&gt;if_list, i, oi))</a>
<a name="ln892">    {</a>
<a name="ln893">      if (oi-&gt;state == OSPF6_INTERFACE_DOWN)</a>
<a name="ln894">        {</a>
<a name="ln895">          if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln896">            zlog_debug (&quot;  Interface %s is down, ignore&quot;, oi-&gt;interface-&gt;name);</a>
<a name="ln897">          continue;</a>
<a name="ln898">        }</a>
<a name="ln899"> </a>
<a name="ln900">      full_count = 0;</a>
<a name="ln901"> </a>
<a name="ln902">      for (ALL_LIST_ELEMENTS_RO (oi-&gt;neighbor_list, j, on))</a>
<a name="ln903">        if (on-&gt;state == OSPF6_NEIGHBOR_FULL)</a>
<a name="ln904">          full_count++;</a>
<a name="ln905"> </a>
<a name="ln906">      if (oi-&gt;state != OSPF6_INTERFACE_LOOPBACK &amp;&amp;</a>
<a name="ln907">          oi-&gt;state != OSPF6_INTERFACE_POINTTOPOINT &amp;&amp;</a>
<a name="ln908">          full_count != 0)</a>
<a name="ln909">        {</a>
<a name="ln910">          if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln911">            zlog_debug (&quot;  Interface %s is not stub, ignore&quot;,</a>
<a name="ln912">                       oi-&gt;interface-&gt;name);</a>
<a name="ln913">          continue;</a>
<a name="ln914">        }</a>
<a name="ln915"> </a>
<a name="ln916">      if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln917">        zlog_debug (&quot;  Interface %s:&quot;, oi-&gt;interface-&gt;name);</a>
<a name="ln918"> </a>
<a name="ln919">      /* connected prefix to advertise */</a>
<a name="ln920">      for (route = ospf6_route_head (oi-&gt;route_connected); route;</a>
<a name="ln921">           route = ospf6_route_best_next (route))</a>
<a name="ln922">        {</a>
<a name="ln923">          if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln924">            {</a>
<a name="ln925">              prefix2str (&amp;route-&gt;prefix, buf, sizeof (buf));</a>
<a name="ln926">              zlog_debug (&quot;    include %s&quot;, buf);</a>
<a name="ln927">            }</a>
<a name="ln928">          ospf6_route_add (ospf6_route_copy (route), route_advertise);</a>
<a name="ln929">        }</a>
<a name="ln930">    }</a>
<a name="ln931"> </a>
<a name="ln932">  if (route_advertise-&gt;count == 0)</a>
<a name="ln933">    {</a>
<a name="ln934">      if (old)</a>
<a name="ln935">        ospf6_lsa_purge (old);</a>
<a name="ln936">      ospf6_route_table_delete (route_advertise);</a>
<a name="ln937">      return 0;</a>
<a name="ln938">    }</a>
<a name="ln939"> </a>
<a name="ln940">  /* put prefixes to advertise */</a>
<a name="ln941">  prefix_num = 0;</a>
<a name="ln942">  op = (struct ospf6_prefix *)</a>
<a name="ln943">    ((caddr_t) intra_prefix_lsa + sizeof (struct ospf6_intra_prefix_lsa));</a>
<a name="ln944">  for (route = ospf6_route_head (route_advertise); route;</a>
<a name="ln945">       route = ospf6_route_best_next (route))</a>
<a name="ln946">    {</a>
<a name="ln947">      op-&gt;prefix_length = route-&gt;prefix.prefixlen;</a>
<a name="ln948">      op-&gt;prefix_options = route-&gt;path.prefix_options;</a>
<a name="ln949">      op-&gt;prefix_metric = htons (route-&gt;path.cost);</a>
<a name="ln950">      memcpy (OSPF6_PREFIX_BODY (op), &amp;route-&gt;prefix.u.prefix6,</a>
<a name="ln951">              OSPF6_PREFIX_SPACE (op-&gt;prefix_length));</a>
<a name="ln952">      op = OSPF6_PREFIX_NEXT (op);</a>
<a name="ln953">      prefix_num++;</a>
<a name="ln954">    }</a>
<a name="ln955"> </a>
<a name="ln956">  ospf6_route_table_delete (route_advertise);</a>
<a name="ln957"> </a>
<a name="ln958">  if (prefix_num == 0)</a>
<a name="ln959">    {</a>
<a name="ln960">      if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln961">        zlog_debug (&quot;Quit to Advertise Intra-Prefix: no route to advertise&quot;);</a>
<a name="ln962">      return 0;</a>
<a name="ln963">    }</a>
<a name="ln964"> </a>
<a name="ln965">  intra_prefix_lsa-&gt;prefix_num = htons (prefix_num);</a>
<a name="ln966"> </a>
<a name="ln967">  /* Fill LSA Header */</a>
<a name="ln968">  lsa_header-&gt;age = 0;</a>
<a name="ln969">  lsa_header-&gt;type = htons (OSPF6_LSTYPE_INTRA_PREFIX);</a>
<a name="ln970">  lsa_header-&gt;id = htonl (0);</a>
<a name="ln971">  lsa_header-&gt;adv_router = oa-&gt;ospf6-&gt;router_id;</a>
<a name="ln972">  lsa_header-&gt;seqnum =</a>
<a name="ln973">    ospf6_new_ls_seqnum (lsa_header-&gt;type, lsa_header-&gt;id,</a>
<a name="ln974">                         lsa_header-&gt;adv_router, oa-&gt;lsdb);</a>
<a name="ln975">  lsa_header-&gt;length = htons ((caddr_t) op - (caddr_t) lsa_header);</a>
<a name="ln976"> </a>
<a name="ln977">  /* LSA checksum */</a>
<a name="ln978">  ospf6_lsa_checksum (lsa_header);</a>
<a name="ln979"> </a>
<a name="ln980">  /* create LSA */</a>
<a name="ln981">  lsa = ospf6_lsa_create (lsa_header);</a>
<a name="ln982"> </a>
<a name="ln983">  /* Originate */</a>
<a name="ln984">  ospf6_lsa_originate_area (lsa, oa);</a>
<a name="ln985"> </a>
<a name="ln986">  return 0;</a>
<a name="ln987">}</a>
<a name="ln988"> </a>
<a name="ln989"> </a>
<a name="ln990">int</a>
<a name="ln991">ospf6_intra_prefix_lsa_originate_transit (struct thread *thread)</a>
<a name="ln992">{</a>
<a name="ln993">  struct ospf6_interface *oi;</a>
<a name="ln994"> </a>
<a name="ln995">  char buffer[OSPF6_MAX_LSASIZE];</a>
<a name="ln996">  struct ospf6_lsa_header *lsa_header;</a>
<a name="ln997">  struct ospf6_lsa *old, *lsa;</a>
<a name="ln998"> </a>
<a name="ln999">  struct ospf6_intra_prefix_lsa *intra_prefix_lsa;</a>
<a name="ln1000">  struct ospf6_neighbor *on;</a>
<a name="ln1001">  struct ospf6_route *route;</a>
<a name="ln1002">  struct ospf6_prefix *op;</a>
<a name="ln1003">  struct listnode *i;</a>
<a name="ln1004">  int full_count = 0;</a>
<a name="ln1005">  unsigned short prefix_num = 0;</a>
<a name="ln1006">  struct ospf6_route_table *route_advertise;</a>
<a name="ln1007">  struct ospf6_link_lsa *link_lsa;</a>
<a name="ln1008">  char *start, *end, *current;</a>
<a name="ln1009">  u_int16_t type;</a>
<a name="ln1010">  char buf[BUFSIZ];</a>
<a name="ln1011"> </a>
<a name="ln1012">  oi = (struct ospf6_interface *) THREAD_ARG (thread);</a>
<a name="ln1013">  oi-&gt;thread_intra_prefix_lsa = NULL;</a>
<a name="ln1014"> </a>
<a name="ln1015">  assert (oi-&gt;area);</a>
<a name="ln1016"> </a>
<a name="ln1017">  /* find previous LSA */</a>
<a name="ln1018">  old = ospf6_lsdb_lookup (htons (OSPF6_LSTYPE_INTRA_PREFIX),</a>
<a name="ln1019">                           htonl (oi-&gt;interface-&gt;ifindex),</a>
<a name="ln1020">                           oi-&gt;area-&gt;ospf6-&gt;router_id, oi-&gt;area-&gt;lsdb);</a>
<a name="ln1021"> </a>
<a name="ln1022">  if (CHECK_FLAG (oi-&gt;flag, OSPF6_INTERFACE_DISABLE))</a>
<a name="ln1023">    {</a>
<a name="ln1024">      if (old)</a>
<a name="ln1025">        ospf6_lsa_purge (old);</a>
<a name="ln1026">      return 0;</a>
<a name="ln1027">    }</a>
<a name="ln1028"> </a>
<a name="ln1029">  if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln1030">    zlog_debug (&quot;Originate Intra-Area-Prefix-LSA for interface %s's prefix&quot;,</a>
<a name="ln1031">               oi-&gt;interface-&gt;name);</a>
<a name="ln1032"> </a>
<a name="ln1033">  /* prepare buffer */</a>
<a name="ln1034">  memset (buffer, 0, sizeof (buffer));</a>
<a name="ln1035">  lsa_header = (struct ospf6_lsa_header *) buffer;</a>
<a name="ln1036">  intra_prefix_lsa = (struct ospf6_intra_prefix_lsa *)</a>
<a name="ln1037">    ((caddr_t) lsa_header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln1038"> </a>
<a name="ln1039">  /* Fill Intra-Area-Prefix-LSA */</a>
<a name="ln1040">  intra_prefix_lsa-&gt;ref_type = htons (OSPF6_LSTYPE_NETWORK);</a>
<a name="ln1041">  intra_prefix_lsa-&gt;ref_id = htonl (oi-&gt;interface-&gt;ifindex);</a>
<a name="ln1042">  intra_prefix_lsa-&gt;ref_adv_router = oi-&gt;area-&gt;ospf6-&gt;router_id;</a>
<a name="ln1043"> </a>
<a name="ln1044">  if (oi-&gt;state != OSPF6_INTERFACE_DR)</a>
<a name="ln1045">    {</a>
<a name="ln1046">      if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln1047">        zlog_debug (&quot;  Interface is not DR&quot;);</a>
<a name="ln1048">      if (old)</a>
<a name="ln1049">        ospf6_lsa_purge (old);</a>
<a name="ln1050">      return 0;</a>
<a name="ln1051">    }</a>
<a name="ln1052"> </a>
<a name="ln1053">  full_count = 0;</a>
<a name="ln1054">  for (ALL_LIST_ELEMENTS_RO (oi-&gt;neighbor_list, i, on))</a>
<a name="ln1055">    if (on-&gt;state == OSPF6_NEIGHBOR_FULL)</a>
<a name="ln1056">      full_count++;</a>
<a name="ln1057">  </a>
<a name="ln1058">  if (full_count == 0)</a>
<a name="ln1059">    {</a>
<a name="ln1060">      if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln1061">        zlog_debug (&quot;  Interface is stub&quot;);</a>
<a name="ln1062">      if (old)</a>
<a name="ln1063">        ospf6_lsa_purge (old);</a>
<a name="ln1064">      return 0;</a>
<a name="ln1065">    }</a>
<a name="ln1066"> </a>
<a name="ln1067">  /* connected prefix to advertise */</a>
<a name="ln1068">  route_advertise = ospf6_route_table_create (0, 0);</a>
<a name="ln1069"> </a>
<a name="ln1070">  type = ntohs (OSPF6_LSTYPE_LINK);</a>
<a name="ln1071">  for (lsa = ospf6_lsdb_type_head (type, oi-&gt;lsdb); lsa;</a>
<a name="ln1072">       lsa = ospf6_lsdb_type_next (type, lsa))</a>
<a name="ln1073">    {</a>
<a name="ln1074">      if (OSPF6_LSA_IS_MAXAGE (lsa))</a>
<a name="ln1075">        continue;</a>
<a name="ln1076"> </a>
<a name="ln1077">      if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln1078">        zlog_debug (&quot;  include prefix from %s&quot;, lsa-&gt;name);</a>
<a name="ln1079"> </a>
<a name="ln1080">      if (lsa-&gt;header-&gt;adv_router != oi-&gt;area-&gt;ospf6-&gt;router_id)</a>
<a name="ln1081">        {</a>
<a name="ln1082">          on = ospf6_neighbor_lookup (lsa-&gt;header-&gt;adv_router, oi);</a>
<a name="ln1083">          if (on == NULL || on-&gt;state != OSPF6_NEIGHBOR_FULL)</a>
<a name="ln1084">            {</a>
<a name="ln1085">              if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln1086">                zlog_debug (&quot;    Neighbor not found or not Full, ignore&quot;);</a>
<a name="ln1087">              continue;</a>
<a name="ln1088">            }</a>
<a name="ln1089">        }</a>
<a name="ln1090"> </a>
<a name="ln1091">      link_lsa = (struct ospf6_link_lsa *)</a>
<a name="ln1092">        ((caddr_t) lsa-&gt;header + sizeof (struct ospf6_lsa_header));</a>
<a name="ln1093"> </a>
<a name="ln1094">      prefix_num = (unsigned short) ntohl (link_lsa-&gt;prefix_num);</a>
<a name="ln1095">      start = (char *) link_lsa + sizeof (struct ospf6_link_lsa);</a>
<a name="ln1096">      end = (char *) lsa-&gt;header + ntohs (lsa-&gt;header-&gt;length); </a>
<a name="ln1097">      for (current = start; current &lt; end &amp;&amp; prefix_num;</a>
<a name="ln1098">           current += OSPF6_PREFIX_SIZE (op))</a>
<a name="ln1099">        {</a>
<a name="ln1100">          op = (struct ospf6_prefix *) current;</a>
<a name="ln1101">          if (op-&gt;prefix_length == 0 ||</a>
<a name="ln1102">              current + OSPF6_PREFIX_SIZE (op) &gt; end)</a>
<a name="ln1103">            break;</a>
<a name="ln1104"> </a>
<a name="ln1105">          route = ospf6_route_create ();</a>
<a name="ln1106"> </a>
<a name="ln1107">          route-&gt;type = OSPF6_DEST_TYPE_NETWORK;</a>
<a name="ln1108">          route-&gt;prefix.family = AF_INET6;</a>
<a name="ln1109">          route-&gt;prefix.prefixlen = op-&gt;prefix_length;</a>
<a name="ln1110">          memset (&amp;route-&gt;prefix.u.prefix6, 0, sizeof (struct in6_addr));</a>
<a name="ln1111">          memcpy (&amp;route-&gt;prefix.u.prefix6, OSPF6_PREFIX_BODY (op),</a>
<a name="ln1112">                  OSPF6_PREFIX_SPACE (op-&gt;prefix_length));</a>
<a name="ln1113"> </a>
<a name="ln1114">          route-&gt;path.origin.type = lsa-&gt;header-&gt;type;</a>
<a name="ln1115">          route-&gt;path.origin.id = lsa-&gt;header-&gt;id;</a>
<a name="ln1116">          route-&gt;path.origin.adv_router = lsa-&gt;header-&gt;adv_router;</a>
<a name="ln1117">          route-&gt;path.options[0] = link_lsa-&gt;options[0];</a>
<a name="ln1118">          route-&gt;path.options[1] = link_lsa-&gt;options[1];</a>
<a name="ln1119">          route-&gt;path.options[2] = link_lsa-&gt;options[2];</a>
<a name="ln1120">          route-&gt;path.prefix_options = op-&gt;prefix_options;</a>
<a name="ln1121">          route-&gt;path.area_id = oi-&gt;area-&gt;area_id;</a>
<a name="ln1122">          route-&gt;path.type = OSPF6_PATH_TYPE_INTRA;</a>
<a name="ln1123"> </a>
<a name="ln1124">          if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln1125">            {</a>
<a name="ln1126">              prefix2str (&amp;route-&gt;prefix, buf, sizeof (buf));</a>
<a name="ln1127">              zlog_debug (&quot;    include %s&quot;, buf);</a>
<a name="ln1128">            }</a>
<a name="ln1129"> </a>
<a name="ln1130">          ospf6_route_add (route, route_advertise);</a>
<a name="ln1131">          prefix_num--;</a>
<a name="ln1132">        }</a>
<a name="ln1133">      if (current != end &amp;&amp; IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln1134">        zlog_debug (&quot;Trailing garbage in %s&quot;, lsa-&gt;name);</a>
<a name="ln1135">    }</a>
<a name="ln1136"> </a>
<a name="ln1137">  op = (struct ospf6_prefix *)</a>
<a name="ln1138">    ((caddr_t) intra_prefix_lsa + sizeof (struct ospf6_intra_prefix_lsa));</a>
<a name="ln1139"> </a>
<a name="ln1140">  prefix_num = 0;</a>
<a name="ln1141">  for (route = ospf6_route_head (route_advertise); route;</a>
<a name="ln1142">       route = ospf6_route_best_next (route))</a>
<a name="ln1143">    {</a>
<a name="ln1144">      op-&gt;prefix_length = route-&gt;prefix.prefixlen;</a>
<a name="ln1145">      op-&gt;prefix_options = route-&gt;path.prefix_options;</a>
<a name="ln1146">      op-&gt;prefix_metric = htons (0);</a>
<a name="ln1147">      memcpy (OSPF6_PREFIX_BODY (op), &amp;route-&gt;prefix.u.prefix6,</a>
<a name="ln1148">              OSPF6_PREFIX_SPACE (op-&gt;prefix_length));</a>
<a name="ln1149">      op = OSPF6_PREFIX_NEXT (op);</a>
<a name="ln1150">      prefix_num++;</a>
<a name="ln1151">    }</a>
<a name="ln1152"> </a>
<a name="ln1153">  ospf6_route_table_delete (route_advertise);</a>
<a name="ln1154"> </a>
<a name="ln1155">  if (prefix_num == 0)</a>
<a name="ln1156">    {</a>
<a name="ln1157">      if (IS_OSPF6_DEBUG_ORIGINATE (INTRA_PREFIX))</a>
<a name="ln1158">        zlog_debug (&quot;Quit to Advertise Intra-Prefix: no route to advertise&quot;);</a>
<a name="ln1159">      return 0;</a>
<a name="ln1160">    }</a>
<a name="ln1161"> </a>
<a name="ln1162">  intra_prefix_lsa-&gt;prefix_num = htons (prefix_num);</a>
<a name="ln1163"> </a>
<a name="ln1164">  /* Fill LSA Header */</a>
<a name="ln1165">  lsa_header-&gt;age = 0;</a>
<a name="ln1166">  lsa_header-&gt;type = htons (OSPF6_LSTYPE_INTRA_PREFIX);</a>
<a name="ln1167">  lsa_header-&gt;id = htonl (oi-&gt;interface-&gt;ifindex);</a>
<a name="ln1168">  lsa_header-&gt;adv_router = oi-&gt;area-&gt;ospf6-&gt;router_id;</a>
<a name="ln1169">  lsa_header-&gt;seqnum =</a>
<a name="ln1170">    ospf6_new_ls_seqnum (lsa_header-&gt;type, lsa_header-&gt;id,</a>
<a name="ln1171">                         lsa_header-&gt;adv_router, oi-&gt;area-&gt;lsdb);</a>
<a name="ln1172">  lsa_header-&gt;length = htons ((caddr_t) op - (caddr_t) lsa_header);</a>
<a name="ln1173"> </a>
<a name="ln1174">  /* LSA checksum */</a>
<a name="ln1175">  ospf6_lsa_checksum (lsa_header);</a>
<a name="ln1176"> </a>
<a name="ln1177">  /* create LSA */</a>
<a name="ln1178">  lsa = ospf6_lsa_create (lsa_header);</a>
<a name="ln1179"> </a>
<a name="ln1180">  /* Originate */</a>
<a name="ln1181">  ospf6_lsa_originate_area (lsa, oi-&gt;area);</a>
<a name="ln1182"> </a>
<a name="ln1183">  return 0;</a>
<a name="ln1184">}</a>
<a name="ln1185"> </a>
<a name="ln1186">void</a>
<a name="ln1187">ospf6_intra_prefix_lsa_add (struct ospf6_lsa *lsa)</a>
<a name="ln1188">{</a>
<a name="ln1189">  struct ospf6_area *oa;</a>
<a name="ln1190">  struct ospf6_intra_prefix_lsa *intra_prefix_lsa;</a>
<a name="ln1191">  struct prefix ls_prefix;</a>
<a name="ln1192">  struct ospf6_route *route, *ls_entry;</a>
<a name="ln1193">  int i, prefix_num;</a>
<a name="ln1194">  struct ospf6_prefix *op;</a>
<a name="ln1195">  char *start, *current, *end;</a>
<a name="ln1196">  char buf[64];</a>
<a name="ln1197">  struct interface *ifp;</a>
<a name="ln1198">  int direct_connect = 0;</a>
<a name="ln1199"> </a>
<a name="ln1200">  if (OSPF6_LSA_IS_MAXAGE (lsa))</a>
<a name="ln1201">    return;</a>
<a name="ln1202"> </a>
<a name="ln1203">  if (IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1204">    zlog_debug (&quot;%s found&quot;, lsa-&gt;name);</a>
<a name="ln1205"> </a>
<a name="ln1206">  oa = OSPF6_AREA (lsa-&gt;lsdb-&gt;data);</a>
<a name="ln1207"> </a>
<a name="ln1208">  intra_prefix_lsa = (struct ospf6_intra_prefix_lsa *)</a>
<a name="ln1209">    OSPF6_LSA_HEADER_END (lsa-&gt;header);</a>
<a name="ln1210">  if (intra_prefix_lsa-&gt;ref_type == htons (OSPF6_LSTYPE_ROUTER))</a>
<a name="ln1211">    ospf6_linkstate_prefix (intra_prefix_lsa-&gt;ref_adv_router,</a>
<a name="ln1212">                            htonl (0), &amp;ls_prefix);</a>
<a name="ln1213">  else if (intra_prefix_lsa-&gt;ref_type == htons (OSPF6_LSTYPE_NETWORK))</a>
<a name="ln1214">    ospf6_linkstate_prefix (intra_prefix_lsa-&gt;ref_adv_router,</a>
<a name="ln1215">                            intra_prefix_lsa-&gt;ref_id, &amp;ls_prefix);</a>
<a name="ln1216">  else</a>
<a name="ln1217">    {</a>
<a name="ln1218">      if (IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1219">        zlog_debug (&quot;Unknown reference LS-type: %#hx&quot;,</a>
<a name="ln1220">		    ntohs (intra_prefix_lsa-&gt;ref_type));</a>
<a name="ln1221">      return;</a>
<a name="ln1222">    }</a>
<a name="ln1223"> </a>
<a name="ln1224">  ls_entry = ospf6_route_lookup (&amp;ls_prefix, oa-&gt;spf_table);</a>
<a name="ln1225">  if (ls_entry == NULL)</a>
<a name="ln1226">    {</a>
<a name="ln1227">      if (IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1228">        {</a>
<a name="ln1229">          ospf6_linkstate_prefix2str (&amp;ls_prefix, buf, sizeof (buf));</a>
<a name="ln1230">          zlog_debug (&quot;LS entry does not exist: %s&quot;, buf);</a>
<a name="ln1231">        }</a>
<a name="ln1232">      return;</a>
<a name="ln1233">    }</a>
<a name="ln1234"> </a>
<a name="ln1235">  if (intra_prefix_lsa-&gt;ref_adv_router == oa-&gt;ospf6-&gt;router_id)</a>
<a name="ln1236">    {</a>
<a name="ln1237">      /* the intra-prefix are directly connected */</a>
<a name="ln1238">      direct_connect = 1;</a>
<a name="ln1239">    }</a>
<a name="ln1240"> </a>
<a name="ln1241">  prefix_num = ntohs (intra_prefix_lsa-&gt;prefix_num);</a>
<a name="ln1242">  start = (caddr_t) intra_prefix_lsa +</a>
<a name="ln1243">          sizeof (struct ospf6_intra_prefix_lsa);</a>
<a name="ln1244">  end = OSPF6_LSA_END (lsa-&gt;header);</a>
<a name="ln1245">  for (current = start; current &lt; end; current += OSPF6_PREFIX_SIZE (op))</a>
<a name="ln1246">    {</a>
<a name="ln1247">      op = (struct ospf6_prefix *) current;</a>
<a name="ln1248">      if (prefix_num == 0)</a>
<a name="ln1249">        break;</a>
<a name="ln1250">      if (end &lt; current + OSPF6_PREFIX_SIZE (op))</a>
<a name="ln1251">        break;</a>
<a name="ln1252"> </a>
<a name="ln1253">      /* Appendix A.4.1.1 */</a>
<a name="ln1254">      if (CHECK_FLAG(op-&gt;prefix_options, OSPF6_PREFIX_OPTION_NU))</a>
<a name="ln1255">	{</a>
<a name="ln1256">	  if (IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1257">	    {</a>
<a name="ln1258">	      ospf6_linkstate_prefix2str ((struct prefix *)OSPF6_PREFIX_BODY(op),</a>
<a name="ln1259">					  buf, sizeof (buf));</a>
<a name="ln1260">	      zlog_debug (&quot;%s: Skipping Prefix %s has NU option set&quot;,</a>
<a name="ln1261">			  __func__, buf);</a>
<a name="ln1262">	    }</a>
<a name="ln1263">	  continue;</a>
<a name="ln1264">	}</a>
<a name="ln1265"> </a>
<a name="ln1266">      route = ospf6_route_create ();</a>
<a name="ln1267"> </a>
<a name="ln1268">      memset (&amp;route-&gt;prefix, 0, sizeof (struct prefix));</a>
<a name="ln1269">      route-&gt;prefix.family = AF_INET6;</a>
<a name="ln1270">      route-&gt;prefix.prefixlen = op-&gt;prefix_length;</a>
<a name="ln1271">      ospf6_prefix_in6_addr (&amp;route-&gt;prefix.u.prefix6, op);</a>
<a name="ln1272"> </a>
<a name="ln1273">      route-&gt;type = OSPF6_DEST_TYPE_NETWORK;</a>
<a name="ln1274">      route-&gt;path.origin.type = lsa-&gt;header-&gt;type;</a>
<a name="ln1275">      route-&gt;path.origin.id = lsa-&gt;header-&gt;id;</a>
<a name="ln1276">      route-&gt;path.origin.adv_router = lsa-&gt;header-&gt;adv_router;</a>
<a name="ln1277">      route-&gt;path.prefix_options = op-&gt;prefix_options;</a>
<a name="ln1278">      route-&gt;path.area_id = oa-&gt;area_id;</a>
<a name="ln1279">      route-&gt;path.type = OSPF6_PATH_TYPE_INTRA;</a>
<a name="ln1280">      route-&gt;path.metric_type = 1;</a>
<a name="ln1281">      route-&gt;path.cost = ls_entry-&gt;path.cost +</a>
<a name="ln1282">                         ntohs (op-&gt;prefix_metric);</a>
<a name="ln1283"> </a>
<a name="ln1284">      if (direct_connect)</a>
<a name="ln1285">        {</a>
<a name="ln1286">          ifp = if_lookup_prefix(&amp;route-&gt;prefix);</a>
<a name="ln1287">          if (ifp)</a>
<a name="ln1288">            route-&gt;nexthop[0].ifindex = ifp-&gt;ifindex;</a>
<a name="ln1289">        }</a>
<a name="ln1290">      else</a>
<a name="ln1291">        {</a>
<a name="ln1292">          for (i = 0; i &lt; OSPF6_MULTI_PATH_LIMIT &amp;&amp;</a>
<a name="ln1293">               ospf6_nexthop_is_set (&amp;ls_entry-&gt;nexthop[i]); i++)</a>
<a name="ln1294">            ospf6_nexthop_copy (&amp;route-&gt;nexthop[i], &amp;ls_entry-&gt;nexthop[i]);</a>
<a name="ln1295">        }</a>
<a name="ln1296"> </a>
<a name="ln1297">      if (IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1298">        {</a>
<a name="ln1299">          prefix2str (&amp;route-&gt;prefix, buf, sizeof (buf));</a>
<a name="ln1300">          zlog_debug (&quot;  add %s&quot;, buf);</a>
<a name="ln1301">        }</a>
<a name="ln1302"> </a>
<a name="ln1303">      ospf6_route_add (route, oa-&gt;route_table);</a>
<a name="ln1304">      prefix_num--;</a>
<a name="ln1305">    }</a>
<a name="ln1306"> </a>
<a name="ln1307">  if (current != end &amp;&amp; IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1308">    zlog_debug (&quot;Trailing garbage ignored&quot;);</a>
<a name="ln1309">}</a>
<a name="ln1310"> </a>
<a name="ln1311">void</a>
<a name="ln1312">ospf6_intra_prefix_lsa_remove (struct ospf6_lsa *lsa)</a>
<a name="ln1313">{</a>
<a name="ln1314">  struct ospf6_area *oa;</a>
<a name="ln1315">  struct ospf6_intra_prefix_lsa *intra_prefix_lsa;</a>
<a name="ln1316">  struct prefix prefix;</a>
<a name="ln1317">  struct ospf6_route *route, *nroute;</a>
<a name="ln1318">  int prefix_num;</a>
<a name="ln1319">  struct ospf6_prefix *op;</a>
<a name="ln1320">  char *start, *current, *end;</a>
<a name="ln1321">  char buf[64];</a>
<a name="ln1322"> </a>
<a name="ln1323">  if (IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1324">    zlog_debug (&quot;%s disappearing&quot;, lsa-&gt;name);</a>
<a name="ln1325"> </a>
<a name="ln1326">  oa = OSPF6_AREA (lsa-&gt;lsdb-&gt;data);</a>
<a name="ln1327"> </a>
<a name="ln1328">  intra_prefix_lsa = (struct ospf6_intra_prefix_lsa *)</a>
<a name="ln1329">    OSPF6_LSA_HEADER_END (lsa-&gt;header);</a>
<a name="ln1330"> </a>
<a name="ln1331">  prefix_num = ntohs (intra_prefix_lsa-&gt;prefix_num);</a>
<a name="ln1332">  start = (caddr_t) intra_prefix_lsa +</a>
<a name="ln1333">          sizeof (struct ospf6_intra_prefix_lsa);</a>
<a name="ln1334">  end = OSPF6_LSA_END (lsa-&gt;header);</a>
<a name="ln1335">  for (current = start; current &lt; end; current += OSPF6_PREFIX_SIZE (op))</a>
<a name="ln1336">    {</a>
<a name="ln1337">      op = (struct ospf6_prefix *) current;</a>
<a name="ln1338">      if (prefix_num == 0)</a>
<a name="ln1339">        break;</a>
<a name="ln1340">      if (end &lt; current + OSPF6_PREFIX_SIZE (op))</a>
<a name="ln1341">        break;</a>
<a name="ln1342">      prefix_num--;</a>
<a name="ln1343"> </a>
<a name="ln1344">      memset (&amp;prefix, 0, sizeof (struct prefix));</a>
<a name="ln1345">      prefix.family = AF_INET6;</a>
<a name="ln1346">      prefix.prefixlen = op-&gt;prefix_length;</a>
<a name="ln1347">      ospf6_prefix_in6_addr (&amp;prefix.u.prefix6, op);</a>
<a name="ln1348"> </a>
<a name="ln1349">      route = ospf6_route_lookup (&amp;prefix, oa-&gt;route_table);</a>
<a name="ln1350">      if (route == NULL)</a>
<a name="ln1351">        continue;</a>
<a name="ln1352"> </a>
<a name="ln1353">      for (ospf6_route_lock (route);</a>
<a name="ln1354">           route &amp;&amp; ospf6_route_is_prefix (&amp;prefix, route);</a>
<a name="ln1355">           route = nroute)</a>
<a name="ln1356">        {</a>
<a name="ln1357">          nroute = ospf6_route_next (route);</a>
<a name="ln1358">          if (route-&gt;type != OSPF6_DEST_TYPE_NETWORK)</a>
<a name="ln1359">            continue;</a>
<a name="ln1360">          if (route-&gt;path.area_id != oa-&gt;area_id)</a>
<a name="ln1361">            continue;</a>
<a name="ln1362">          if (route-&gt;path.type != OSPF6_PATH_TYPE_INTRA)</a>
<a name="ln1363">            continue;</a>
<a name="ln1364">          if (route-&gt;path.origin.type != lsa-&gt;header-&gt;type ||</a>
<a name="ln1365">              route-&gt;path.origin.id != lsa-&gt;header-&gt;id ||</a>
<a name="ln1366">              route-&gt;path.origin.adv_router != lsa-&gt;header-&gt;adv_router)</a>
<a name="ln1367">            continue;</a>
<a name="ln1368"> </a>
<a name="ln1369">          if (IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1370">            {</a>
<a name="ln1371">              prefix2str (&amp;route-&gt;prefix, buf, sizeof (buf));</a>
<a name="ln1372">              zlog_debug (&quot;remove %s&quot;, buf);</a>
<a name="ln1373">            }</a>
<a name="ln1374">          ospf6_route_remove (route, oa-&gt;route_table);</a>
<a name="ln1375">        }</a>
<a name="ln1376">      if (route)</a>
<a name="ln1377">	ospf6_route_unlock (route);</a>
<a name="ln1378">    }</a>
<a name="ln1379"> </a>
<a name="ln1380">  if (current != end &amp;&amp; IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1381">    zlog_debug (&quot;Trailing garbage ignored&quot;);</a>
<a name="ln1382">}</a>
<a name="ln1383"> </a>
<a name="ln1384">void</a>
<a name="ln1385">ospf6_intra_route_calculation (struct ospf6_area *oa)</a>
<a name="ln1386">{</a>
<a name="ln1387">  struct ospf6_route *route, *nroute;</a>
<a name="ln1388">  u_int16_t type;</a>
<a name="ln1389">  struct ospf6_lsa *lsa;</a>
<a name="ln1390">  void (*hook_add) (struct ospf6_route *) = NULL;</a>
<a name="ln1391">  void (*hook_remove) (struct ospf6_route *) = NULL;</a>
<a name="ln1392"> </a>
<a name="ln1393">  if (IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1394">    zlog_debug (&quot;Re-examin intra-routes for area %s&quot;, oa-&gt;name);</a>
<a name="ln1395"> </a>
<a name="ln1396">  hook_add = oa-&gt;route_table-&gt;hook_add;</a>
<a name="ln1397">  hook_remove = oa-&gt;route_table-&gt;hook_remove;</a>
<a name="ln1398">  oa-&gt;route_table-&gt;hook_add = NULL;</a>
<a name="ln1399">  oa-&gt;route_table-&gt;hook_remove = NULL;</a>
<a name="ln1400"> </a>
<a name="ln1401">  for (route = ospf6_route_head (oa-&gt;route_table); route;</a>
<a name="ln1402">       route = ospf6_route_next (route))</a>
<a name="ln1403">    route-&gt;flag = OSPF6_ROUTE_REMOVE;</a>
<a name="ln1404"> </a>
<a name="ln1405">  type = htons (OSPF6_LSTYPE_INTRA_PREFIX);</a>
<a name="ln1406">  for (lsa = ospf6_lsdb_type_head (type, oa-&gt;lsdb); lsa;</a>
<a name="ln1407">       lsa = ospf6_lsdb_type_next (type, lsa))</a>
<a name="ln1408">    ospf6_intra_prefix_lsa_add (lsa);</a>
<a name="ln1409"> </a>
<a name="ln1410">  oa-&gt;route_table-&gt;hook_add = hook_add;</a>
<a name="ln1411">  oa-&gt;route_table-&gt;hook_remove = hook_remove;</a>
<a name="ln1412"> </a>
<a name="ln1413">  for (route = ospf6_route_head (oa-&gt;route_table); route;</a>
<a name="ln1414">       route = nroute)</a>
<a name="ln1415">    {</a>
<a name="ln1416">      nroute = ospf6_route_next (route);</a>
<a name="ln1417">      if (CHECK_FLAG (route-&gt;flag, OSPF6_ROUTE_REMOVE) &amp;&amp;</a>
<a name="ln1418">          CHECK_FLAG (route-&gt;flag, OSPF6_ROUTE_ADD))</a>
<a name="ln1419">        {</a>
<a name="ln1420">          UNSET_FLAG (route-&gt;flag, OSPF6_ROUTE_REMOVE);</a>
<a name="ln1421">          UNSET_FLAG (route-&gt;flag, OSPF6_ROUTE_ADD);</a>
<a name="ln1422">        }</a>
<a name="ln1423"> </a>
<a name="ln1424">      if (CHECK_FLAG (route-&gt;flag, OSPF6_ROUTE_REMOVE))</a>
<a name="ln1425">        ospf6_route_remove (route, oa-&gt;route_table);</a>
<a name="ln1426">      else if (CHECK_FLAG (route-&gt;flag, OSPF6_ROUTE_ADD) ||</a>
<a name="ln1427">               CHECK_FLAG (route-&gt;flag, OSPF6_ROUTE_CHANGE))</a>
<a name="ln1428">        {</a>
<a name="ln1429">          if (hook_add)</a>
<a name="ln1430">            (*hook_add) (route);</a>
<a name="ln1431">        }</a>
<a name="ln1432"> </a>
<a name="ln1433">      route-&gt;flag = 0;</a>
<a name="ln1434">    }</a>
<a name="ln1435"> </a>
<a name="ln1436">  if (IS_OSPF6_DEBUG_EXAMIN (INTRA_PREFIX))</a>
<a name="ln1437">    zlog_debug (&quot;Re-examin intra-routes for area %s: Done&quot;, oa-&gt;name);</a>
<a name="ln1438">}</a>
<a name="ln1439"> </a>
<a name="ln1440">static void</a>
<a name="ln1441">ospf6_brouter_debug_print (struct ospf6_route *brouter)</a>
<a name="ln1442">{</a>
<a name="ln1443">  u_int32_t brouter_id;</a>
<a name="ln1444">  char brouter_name[16];</a>
<a name="ln1445">  char area_name[16];</a>
<a name="ln1446">  char destination[64];</a>
<a name="ln1447">  char installed[16], changed[16];</a>
<a name="ln1448">  struct timeval now, res;</a>
<a name="ln1449">  char id[16], adv_router[16];</a>
<a name="ln1450">  char capa[16], options[16];</a>
<a name="ln1451"> </a>
<a name="ln1452">  brouter_id = ADV_ROUTER_IN_PREFIX (&amp;brouter-&gt;prefix);</a>
<a name="ln1453">  inet_ntop (AF_INET, &amp;brouter_id, brouter_name, sizeof (brouter_name));</a>
<a name="ln1454">  inet_ntop (AF_INET, &amp;brouter-&gt;path.area_id, area_name, sizeof (area_name));</a>
<a name="ln1455">  ospf6_linkstate_prefix2str (&amp;brouter-&gt;prefix, destination,</a>
<a name="ln1456">                              sizeof (destination));</a>
<a name="ln1457"> </a>
<a name="ln1458">  quagga_gettime (QUAGGA_CLK_MONOTONIC, &amp;now);</a>
<a name="ln1459">  timersub (&amp;now, &amp;brouter-&gt;installed, &amp;res);</a>
<a name="ln1460">  timerstring (&amp;res, installed, sizeof (installed));</a>
<a name="ln1461"> </a>
<a name="ln1462">  quagga_gettime (QUAGGA_CLK_MONOTONIC, &amp;now);</a>
<a name="ln1463">  timersub (&amp;now, &amp;brouter-&gt;changed, &amp;res);</a>
<a name="ln1464">  timerstring (&amp;res, changed, sizeof (changed));</a>
<a name="ln1465"> </a>
<a name="ln1466">  inet_ntop (AF_INET, &amp;brouter-&gt;path.origin.id, id, sizeof (id));</a>
<a name="ln1467">  inet_ntop (AF_INET, &amp;brouter-&gt;path.origin.adv_router, adv_router,</a>
<a name="ln1468">             sizeof (adv_router));</a>
<a name="ln1469"> </a>
<a name="ln1470">  ospf6_options_printbuf (brouter-&gt;path.options, options, sizeof (options));</a>
<a name="ln1471">  ospf6_capability_printbuf (brouter-&gt;path.router_bits, capa, sizeof (capa));</a>
<a name="ln1472"> </a>
<a name="ln1473">  zlog_info (&quot;Brouter: %s via area %s&quot;, brouter_name, area_name);</a>
<a name="ln1474">  zlog_info (&quot;  memory: prev: %p this: %p next: %p parent rnode: %p&quot;,</a>
<a name="ln1475">             (void *)brouter-&gt;prev, (void *)brouter, (void *)brouter-&gt;next,</a>
<a name="ln1476">             (void *)brouter-&gt;rnode);</a>
<a name="ln1477">  zlog_info (&quot;  type: %d prefix: %s installed: %s changed: %s&quot;,</a>
<a name="ln1478">             brouter-&gt;type, destination, installed, changed);</a>
<a name="ln1479">  zlog_info (&quot;  lock: %d flags: %s%s%s%s&quot;, brouter-&gt;lock,</a>
<a name="ln1480">           (CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_BEST)   ? &quot;B&quot; : &quot;-&quot;),</a>
<a name="ln1481">           (CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_ADD)    ? &quot;A&quot; : &quot;-&quot;),</a>
<a name="ln1482">           (CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_REMOVE) ? &quot;R&quot; : &quot;-&quot;),</a>
<a name="ln1483">           (CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_CHANGE) ? &quot;C&quot; : &quot;-&quot;));</a>
<a name="ln1484">  zlog_info (&quot;  path type: %s ls-origin %s id: %s adv-router %s&quot;,</a>
<a name="ln1485">             OSPF6_PATH_TYPE_NAME (brouter-&gt;path.type),</a>
<a name="ln1486">             ospf6_lstype_name (brouter-&gt;path.origin.type),</a>
<a name="ln1487">             id, adv_router);</a>
<a name="ln1488">  zlog_info (&quot;  options: %s router-bits: %s metric-type: %d metric: %d/%d&quot;,</a>
<a name="ln1489">             options, capa, brouter-&gt;path.metric_type,</a>
<a name="ln1490">             brouter-&gt;path.cost, brouter-&gt;path.cost_e2);</a>
<a name="ln1491">}</a>
<a name="ln1492"> </a>
<a name="ln1493">void</a>
<a name="ln1494">ospf6_intra_brouter_calculation (struct ospf6_area *oa)</a>
<a name="ln1495">{</a>
<a name="ln1496">  struct ospf6_route *brouter, *nbrouter, *copy;</a>
<a name="ln1497">  void (*hook_add) (struct ospf6_route *) = NULL;</a>
<a name="ln1498">  void (*hook_remove) (struct ospf6_route *) = NULL;</a>
<a name="ln1499">  u_int32_t brouter_id;</a>
<a name="ln1500">  char brouter_name[16];</a>
<a name="ln1501">  </a>
<a name="ln1502">  if (IS_OSPF6_DEBUG_BROUTER_SPECIFIC_AREA_ID (oa-&gt;area_id))</a>
<a name="ln1503">    zlog_info (&quot;border-router calculation for area %s&quot;, oa-&gt;name);</a>
<a name="ln1504">  </a>
<a name="ln1505">  hook_add = oa-&gt;ospf6-&gt;brouter_table-&gt;hook_add;</a>
<a name="ln1506">  hook_remove = oa-&gt;ospf6-&gt;brouter_table-&gt;hook_remove;</a>
<a name="ln1507">  oa-&gt;ospf6-&gt;brouter_table-&gt;hook_add = NULL;</a>
<a name="ln1508">  oa-&gt;ospf6-&gt;brouter_table-&gt;hook_remove = NULL;</a>
<a name="ln1509"> </a>
<a name="ln1510">  /* withdraw the previous router entries for the area */</a>
<a name="ln1511">  for (brouter = ospf6_route_head (oa-&gt;ospf6-&gt;brouter_table); brouter;</a>
<a name="ln1512">       brouter = ospf6_route_next (brouter))</a>
<a name="ln1513">    {</a>
<a name="ln1514">      brouter_id = ADV_ROUTER_IN_PREFIX (&amp;brouter-&gt;prefix);</a>
<a name="ln1515">      inet_ntop (AF_INET, &amp;brouter_id, brouter_name, sizeof (brouter_name));</a>
<a name="ln1516">      if (brouter-&gt;path.area_id != oa-&gt;area_id)</a>
<a name="ln1517">        continue;</a>
<a name="ln1518">      brouter-&gt;flag = OSPF6_ROUTE_REMOVE;</a>
<a name="ln1519"> </a>
<a name="ln1520">      if (IS_OSPF6_DEBUG_BROUTER_SPECIFIC_ROUTER_ID (brouter_id) ||</a>
<a name="ln1521">          IS_OSPF6_DEBUG_ROUTE (MEMORY))</a>
<a name="ln1522">        {</a>
<a name="ln1523">          zlog_info (&quot;%p: mark as removing: area %s brouter %s&quot;,</a>
<a name="ln1524">                     (void *)brouter, oa-&gt;name, brouter_name);</a>
<a name="ln1525">          ospf6_brouter_debug_print (brouter);</a>
<a name="ln1526">        }</a>
<a name="ln1527">    }</a>
<a name="ln1528"> </a>
<a name="ln1529">  for (brouter = ospf6_route_head (oa-&gt;spf_table); brouter;</a>
<a name="ln1530">       brouter = ospf6_route_next (brouter))</a>
<a name="ln1531">    {</a>
<a name="ln1532">      brouter_id = ADV_ROUTER_IN_PREFIX (&amp;brouter-&gt;prefix);</a>
<a name="ln1533">      inet_ntop (AF_INET, &amp;brouter_id, brouter_name, sizeof (brouter_name));</a>
<a name="ln1534"> </a>
<a name="ln1535">      if (brouter-&gt;type != OSPF6_DEST_TYPE_LINKSTATE)</a>
<a name="ln1536">        continue;</a>
<a name="ln1537">      if (ospf6_linkstate_prefix_id (&amp;brouter-&gt;prefix) != htonl (0))</a>
<a name="ln1538">        continue;</a>
<a name="ln1539">      if (! CHECK_FLAG (brouter-&gt;path.router_bits, OSPF6_ROUTER_BIT_E) &amp;&amp;</a>
<a name="ln1540">          ! CHECK_FLAG (brouter-&gt;path.router_bits, OSPF6_ROUTER_BIT_B))</a>
<a name="ln1541">        continue;</a>
<a name="ln1542"> </a>
<a name="ln1543">      if (! OSPF6_OPT_ISSET (brouter-&gt;path.options, OSPF6_OPT_V6) ||</a>
<a name="ln1544">	  ! OSPF6_OPT_ISSET (brouter-&gt;path.options, OSPF6_OPT_R))</a>
<a name="ln1545">	continue;</a>
<a name="ln1546"> </a>
<a name="ln1547">      copy = ospf6_route_copy (brouter);</a>
<a name="ln1548">      copy-&gt;type = OSPF6_DEST_TYPE_ROUTER;</a>
<a name="ln1549">      copy-&gt;path.area_id = oa-&gt;area_id;</a>
<a name="ln1550">      ospf6_route_add (copy, oa-&gt;ospf6-&gt;brouter_table);</a>
<a name="ln1551"> </a>
<a name="ln1552">      if (IS_OSPF6_DEBUG_BROUTER_SPECIFIC_ROUTER_ID (brouter_id) ||</a>
<a name="ln1553">          IS_OSPF6_DEBUG_ROUTE (MEMORY))</a>
<a name="ln1554">        {</a>
<a name="ln1555">          zlog_info (&quot;%p: transfer: area %s brouter %s&quot;,</a>
<a name="ln1556">                     (void *)brouter, oa-&gt;name, brouter_name);</a>
<a name="ln1557">          ospf6_brouter_debug_print (brouter);</a>
<a name="ln1558">        }</a>
<a name="ln1559">    }</a>
<a name="ln1560"> </a>
<a name="ln1561">  oa-&gt;ospf6-&gt;brouter_table-&gt;hook_add = hook_add;</a>
<a name="ln1562">  oa-&gt;ospf6-&gt;brouter_table-&gt;hook_remove = hook_remove;</a>
<a name="ln1563"> </a>
<a name="ln1564">  for (brouter = ospf6_route_head (oa-&gt;ospf6-&gt;brouter_table); brouter;</a>
<a name="ln1565">       brouter = nbrouter)</a>
<a name="ln1566">    {</a>
<a name="ln1567">      nbrouter = ospf6_route_next (brouter);</a>
<a name="ln1568">      brouter_id = ADV_ROUTER_IN_PREFIX (&amp;brouter-&gt;prefix);</a>
<a name="ln1569">      inet_ntop (AF_INET, &amp;brouter_id, brouter_name, sizeof (brouter_name));</a>
<a name="ln1570">      </a>
<a name="ln1571">      if (brouter-&gt;path.area_id != oa-&gt;area_id)</a>
<a name="ln1572">        continue;</a>
<a name="ln1573"> </a>
<a name="ln1574">      if (CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_WAS_REMOVED))</a>
<a name="ln1575">        continue;</a>
<a name="ln1576"> </a>
<a name="ln1577">      if (CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_REMOVE) &amp;&amp;</a>
<a name="ln1578">          CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_ADD))</a>
<a name="ln1579">        {</a>
<a name="ln1580">          UNSET_FLAG (brouter-&gt;flag, OSPF6_ROUTE_REMOVE);</a>
<a name="ln1581">          UNSET_FLAG (brouter-&gt;flag, OSPF6_ROUTE_ADD);</a>
<a name="ln1582">        }</a>
<a name="ln1583"> </a>
<a name="ln1584">      if (CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_REMOVE))</a>
<a name="ln1585">        {</a>
<a name="ln1586">          if (IS_OSPF6_DEBUG_BROUTER ||</a>
<a name="ln1587">              IS_OSPF6_DEBUG_BROUTER_SPECIFIC_ROUTER_ID (brouter_id) ||</a>
<a name="ln1588">              IS_OSPF6_DEBUG_BROUTER_SPECIFIC_AREA_ID (oa-&gt;area_id))</a>
<a name="ln1589">            zlog_info (&quot;brouter %s disappears via area %s&quot;,</a>
<a name="ln1590">                       brouter_name, oa-&gt;name);</a>
<a name="ln1591">          ospf6_route_remove (brouter, oa-&gt;ospf6-&gt;brouter_table);</a>
<a name="ln1592">        }</a>
<a name="ln1593">      else if (CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_ADD) ||</a>
<a name="ln1594">               CHECK_FLAG (brouter-&gt;flag, OSPF6_ROUTE_CHANGE))</a>
<a name="ln1595">        {</a>
<a name="ln1596">          if (IS_OSPF6_DEBUG_BROUTER ||</a>
<a name="ln1597">              IS_OSPF6_DEBUG_BROUTER_SPECIFIC_ROUTER_ID (brouter_id) ||</a>
<a name="ln1598">              IS_OSPF6_DEBUG_BROUTER_SPECIFIC_AREA_ID (oa-&gt;area_id))</a>
<a name="ln1599">            zlog_info (&quot;brouter %s appears via area %s&quot;,</a>
<a name="ln1600">                       brouter_name, oa-&gt;name);</a>
<a name="ln1601"> </a>
<a name="ln1602">          /* newly added */</a>
<a name="ln1603">          if (hook_add)</a>
<a name="ln1604">            (*hook_add) (brouter);</a>
<a name="ln1605">        }</a>
<a name="ln1606">      else</a>
<a name="ln1607">        {</a>
<a name="ln1608">          if (IS_OSPF6_DEBUG_BROUTER_SPECIFIC_ROUTER_ID (brouter_id) ||</a>
<a name="ln1609">              IS_OSPF6_DEBUG_BROUTER_SPECIFIC_AREA_ID (oa-&gt;area_id))</a>
<a name="ln1610">            zlog_info (&quot;brouter %s still exists via area %s&quot;,</a>
<a name="ln1611">                       brouter_name, oa-&gt;name);</a>
<a name="ln1612">        }</a>
<a name="ln1613"> </a>
<a name="ln1614">      brouter-&gt;flag = 0;</a>
<a name="ln1615">    }</a>
<a name="ln1616"> </a>
<a name="ln1617">  if (IS_OSPF6_DEBUG_BROUTER_SPECIFIC_AREA_ID (oa-&gt;area_id))</a>
<a name="ln1618">    zlog_info (&quot;border-router calculation for area %s: done&quot;, oa-&gt;name);</a>
<a name="ln1619">}</a>
<a name="ln1620"> </a>
<a name="ln1621">struct ospf6_lsa_handler router_handler =</a>
<a name="ln1622">{</a>
<a name="ln1623">  OSPF6_LSTYPE_ROUTER,</a>
<a name="ln1624">  &quot;Router&quot;,</a>
<a name="ln1625">  &quot;Rtr&quot;,</a>
<a name="ln1626">  ospf6_router_lsa_show,</a>
<a name="ln1627">  ospf6_router_lsa_get_nbr_id</a>
<a name="ln1628">};</a>
<a name="ln1629"> </a>
<a name="ln1630">struct ospf6_lsa_handler network_handler =</a>
<a name="ln1631">{</a>
<a name="ln1632">  OSPF6_LSTYPE_NETWORK,</a>
<a name="ln1633">  &quot;Network&quot;,</a>
<a name="ln1634">  &quot;Net&quot;,</a>
<a name="ln1635">  ospf6_network_lsa_show,</a>
<a name="ln1636">  ospf6_network_lsa_get_ar_id</a>
<a name="ln1637">};</a>
<a name="ln1638"> </a>
<a name="ln1639">struct ospf6_lsa_handler link_handler =</a>
<a name="ln1640">{</a>
<a name="ln1641">  OSPF6_LSTYPE_LINK,</a>
<a name="ln1642">  &quot;Link&quot;,</a>
<a name="ln1643">  &quot;Lnk&quot;,</a>
<a name="ln1644">  ospf6_link_lsa_show,</a>
<a name="ln1645">  ospf6_link_lsa_get_prefix_str</a>
<a name="ln1646">};</a>
<a name="ln1647"> </a>
<a name="ln1648">struct ospf6_lsa_handler intra_prefix_handler =</a>
<a name="ln1649">{</a>
<a name="ln1650">  OSPF6_LSTYPE_INTRA_PREFIX,</a>
<a name="ln1651">  &quot;Intra-Prefix&quot;,</a>
<a name="ln1652">  &quot;INP&quot;,</a>
<a name="ln1653">  ospf6_intra_prefix_lsa_show,</a>
<a name="ln1654">  ospf6_intra_prefix_lsa_get_prefix_str</a>
<a name="ln1655">};</a>
<a name="ln1656"> </a>
<a name="ln1657">void</a>
<a name="ln1658">ospf6_intra_init (void)</a>
<a name="ln1659">{</a>
<a name="ln1660">  ospf6_install_lsa_handler (&amp;router_handler);</a>
<a name="ln1661">  ospf6_install_lsa_handler (&amp;network_handler);</a>
<a name="ln1662">  ospf6_install_lsa_handler (&amp;link_handler);</a>
<a name="ln1663">  ospf6_install_lsa_handler (&amp;intra_prefix_handler);</a>
<a name="ln1664">}</a>
<a name="ln1665"> </a>
<a name="ln1666">DEFUN (debug_ospf6_brouter,</a>
<a name="ln1667">       debug_ospf6_brouter_cmd,</a>
<a name="ln1668">       &quot;debug ospf6 border-routers&quot;,</a>
<a name="ln1669">       DEBUG_STR</a>
<a name="ln1670">       OSPF6_STR</a>
<a name="ln1671">       &quot;Debug border router\n&quot;</a>
<a name="ln1672">      )</a>
<a name="ln1673">{</a>
<a name="ln1674">  OSPF6_DEBUG_BROUTER_ON ();</a>
<a name="ln1675">  return CMD_SUCCESS;</a>
<a name="ln1676">}</a>
<a name="ln1677"> </a>
<a name="ln1678">DEFUN (no_debug_ospf6_brouter,</a>
<a name="ln1679">       no_debug_ospf6_brouter_cmd,</a>
<a name="ln1680">       &quot;no debug ospf6 border-routers&quot;,</a>
<a name="ln1681">       NO_STR</a>
<a name="ln1682">       DEBUG_STR</a>
<a name="ln1683">       OSPF6_STR</a>
<a name="ln1684">       &quot;Debug border router\n&quot;</a>
<a name="ln1685">      )</a>
<a name="ln1686">{</a>
<a name="ln1687">  OSPF6_DEBUG_BROUTER_OFF ();</a>
<a name="ln1688">  return CMD_SUCCESS;</a>
<a name="ln1689">}</a>
<a name="ln1690"> </a>
<a name="ln1691">DEFUN (debug_ospf6_brouter_router,</a>
<a name="ln1692">       debug_ospf6_brouter_router_cmd,</a>
<a name="ln1693">       &quot;debug ospf6 border-routers router-id A.B.C.D&quot;,</a>
<a name="ln1694">       DEBUG_STR</a>
<a name="ln1695">       OSPF6_STR</a>
<a name="ln1696">       &quot;Debug border router\n&quot;</a>
<a name="ln1697">       &quot;Debug specific border router\n&quot;</a>
<a name="ln1698">       &quot;Specify border-router's router-id\n&quot;</a>
<a name="ln1699">      )</a>
<a name="ln1700">{</a>
<a name="ln1701">  u_int32_t router_id;</a>
<a name="ln1702">  inet_pton (AF_INET, argv[0], &amp;router_id);</a>
<a name="ln1703">  OSPF6_DEBUG_BROUTER_SPECIFIC_ROUTER_ON (router_id);</a>
<a name="ln1704">  return CMD_SUCCESS;</a>
<a name="ln1705">}</a>
<a name="ln1706"> </a>
<a name="ln1707">DEFUN (no_debug_ospf6_brouter_router,</a>
<a name="ln1708">       no_debug_ospf6_brouter_router_cmd,</a>
<a name="ln1709">       &quot;no debug ospf6 border-routers router-id&quot;,</a>
<a name="ln1710">       NO_STR</a>
<a name="ln1711">       DEBUG_STR</a>
<a name="ln1712">       OSPF6_STR</a>
<a name="ln1713">       &quot;Debug border router\n&quot;</a>
<a name="ln1714">       &quot;Debug specific border router\n&quot;</a>
<a name="ln1715">      )</a>
<a name="ln1716">{</a>
<a name="ln1717">  OSPF6_DEBUG_BROUTER_SPECIFIC_ROUTER_OFF ();</a>
<a name="ln1718">  return CMD_SUCCESS;</a>
<a name="ln1719">}</a>
<a name="ln1720"> </a>
<a name="ln1721">DEFUN (debug_ospf6_brouter_area,</a>
<a name="ln1722">       debug_ospf6_brouter_area_cmd,</a>
<a name="ln1723">       &quot;debug ospf6 border-routers area-id A.B.C.D&quot;,</a>
<a name="ln1724">       DEBUG_STR</a>
<a name="ln1725">       OSPF6_STR</a>
<a name="ln1726">       &quot;Debug border router\n&quot;</a>
<a name="ln1727">       &quot;Debug border routers in specific Area\n&quot;</a>
<a name="ln1728">       &quot;Specify Area-ID\n&quot;</a>
<a name="ln1729">      )</a>
<a name="ln1730">{</a>
<a name="ln1731">  u_int32_t area_id;</a>
<a name="ln1732">  inet_pton (AF_INET, argv[0], &amp;area_id);</a>
<a name="ln1733">  OSPF6_DEBUG_BROUTER_SPECIFIC_AREA_ON (area_id);</a>
<a name="ln1734">  return CMD_SUCCESS;</a>
<a name="ln1735">}</a>
<a name="ln1736"> </a>
<a name="ln1737">DEFUN (no_debug_ospf6_brouter_area,</a>
<a name="ln1738">       no_debug_ospf6_brouter_area_cmd,</a>
<a name="ln1739">       &quot;no debug ospf6 border-routers area-id&quot;,</a>
<a name="ln1740">       NO_STR</a>
<a name="ln1741">       DEBUG_STR</a>
<a name="ln1742">       OSPF6_STR</a>
<a name="ln1743">       &quot;Debug border router\n&quot;</a>
<a name="ln1744">       &quot;Debug border routers in specific Area\n&quot;</a>
<a name="ln1745">      )</a>
<a name="ln1746">{</a>
<a name="ln1747">  OSPF6_DEBUG_BROUTER_SPECIFIC_AREA_OFF ();</a>
<a name="ln1748">  return CMD_SUCCESS;</a>
<a name="ln1749">}</a>
<a name="ln1750"> </a>
<a name="ln1751">int</a>
<a name="ln1752">config_write_ospf6_debug_brouter (struct vty *vty)</a>
<a name="ln1753">{</a>
<a name="ln1754">  char buf[16];</a>
<a name="ln1755">  if (IS_OSPF6_DEBUG_BROUTER)</a>
<a name="ln1756">    vty_out (vty, &quot;debug ospf6 border-routers%s&quot;, VNL);</a>
<a name="ln1757">  if (IS_OSPF6_DEBUG_BROUTER_SPECIFIC_ROUTER)</a>
<a name="ln1758">    {</a>
<a name="ln1759">      inet_ntop (AF_INET, &amp;conf_debug_ospf6_brouter_specific_router_id,</a>
<a name="ln1760">                 buf, sizeof (buf));</a>
<a name="ln1761">      vty_out (vty, &quot;debug ospf6 border-routers router-id %s%s&quot;, buf, VNL);</a>
<a name="ln1762">    }</a>
<a name="ln1763">  if (IS_OSPF6_DEBUG_BROUTER_SPECIFIC_AREA)</a>
<a name="ln1764">    {</a>
<a name="ln1765">      inet_ntop (AF_INET, &amp;conf_debug_ospf6_brouter_specific_area_id,</a>
<a name="ln1766">                 buf, sizeof (buf));</a>
<a name="ln1767">      vty_out (vty, &quot;debug ospf6 border-routers area-id %s%s&quot;, buf, VNL);</a>
<a name="ln1768">    }</a>
<a name="ln1769">  return 0;</a>
<a name="ln1770">}</a>
<a name="ln1771"> </a>
<a name="ln1772">void</a>
<a name="ln1773">install_element_ospf6_debug_brouter (void)</a>
<a name="ln1774">{</a>
<a name="ln1775">  install_element (ENABLE_NODE, &amp;debug_ospf6_brouter_cmd);</a>
<a name="ln1776">  install_element (ENABLE_NODE, &amp;debug_ospf6_brouter_router_cmd);</a>
<a name="ln1777">  install_element (ENABLE_NODE, &amp;debug_ospf6_brouter_area_cmd);</a>
<a name="ln1778">  install_element (ENABLE_NODE, &amp;no_debug_ospf6_brouter_cmd);</a>
<a name="ln1779">  install_element (ENABLE_NODE, &amp;no_debug_ospf6_brouter_router_cmd);</a>
<a name="ln1780">  install_element (ENABLE_NODE, &amp;no_debug_ospf6_brouter_area_cmd);</a>
<a name="ln1781">  install_element (CONFIG_NODE, &amp;debug_ospf6_brouter_cmd);</a>
<a name="ln1782">  install_element (CONFIG_NODE, &amp;debug_ospf6_brouter_router_cmd);</a>
<a name="ln1783">  install_element (CONFIG_NODE, &amp;debug_ospf6_brouter_area_cmd);</a>
<a name="ln1784">  install_element (CONFIG_NODE, &amp;no_debug_ospf6_brouter_cmd);</a>
<a name="ln1785">  install_element (CONFIG_NODE, &amp;no_debug_ospf6_brouter_router_cmd);</a>
<a name="ln1786">  install_element (CONFIG_NODE, &amp;no_debug_ospf6_brouter_area_cmd);</a>
<a name="ln1787">}</a>
<a name="ln1788"> </a>
<a name="ln1789"> </a>

</code></pre>
<div class="balloon" rel="7"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>
<div class="balloon" rel="193"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buffer' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="216"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'router_lsa' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="463"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buffer' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="480"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'network_lsa' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="680"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buffer' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="681"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'lsa_header' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="691"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'link_lsa' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="880"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buffer' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="881"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'lsa_header' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="942"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'intra_prefix_lsa' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="1035"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buffer' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="1036"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'lsa_header' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="1137"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'intra_prefix_lsa' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="1380"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1020/" target="_blank">V1020</a> The function exited without calling the 'ospf6_route_unlock' function. Check lines: 1380, 1353.</p></div>
<div class="balloon" rel="1381"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1020/" target="_blank">V1020</a> The function exited without calling the 'ospf6_route_unlock' function. Check lines: 1381, 1353.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
