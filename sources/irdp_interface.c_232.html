
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=windows-1256" />
  <title>irdp_interface.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> *</a>
<a name="ln3"> * Copyright (C) 2000  Robert Olsson.</a>
<a name="ln4"> * Swedish University of Agricultural Sciences</a>
<a name="ln5"> *</a>
<a name="ln6"> * This file is part of GNU Zebra.</a>
<a name="ln7"> *</a>
<a name="ln8"> * GNU Zebra is free software; you can redistribute it and/or modify it</a>
<a name="ln9"> * under the terms of the GNU General Public License as published by the</a>
<a name="ln10"> * Free Software Foundation; either version 2, or (at your option) any</a>
<a name="ln11"> * later version.</a>
<a name="ln12"> *</a>
<a name="ln13"> * GNU Zebra is distributed in the hope that it will be useful, but</a>
<a name="ln14"> * WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln15"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln16"> * General Public License for more details.</a>
<a name="ln17"> *</a>
<a name="ln18"> * You should have received a copy of the GNU General Public License</a>
<a name="ln19"> * along with GNU Zebra; see the file COPYING.  If not, write to the Free</a>
<a name="ln20"> * Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</a>
<a name="ln21"> * 02111-1307, USA.  </a>
<a name="ln22"> */</a>
<a name="ln23"> </a>
<a name="ln24">/* </a>
<a name="ln25"> * This work includes work with the following copywrite:</a>
<a name="ln26"> *</a>
<a name="ln27"> * Copyright (C) 1997, 2000 Kunihiro Ishiguro</a>
<a name="ln28"> *</a>
<a name="ln29"> */</a>
<a name="ln30"> </a>
<a name="ln31">/* </a>
<a name="ln32"> * Thanks to Jens Låås at Swedish University of Agricultural Sciences</a>
<a name="ln33"> * for reviewing and tests.</a>
<a name="ln34"> */</a>
<a name="ln35"> </a>
<a name="ln36"> </a>
<a name="ln37">#include &lt;zebra.h&gt;</a>
<a name="ln38"> </a>
<a name="ln39">#ifdef HAVE_IRDP </a>
<a name="ln40"> </a>
<a name="ln41">#include &quot;if.h&quot;</a>
<a name="ln42">#include &quot;vty.h&quot;</a>
<a name="ln43">#include &quot;sockunion.h&quot;</a>
<a name="ln44">#include &quot;prefix.h&quot;</a>
<a name="ln45">#include &quot;command.h&quot;</a>
<a name="ln46">#include &quot;memory.h&quot;</a>
<a name="ln47">#include &quot;stream.h&quot;</a>
<a name="ln48">#include &quot;ioctl.h&quot;</a>
<a name="ln49">#include &quot;connected.h&quot;</a>
<a name="ln50">#include &quot;log.h&quot;</a>
<a name="ln51">#include &quot;zclient.h&quot;</a>
<a name="ln52">#include &quot;thread.h&quot;</a>
<a name="ln53">#include &quot;zebra/interface.h&quot;</a>
<a name="ln54">#include &quot;zebra/rtadv.h&quot;</a>
<a name="ln55">#include &quot;zebra/rib.h&quot;</a>
<a name="ln56">#include &quot;zebra/zserv.h&quot;</a>
<a name="ln57">#include &quot;zebra/redistribute.h&quot;</a>
<a name="ln58">#include &quot;zebra/irdp.h&quot;</a>
<a name="ln59">#include &lt;netinet/ip_icmp.h&gt;</a>
<a name="ln60">#include &quot;if.h&quot;</a>
<a name="ln61">#include &quot;sockunion.h&quot;</a>
<a name="ln62">#include &quot;log.h&quot;</a>
<a name="ln63"> </a>
<a name="ln64"> </a>
<a name="ln65">/* Master of threads. */</a>
<a name="ln66">extern struct zebra_t zebrad;</a>
<a name="ln67"> </a>
<a name="ln68">extern int irdp_sock;</a>
<a name="ln69"> </a>
<a name="ln70">static const char *</a>
<a name="ln71">inet_2a(u_int32_t a, char *b)</a>
<a name="ln72">{</a>
<a name="ln73">  sprintf(b, &quot;%u.%u.%u.%u&quot;,</a>
<a name="ln74">          (a    ) &amp; 0xFF,</a>
<a name="ln75">          (a&gt;&gt; 8) &amp; 0xFF,</a>
<a name="ln76">          (a&gt;&gt;16) &amp; 0xFF,</a>
<a name="ln77">          (a&gt;&gt;24) &amp; 0xFF);</a>
<a name="ln78">  return  b;</a>
<a name="ln79">}</a>
<a name="ln80"> </a>
<a name="ln81"> </a>
<a name="ln82">static struct prefix *</a>
<a name="ln83">irdp_get_prefix(struct interface *ifp)</a>
<a name="ln84">{</a>
<a name="ln85">  struct listnode *node;</a>
<a name="ln86">  struct connected *ifc;</a>
<a name="ln87">  </a>
<a name="ln88">  if (ifp-&gt;connected)</a>
<a name="ln89">    for (ALL_LIST_ELEMENTS_RO (ifp-&gt;connected, node, ifc))</a>
<a name="ln90">      return ifc-&gt;address;</a>
<a name="ln91"> </a>
<a name="ln92">  return NULL;</a>
<a name="ln93">}</a>
<a name="ln94"> </a>
<a name="ln95">/* Join to the add/leave multicast group. */</a>
<a name="ln96">static int</a>
<a name="ln97">if_group (struct interface *ifp, </a>
<a name="ln98">	  int sock, </a>
<a name="ln99">	  u_int32_t group, </a>
<a name="ln100">	  int add_leave)</a>
<a name="ln101">{</a>
<a name="ln102">  struct ip_mreq m;</a>
<a name="ln103">  struct prefix *p;</a>
<a name="ln104">  int ret;</a>
<a name="ln105">  char b1[INET_ADDRSTRLEN];</a>
<a name="ln106"> </a>
<a name="ln107">  memset (&amp;m, 0, sizeof (m));</a>
<a name="ln108">  m.imr_multiaddr.s_addr = htonl (group);</a>
<a name="ln109">  p = irdp_get_prefix(ifp);</a>
<a name="ln110"> </a>
<a name="ln111">  if(!p) {</a>
<a name="ln112">        zlog_warn (&quot;IRDP: can't get address for %s&quot;, ifp-&gt;name);</a>
<a name="ln113">	return 1;</a>
<a name="ln114">  }</a>
<a name="ln115"> </a>
<a name="ln116">  m.imr_interface = p-&gt;u.prefix4;</a>
<a name="ln117"> </a>
<a name="ln118">  ret = setsockopt (sock, IPPROTO_IP, add_leave,</a>
<a name="ln119">		    (char *) &amp;m, sizeof (struct ip_mreq));</a>
<a name="ln120">  if (ret &lt; 0)</a>
<a name="ln121">    zlog_warn (&quot;IRDP: %s can't setsockopt %s: %s&quot;,</a>
<a name="ln122">	       add_leave == IP_ADD_MEMBERSHIP? &quot;join group&quot;:&quot;leave group&quot;, </a>
<a name="ln123">	       inet_2a(group, b1),</a>
<a name="ln124">	       safe_strerror (errno));</a>
<a name="ln125"> </a>
<a name="ln126">  return ret;</a>
<a name="ln127">}</a>
<a name="ln128"> </a>
<a name="ln129">static int</a>
<a name="ln130">if_add_group (struct interface *ifp)</a>
<a name="ln131">{</a>
<a name="ln132">  struct zebra_if *zi= ifp-&gt;info;</a>
<a name="ln133">  struct irdp_interface *irdp = &amp;zi-&gt;irdp;</a>
<a name="ln134">  int ret;</a>
<a name="ln135">  char b1[INET_ADDRSTRLEN];</a>
<a name="ln136"> </a>
<a name="ln137">  ret = if_group (ifp, irdp_sock, INADDR_ALLRTRS_GROUP, IP_ADD_MEMBERSHIP);</a>
<a name="ln138">  if (ret &lt; 0) {</a>
<a name="ln139">    return ret;</a>
<a name="ln140">  }</a>
<a name="ln141"> </a>
<a name="ln142">  if(irdp-&gt;flags &amp; IF_DEBUG_MISC )</a>
<a name="ln143">    zlog_debug(&quot;IRDP: Adding group %s for %s&quot;, </a>
<a name="ln144">	       inet_2a(htonl(INADDR_ALLRTRS_GROUP), b1),</a>
<a name="ln145">	       ifp-&gt;name);</a>
<a name="ln146">  return 0;</a>
<a name="ln147">}</a>
<a name="ln148"> </a>
<a name="ln149">static int</a>
<a name="ln150">if_drop_group (struct interface *ifp)</a>
<a name="ln151">{</a>
<a name="ln152">  struct zebra_if *zi= ifp-&gt;info;</a>
<a name="ln153">  struct irdp_interface *irdp = &amp;zi-&gt;irdp;</a>
<a name="ln154">  int ret;</a>
<a name="ln155">  char b1[INET_ADDRSTRLEN];</a>
<a name="ln156"> </a>
<a name="ln157">  ret = if_group (ifp, irdp_sock, INADDR_ALLRTRS_GROUP, IP_DROP_MEMBERSHIP);</a>
<a name="ln158">  if (ret &lt; 0)</a>
<a name="ln159">    return ret;</a>
<a name="ln160"> </a>
<a name="ln161">  if(irdp-&gt;flags &amp; IF_DEBUG_MISC)</a>
<a name="ln162">    zlog_debug(&quot;IRDP: Leaving group %s for %s&quot;, </a>
<a name="ln163">	       inet_2a(htonl(INADDR_ALLRTRS_GROUP), b1),</a>
<a name="ln164">	       ifp-&gt;name);</a>
<a name="ln165">  return 0;</a>
<a name="ln166">}</a>
<a name="ln167"> </a>
<a name="ln168">static void</a>
<a name="ln169">if_set_defaults(struct interface *ifp)</a>
<a name="ln170">{</a>
<a name="ln171">  struct zebra_if *zi=ifp-&gt;info;</a>
<a name="ln172">  struct irdp_interface *irdp=&amp;zi-&gt;irdp;</a>
<a name="ln173"> </a>
<a name="ln174">  irdp-&gt;MaxAdvertInterval = IRDP_MAXADVERTINTERVAL;</a>
<a name="ln175">  irdp-&gt;MinAdvertInterval = IRDP_MINADVERTINTERVAL;</a>
<a name="ln176">  irdp-&gt;Preference = IRDP_PREFERENCE;</a>
<a name="ln177">  irdp-&gt;Lifetime = IRDP_LIFETIME;</a>
<a name="ln178">}</a>
<a name="ln179"> </a>
<a name="ln180"> </a>
<a name="ln181">static struct Adv *Adv_new (void)</a>
<a name="ln182">{</a>
<a name="ln183">  return XCALLOC (MTYPE_TMP, sizeof (struct Adv));</a>
<a name="ln184">}</a>
<a name="ln185"> </a>
<a name="ln186">static void</a>
<a name="ln187">Adv_free (struct Adv *adv)</a>
<a name="ln188">{</a>
<a name="ln189">  XFREE (MTYPE_TMP, adv);</a>
<a name="ln190">}</a>
<a name="ln191"> </a>
<a name="ln192">static void</a>
<a name="ln193">irdp_if_start(struct interface *ifp, int multicast, int set_defaults)</a>
<a name="ln194">{</a>
<a name="ln195">  struct zebra_if *zi= ifp-&gt;info;</a>
<a name="ln196">  struct irdp_interface *irdp = &amp;zi-&gt;irdp;</a>
<a name="ln197">  struct listnode *node;</a>
<a name="ln198">  struct connected *ifc;</a>
<a name="ln199">  u_int32_t timer, seed;</a>
<a name="ln200"> </a>
<a name="ln201">  if (irdp-&gt;flags &amp; IF_ACTIVE ) {</a>
<a name="ln202">    zlog_warn(&quot;IRDP: Interface is already active %s&quot;, ifp-&gt;name);</a>
<a name="ln203">    return;</a>
<a name="ln204">  }</a>
<a name="ln205">  if ((irdp_sock &lt; 0) &amp;&amp; ((irdp_sock = irdp_sock_init()) &lt; 0)) {</a>
<a name="ln206">    zlog_warn(&quot;IRDP: Cannot activate interface %s (cannot create &quot;</a>
<a name="ln207">	      &quot;IRDP socket)&quot;, ifp-&gt;name);</a>
<a name="ln208">    return;</a>
<a name="ln209">  }</a>
<a name="ln210">  irdp-&gt;flags |= IF_ACTIVE;</a>
<a name="ln211"> </a>
<a name="ln212">  if(!multicast) </a>
<a name="ln213">    irdp-&gt;flags |= IF_BROADCAST;</a>
<a name="ln214"> </a>
<a name="ln215">  if_add_update(ifp);</a>
<a name="ln216"> </a>
<a name="ln217">  if (! (ifp-&gt;flags &amp; IFF_UP)) {</a>
<a name="ln218">    zlog_warn(&quot;IRDP: Interface is down %s&quot;, ifp-&gt;name);</a>
<a name="ln219">  }</a>
<a name="ln220"> </a>
<a name="ln221">  /* Shall we cancel if_start if if_add_group fails? */</a>
<a name="ln222"> </a>
<a name="ln223">  if( multicast) {</a>
<a name="ln224">    if_add_group(ifp);</a>
<a name="ln225">    </a>
<a name="ln226">    if (! (ifp-&gt;flags &amp; (IFF_MULTICAST|IFF_ALLMULTI))) {</a>
<a name="ln227">      zlog_warn(&quot;IRDP: Interface not multicast enabled %s&quot;, ifp-&gt;name);</a>
<a name="ln228">    }</a>
<a name="ln229">  }</a>
<a name="ln230"> </a>
<a name="ln231">  if(set_defaults) </a>
<a name="ln232">    if_set_defaults(ifp);</a>
<a name="ln233"> </a>
<a name="ln234">  irdp-&gt;irdp_sent = 0;</a>
<a name="ln235"> </a>
<a name="ln236">  /* The spec suggests this for randomness */</a>
<a name="ln237"> </a>
<a name="ln238">  seed = 0;</a>
<a name="ln239">  if( ifp-&gt;connected)</a>
<a name="ln240">    for (ALL_LIST_ELEMENTS_RO (ifp-&gt;connected, node, ifc))</a>
<a name="ln241">      {</a>
<a name="ln242">        seed = ifc-&gt;address-&gt;u.prefix4.s_addr;</a>
<a name="ln243">        break;</a>
<a name="ln244">      }</a>
<a name="ln245">  </a>
<a name="ln246">  srandom(seed);</a>
<a name="ln247">  timer =  (random () % IRDP_DEFAULT_INTERVAL) + 1; </a>
<a name="ln248"> </a>
<a name="ln249">  irdp-&gt;AdvPrefList = list_new();</a>
<a name="ln250">  irdp-&gt;AdvPrefList-&gt;del =  (void (*)(void *)) Adv_free; /* Destructor */</a>
<a name="ln251"> </a>
<a name="ln252"> </a>
<a name="ln253">  /* And this for startup. Speed limit from 1991 :-). But it's OK*/</a>
<a name="ln254"> </a>
<a name="ln255">  if(irdp-&gt;irdp_sent &lt; MAX_INITIAL_ADVERTISEMENTS &amp;&amp;</a>
<a name="ln256">     timer &gt; MAX_INITIAL_ADVERT_INTERVAL ) </a>
<a name="ln257">	  timer= MAX_INITIAL_ADVERT_INTERVAL;</a>
<a name="ln258"> </a>
<a name="ln259">  </a>
<a name="ln260">  if(irdp-&gt;flags &amp; IF_DEBUG_MISC)</a>
<a name="ln261">    zlog_debug(&quot;IRDP: Init timer for %s set to %u&quot;, </a>
<a name="ln262">	       ifp-&gt;name, </a>
<a name="ln263">	       timer);</a>
<a name="ln264"> </a>
<a name="ln265">  irdp-&gt;t_advertise = thread_add_timer(zebrad.master, </a>
<a name="ln266">				       irdp_send_thread, </a>
<a name="ln267">				       ifp, </a>
<a name="ln268">				       timer);</a>
<a name="ln269">}</a>
<a name="ln270"> </a>
<a name="ln271">static void</a>
<a name="ln272">irdp_if_stop(struct interface *ifp)</a>
<a name="ln273">{</a>
<a name="ln274">  struct zebra_if *zi=ifp-&gt;info;</a>
<a name="ln275">  struct irdp_interface *irdp=&amp;zi-&gt;irdp;</a>
<a name="ln276">  </a>
<a name="ln277">  if (irdp == NULL) {</a>
<a name="ln278">    zlog_warn (&quot;Interface %s structure is NULL&quot;, ifp-&gt;name);</a>
<a name="ln279">    return;</a>
<a name="ln280">  }</a>
<a name="ln281"> </a>
<a name="ln282">  if (! (irdp-&gt;flags &amp; IF_ACTIVE )) {</a>
<a name="ln283">    zlog_warn(&quot;Interface is not active %s&quot;, ifp-&gt;name);</a>
<a name="ln284">    return;</a>
<a name="ln285">  }</a>
<a name="ln286"> </a>
<a name="ln287">  if(! (irdp-&gt;flags &amp; IF_BROADCAST)) </a>
<a name="ln288">    if_drop_group(ifp);</a>
<a name="ln289"> </a>
<a name="ln290">  irdp_advert_off(ifp);</a>
<a name="ln291"> </a>
<a name="ln292">  list_delete(irdp-&gt;AdvPrefList);</a>
<a name="ln293">  irdp-&gt;AdvPrefList=NULL;</a>
<a name="ln294"> </a>
<a name="ln295">  irdp-&gt;flags = 0;</a>
<a name="ln296">}</a>
<a name="ln297"> </a>
<a name="ln298"> </a>
<a name="ln299">static void</a>
<a name="ln300">irdp_if_shutdown(struct interface *ifp)</a>
<a name="ln301">{</a>
<a name="ln302">  struct zebra_if *zi= ifp-&gt;info;</a>
<a name="ln303">  struct irdp_interface *irdp = &amp;zi-&gt;irdp;</a>
<a name="ln304"> </a>
<a name="ln305">  if (irdp-&gt;flags &amp; IF_SHUTDOWN ) {</a>
<a name="ln306">    zlog_warn(&quot;IRDP: Interface is already shutdown %s&quot;, ifp-&gt;name);</a>
<a name="ln307">    return;</a>
<a name="ln308">  }</a>
<a name="ln309"> </a>
<a name="ln310">  irdp-&gt;flags |= IF_SHUTDOWN;</a>
<a name="ln311">  irdp-&gt;flags &amp;= ~IF_ACTIVE;</a>
<a name="ln312"> </a>
<a name="ln313">  if(! (irdp-&gt;flags &amp; IF_BROADCAST)) </a>
<a name="ln314">    if_drop_group(ifp);</a>
<a name="ln315">  </a>
<a name="ln316">  /* Tell the hosts we are out of service */</a>
<a name="ln317">  irdp_advert_off(ifp);</a>
<a name="ln318">}</a>
<a name="ln319"> </a>
<a name="ln320">static void</a>
<a name="ln321">irdp_if_no_shutdown(struct interface *ifp)</a>
<a name="ln322">{</a>
<a name="ln323">  struct zebra_if *zi= ifp-&gt;info;</a>
<a name="ln324">  struct irdp_interface *irdp = &amp;zi-&gt;irdp;</a>
<a name="ln325"> </a>
<a name="ln326">  if (! (irdp-&gt;flags &amp; IF_SHUTDOWN )) {</a>
<a name="ln327">    zlog_warn(&quot;IRDP: Interface is not shutdown %s&quot;, ifp-&gt;name);</a>
<a name="ln328">    return;</a>
<a name="ln329">  }</a>
<a name="ln330"> </a>
<a name="ln331">  irdp-&gt;flags &amp;= ~IF_SHUTDOWN;</a>
<a name="ln332"> </a>
<a name="ln333">  irdp_if_start(ifp, irdp-&gt;flags &amp; IF_BROADCAST? FALSE : TRUE, FALSE); </a>
<a name="ln334"> </a>
<a name="ln335">}</a>
<a name="ln336"> </a>
<a name="ln337"> </a>
<a name="ln338">/* Write configuration to user */</a>
<a name="ln339"> </a>
<a name="ln340">void irdp_config_write (struct vty *vty, struct interface *ifp)</a>
<a name="ln341">{</a>
<a name="ln342">  struct zebra_if *zi=ifp-&gt;info;</a>
<a name="ln343">  struct irdp_interface *irdp=&amp;zi-&gt;irdp;</a>
<a name="ln344">  struct Adv *adv;</a>
<a name="ln345">  struct listnode *node;</a>
<a name="ln346">  char b1[INET_ADDRSTRLEN];</a>
<a name="ln347"> </a>
<a name="ln348">  if(irdp-&gt;flags &amp; IF_ACTIVE || irdp-&gt;flags &amp; IF_SHUTDOWN) {</a>
<a name="ln349"> </a>
<a name="ln350">    if( irdp-&gt;flags &amp; IF_SHUTDOWN) </a>
<a name="ln351">      vty_out (vty, &quot; ip irdp shutdown %s&quot;,  VTY_NEWLINE);</a>
<a name="ln352"> </a>
<a name="ln353">    if( irdp-&gt;flags &amp; IF_BROADCAST) </a>
<a name="ln354">      vty_out (vty, &quot; ip irdp broadcast%s&quot;,  VTY_NEWLINE);</a>
<a name="ln355">    else </a>
<a name="ln356">      vty_out (vty, &quot; ip irdp multicast%s&quot;,  VTY_NEWLINE);</a>
<a name="ln357"> </a>
<a name="ln358">    vty_out (vty, &quot; ip irdp preference %ld%s&quot;,  </a>
<a name="ln359">	     irdp-&gt;Preference, VTY_NEWLINE);</a>
<a name="ln360"> </a>
<a name="ln361">    for (ALL_LIST_ELEMENTS_RO (irdp-&gt;AdvPrefList, node, adv))</a>
<a name="ln362">      vty_out (vty, &quot; ip irdp address %s preference %d%s&quot;,</a>
<a name="ln363">                    inet_2a(adv-&gt;ip.s_addr, b1),</a>
<a name="ln364">                    adv-&gt;pref, </a>
<a name="ln365">                    VTY_NEWLINE);</a>
<a name="ln366"> </a>
<a name="ln367">    vty_out (vty, &quot; ip irdp holdtime %d%s&quot;,  </a>
<a name="ln368">	     irdp-&gt;Lifetime, VTY_NEWLINE);</a>
<a name="ln369"> </a>
<a name="ln370">    vty_out (vty, &quot; ip irdp minadvertinterval %ld%s&quot;,  </a>
<a name="ln371">	     irdp-&gt;MinAdvertInterval, VTY_NEWLINE);</a>
<a name="ln372"> </a>
<a name="ln373">    vty_out (vty, &quot; ip irdp maxadvertinterval %ld%s&quot;,  </a>
<a name="ln374">	     irdp-&gt;MaxAdvertInterval, VTY_NEWLINE);</a>
<a name="ln375"> </a>
<a name="ln376">  }</a>
<a name="ln377">}</a>
<a name="ln378"> </a>
<a name="ln379"> </a>
<a name="ln380">DEFUN (ip_irdp_multicast,</a>
<a name="ln381">       ip_irdp_multicast_cmd,</a>
<a name="ln382">       &quot;ip irdp multicast&quot;,</a>
<a name="ln383">       IP_STR</a>
<a name="ln384">       &quot;ICMP Router discovery on this interface using multicast\n&quot;)</a>
<a name="ln385">{</a>
<a name="ln386">  struct interface *ifp;</a>
<a name="ln387"> </a>
<a name="ln388">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln389">  if(!ifp) {</a>
<a name="ln390">	  return CMD_WARNING;</a>
<a name="ln391">  }</a>
<a name="ln392"> </a>
<a name="ln393">  irdp_if_start(ifp, TRUE, TRUE);</a>
<a name="ln394">  return CMD_SUCCESS;</a>
<a name="ln395">}</a>
<a name="ln396"> </a>
<a name="ln397">DEFUN (ip_irdp_broadcast,</a>
<a name="ln398">       ip_irdp_broadcast_cmd,</a>
<a name="ln399">       &quot;ip irdp broadcast&quot;,</a>
<a name="ln400">       IP_STR</a>
<a name="ln401">       &quot;ICMP Router discovery on this interface using broadcast\n&quot;)</a>
<a name="ln402">{</a>
<a name="ln403">  struct interface *ifp;</a>
<a name="ln404"> </a>
<a name="ln405">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln406">  if(!ifp) {</a>
<a name="ln407">	  return CMD_WARNING;</a>
<a name="ln408">  }</a>
<a name="ln409"> </a>
<a name="ln410">  irdp_if_start(ifp, FALSE, TRUE);</a>
<a name="ln411">  return CMD_SUCCESS;</a>
<a name="ln412">}</a>
<a name="ln413"> </a>
<a name="ln414">DEFUN (no_ip_irdp,</a>
<a name="ln415">       no_ip_irdp_cmd,</a>
<a name="ln416">       &quot;no ip irdp&quot;,</a>
<a name="ln417">       NO_STR</a>
<a name="ln418">       IP_STR</a>
<a name="ln419">       &quot;Disable ICMP Router discovery on this interface\n&quot;)</a>
<a name="ln420">{</a>
<a name="ln421">  struct interface *ifp;</a>
<a name="ln422"> </a>
<a name="ln423">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln424">  if(!ifp) {</a>
<a name="ln425">	  return CMD_WARNING;</a>
<a name="ln426">  }</a>
<a name="ln427"> </a>
<a name="ln428">  irdp_if_stop(ifp);</a>
<a name="ln429">  return CMD_SUCCESS;</a>
<a name="ln430">}</a>
<a name="ln431"> </a>
<a name="ln432">DEFUN (ip_irdp_shutdown,</a>
<a name="ln433">       ip_irdp_shutdown_cmd,</a>
<a name="ln434">       &quot;ip irdp shutdown&quot;,</a>
<a name="ln435">       IP_STR</a>
<a name="ln436">       &quot;ICMP Router discovery shutdown on this interface\n&quot;)</a>
<a name="ln437">{</a>
<a name="ln438">  struct interface *ifp;</a>
<a name="ln439"> </a>
<a name="ln440">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln441">  if(!ifp) {</a>
<a name="ln442">	  return CMD_WARNING;</a>
<a name="ln443">  }</a>
<a name="ln444"> </a>
<a name="ln445">  irdp_if_shutdown(ifp);</a>
<a name="ln446">  return CMD_SUCCESS;</a>
<a name="ln447">}</a>
<a name="ln448"> </a>
<a name="ln449">DEFUN (no_ip_irdp_shutdown,</a>
<a name="ln450">       no_ip_irdp_shutdown_cmd,</a>
<a name="ln451">       &quot;no ip irdp shutdown&quot;,</a>
<a name="ln452">       NO_STR</a>
<a name="ln453">       IP_STR</a>
<a name="ln454">       &quot;ICMP Router discovery no shutdown on this interface\n&quot;)</a>
<a name="ln455">{</a>
<a name="ln456">  struct interface *ifp;</a>
<a name="ln457"> </a>
<a name="ln458">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln459">  if(!ifp) {</a>
<a name="ln460">	  return CMD_WARNING;</a>
<a name="ln461">  }</a>
<a name="ln462"> </a>
<a name="ln463">  irdp_if_no_shutdown(ifp);</a>
<a name="ln464">  return CMD_SUCCESS;</a>
<a name="ln465">}</a>
<a name="ln466"> </a>
<a name="ln467">DEFUN (ip_irdp_holdtime,</a>
<a name="ln468">       ip_irdp_holdtime_cmd,</a>
<a name="ln469">       &quot;ip irdp holdtime &lt;0-9000&gt;&quot;,</a>
<a name="ln470">       IP_STR</a>
<a name="ln471">       &quot;ICMP Router discovery on this interface\n&quot;</a>
<a name="ln472">       &quot;Set holdtime value\n&quot;</a>
<a name="ln473">       &quot;Holdtime value in seconds. Default is 1800 seconds\n&quot;)</a>
<a name="ln474">{</a>
<a name="ln475">  struct interface *ifp;</a>
<a name="ln476">  struct zebra_if *zi;</a>
<a name="ln477">  struct irdp_interface *irdp;</a>
<a name="ln478">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln479">  if(!ifp) {</a>
<a name="ln480">	  return CMD_WARNING;</a>
<a name="ln481">  }</a>
<a name="ln482"> </a>
<a name="ln483">  zi=ifp-&gt;info;</a>
<a name="ln484">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln485"> </a>
<a name="ln486">  irdp-&gt;Lifetime = atoi(argv[0]);</a>
<a name="ln487">  return CMD_SUCCESS;</a>
<a name="ln488">}</a>
<a name="ln489"> </a>
<a name="ln490">DEFUN (ip_irdp_minadvertinterval,</a>
<a name="ln491">       ip_irdp_minadvertinterval_cmd,</a>
<a name="ln492">       &quot;ip irdp minadvertinterval &lt;3-1800&gt;&quot;,</a>
<a name="ln493">       IP_STR</a>
<a name="ln494">       &quot;ICMP Router discovery on this interface\n&quot;</a>
<a name="ln495">       &quot;Set minimum time between advertisement\n&quot;</a>
<a name="ln496">       &quot;Minimum advertisement interval in seconds\n&quot;)</a>
<a name="ln497">{</a>
<a name="ln498">  struct interface *ifp;</a>
<a name="ln499">  struct zebra_if *zi;</a>
<a name="ln500">  struct irdp_interface *irdp;</a>
<a name="ln501">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln502">  if(!ifp) {</a>
<a name="ln503">	  return CMD_WARNING;</a>
<a name="ln504">  }</a>
<a name="ln505"> </a>
<a name="ln506">  zi=ifp-&gt;info;</a>
<a name="ln507">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln508"> </a>
<a name="ln509">  if( (unsigned) atoi(argv[0]) &lt;= irdp-&gt;MaxAdvertInterval) {</a>
<a name="ln510">      irdp-&gt;MinAdvertInterval = atoi(argv[0]);</a>
<a name="ln511"> </a>
<a name="ln512">      return CMD_SUCCESS;</a>
<a name="ln513">  }</a>
<a name="ln514"> </a>
<a name="ln515">  vty_out (vty, &quot;ICMP warning maxadvertinterval is greater or equal than minadvertinterval%s&quot;, </a>
<a name="ln516">	     VTY_NEWLINE);</a>
<a name="ln517"> </a>
<a name="ln518">  vty_out (vty, &quot;Please correct!%s&quot;, </a>
<a name="ln519">	     VTY_NEWLINE);</a>
<a name="ln520">  return CMD_WARNING;</a>
<a name="ln521">}</a>
<a name="ln522"> </a>
<a name="ln523">DEFUN (ip_irdp_maxadvertinterval,</a>
<a name="ln524">       ip_irdp_maxadvertinterval_cmd,</a>
<a name="ln525">       &quot;ip irdp maxadvertinterval &lt;4-1800&gt;&quot;,</a>
<a name="ln526">       IP_STR</a>
<a name="ln527">       &quot;ICMP Router discovery on this interface\n&quot;</a>
<a name="ln528">       &quot;Set maximum time between advertisement\n&quot;</a>
<a name="ln529">       &quot;Maximum advertisement interval in seconds\n&quot;)</a>
<a name="ln530">{</a>
<a name="ln531">  struct interface *ifp;</a>
<a name="ln532">  struct zebra_if *zi;</a>
<a name="ln533">  struct irdp_interface *irdp;</a>
<a name="ln534">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln535">  if(!ifp) {</a>
<a name="ln536">	  return CMD_WARNING;</a>
<a name="ln537">  }</a>
<a name="ln538"> </a>
<a name="ln539">  zi=ifp-&gt;info;</a>
<a name="ln540">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln541"> </a>
<a name="ln542"> </a>
<a name="ln543">  if( irdp-&gt;MinAdvertInterval &lt;= (unsigned) atoi(argv[0]) ) {</a>
<a name="ln544">    irdp-&gt;MaxAdvertInterval = atoi(argv[0]);</a>
<a name="ln545"> </a>
<a name="ln546">      return CMD_SUCCESS;</a>
<a name="ln547">  }</a>
<a name="ln548"> </a>
<a name="ln549">  vty_out (vty, &quot;ICMP warning maxadvertinterval is greater or equal than minadvertinterval%s&quot;, </a>
<a name="ln550">	     VTY_NEWLINE);</a>
<a name="ln551"> </a>
<a name="ln552">  vty_out (vty, &quot;Please correct!%s&quot;, </a>
<a name="ln553">	     VTY_NEWLINE);</a>
<a name="ln554">  return CMD_WARNING;</a>
<a name="ln555">}</a>
<a name="ln556"> </a>
<a name="ln557">/* DEFUN needs to be fixed for negative ranages...</a>
<a name="ln558"> * &quot;ip irdp preference &lt;-2147483648-2147483647&gt;&quot;,</a>
<a name="ln559"> * Be positive for now. :-)</a>
<a name="ln560"> */</a>
<a name="ln561"> </a>
<a name="ln562">DEFUN (ip_irdp_preference,</a>
<a name="ln563">       ip_irdp_preference_cmd,</a>
<a name="ln564">       &quot;ip irdp preference &lt;0-2147483647&gt;&quot;,</a>
<a name="ln565">       IP_STR</a>
<a name="ln566">       &quot;ICMP Router discovery on this interface\n&quot;</a>
<a name="ln567">       &quot;Set default preference level for this interface\n&quot;</a>
<a name="ln568">       &quot;Preference level\n&quot;)</a>
<a name="ln569">{</a>
<a name="ln570">  struct interface *ifp;</a>
<a name="ln571">  struct zebra_if *zi;</a>
<a name="ln572">  struct irdp_interface *irdp;</a>
<a name="ln573">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln574">  if(!ifp) {</a>
<a name="ln575">	  return CMD_WARNING;</a>
<a name="ln576">  }</a>
<a name="ln577"> </a>
<a name="ln578">  zi=ifp-&gt;info;</a>
<a name="ln579">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln580"> </a>
<a name="ln581">  irdp-&gt;Preference = atoi(argv[0]);</a>
<a name="ln582">  return CMD_SUCCESS;</a>
<a name="ln583">}</a>
<a name="ln584"> </a>
<a name="ln585">DEFUN (ip_irdp_address_preference,</a>
<a name="ln586">       ip_irdp_address_preference_cmd,</a>
<a name="ln587">       &quot;ip irdp address A.B.C.D preference &lt;0-2147483647&gt;&quot;,</a>
<a name="ln588">       IP_STR</a>
<a name="ln589">       &quot;Alter ICMP Router discovery preference this interface\n&quot;</a>
<a name="ln590">       &quot;Specify IRDP non-default preference to advertise\n&quot;</a>
<a name="ln591">       &quot;Set IRDP address for advertise\n&quot;</a>
<a name="ln592">       &quot;Preference level\n&quot;)</a>
<a name="ln593">{</a>
<a name="ln594">  struct listnode *node;</a>
<a name="ln595">  struct in_addr ip; </a>
<a name="ln596">  int pref;</a>
<a name="ln597">  int ret;</a>
<a name="ln598">  struct interface *ifp;</a>
<a name="ln599">  struct zebra_if *zi;</a>
<a name="ln600">  struct irdp_interface *irdp;</a>
<a name="ln601">  struct Adv *adv;</a>
<a name="ln602"> </a>
<a name="ln603">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln604">  if(!ifp) {</a>
<a name="ln605">	  return CMD_WARNING;</a>
<a name="ln606">  }</a>
<a name="ln607"> </a>
<a name="ln608">  zi=ifp-&gt;info;</a>
<a name="ln609">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln610"> </a>
<a name="ln611">  ret = inet_aton(argv[0], &amp;ip);</a>
<a name="ln612">  if(!ret) return CMD_WARNING;</a>
<a name="ln613"> </a>
<a name="ln614">  pref = atoi(argv[1]);</a>
<a name="ln615"> </a>
<a name="ln616">  for (ALL_LIST_ELEMENTS_RO (irdp-&gt;AdvPrefList, node, adv))</a>
<a name="ln617">    if(adv-&gt;ip.s_addr == ip.s_addr) </a>
<a name="ln618">      return CMD_SUCCESS;</a>
<a name="ln619"> </a>
<a name="ln620">  adv = Adv_new();</a>
<a name="ln621">  adv-&gt;ip = ip;</a>
<a name="ln622">  adv-&gt;pref = pref;</a>
<a name="ln623">  listnode_add(irdp-&gt;AdvPrefList, adv);</a>
<a name="ln624"> </a>
<a name="ln625">  return CMD_SUCCESS;</a>
<a name="ln626"> </a>
<a name="ln627">}</a>
<a name="ln628"> </a>
<a name="ln629">DEFUN (no_ip_irdp_address_preference,</a>
<a name="ln630">       no_ip_irdp_address_preference_cmd,</a>
<a name="ln631">       &quot;no ip irdp address A.B.C.D preference &lt;0-2147483647&gt;&quot;,</a>
<a name="ln632">       NO_STR</a>
<a name="ln633">       IP_STR</a>
<a name="ln634">       &quot;Alter ICMP Router discovery preference this interface\n&quot;</a>
<a name="ln635">       &quot;Removes IRDP non-default preference\n&quot;</a>
<a name="ln636">       &quot;Select IRDP address\n&quot;</a>
<a name="ln637">       &quot;Old preference level\n&quot;)</a>
<a name="ln638">{</a>
<a name="ln639">  struct listnode *node, *nnode;</a>
<a name="ln640">  struct in_addr ip; </a>
<a name="ln641">  int ret;</a>
<a name="ln642">  struct interface *ifp;</a>
<a name="ln643">  struct zebra_if *zi;</a>
<a name="ln644">  struct irdp_interface *irdp;</a>
<a name="ln645">  struct Adv *adv;</a>
<a name="ln646"> </a>
<a name="ln647">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln648">  if(!ifp) {</a>
<a name="ln649">	  return CMD_WARNING;</a>
<a name="ln650">  }</a>
<a name="ln651"> </a>
<a name="ln652">  zi=ifp-&gt;info;</a>
<a name="ln653">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln654"> </a>
<a name="ln655">  ret = inet_aton(argv[0], &amp;ip);</a>
<a name="ln656">  if (!ret) </a>
<a name="ln657">    return CMD_WARNING;</a>
<a name="ln658"> </a>
<a name="ln659">  for (ALL_LIST_ELEMENTS (irdp-&gt;AdvPrefList, node, nnode, adv))</a>
<a name="ln660">    {</a>
<a name="ln661">      if(adv-&gt;ip.s_addr == ip.s_addr )</a>
<a name="ln662">        {</a>
<a name="ln663">          listnode_delete(irdp-&gt;AdvPrefList, adv);</a>
<a name="ln664">          break;</a>
<a name="ln665">        }</a>
<a name="ln666">    }</a>
<a name="ln667">  </a>
<a name="ln668">  return CMD_SUCCESS;</a>
<a name="ln669">}</a>
<a name="ln670"> </a>
<a name="ln671">DEFUN (ip_irdp_debug_messages,</a>
<a name="ln672">       ip_irdp_debug_messages_cmd,</a>
<a name="ln673">       &quot;ip irdp debug messages&quot;,</a>
<a name="ln674">       IP_STR</a>
<a name="ln675">       &quot;ICMP Router discovery debug Averts. and Solicits (short)\n&quot;)</a>
<a name="ln676">{</a>
<a name="ln677">  struct interface *ifp;</a>
<a name="ln678">  struct zebra_if *zi;</a>
<a name="ln679">  struct irdp_interface *irdp;</a>
<a name="ln680">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln681">  if(!ifp) {</a>
<a name="ln682">	  return CMD_WARNING;</a>
<a name="ln683">  }</a>
<a name="ln684"> </a>
<a name="ln685">  zi=ifp-&gt;info;</a>
<a name="ln686">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln687"> </a>
<a name="ln688">  irdp-&gt;flags |= IF_DEBUG_MESSAGES;</a>
<a name="ln689"> </a>
<a name="ln690">  return CMD_SUCCESS;</a>
<a name="ln691">}</a>
<a name="ln692"> </a>
<a name="ln693">DEFUN (ip_irdp_debug_misc,</a>
<a name="ln694">       ip_irdp_debug_misc_cmd,</a>
<a name="ln695">       &quot;ip irdp debug misc&quot;,</a>
<a name="ln696">       IP_STR</a>
<a name="ln697">       &quot;ICMP Router discovery debug Averts. and Solicits (short)\n&quot;)</a>
<a name="ln698">{</a>
<a name="ln699">  struct interface *ifp;</a>
<a name="ln700">  struct zebra_if *zi;</a>
<a name="ln701">  struct irdp_interface *irdp;</a>
<a name="ln702">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln703">  if(!ifp) {</a>
<a name="ln704">	  return CMD_WARNING;</a>
<a name="ln705">  }</a>
<a name="ln706"> </a>
<a name="ln707">  zi=ifp-&gt;info;</a>
<a name="ln708">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln709"> </a>
<a name="ln710">  irdp-&gt;flags |= IF_DEBUG_MISC;</a>
<a name="ln711"> </a>
<a name="ln712">  return CMD_SUCCESS;</a>
<a name="ln713">}</a>
<a name="ln714"> </a>
<a name="ln715">DEFUN (ip_irdp_debug_packet,</a>
<a name="ln716">       ip_irdp_debug_packet_cmd,</a>
<a name="ln717">       &quot;ip irdp debug packet&quot;,</a>
<a name="ln718">       IP_STR</a>
<a name="ln719">       &quot;ICMP Router discovery debug Averts. and Solicits (short)\n&quot;)</a>
<a name="ln720">{</a>
<a name="ln721">  struct interface *ifp;</a>
<a name="ln722">  struct zebra_if *zi;</a>
<a name="ln723">  struct irdp_interface *irdp;</a>
<a name="ln724">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln725">  if(!ifp) {</a>
<a name="ln726">	  return CMD_WARNING;</a>
<a name="ln727">  }</a>
<a name="ln728"> </a>
<a name="ln729">  zi=ifp-&gt;info;</a>
<a name="ln730">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln731"> </a>
<a name="ln732">  irdp-&gt;flags |= IF_DEBUG_PACKET;</a>
<a name="ln733"> </a>
<a name="ln734">  return CMD_SUCCESS;</a>
<a name="ln735">}</a>
<a name="ln736"> </a>
<a name="ln737"> </a>
<a name="ln738">DEFUN (ip_irdp_debug_disable,</a>
<a name="ln739">       ip_irdp_debug_disable_cmd,</a>
<a name="ln740">       &quot;ip irdp debug disable&quot;,</a>
<a name="ln741">       IP_STR</a>
<a name="ln742">       &quot;ICMP Router discovery debug Averts. and Solicits (short)\n&quot;)</a>
<a name="ln743">{</a>
<a name="ln744">  struct interface *ifp;</a>
<a name="ln745">  struct zebra_if *zi;</a>
<a name="ln746">  struct irdp_interface *irdp;</a>
<a name="ln747">  ifp = (struct interface *) vty-&gt;index;</a>
<a name="ln748">  if(!ifp) {</a>
<a name="ln749">	  return CMD_WARNING;</a>
<a name="ln750">  }</a>
<a name="ln751"> </a>
<a name="ln752">  zi=ifp-&gt;info;</a>
<a name="ln753">  irdp=&amp;zi-&gt;irdp;</a>
<a name="ln754"> </a>
<a name="ln755">  irdp-&gt;flags &amp;= ~IF_DEBUG_PACKET;</a>
<a name="ln756">  irdp-&gt;flags &amp;= ~IF_DEBUG_MESSAGES;</a>
<a name="ln757">  irdp-&gt;flags &amp;= ~IF_DEBUG_MISC;</a>
<a name="ln758"> </a>
<a name="ln759">  return CMD_SUCCESS;</a>
<a name="ln760">}</a>
<a name="ln761"> </a>
<a name="ln762">void</a>
<a name="ln763">irdp_init ()</a>
<a name="ln764">{</a>
<a name="ln765">  install_element (INTERFACE_NODE, &amp;ip_irdp_broadcast_cmd);</a>
<a name="ln766">  install_element (INTERFACE_NODE, &amp;ip_irdp_multicast_cmd);</a>
<a name="ln767">  install_element (INTERFACE_NODE, &amp;no_ip_irdp_cmd);</a>
<a name="ln768">  install_element (INTERFACE_NODE, &amp;ip_irdp_shutdown_cmd);</a>
<a name="ln769">  install_element (INTERFACE_NODE, &amp;no_ip_irdp_shutdown_cmd);</a>
<a name="ln770">  install_element (INTERFACE_NODE, &amp;ip_irdp_holdtime_cmd);</a>
<a name="ln771">  install_element (INTERFACE_NODE, &amp;ip_irdp_maxadvertinterval_cmd);</a>
<a name="ln772">  install_element (INTERFACE_NODE, &amp;ip_irdp_minadvertinterval_cmd);</a>
<a name="ln773">  install_element (INTERFACE_NODE, &amp;ip_irdp_preference_cmd);</a>
<a name="ln774">  install_element (INTERFACE_NODE, &amp;ip_irdp_address_preference_cmd);</a>
<a name="ln775">  install_element (INTERFACE_NODE, &amp;no_ip_irdp_address_preference_cmd);</a>
<a name="ln776"> </a>
<a name="ln777">  install_element (INTERFACE_NODE, &amp;ip_irdp_debug_messages_cmd);</a>
<a name="ln778">  install_element (INTERFACE_NODE, &amp;ip_irdp_debug_misc_cmd);</a>
<a name="ln779">  install_element (INTERFACE_NODE, &amp;ip_irdp_debug_packet_cmd);</a>
<a name="ln780">  install_element (INTERFACE_NODE, &amp;ip_irdp_debug_disable_cmd);</a>
<a name="ln781">}</a>
<a name="ln782"> </a>
<a name="ln783">#endif /* HAVE_IRDP */</a>

</code></pre>
<div class="balloon" rel="9"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>
<div class="balloon" rel="243"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v612/" target="_blank">V612</a> An unconditional 'break' within a loop.</p></div>
<div class="balloon" rel="255"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v560/" target="_blank">V560</a> A part of conditional expression is always true: irdp->irdp_sent < 3.</p></div>
<div class="balloon" rel="277"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v547/" target="_blank">V547</a> Expression 'irdp == NULL' is always false.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
