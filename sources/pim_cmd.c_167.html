
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>pim_cmd.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">  PIM for Quagga</a>
<a name="ln3">  Copyright (C) 2008  Everton da Silva Marques</a>
<a name="ln4"> </a>
<a name="ln5">  This program is free software; you can redistribute it and/or modify</a>
<a name="ln6">  it under the terms of the GNU General Public License as published by</a>
<a name="ln7">  the Free Software Foundation; either version 2 of the License, or</a>
<a name="ln8">  (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">  This program is distributed in the hope that it will be useful, but</a>
<a name="ln11">  WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln13">  General Public License for more details.</a>
<a name="ln14">  </a>
<a name="ln15">  You should have received a copy of the GNU General Public License</a>
<a name="ln16">  along with this program; see the file COPYING; if not, write to the</a>
<a name="ln17">  Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston,</a>
<a name="ln18">  MA 02110-1301 USA</a>
<a name="ln19">  </a>
<a name="ln20">  $QuaggaId: $Format:%an, %ai, %h$ $</a>
<a name="ln21">*/</a>
<a name="ln22"> </a>
<a name="ln23">#include &lt;zebra.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &lt;sys/ioctl.h&gt;</a>
<a name="ln26"> </a>
<a name="ln27">#include &quot;command.h&quot;</a>
<a name="ln28">#include &quot;if.h&quot;</a>
<a name="ln29">#include &quot;prefix.h&quot;</a>
<a name="ln30">#include &quot;zclient.h&quot;</a>
<a name="ln31"> </a>
<a name="ln32">#include &quot;pimd.h&quot;</a>
<a name="ln33">#include &quot;pim_cmd.h&quot;</a>
<a name="ln34">#include &quot;pim_iface.h&quot;</a>
<a name="ln35">#include &quot;pim_vty.h&quot;</a>
<a name="ln36">#include &quot;pim_mroute.h&quot;</a>
<a name="ln37">#include &quot;pim_str.h&quot;</a>
<a name="ln38">#include &quot;pim_igmp.h&quot;</a>
<a name="ln39">#include &quot;pim_igmpv3.h&quot;</a>
<a name="ln40">#include &quot;pim_sock.h&quot;</a>
<a name="ln41">#include &quot;pim_time.h&quot;</a>
<a name="ln42">#include &quot;pim_util.h&quot;</a>
<a name="ln43">#include &quot;pim_oil.h&quot;</a>
<a name="ln44">#include &quot;pim_neighbor.h&quot;</a>
<a name="ln45">#include &quot;pim_pim.h&quot;</a>
<a name="ln46">#include &quot;pim_ifchannel.h&quot;</a>
<a name="ln47">#include &quot;pim_hello.h&quot;</a>
<a name="ln48">#include &quot;pim_msg.h&quot;</a>
<a name="ln49">#include &quot;pim_upstream.h&quot;</a>
<a name="ln50">#include &quot;pim_rpf.h&quot;</a>
<a name="ln51">#include &quot;pim_macro.h&quot;</a>
<a name="ln52">#include &quot;pim_ssmpingd.h&quot;</a>
<a name="ln53">#include &quot;pim_zebra.h&quot;</a>
<a name="ln54">#include &quot;pim_static.h&quot;</a>
<a name="ln55"> </a>
<a name="ln56">static struct cmd_node pim_global_node = {</a>
<a name="ln57">  PIM_NODE,</a>
<a name="ln58">  &quot;&quot;,</a>
<a name="ln59">  1 /* vtysh ? yes */</a>
<a name="ln60">};</a>
<a name="ln61"> </a>
<a name="ln62">static struct cmd_node interface_node = {</a>
<a name="ln63">  INTERFACE_NODE,</a>
<a name="ln64">  &quot;%s(config-if)# &quot;,</a>
<a name="ln65">  1 /* vtysh ? yes */</a>
<a name="ln66">};</a>
<a name="ln67"> </a>
<a name="ln68">static void pim_if_membership_clear(struct interface *ifp)</a>
<a name="ln69">{</a>
<a name="ln70">  struct pim_interface *pim_ifp;</a>
<a name="ln71"> </a>
<a name="ln72">  pim_ifp = ifp-&gt;info;</a>
<a name="ln73">  zassert(pim_ifp);</a>
<a name="ln74"> </a>
<a name="ln75">  if (PIM_IF_TEST_PIM(pim_ifp-&gt;options) &amp;&amp;</a>
<a name="ln76">      PIM_IF_TEST_IGMP(pim_ifp-&gt;options)) {</a>
<a name="ln77">    return;</a>
<a name="ln78">  }</a>
<a name="ln79"> </a>
<a name="ln80">  pim_ifchannel_membership_clear(ifp);</a>
<a name="ln81">}</a>
<a name="ln82"> </a>
<a name="ln83">/*</a>
<a name="ln84">  When PIM is disabled on interface, IGMPv3 local membership</a>
<a name="ln85">  information is not injected into PIM interface state.</a>
<a name="ln86"> </a>
<a name="ln87">  The function pim_if_membership_refresh() fetches all IGMPv3 local</a>
<a name="ln88">  membership information into PIM. It is intented to be called</a>
<a name="ln89">  whenever PIM is enabled on the interface in order to collect missed</a>
<a name="ln90">  local membership information.</a>
<a name="ln91"> */</a>
<a name="ln92">static void pim_if_membership_refresh(struct interface *ifp)</a>
<a name="ln93">{</a>
<a name="ln94">  struct pim_interface *pim_ifp;</a>
<a name="ln95">  struct listnode      *sock_node;</a>
<a name="ln96">  struct igmp_sock     *igmp;</a>
<a name="ln97"> </a>
<a name="ln98">  pim_ifp = ifp-&gt;info;</a>
<a name="ln99">  zassert(pim_ifp);</a>
<a name="ln100"> </a>
<a name="ln101">  if (!PIM_IF_TEST_PIM(pim_ifp-&gt;options))</a>
<a name="ln102">    return;</a>
<a name="ln103">  if (!PIM_IF_TEST_IGMP(pim_ifp-&gt;options))</a>
<a name="ln104">    return;</a>
<a name="ln105"> </a>
<a name="ln106">  /*</a>
<a name="ln107">    First clear off membership from all PIM (S,G) entries on the</a>
<a name="ln108">    interface</a>
<a name="ln109">  */</a>
<a name="ln110"> </a>
<a name="ln111">  pim_ifchannel_membership_clear(ifp);</a>
<a name="ln112"> </a>
<a name="ln113">  /*</a>
<a name="ln114">    Then restore PIM (S,G) membership from all IGMPv3 (S,G) entries on</a>
<a name="ln115">    the interface</a>
<a name="ln116">  */</a>
<a name="ln117"> </a>
<a name="ln118">  /* scan igmp sockets */</a>
<a name="ln119">  for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln120">    struct listnode   *grpnode;</a>
<a name="ln121">    struct igmp_group *grp;</a>
<a name="ln122">    </a>
<a name="ln123">    /* scan igmp groups */</a>
<a name="ln124">    for (ALL_LIST_ELEMENTS_RO(igmp-&gt;igmp_group_list, grpnode, grp)) {</a>
<a name="ln125">      struct listnode    *srcnode;</a>
<a name="ln126">      struct igmp_source *src;</a>
<a name="ln127">      </a>
<a name="ln128">      /* scan group sources */</a>
<a name="ln129">      for (ALL_LIST_ELEMENTS_RO(grp-&gt;group_source_list, srcnode, src)) {</a>
<a name="ln130"> </a>
<a name="ln131">	if (IGMP_SOURCE_TEST_FORWARDING(src-&gt;source_flags)) {</a>
<a name="ln132">	  pim_ifchannel_local_membership_add(ifp,</a>
<a name="ln133">					     src-&gt;source_addr,</a>
<a name="ln134">					     grp-&gt;group_addr);</a>
<a name="ln135">	}</a>
<a name="ln136">	</a>
<a name="ln137">      } /* scan group sources */</a>
<a name="ln138">    } /* scan igmp groups */</a>
<a name="ln139">  } /* scan igmp sockets */</a>
<a name="ln140"> </a>
<a name="ln141">  /*</a>
<a name="ln142">    Finally delete every PIM (S,G) entry lacking all state info</a>
<a name="ln143">   */</a>
<a name="ln144"> </a>
<a name="ln145">  pim_ifchannel_delete_on_noinfo(ifp);</a>
<a name="ln146"> </a>
<a name="ln147">}</a>
<a name="ln148"> </a>
<a name="ln149">static void pim_show_assert(struct vty *vty)</a>
<a name="ln150">{</a>
<a name="ln151">  struct listnode  *ifnode;</a>
<a name="ln152">  struct interface *ifp;</a>
<a name="ln153">  time_t            now;</a>
<a name="ln154">  </a>
<a name="ln155">  now = pim_time_monotonic_sec();</a>
<a name="ln156"> </a>
<a name="ln157">  vty_out(vty,</a>
<a name="ln158">	  &quot;Interface Address         Source          Group           State  Winner          Uptime   Timer%s&quot;,</a>
<a name="ln159">	  VTY_NEWLINE);</a>
<a name="ln160"> </a>
<a name="ln161">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln162">    struct pim_interface *pim_ifp;</a>
<a name="ln163">    struct in_addr ifaddr;</a>
<a name="ln164">    struct listnode *ch_node;</a>
<a name="ln165">    struct pim_ifchannel *ch;</a>
<a name="ln166"> </a>
<a name="ln167">    pim_ifp = ifp-&gt;info;</a>
<a name="ln168">    </a>
<a name="ln169">    if (!pim_ifp)</a>
<a name="ln170">      continue;</a>
<a name="ln171"> </a>
<a name="ln172">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln173"> </a>
<a name="ln174">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_ifchannel_list, ch_node, ch)) {</a>
<a name="ln175">      char ch_src_str[100];</a>
<a name="ln176">      char ch_grp_str[100];</a>
<a name="ln177">      char winner_str[100];</a>
<a name="ln178">      char uptime[10];</a>
<a name="ln179">      char timer[10];</a>
<a name="ln180"> </a>
<a name="ln181">      pim_inet4_dump(&quot;&lt;ch_src?&gt;&quot;, ch-&gt;source_addr,</a>
<a name="ln182">		     ch_src_str, sizeof(ch_src_str));</a>
<a name="ln183">      pim_inet4_dump(&quot;&lt;ch_grp?&gt;&quot;, ch-&gt;group_addr,</a>
<a name="ln184">		     ch_grp_str, sizeof(ch_grp_str));</a>
<a name="ln185">      pim_inet4_dump(&quot;&lt;assrt_win?&gt;&quot;, ch-&gt;ifassert_winner,</a>
<a name="ln186">		     winner_str, sizeof(winner_str));</a>
<a name="ln187"> </a>
<a name="ln188">      pim_time_uptime(uptime, sizeof(uptime), now - ch-&gt;ifassert_creation);</a>
<a name="ln189">      pim_time_timer_to_mmss(timer, sizeof(timer),</a>
<a name="ln190">			     ch-&gt;t_ifassert_timer);</a>
<a name="ln191"> </a>
<a name="ln192">      vty_out(vty, &quot;%-9s %-15s %-15s %-15s %-6s %-15s %-8s %-5s%s&quot;,</a>
<a name="ln193">	      ifp-&gt;name,</a>
<a name="ln194">	      inet_ntoa(ifaddr),</a>
<a name="ln195">	      ch_src_str,</a>
<a name="ln196">	      ch_grp_str,</a>
<a name="ln197">	      pim_ifchannel_ifassert_name(ch-&gt;ifassert_state),</a>
<a name="ln198">	      winner_str,</a>
<a name="ln199">	      uptime,</a>
<a name="ln200">	      timer,</a>
<a name="ln201">	      VTY_NEWLINE);</a>
<a name="ln202">    } /* scan interface channels */</a>
<a name="ln203">  } /* scan interfaces */</a>
<a name="ln204">}</a>
<a name="ln205"> </a>
<a name="ln206">static void pim_show_assert_internal(struct vty *vty)</a>
<a name="ln207">{</a>
<a name="ln208">  struct listnode  *ifnode;</a>
<a name="ln209">  struct interface *ifp;</a>
<a name="ln210"> </a>
<a name="ln211">  vty_out(vty,</a>
<a name="ln212">	  &quot;CA:   CouldAssert%s&quot;</a>
<a name="ln213">	  &quot;ECA:  Evaluate CouldAssert%s&quot;</a>
<a name="ln214">	  &quot;ATD:  AssertTrackingDesired%s&quot;</a>
<a name="ln215">	  &quot;eATD: Evaluate AssertTrackingDesired%s%s&quot;,</a>
<a name="ln216">	  VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE);</a>
<a name="ln217"> </a>
<a name="ln218">  vty_out(vty,</a>
<a name="ln219">	  &quot;Interface Address         Source          Group           CA  eCA ATD eATD%s&quot;,</a>
<a name="ln220">	  VTY_NEWLINE);</a>
<a name="ln221"> </a>
<a name="ln222">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln223">    struct pim_interface *pim_ifp;</a>
<a name="ln224">    struct in_addr ifaddr;</a>
<a name="ln225">    struct listnode *ch_node;</a>
<a name="ln226">    struct pim_ifchannel *ch;</a>
<a name="ln227"> </a>
<a name="ln228">    pim_ifp = ifp-&gt;info;</a>
<a name="ln229">    </a>
<a name="ln230">    if (!pim_ifp)</a>
<a name="ln231">      continue;</a>
<a name="ln232"> </a>
<a name="ln233">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln234"> </a>
<a name="ln235">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_ifchannel_list, ch_node, ch)) {</a>
<a name="ln236">      char ch_src_str[100];</a>
<a name="ln237">      char ch_grp_str[100];</a>
<a name="ln238"> </a>
<a name="ln239">      pim_inet4_dump(&quot;&lt;ch_src?&gt;&quot;, ch-&gt;source_addr,</a>
<a name="ln240">		     ch_src_str, sizeof(ch_src_str));</a>
<a name="ln241">      pim_inet4_dump(&quot;&lt;ch_grp?&gt;&quot;, ch-&gt;group_addr,</a>
<a name="ln242">		     ch_grp_str, sizeof(ch_grp_str));</a>
<a name="ln243">      vty_out(vty, &quot;%-9s %-15s %-15s %-15s %-3s %-3s %-3s %-4s%s&quot;,</a>
<a name="ln244">	      ifp-&gt;name,</a>
<a name="ln245">	      inet_ntoa(ifaddr),</a>
<a name="ln246">	      ch_src_str,</a>
<a name="ln247">	      ch_grp_str,</a>
<a name="ln248">	      PIM_IF_FLAG_TEST_COULD_ASSERT(ch-&gt;flags) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln249">	      pim_macro_ch_could_assert_eval(ch) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln250">	      PIM_IF_FLAG_TEST_ASSERT_TRACKING_DESIRED(ch-&gt;flags) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln251">	      pim_macro_assert_tracking_desired_eval(ch) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln252">	      VTY_NEWLINE);</a>
<a name="ln253">    } /* scan interface channels */</a>
<a name="ln254">  } /* scan interfaces */</a>
<a name="ln255">}</a>
<a name="ln256"> </a>
<a name="ln257">static void pim_show_assert_metric(struct vty *vty)</a>
<a name="ln258">{</a>
<a name="ln259">  struct listnode  *ifnode;</a>
<a name="ln260">  struct interface *ifp;</a>
<a name="ln261">  </a>
<a name="ln262">  vty_out(vty,</a>
<a name="ln263">	  &quot;Interface Address         Source          Group           RPT Pref Metric Address        %s&quot;,</a>
<a name="ln264">	  VTY_NEWLINE);</a>
<a name="ln265"> </a>
<a name="ln266">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln267">    struct pim_interface *pim_ifp;</a>
<a name="ln268">    struct in_addr ifaddr;</a>
<a name="ln269">    struct listnode *ch_node;</a>
<a name="ln270">    struct pim_ifchannel *ch;</a>
<a name="ln271"> </a>
<a name="ln272">    pim_ifp = ifp-&gt;info;</a>
<a name="ln273">    </a>
<a name="ln274">    if (!pim_ifp)</a>
<a name="ln275">      continue;</a>
<a name="ln276"> </a>
<a name="ln277">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln278"> </a>
<a name="ln279">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_ifchannel_list, ch_node, ch)) {</a>
<a name="ln280">      char ch_src_str[100];</a>
<a name="ln281">      char ch_grp_str[100];</a>
<a name="ln282">      char addr_str[100];</a>
<a name="ln283">      struct pim_assert_metric am;</a>
<a name="ln284"> </a>
<a name="ln285">      am = pim_macro_spt_assert_metric(&amp;ch-&gt;upstream-&gt;rpf, pim_ifp-&gt;primary_address);</a>
<a name="ln286"> </a>
<a name="ln287">      pim_inet4_dump(&quot;&lt;ch_src?&gt;&quot;, ch-&gt;source_addr,</a>
<a name="ln288">		     ch_src_str, sizeof(ch_src_str));</a>
<a name="ln289">      pim_inet4_dump(&quot;&lt;ch_grp?&gt;&quot;, ch-&gt;group_addr,</a>
<a name="ln290">		     ch_grp_str, sizeof(ch_grp_str));</a>
<a name="ln291">      pim_inet4_dump(&quot;&lt;addr?&gt;&quot;, am.ip_address,</a>
<a name="ln292">		     addr_str, sizeof(addr_str));</a>
<a name="ln293"> </a>
<a name="ln294">      vty_out(vty, &quot;%-9s %-15s %-15s %-15s %-3s %4u %6u %-15s%s&quot;,</a>
<a name="ln295">	      ifp-&gt;name,</a>
<a name="ln296">	      inet_ntoa(ifaddr),</a>
<a name="ln297">	      ch_src_str,</a>
<a name="ln298">	      ch_grp_str,</a>
<a name="ln299">	      am.rpt_bit_flag ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln300">	      am.metric_preference,</a>
<a name="ln301">	      am.route_metric,</a>
<a name="ln302">	      addr_str,</a>
<a name="ln303">	      VTY_NEWLINE);</a>
<a name="ln304">    } /* scan interface channels */</a>
<a name="ln305">  } /* scan interfaces */</a>
<a name="ln306">}</a>
<a name="ln307"> </a>
<a name="ln308">static void pim_show_assert_winner_metric(struct vty *vty)</a>
<a name="ln309">{</a>
<a name="ln310">  struct listnode  *ifnode;</a>
<a name="ln311">  struct interface *ifp;</a>
<a name="ln312">  </a>
<a name="ln313">  vty_out(vty,</a>
<a name="ln314">	  &quot;Interface Address         Source          Group           RPT Pref Metric Address        %s&quot;,</a>
<a name="ln315">	  VTY_NEWLINE);</a>
<a name="ln316"> </a>
<a name="ln317">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln318">    struct pim_interface *pim_ifp;</a>
<a name="ln319">    struct in_addr ifaddr;</a>
<a name="ln320">    struct listnode *ch_node;</a>
<a name="ln321">    struct pim_ifchannel *ch;</a>
<a name="ln322"> </a>
<a name="ln323">    pim_ifp = ifp-&gt;info;</a>
<a name="ln324">    </a>
<a name="ln325">    if (!pim_ifp)</a>
<a name="ln326">      continue;</a>
<a name="ln327"> </a>
<a name="ln328">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln329"> </a>
<a name="ln330">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_ifchannel_list, ch_node, ch)) {</a>
<a name="ln331">      char ch_src_str[100];</a>
<a name="ln332">      char ch_grp_str[100];</a>
<a name="ln333">      char addr_str[100];</a>
<a name="ln334">      struct pim_assert_metric *am;</a>
<a name="ln335">      char pref_str[5];</a>
<a name="ln336">      char metr_str[7];</a>
<a name="ln337"> </a>
<a name="ln338">      am = &amp;ch-&gt;ifassert_winner_metric;</a>
<a name="ln339"> </a>
<a name="ln340">      pim_inet4_dump(&quot;&lt;ch_src?&gt;&quot;, ch-&gt;source_addr,</a>
<a name="ln341">		     ch_src_str, sizeof(ch_src_str));</a>
<a name="ln342">      pim_inet4_dump(&quot;&lt;ch_grp?&gt;&quot;, ch-&gt;group_addr,</a>
<a name="ln343">		     ch_grp_str, sizeof(ch_grp_str));</a>
<a name="ln344">      pim_inet4_dump(&quot;&lt;addr?&gt;&quot;, am-&gt;ip_address,</a>
<a name="ln345">		     addr_str, sizeof(addr_str));</a>
<a name="ln346"> </a>
<a name="ln347">      if (am-&gt;metric_preference == PIM_ASSERT_METRIC_PREFERENCE_MAX)</a>
<a name="ln348">	snprintf(pref_str, sizeof(pref_str), &quot;INFI&quot;);</a>
<a name="ln349">      else</a>
<a name="ln350">	snprintf(pref_str, sizeof(pref_str), &quot;%4u&quot;, am-&gt;metric_preference);</a>
<a name="ln351"> </a>
<a name="ln352">      if (am-&gt;route_metric == PIM_ASSERT_ROUTE_METRIC_MAX)</a>
<a name="ln353">	snprintf(metr_str, sizeof(metr_str), &quot;INFI&quot;);</a>
<a name="ln354">      else</a>
<a name="ln355">	snprintf(metr_str, sizeof(metr_str), &quot;%6u&quot;, am-&gt;route_metric);</a>
<a name="ln356"> </a>
<a name="ln357">      vty_out(vty, &quot;%-9s %-15s %-15s %-15s %-3s %-4s %-6s %-15s%s&quot;,</a>
<a name="ln358">	      ifp-&gt;name,</a>
<a name="ln359">	      inet_ntoa(ifaddr),</a>
<a name="ln360">	      ch_src_str,</a>
<a name="ln361">	      ch_grp_str,</a>
<a name="ln362">	      am-&gt;rpt_bit_flag ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln363">	      pref_str,</a>
<a name="ln364">	      metr_str,</a>
<a name="ln365">	      addr_str,</a>
<a name="ln366">	      VTY_NEWLINE);</a>
<a name="ln367">    } /* scan interface channels */</a>
<a name="ln368">  } /* scan interfaces */</a>
<a name="ln369">}</a>
<a name="ln370"> </a>
<a name="ln371">static void pim_show_membership(struct vty *vty)</a>
<a name="ln372">{</a>
<a name="ln373">  struct listnode  *ifnode;</a>
<a name="ln374">  struct interface *ifp;</a>
<a name="ln375"> </a>
<a name="ln376">  vty_out(vty,</a>
<a name="ln377">	  &quot;Interface Address         Source          Group           Membership%s&quot;,</a>
<a name="ln378">	  VTY_NEWLINE);</a>
<a name="ln379"> </a>
<a name="ln380">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln381">    struct pim_interface *pim_ifp;</a>
<a name="ln382">    struct in_addr ifaddr;</a>
<a name="ln383">    struct listnode *ch_node;</a>
<a name="ln384">    struct pim_ifchannel *ch;</a>
<a name="ln385"> </a>
<a name="ln386">    pim_ifp = ifp-&gt;info;</a>
<a name="ln387">    </a>
<a name="ln388">    if (!pim_ifp)</a>
<a name="ln389">      continue;</a>
<a name="ln390"> </a>
<a name="ln391">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln392"> </a>
<a name="ln393">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_ifchannel_list, ch_node, ch)) {</a>
<a name="ln394">      char ch_src_str[100];</a>
<a name="ln395">      char ch_grp_str[100];</a>
<a name="ln396"> </a>
<a name="ln397">      pim_inet4_dump(&quot;&lt;ch_src?&gt;&quot;, ch-&gt;source_addr,</a>
<a name="ln398">		     ch_src_str, sizeof(ch_src_str));</a>
<a name="ln399">      pim_inet4_dump(&quot;&lt;ch_grp?&gt;&quot;, ch-&gt;group_addr,</a>
<a name="ln400">		     ch_grp_str, sizeof(ch_grp_str));</a>
<a name="ln401"> </a>
<a name="ln402">      vty_out(vty, &quot;%-9s %-15s %-15s %-15s %-10s%s&quot;,</a>
<a name="ln403">	      ifp-&gt;name,</a>
<a name="ln404">	      inet_ntoa(ifaddr),</a>
<a name="ln405">	      ch_src_str,</a>
<a name="ln406">	      ch_grp_str,</a>
<a name="ln407">	      ch-&gt;local_ifmembership == PIM_IFMEMBERSHIP_NOINFO ?</a>
<a name="ln408">	      &quot;NOINFO&quot; : &quot;INCLUDE&quot;,</a>
<a name="ln409">	      VTY_NEWLINE);</a>
<a name="ln410">    } /* scan interface channels */</a>
<a name="ln411">  } /* scan interfaces */</a>
<a name="ln412"> </a>
<a name="ln413">}</a>
<a name="ln414"> </a>
<a name="ln415">static void igmp_show_interfaces(struct vty *vty)</a>
<a name="ln416">{</a>
<a name="ln417">  struct listnode  *node;</a>
<a name="ln418">  struct interface *ifp;</a>
<a name="ln419">  time_t            now;</a>
<a name="ln420">  </a>
<a name="ln421">  now = pim_time_monotonic_sec();</a>
<a name="ln422"> </a>
<a name="ln423">  vty_out(vty,</a>
<a name="ln424">	  &quot;Interface Address         ifIndex Socket Uptime   Multi Broad MLoop AllMu Prmsc Del%s&quot;,</a>
<a name="ln425">	  VTY_NEWLINE);</a>
<a name="ln426"> </a>
<a name="ln427">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln428">    struct pim_interface *pim_ifp;</a>
<a name="ln429">    struct listnode *sock_node;</a>
<a name="ln430">    struct igmp_sock *igmp;</a>
<a name="ln431"> </a>
<a name="ln432">    pim_ifp = ifp-&gt;info;</a>
<a name="ln433">    </a>
<a name="ln434">    if (!pim_ifp)</a>
<a name="ln435">      continue;</a>
<a name="ln436"> </a>
<a name="ln437">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln438">      char uptime[10];</a>
<a name="ln439">      int mloop;</a>
<a name="ln440"> </a>
<a name="ln441">      pim_time_uptime(uptime, sizeof(uptime), now - igmp-&gt;sock_creation);</a>
<a name="ln442"> </a>
<a name="ln443">      mloop = pim_socket_mcastloop_get(igmp-&gt;fd);</a>
<a name="ln444">      </a>
<a name="ln445">      vty_out(vty, &quot;%-9s %-15s %7d %6d %8s %5s %5s %5s %5s %5s %3s%s&quot;,</a>
<a name="ln446">	      ifp-&gt;name,</a>
<a name="ln447">	      inet_ntoa(igmp-&gt;ifaddr),</a>
<a name="ln448">	      ifp-&gt;ifindex,</a>
<a name="ln449">	      igmp-&gt;fd,</a>
<a name="ln450">	      uptime,</a>
<a name="ln451">	      if_is_multicast(ifp) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln452">	      if_is_broadcast(ifp) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln453">	      (mloop &lt; 0) ? &quot;?&quot; : (mloop ? &quot;yes&quot; : &quot;no&quot;),</a>
<a name="ln454">	      (ifp-&gt;flags &amp; IFF_ALLMULTI) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln455">	      (ifp-&gt;flags &amp; IFF_PROMISC) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln456">	      PIM_IF_IS_DELETED(ifp) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln457">	      VTY_NEWLINE);</a>
<a name="ln458">    }</a>
<a name="ln459">  }</a>
<a name="ln460">}</a>
<a name="ln461"> </a>
<a name="ln462">static void igmp_show_interface_join(struct vty *vty)</a>
<a name="ln463">{</a>
<a name="ln464">  struct listnode  *node;</a>
<a name="ln465">  struct interface *ifp;</a>
<a name="ln466">  time_t            now;</a>
<a name="ln467">  </a>
<a name="ln468">  now = pim_time_monotonic_sec();</a>
<a name="ln469"> </a>
<a name="ln470">  vty_out(vty,</a>
<a name="ln471">	  &quot;Interface Address         Source          Group           Socket Uptime  %s&quot;,</a>
<a name="ln472">	  VTY_NEWLINE);</a>
<a name="ln473"> </a>
<a name="ln474">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln475">    struct pim_interface *pim_ifp;</a>
<a name="ln476">    struct listnode *join_node;</a>
<a name="ln477">    struct igmp_join *ij;</a>
<a name="ln478">    struct in_addr pri_addr;</a>
<a name="ln479">    char pri_addr_str[100];</a>
<a name="ln480"> </a>
<a name="ln481">    pim_ifp = ifp-&gt;info;</a>
<a name="ln482">    </a>
<a name="ln483">    if (!pim_ifp)</a>
<a name="ln484">      continue;</a>
<a name="ln485"> </a>
<a name="ln486">    if (!pim_ifp-&gt;igmp_join_list)</a>
<a name="ln487">      continue;</a>
<a name="ln488"> </a>
<a name="ln489">    pri_addr = pim_find_primary_addr(ifp);</a>
<a name="ln490">    pim_inet4_dump(&quot;&lt;pri?&gt;&quot;, pri_addr, pri_addr_str, sizeof(pri_addr_str));</a>
<a name="ln491"> </a>
<a name="ln492">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_join_list, join_node, ij)) {</a>
<a name="ln493">      char group_str[100];</a>
<a name="ln494">      char source_str[100];</a>
<a name="ln495">      char uptime[10];</a>
<a name="ln496"> </a>
<a name="ln497">      pim_time_uptime(uptime, sizeof(uptime), now - ij-&gt;sock_creation);</a>
<a name="ln498">      pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, ij-&gt;group_addr, group_str, sizeof(group_str));</a>
<a name="ln499">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, ij-&gt;source_addr, source_str, sizeof(source_str));</a>
<a name="ln500">      </a>
<a name="ln501">      vty_out(vty, &quot;%-9s %-15s %-15s %-15s %6d %8s%s&quot;,</a>
<a name="ln502">	      ifp-&gt;name,</a>
<a name="ln503">	      pri_addr_str,</a>
<a name="ln504">	      source_str,</a>
<a name="ln505">	      group_str,</a>
<a name="ln506">	      ij-&gt;sock_fd,</a>
<a name="ln507">	      uptime,</a>
<a name="ln508">	      VTY_NEWLINE);</a>
<a name="ln509">    } /* for (pim_ifp-&gt;igmp_join_list) */</a>
<a name="ln510"> </a>
<a name="ln511">  } /* for (iflist) */</a>
<a name="ln512"> </a>
<a name="ln513">}</a>
<a name="ln514"> </a>
<a name="ln515">static void show_interface_address(struct vty *vty)</a>
<a name="ln516">{</a>
<a name="ln517">  struct listnode  *ifpnode;</a>
<a name="ln518">  struct interface *ifp;</a>
<a name="ln519">  </a>
<a name="ln520">  vty_out(vty,</a>
<a name="ln521">	  &quot;Interface Primary         Secondary      %s&quot;,</a>
<a name="ln522">	  VTY_NEWLINE);</a>
<a name="ln523"> </a>
<a name="ln524">  for (ALL_LIST_ELEMENTS_RO(iflist, ifpnode, ifp)) {</a>
<a name="ln525">    struct listnode  *ifcnode;</a>
<a name="ln526">    struct connected *ifc;</a>
<a name="ln527">    struct in_addr    pri_addr;</a>
<a name="ln528">    char pri_addr_str[100];</a>
<a name="ln529"> </a>
<a name="ln530">    pri_addr = pim_find_primary_addr(ifp);</a>
<a name="ln531"> </a>
<a name="ln532">    pim_inet4_dump(&quot;&lt;pri?&gt;&quot;, pri_addr, pri_addr_str, sizeof(pri_addr_str));</a>
<a name="ln533">    </a>
<a name="ln534">    for (ALL_LIST_ELEMENTS_RO(ifp-&gt;connected, ifcnode, ifc)) {</a>
<a name="ln535">      char sec_addr_str[100];</a>
<a name="ln536">      struct prefix *p = ifc-&gt;address;</a>
<a name="ln537"> </a>
<a name="ln538">      if (p-&gt;family != AF_INET)</a>
<a name="ln539">	continue;</a>
<a name="ln540"> </a>
<a name="ln541">      if (p-&gt;u.prefix4.s_addr == pri_addr.s_addr) {</a>
<a name="ln542">	sec_addr_str[0] = '\0';</a>
<a name="ln543">      }</a>
<a name="ln544">      else {</a>
<a name="ln545">	pim_inet4_dump(&quot;&lt;sec?&gt;&quot;, p-&gt;u.prefix4, sec_addr_str, sizeof(sec_addr_str));</a>
<a name="ln546">      }</a>
<a name="ln547">    </a>
<a name="ln548">      vty_out(vty, &quot;%-9s %-15s %-15s%s&quot;,</a>
<a name="ln549">	      ifp-&gt;name,</a>
<a name="ln550">	      pri_addr_str,</a>
<a name="ln551">	      sec_addr_str,</a>
<a name="ln552">	      VTY_NEWLINE);</a>
<a name="ln553">    }</a>
<a name="ln554">  }</a>
<a name="ln555">}</a>
<a name="ln556"> </a>
<a name="ln557">static void pim_show_dr(struct vty *vty)</a>
<a name="ln558">{</a>
<a name="ln559">  struct listnode  *node;</a>
<a name="ln560">  struct interface *ifp;</a>
<a name="ln561">  time_t            now;</a>
<a name="ln562">  </a>
<a name="ln563">  now = pim_time_monotonic_sec();</a>
<a name="ln564"> </a>
<a name="ln565">  vty_out(vty,</a>
<a name="ln566">	  &quot;NonPri: Number of neighbors missing DR Priority hello option%s&quot;</a>
<a name="ln567">	  &quot;DrPri: Designated Router Priority sent%s%s&quot;,</a>
<a name="ln568">	  VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE);</a>
<a name="ln569">  </a>
<a name="ln570">  vty_out(vty, &quot;Interface Address         DR              Uptime   Elections Changes NonPri      DrPri%s&quot;, VTY_NEWLINE);</a>
<a name="ln571"> </a>
<a name="ln572">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln573">    struct pim_interface *pim_ifp;</a>
<a name="ln574">    struct in_addr ifaddr;</a>
<a name="ln575">    char dr_str[100];</a>
<a name="ln576">    char dr_uptime[10];</a>
<a name="ln577"> </a>
<a name="ln578">    pim_ifp = ifp-&gt;info;</a>
<a name="ln579">    </a>
<a name="ln580">    if (!pim_ifp)</a>
<a name="ln581">      continue;</a>
<a name="ln582"> </a>
<a name="ln583">    if (pim_ifp-&gt;pim_sock_fd &lt; 0)</a>
<a name="ln584">      continue;</a>
<a name="ln585"> </a>
<a name="ln586">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln587"> </a>
<a name="ln588">    pim_time_uptime_begin(dr_uptime, sizeof(dr_uptime),</a>
<a name="ln589">			  now, pim_ifp-&gt;pim_dr_election_last);</a>
<a name="ln590"> </a>
<a name="ln591">    pim_inet4_dump(&quot;&lt;dr?&gt;&quot;, pim_ifp-&gt;pim_dr_addr,</a>
<a name="ln592">		   dr_str, sizeof(dr_str));</a>
<a name="ln593"> </a>
<a name="ln594">    vty_out(vty, &quot;%-9s %-15s %-15s %8s %9d %7d %6d %10d%s&quot;,</a>
<a name="ln595">	    ifp-&gt;name,</a>
<a name="ln596">	    inet_ntoa(ifaddr),</a>
<a name="ln597">	    dr_str,</a>
<a name="ln598">	    dr_uptime,</a>
<a name="ln599">	    pim_ifp-&gt;pim_dr_election_count,</a>
<a name="ln600">	    pim_ifp-&gt;pim_dr_election_changes,</a>
<a name="ln601">	    pim_ifp-&gt;pim_dr_num_nondrpri_neighbors,</a>
<a name="ln602">	    pim_ifp-&gt;pim_dr_priority,</a>
<a name="ln603">	    VTY_NEWLINE);</a>
<a name="ln604">  }</a>
<a name="ln605">}</a>
<a name="ln606"> </a>
<a name="ln607">static void pim_show_hello(struct vty *vty)</a>
<a name="ln608">{</a>
<a name="ln609">  struct listnode  *node;</a>
<a name="ln610">  struct interface *ifp;</a>
<a name="ln611">  time_t            now;</a>
<a name="ln612">  </a>
<a name="ln613">  now = pim_time_monotonic_sec();</a>
<a name="ln614">  </a>
<a name="ln615">  vty_out(vty, &quot;Interface Address         Period Timer StatStart Recv Rfail Send Sfail%s&quot;, VTY_NEWLINE);</a>
<a name="ln616"> </a>
<a name="ln617">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln618">    struct pim_interface *pim_ifp;</a>
<a name="ln619">    struct in_addr ifaddr;</a>
<a name="ln620">    char hello_period[10];</a>
<a name="ln621">    char hello_timer[10];</a>
<a name="ln622">    char stat_uptime[10];</a>
<a name="ln623"> </a>
<a name="ln624">    pim_ifp = ifp-&gt;info;</a>
<a name="ln625">    </a>
<a name="ln626">    if (!pim_ifp)</a>
<a name="ln627">      continue;</a>
<a name="ln628"> </a>
<a name="ln629">    if (pim_ifp-&gt;pim_sock_fd &lt; 0)</a>
<a name="ln630">      continue;</a>
<a name="ln631"> </a>
<a name="ln632">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln633"> </a>
<a name="ln634">    pim_time_timer_to_mmss(hello_timer, sizeof(hello_timer), pim_ifp-&gt;t_pim_hello_timer);</a>
<a name="ln635">    pim_time_mmss(hello_period, sizeof(hello_period), pim_ifp-&gt;pim_hello_period);</a>
<a name="ln636">    pim_time_uptime(stat_uptime, sizeof(stat_uptime), now - pim_ifp-&gt;pim_ifstat_start);</a>
<a name="ln637"> </a>
<a name="ln638">    vty_out(vty, &quot;%-9s %-15s %6s %5s %9s %4u %5u %4u %5u%s&quot;,</a>
<a name="ln639">	    ifp-&gt;name,</a>
<a name="ln640">	    inet_ntoa(ifaddr),</a>
<a name="ln641">	    hello_period,</a>
<a name="ln642">	    hello_timer,</a>
<a name="ln643">	    stat_uptime,</a>
<a name="ln644">	    pim_ifp-&gt;pim_ifstat_hello_recv,</a>
<a name="ln645">	    pim_ifp-&gt;pim_ifstat_hello_recvfail,</a>
<a name="ln646">	    pim_ifp-&gt;pim_ifstat_hello_sent,</a>
<a name="ln647">	    pim_ifp-&gt;pim_ifstat_hello_sendfail,</a>
<a name="ln648">	    VTY_NEWLINE);</a>
<a name="ln649">  }</a>
<a name="ln650">}</a>
<a name="ln651"> </a>
<a name="ln652">static void pim_show_interfaces(struct vty *vty)</a>
<a name="ln653">{</a>
<a name="ln654">  struct listnode  *node;</a>
<a name="ln655">  struct interface *ifp;</a>
<a name="ln656">  time_t            now;</a>
<a name="ln657">  </a>
<a name="ln658">  now = pim_time_monotonic_sec();</a>
<a name="ln659"> </a>
<a name="ln660">  vty_out(vty, &quot;Interface Address         ifIndex Socket Uptime   Multi Broad MLoop AllMu Prmsc Del%s&quot;, VTY_NEWLINE);</a>
<a name="ln661"> </a>
<a name="ln662">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln663">    struct pim_interface *pim_ifp;</a>
<a name="ln664">    struct in_addr ifaddr;</a>
<a name="ln665">    char uptime[10];</a>
<a name="ln666">    int mloop;</a>
<a name="ln667"> </a>
<a name="ln668">    pim_ifp = ifp-&gt;info;</a>
<a name="ln669">    </a>
<a name="ln670">    if (!pim_ifp)</a>
<a name="ln671">      continue;</a>
<a name="ln672"> </a>
<a name="ln673">    if (pim_ifp-&gt;pim_sock_fd &lt; 0)</a>
<a name="ln674">      continue;</a>
<a name="ln675"> </a>
<a name="ln676">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln677"> </a>
<a name="ln678">    pim_time_uptime(uptime, sizeof(uptime), now - pim_ifp-&gt;pim_sock_creation);</a>
<a name="ln679"> </a>
<a name="ln680">    mloop = pim_socket_mcastloop_get(pim_ifp-&gt;pim_sock_fd);</a>
<a name="ln681">      </a>
<a name="ln682">    vty_out(vty, &quot;%-9s %-15s %7d %6d %8s %5s %5s %5s %5s %5s %3s%s&quot;,</a>
<a name="ln683">	    ifp-&gt;name,</a>
<a name="ln684">	    inet_ntoa(ifaddr),</a>
<a name="ln685">	    ifp-&gt;ifindex,</a>
<a name="ln686">	    pim_ifp-&gt;pim_sock_fd,</a>
<a name="ln687">	    uptime,</a>
<a name="ln688">	    if_is_multicast(ifp) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln689">	    if_is_broadcast(ifp) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln690">	    (mloop &lt; 0) ? &quot;?&quot; : (mloop ? &quot;yes&quot; : &quot;no&quot;),</a>
<a name="ln691">	    (ifp-&gt;flags &amp; IFF_ALLMULTI) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln692">	    (ifp-&gt;flags &amp; IFF_PROMISC) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln693">	    PIM_IF_IS_DELETED(ifp) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln694">	    VTY_NEWLINE);</a>
<a name="ln695">  }</a>
<a name="ln696">}</a>
<a name="ln697"> </a>
<a name="ln698">static void pim_show_join(struct vty *vty)</a>
<a name="ln699">{</a>
<a name="ln700">  struct listnode  *ifnode;</a>
<a name="ln701">  struct interface *ifp;</a>
<a name="ln702">  time_t            now;</a>
<a name="ln703">  </a>
<a name="ln704">  now = pim_time_monotonic_sec();</a>
<a name="ln705"> </a>
<a name="ln706">  vty_out(vty,</a>
<a name="ln707">	  &quot;Interface Address         Source          Group           State  Uptime   Expire Prune%s&quot;,</a>
<a name="ln708">	  VTY_NEWLINE);</a>
<a name="ln709"> </a>
<a name="ln710">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln711">    struct pim_interface *pim_ifp;</a>
<a name="ln712">    struct in_addr ifaddr;</a>
<a name="ln713">    struct listnode *ch_node;</a>
<a name="ln714">    struct pim_ifchannel *ch;</a>
<a name="ln715"> </a>
<a name="ln716">    pim_ifp = ifp-&gt;info;</a>
<a name="ln717">    </a>
<a name="ln718">    if (!pim_ifp)</a>
<a name="ln719">      continue;</a>
<a name="ln720"> </a>
<a name="ln721">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln722"> </a>
<a name="ln723">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_ifchannel_list, ch_node, ch)) {</a>
<a name="ln724">      char ch_src_str[100];</a>
<a name="ln725">      char ch_grp_str[100];</a>
<a name="ln726">      char uptime[10];</a>
<a name="ln727">      char expire[10];</a>
<a name="ln728">      char prune[10];</a>
<a name="ln729"> </a>
<a name="ln730">      pim_inet4_dump(&quot;&lt;ch_src?&gt;&quot;, ch-&gt;source_addr,</a>
<a name="ln731">		     ch_src_str, sizeof(ch_src_str));</a>
<a name="ln732">      pim_inet4_dump(&quot;&lt;ch_grp?&gt;&quot;, ch-&gt;group_addr,</a>
<a name="ln733">		     ch_grp_str, sizeof(ch_grp_str));</a>
<a name="ln734"> </a>
<a name="ln735">      pim_time_uptime_begin(uptime, sizeof(uptime), now, ch-&gt;ifjoin_creation);</a>
<a name="ln736">      pim_time_timer_to_mmss(expire, sizeof(expire),</a>
<a name="ln737">			     ch-&gt;t_ifjoin_expiry_timer);</a>
<a name="ln738">      pim_time_timer_to_mmss(prune, sizeof(prune),</a>
<a name="ln739">			     ch-&gt;t_ifjoin_prune_pending_timer);</a>
<a name="ln740"> </a>
<a name="ln741">      vty_out(vty, &quot;%-9s %-15s %-15s %-15s %-6s %8s %-6s %5s%s&quot;,</a>
<a name="ln742">	      ifp-&gt;name,</a>
<a name="ln743">	      inet_ntoa(ifaddr),</a>
<a name="ln744">	      ch_src_str,</a>
<a name="ln745">	      ch_grp_str,</a>
<a name="ln746">	      pim_ifchannel_ifjoin_name(ch-&gt;ifjoin_state),</a>
<a name="ln747">	      uptime,</a>
<a name="ln748">	      expire,</a>
<a name="ln749">	      prune,</a>
<a name="ln750">	      VTY_NEWLINE);</a>
<a name="ln751">    } /* scan interface channels */</a>
<a name="ln752">  } /* scan interfaces */</a>
<a name="ln753"> </a>
<a name="ln754">}</a>
<a name="ln755"> </a>
<a name="ln756">static void pim_show_neighbors(struct vty *vty)</a>
<a name="ln757">{</a>
<a name="ln758">  struct listnode  *node;</a>
<a name="ln759">  struct interface *ifp;</a>
<a name="ln760">  time_t            now;</a>
<a name="ln761">  </a>
<a name="ln762">  now = pim_time_monotonic_sec();</a>
<a name="ln763"> </a>
<a name="ln764">  vty_out(vty,</a>
<a name="ln765">	  &quot;Recv flags: H=holdtime L=lan_prune_delay P=dr_priority G=generation_id A=address_list%s&quot;</a>
<a name="ln766">	  &quot;            T=can_disable_join_suppression%s%s&quot;,</a>
<a name="ln767">	  VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE);</a>
<a name="ln768"> </a>
<a name="ln769">  vty_out(vty, &quot;Interface Address         Neighbor        Uptime   Timer Holdt DrPri GenId    Recv  %s&quot;, VTY_NEWLINE);</a>
<a name="ln770"> </a>
<a name="ln771">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln772">    struct pim_interface *pim_ifp;</a>
<a name="ln773">    struct in_addr ifaddr;</a>
<a name="ln774">    struct listnode *neighnode;</a>
<a name="ln775">    struct pim_neighbor *neigh;</a>
<a name="ln776"> </a>
<a name="ln777">    pim_ifp = ifp-&gt;info;</a>
<a name="ln778">    </a>
<a name="ln779">    if (!pim_ifp)</a>
<a name="ln780">      continue;</a>
<a name="ln781"> </a>
<a name="ln782">    if (pim_ifp-&gt;pim_sock_fd &lt; 0)</a>
<a name="ln783">      continue;</a>
<a name="ln784"> </a>
<a name="ln785">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln786"> </a>
<a name="ln787">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_neighbor_list, neighnode, neigh)) {</a>
<a name="ln788">      char uptime[10];</a>
<a name="ln789">      char holdtime[10];</a>
<a name="ln790">      char expire[10];</a>
<a name="ln791">      char neigh_src_str[100];</a>
<a name="ln792">      char recv[7];</a>
<a name="ln793"> </a>
<a name="ln794">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, neigh-&gt;source_addr,</a>
<a name="ln795">		     neigh_src_str, sizeof(neigh_src_str));</a>
<a name="ln796">      pim_time_uptime(uptime, sizeof(uptime), now - neigh-&gt;creation);</a>
<a name="ln797">      pim_time_mmss(holdtime, sizeof(holdtime), neigh-&gt;holdtime);</a>
<a name="ln798">      pim_time_timer_to_mmss(expire, sizeof(expire), neigh-&gt;t_expire_timer);</a>
<a name="ln799"> </a>
<a name="ln800">      recv[0] = PIM_OPTION_IS_SET(neigh-&gt;hello_options, PIM_OPTION_MASK_HOLDTIME)                     ? 'H' : ' ';</a>
<a name="ln801">      recv[1] = PIM_OPTION_IS_SET(neigh-&gt;hello_options, PIM_OPTION_MASK_LAN_PRUNE_DELAY)              ? 'L' : ' ';</a>
<a name="ln802">      recv[2] = PIM_OPTION_IS_SET(neigh-&gt;hello_options, PIM_OPTION_MASK_DR_PRIORITY)                  ? 'P' : ' ';</a>
<a name="ln803">      recv[3] = PIM_OPTION_IS_SET(neigh-&gt;hello_options, PIM_OPTION_MASK_GENERATION_ID)                ? 'G' : ' ';</a>
<a name="ln804">      recv[4] = PIM_OPTION_IS_SET(neigh-&gt;hello_options, PIM_OPTION_MASK_ADDRESS_LIST)                 ? 'A' : ' ';</a>
<a name="ln805">      recv[5] = PIM_OPTION_IS_SET(neigh-&gt;hello_options, PIM_OPTION_MASK_CAN_DISABLE_JOIN_SUPPRESSION) ? 'T' : ' ';</a>
<a name="ln806">      recv[6] = '\0';</a>
<a name="ln807"> </a>
<a name="ln808">      vty_out(vty, &quot;%-9s %-15s %-15s %8s %5s %5s %5u %08x %6s%s&quot;,</a>
<a name="ln809">	      ifp-&gt;name,</a>
<a name="ln810">	      inet_ntoa(ifaddr),</a>
<a name="ln811">	      neigh_src_str,</a>
<a name="ln812">	      uptime,</a>
<a name="ln813">	      expire,</a>
<a name="ln814">	      holdtime,</a>
<a name="ln815">	      neigh-&gt;dr_priority,</a>
<a name="ln816">	      neigh-&gt;generation_id,</a>
<a name="ln817">	      recv,</a>
<a name="ln818">	      VTY_NEWLINE);</a>
<a name="ln819">    }</a>
<a name="ln820"> </a>
<a name="ln821"> </a>
<a name="ln822">  }</a>
<a name="ln823">}</a>
<a name="ln824"> </a>
<a name="ln825">static void pim_show_lan_prune_delay(struct vty *vty)</a>
<a name="ln826">{</a>
<a name="ln827">  struct listnode  *node;</a>
<a name="ln828">  struct interface *ifp;</a>
<a name="ln829"> </a>
<a name="ln830">  vty_out(vty,</a>
<a name="ln831">	  &quot;PrDly=propagation_delay (msec)           OvInt=override_interval (msec)%s&quot;</a>
<a name="ln832">	  &quot;HiDly=highest_propagation_delay (msec)   HiInt=highest_override_interval (msec)%s&quot;</a>
<a name="ln833">	  &quot;NoDly=number_of_non_lan_delay_neighbors%s&quot;</a>
<a name="ln834">	  &quot;T=t_bit LPD=lan_prune_delay_hello_option%s%s&quot;,</a>
<a name="ln835">	  VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE);</a>
<a name="ln836"> </a>
<a name="ln837">  vty_out(vty, &quot;Interface Address         PrDly OvInt NoDly HiDly HiInt T | Neighbor        LPD PrDly OvInt T%s&quot;, VTY_NEWLINE);</a>
<a name="ln838"> </a>
<a name="ln839">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln840">    struct pim_interface *pim_ifp;</a>
<a name="ln841">    struct in_addr ifaddr;</a>
<a name="ln842">    struct listnode *neighnode;</a>
<a name="ln843">    struct pim_neighbor *neigh;</a>
<a name="ln844"> </a>
<a name="ln845">    pim_ifp = ifp-&gt;info;</a>
<a name="ln846">    </a>
<a name="ln847">    if (!pim_ifp)</a>
<a name="ln848">      continue;</a>
<a name="ln849"> </a>
<a name="ln850">    if (pim_ifp-&gt;pim_sock_fd &lt; 0)</a>
<a name="ln851">      continue;</a>
<a name="ln852"> </a>
<a name="ln853">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln854"> </a>
<a name="ln855">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_neighbor_list, neighnode, neigh)) {</a>
<a name="ln856">      char neigh_src_str[100];</a>
<a name="ln857"> </a>
<a name="ln858">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, neigh-&gt;source_addr,</a>
<a name="ln859">		     neigh_src_str, sizeof(neigh_src_str));</a>
<a name="ln860"> </a>
<a name="ln861">      vty_out(vty, &quot;%-9s %-15s %5u %5u %5u %5u %5u %1u | %-15s %-3s %5u %5u %1u%s&quot;,</a>
<a name="ln862">	      ifp-&gt;name,</a>
<a name="ln863">	      inet_ntoa(ifaddr),</a>
<a name="ln864">	      pim_ifp-&gt;pim_propagation_delay_msec,</a>
<a name="ln865">	      pim_ifp-&gt;pim_override_interval_msec,</a>
<a name="ln866">	      pim_ifp-&gt;pim_number_of_nonlandelay_neighbors,</a>
<a name="ln867">	      pim_ifp-&gt;pim_neighbors_highest_propagation_delay_msec,</a>
<a name="ln868">	      pim_ifp-&gt;pim_neighbors_highest_override_interval_msec,</a>
<a name="ln869">	      PIM_FORCE_BOOLEAN(PIM_IF_TEST_PIM_CAN_DISABLE_JOIN_SUPRESSION(pim_ifp-&gt;options)),</a>
<a name="ln870">	      neigh_src_str,</a>
<a name="ln871">	      PIM_OPTION_IS_SET(neigh-&gt;hello_options, PIM_OPTION_MASK_LAN_PRUNE_DELAY) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln872">	      neigh-&gt;propagation_delay_msec,</a>
<a name="ln873">	      neigh-&gt;override_interval_msec,</a>
<a name="ln874">	      PIM_FORCE_BOOLEAN(PIM_OPTION_IS_SET(neigh-&gt;hello_options,</a>
<a name="ln875">						  PIM_OPTION_MASK_CAN_DISABLE_JOIN_SUPPRESSION)),</a>
<a name="ln876">	      VTY_NEWLINE);</a>
<a name="ln877">    }</a>
<a name="ln878"> </a>
<a name="ln879">  }</a>
<a name="ln880">}</a>
<a name="ln881"> </a>
<a name="ln882">static void pim_show_jp_override_interval(struct vty *vty)</a>
<a name="ln883">{</a>
<a name="ln884">  struct listnode  *node;</a>
<a name="ln885">  struct interface *ifp;</a>
<a name="ln886"> </a>
<a name="ln887">  vty_out(vty,</a>
<a name="ln888">	  &quot;EffPDelay=effective_propagation_delay (msec)%s&quot;</a>
<a name="ln889">	  &quot;EffOvrInt=override_interval (msec)%s&quot;</a>
<a name="ln890">	  &quot;JPOvrInt=jp_override_interval (msec)%s%s&quot;,</a>
<a name="ln891">	  VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE);</a>
<a name="ln892"> </a>
<a name="ln893">  vty_out(vty, &quot;Interface Address         LAN_Delay EffPDelay EffOvrInt JPOvrInt%s&quot;, VTY_NEWLINE);</a>
<a name="ln894"> </a>
<a name="ln895">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln896">    struct pim_interface *pim_ifp;</a>
<a name="ln897">    struct in_addr ifaddr;</a>
<a name="ln898"> </a>
<a name="ln899">    pim_ifp = ifp-&gt;info;</a>
<a name="ln900">    </a>
<a name="ln901">    if (!pim_ifp)</a>
<a name="ln902">      continue;</a>
<a name="ln903"> </a>
<a name="ln904">    if (pim_ifp-&gt;pim_sock_fd &lt; 0)</a>
<a name="ln905">      continue;</a>
<a name="ln906"> </a>
<a name="ln907">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln908"> </a>
<a name="ln909">    vty_out(vty, &quot;%-9s %-15s %-9s %9u %9u %8u%s&quot;,</a>
<a name="ln910">	    ifp-&gt;name,</a>
<a name="ln911">	    inet_ntoa(ifaddr),</a>
<a name="ln912">	    pim_if_lan_delay_enabled(ifp) ? &quot;enabled&quot; : &quot;disabled&quot;,</a>
<a name="ln913">	    pim_if_effective_propagation_delay_msec(ifp),</a>
<a name="ln914">	    pim_if_effective_override_interval_msec(ifp),</a>
<a name="ln915">	    pim_if_jp_override_interval_msec(ifp),</a>
<a name="ln916">	    VTY_NEWLINE);</a>
<a name="ln917">  }</a>
<a name="ln918">}</a>
<a name="ln919"> </a>
<a name="ln920">static void pim_show_neighbors_secondary(struct vty *vty)</a>
<a name="ln921">{</a>
<a name="ln922">  struct listnode  *node;</a>
<a name="ln923">  struct interface *ifp;</a>
<a name="ln924"> </a>
<a name="ln925">  vty_out(vty, &quot;Interface Address         Neighbor        Secondary      %s&quot;, VTY_NEWLINE);</a>
<a name="ln926"> </a>
<a name="ln927">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln928">    struct pim_interface *pim_ifp;</a>
<a name="ln929">    struct in_addr ifaddr;</a>
<a name="ln930">    struct listnode *neighnode;</a>
<a name="ln931">    struct pim_neighbor *neigh;</a>
<a name="ln932"> </a>
<a name="ln933">    pim_ifp = ifp-&gt;info;</a>
<a name="ln934">    </a>
<a name="ln935">    if (!pim_ifp)</a>
<a name="ln936">      continue;</a>
<a name="ln937"> </a>
<a name="ln938">    if (pim_ifp-&gt;pim_sock_fd &lt; 0)</a>
<a name="ln939">      continue;</a>
<a name="ln940"> </a>
<a name="ln941">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln942"> </a>
<a name="ln943">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_neighbor_list, neighnode, neigh)) {</a>
<a name="ln944">      char neigh_src_str[100];</a>
<a name="ln945">      struct listnode *prefix_node;</a>
<a name="ln946">      struct prefix *p;</a>
<a name="ln947"> </a>
<a name="ln948">      if (!neigh-&gt;prefix_list)</a>
<a name="ln949">	continue;</a>
<a name="ln950"> </a>
<a name="ln951">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, neigh-&gt;source_addr,</a>
<a name="ln952">		     neigh_src_str, sizeof(neigh_src_str));</a>
<a name="ln953"> </a>
<a name="ln954">      for (ALL_LIST_ELEMENTS_RO(neigh-&gt;prefix_list, prefix_node, p)) {</a>
<a name="ln955">	char neigh_sec_str[100];</a>
<a name="ln956"> </a>
<a name="ln957">	if (p-&gt;family != AF_INET)</a>
<a name="ln958">	  continue;</a>
<a name="ln959"> </a>
<a name="ln960">	pim_inet4_dump(&quot;&lt;src?&gt;&quot;, p-&gt;u.prefix4,</a>
<a name="ln961">		       neigh_sec_str, sizeof(neigh_sec_str));</a>
<a name="ln962"> </a>
<a name="ln963">	vty_out(vty, &quot;%-9s %-15s %-15s %-15s%s&quot;,</a>
<a name="ln964">		ifp-&gt;name,</a>
<a name="ln965">		inet_ntoa(ifaddr),</a>
<a name="ln966">		neigh_src_str,</a>
<a name="ln967">		neigh_sec_str,</a>
<a name="ln968">		VTY_NEWLINE);</a>
<a name="ln969">      }</a>
<a name="ln970">    }</a>
<a name="ln971">  }</a>
<a name="ln972">}</a>
<a name="ln973"> </a>
<a name="ln974">static void pim_show_upstream(struct vty *vty)</a>
<a name="ln975">{</a>
<a name="ln976">  struct listnode     *upnode;</a>
<a name="ln977">  struct pim_upstream *up;</a>
<a name="ln978">  time_t               now;</a>
<a name="ln979"> </a>
<a name="ln980">  now = pim_time_monotonic_sec();</a>
<a name="ln981"> </a>
<a name="ln982">  vty_out(vty, &quot;Source          Group           State Uptime   JoinTimer RefCnt%s&quot;, VTY_NEWLINE);</a>
<a name="ln983"> </a>
<a name="ln984">  for (ALL_LIST_ELEMENTS_RO(qpim_upstream_list, upnode, up)) {</a>
<a name="ln985">      char src_str[100];</a>
<a name="ln986">      char grp_str[100];</a>
<a name="ln987">      char uptime[10];</a>
<a name="ln988">      char join_timer[10];</a>
<a name="ln989"> </a>
<a name="ln990">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, up-&gt;source_addr, src_str, sizeof(src_str));</a>
<a name="ln991">      pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, up-&gt;group_addr, grp_str, sizeof(grp_str));</a>
<a name="ln992">      pim_time_uptime(uptime, sizeof(uptime), now - up-&gt;state_transition);</a>
<a name="ln993">      pim_time_timer_to_hhmmss(join_timer, sizeof(join_timer), up-&gt;t_join_timer);</a>
<a name="ln994"> </a>
<a name="ln995">      vty_out(vty, &quot;%-15s %-15s %-5s %-8s %-9s %6d%s&quot;,</a>
<a name="ln996">	      src_str,</a>
<a name="ln997">	      grp_str,</a>
<a name="ln998">	      up-&gt;join_state == PIM_UPSTREAM_JOINED ? &quot;Jnd&quot; : &quot;NtJnd&quot;,</a>
<a name="ln999">	      uptime,</a>
<a name="ln1000">	      join_timer,</a>
<a name="ln1001">	      up-&gt;ref_count,</a>
<a name="ln1002">	      VTY_NEWLINE);</a>
<a name="ln1003">  }</a>
<a name="ln1004">}</a>
<a name="ln1005"> </a>
<a name="ln1006">static void pim_show_join_desired(struct vty *vty)</a>
<a name="ln1007">{</a>
<a name="ln1008">  struct listnode      *ifnode;</a>
<a name="ln1009">  struct listnode      *chnode;</a>
<a name="ln1010">  struct interface     *ifp;</a>
<a name="ln1011">  struct pim_interface *pim_ifp;</a>
<a name="ln1012">  struct pim_ifchannel *ch;</a>
<a name="ln1013">  char src_str[100];</a>
<a name="ln1014">  char grp_str[100];</a>
<a name="ln1015"> </a>
<a name="ln1016">  vty_out(vty,</a>
<a name="ln1017">	  &quot;Interface Source          Group           LostAssert Joins PimInclude JoinDesired EvalJD%s&quot;,</a>
<a name="ln1018">	  VTY_NEWLINE);</a>
<a name="ln1019"> </a>
<a name="ln1020">  /* scan all interfaces */</a>
<a name="ln1021">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln1022">    pim_ifp = ifp-&gt;info;</a>
<a name="ln1023">    if (!pim_ifp)</a>
<a name="ln1024">      continue;</a>
<a name="ln1025"> </a>
<a name="ln1026">    /* scan per-interface (S,G) state */</a>
<a name="ln1027">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;pim_ifchannel_list, chnode, ch)) {</a>
<a name="ln1028">      struct pim_upstream *up = ch-&gt;upstream;</a>
<a name="ln1029"> </a>
<a name="ln1030">      pim_inet4_dump(&quot;&lt;src?&gt;&quot;, up-&gt;source_addr, src_str, sizeof(src_str));</a>
<a name="ln1031">      pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, up-&gt;group_addr, grp_str, sizeof(grp_str));</a>
<a name="ln1032"> </a>
<a name="ln1033">      vty_out(vty, &quot;%-9s %-15s %-15s %-10s %-5s %-10s %-11s %-6s%s&quot;,</a>
<a name="ln1034">	      ifp-&gt;name,</a>
<a name="ln1035">	      src_str,</a>
<a name="ln1036">	      grp_str,</a>
<a name="ln1037">	      pim_macro_ch_lost_assert(ch) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln1038">	      pim_macro_chisin_joins(ch) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln1039">	      pim_macro_chisin_pim_include(ch) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln1040">	      PIM_UPSTREAM_FLAG_TEST_DR_JOIN_DESIRED(up-&gt;flags) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln1041">	      pim_upstream_evaluate_join_desired(up) ? &quot;yes&quot; : &quot;no&quot;,</a>
<a name="ln1042">	      VTY_NEWLINE);</a>
<a name="ln1043">    }</a>
<a name="ln1044">  }</a>
<a name="ln1045">}</a>
<a name="ln1046"> </a>
<a name="ln1047">static void pim_show_upstream_rpf(struct vty *vty)</a>
<a name="ln1048">{</a>
<a name="ln1049">  struct listnode     *upnode;</a>
<a name="ln1050">  struct pim_upstream *up;</a>
<a name="ln1051"> </a>
<a name="ln1052">  vty_out(vty,</a>
<a name="ln1053">	  &quot;Source          Group           RpfIface RibNextHop      RpfAddress     %s&quot;,</a>
<a name="ln1054">	  VTY_NEWLINE);</a>
<a name="ln1055"> </a>
<a name="ln1056">  for (ALL_LIST_ELEMENTS_RO(qpim_upstream_list, upnode, up)) {</a>
<a name="ln1057">    char src_str[100];</a>
<a name="ln1058">    char grp_str[100];</a>
<a name="ln1059">    char rpf_nexthop_str[100];</a>
<a name="ln1060">    char rpf_addr_str[100];</a>
<a name="ln1061">    struct pim_rpf *rpf;</a>
<a name="ln1062">    const char *rpf_ifname;</a>
<a name="ln1063">    </a>
<a name="ln1064">    rpf = &amp;up-&gt;rpf;</a>
<a name="ln1065">    </a>
<a name="ln1066">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, up-&gt;source_addr, src_str, sizeof(src_str));</a>
<a name="ln1067">    pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, up-&gt;group_addr, grp_str, sizeof(grp_str));</a>
<a name="ln1068">    pim_inet4_dump(&quot;&lt;nexthop?&gt;&quot;, rpf-&gt;source_nexthop.mrib_nexthop_addr, rpf_nexthop_str, sizeof(rpf_nexthop_str));</a>
<a name="ln1069">    pim_inet4_dump(&quot;&lt;rpf?&gt;&quot;, rpf-&gt;rpf_addr, rpf_addr_str, sizeof(rpf_addr_str));</a>
<a name="ln1070">    </a>
<a name="ln1071">    rpf_ifname = rpf-&gt;source_nexthop.interface ? rpf-&gt;source_nexthop.interface-&gt;name : &quot;&lt;ifname?&gt;&quot;;</a>
<a name="ln1072">    </a>
<a name="ln1073">    vty_out(vty, &quot;%-15s %-15s %-8s %-15s %-15s%s&quot;,</a>
<a name="ln1074">	    src_str,</a>
<a name="ln1075">	    grp_str,</a>
<a name="ln1076">	    rpf_ifname,</a>
<a name="ln1077">	    rpf_nexthop_str,</a>
<a name="ln1078">	    rpf_addr_str,</a>
<a name="ln1079">	    VTY_NEWLINE);</a>
<a name="ln1080">  }</a>
<a name="ln1081">}</a>
<a name="ln1082"> </a>
<a name="ln1083">static void show_rpf_refresh_stats(struct vty *vty, time_t now)</a>
<a name="ln1084">{</a>
<a name="ln1085">  char refresh_uptime[10];</a>
<a name="ln1086"> </a>
<a name="ln1087">  pim_time_uptime_begin(refresh_uptime, sizeof(refresh_uptime), now, qpim_rpf_cache_refresh_last);</a>
<a name="ln1088"> </a>
<a name="ln1089">  vty_out(vty, </a>
<a name="ln1090">	  &quot;RPF Cache Refresh Delay:    %ld msecs%s&quot;</a>
<a name="ln1091">	  &quot;RPF Cache Refresh Timer:    %ld msecs%s&quot;</a>
<a name="ln1092">	  &quot;RPF Cache Refresh Requests: %lld%s&quot;</a>
<a name="ln1093">	  &quot;RPF Cache Refresh Events:   %lld%s&quot;</a>
<a name="ln1094">	  &quot;RPF Cache Refresh Last:     %s%s&quot;,</a>
<a name="ln1095">	  qpim_rpf_cache_refresh_delay_msec, VTY_NEWLINE,</a>
<a name="ln1096">	  pim_time_timer_remain_msec(qpim_rpf_cache_refresher), VTY_NEWLINE,</a>
<a name="ln1097">	  (long long)qpim_rpf_cache_refresh_requests, VTY_NEWLINE,</a>
<a name="ln1098">	  (long long)qpim_rpf_cache_refresh_events, VTY_NEWLINE,</a>
<a name="ln1099">	  refresh_uptime, VTY_NEWLINE);</a>
<a name="ln1100">}</a>
<a name="ln1101"> </a>
<a name="ln1102">static void show_scan_oil_stats(struct vty *vty, time_t now)</a>
<a name="ln1103">{</a>
<a name="ln1104">  char uptime_scan_oil[10];</a>
<a name="ln1105">  char uptime_mroute_add[10];</a>
<a name="ln1106">  char uptime_mroute_del[10];</a>
<a name="ln1107"> </a>
<a name="ln1108">  pim_time_uptime_begin(uptime_scan_oil, sizeof(uptime_scan_oil), now, qpim_scan_oil_last);</a>
<a name="ln1109">  pim_time_uptime_begin(uptime_mroute_add, sizeof(uptime_mroute_add), now, qpim_mroute_add_last);</a>
<a name="ln1110">  pim_time_uptime_begin(uptime_mroute_del, sizeof(uptime_mroute_del), now, qpim_mroute_del_last);</a>
<a name="ln1111"> </a>
<a name="ln1112">  vty_out(vty,</a>
<a name="ln1113">          &quot;Scan OIL - Last: %s  Events: %lld%s&quot;</a>
<a name="ln1114">          &quot;MFC Add  - Last: %s  Events: %lld%s&quot;</a>
<a name="ln1115">          &quot;MFC Del  - Last: %s  Events: %lld%s&quot;,</a>
<a name="ln1116">          uptime_scan_oil,   (long long) qpim_scan_oil_events,   VTY_NEWLINE,</a>
<a name="ln1117">          uptime_mroute_add, (long long) qpim_mroute_add_events, VTY_NEWLINE,</a>
<a name="ln1118">          uptime_mroute_del, (long long) qpim_mroute_del_events, VTY_NEWLINE);</a>
<a name="ln1119">}</a>
<a name="ln1120"> </a>
<a name="ln1121">static void pim_show_rpf(struct vty *vty)</a>
<a name="ln1122">{</a>
<a name="ln1123">  struct listnode     *up_node;</a>
<a name="ln1124">  struct pim_upstream *up;</a>
<a name="ln1125">  time_t               now = pim_time_monotonic_sec();</a>
<a name="ln1126"> </a>
<a name="ln1127">  show_rpf_refresh_stats(vty, now);</a>
<a name="ln1128"> </a>
<a name="ln1129">  vty_out(vty, &quot;%s&quot;, VTY_NEWLINE);</a>
<a name="ln1130"> </a>
<a name="ln1131">  vty_out(vty,</a>
<a name="ln1132">	  &quot;Source          Group           RpfIface RpfAddress      RibNextHop      Metric Pref%s&quot;,</a>
<a name="ln1133">	  VTY_NEWLINE);</a>
<a name="ln1134"> </a>
<a name="ln1135">  for (ALL_LIST_ELEMENTS_RO(qpim_upstream_list, up_node, up)) {</a>
<a name="ln1136">    char src_str[100];</a>
<a name="ln1137">    char grp_str[100];</a>
<a name="ln1138">    char rpf_addr_str[100];</a>
<a name="ln1139">    char rib_nexthop_str[100];</a>
<a name="ln1140">    const char *rpf_ifname;</a>
<a name="ln1141">    struct pim_rpf  *rpf = &amp;up-&gt;rpf;</a>
<a name="ln1142">    </a>
<a name="ln1143">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, up-&gt;source_addr, src_str, sizeof(src_str));</a>
<a name="ln1144">    pim_inet4_dump(&quot;&lt;grp?&gt;&quot;, up-&gt;group_addr, grp_str, sizeof(grp_str));</a>
<a name="ln1145">    pim_inet4_dump(&quot;&lt;rpf?&gt;&quot;, rpf-&gt;rpf_addr, rpf_addr_str, sizeof(rpf_addr_str));</a>
<a name="ln1146">    pim_inet4_dump(&quot;&lt;nexthop?&gt;&quot;, rpf-&gt;source_nexthop.mrib_nexthop_addr, rib_nexthop_str, sizeof(rib_nexthop_str));</a>
<a name="ln1147">    </a>
<a name="ln1148">    rpf_ifname = rpf-&gt;source_nexthop.interface ? rpf-&gt;source_nexthop.interface-&gt;name : &quot;&lt;ifname?&gt;&quot;;</a>
<a name="ln1149">    </a>
<a name="ln1150">    vty_out(vty, &quot;%-15s %-15s %-8s %-15s %-15s %6d %4d%s&quot;,</a>
<a name="ln1151">	    src_str,</a>
<a name="ln1152">	    grp_str,</a>
<a name="ln1153">	    rpf_ifname,</a>
<a name="ln1154">	    rpf_addr_str,</a>
<a name="ln1155">	    rib_nexthop_str,</a>
<a name="ln1156">	    rpf-&gt;source_nexthop.mrib_route_metric,</a>
<a name="ln1157">	    rpf-&gt;source_nexthop.mrib_metric_preference,</a>
<a name="ln1158">	    VTY_NEWLINE);</a>
<a name="ln1159">  }</a>
<a name="ln1160">}</a>
<a name="ln1161"> </a>
<a name="ln1162">static void igmp_show_querier(struct vty *vty)</a>
<a name="ln1163">{</a>
<a name="ln1164">  struct listnode  *node;</a>
<a name="ln1165">  struct interface *ifp;</a>
<a name="ln1166"> </a>
<a name="ln1167">  vty_out(vty, &quot;Interface Address         Querier StartCount Query-Timer Other-Timer%s&quot;, VTY_NEWLINE);</a>
<a name="ln1168"> </a>
<a name="ln1169">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln1170">    struct pim_interface *pim_ifp = ifp-&gt;info;</a>
<a name="ln1171">    struct listnode  *sock_node;</a>
<a name="ln1172">    struct igmp_sock *igmp;</a>
<a name="ln1173">    </a>
<a name="ln1174">    if (!pim_ifp)</a>
<a name="ln1175">      continue;</a>
<a name="ln1176"> </a>
<a name="ln1177">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln1178">      char query_hhmmss[10];</a>
<a name="ln1179">      char other_hhmmss[10];</a>
<a name="ln1180"> </a>
<a name="ln1181">      pim_time_timer_to_hhmmss(query_hhmmss, sizeof(query_hhmmss), igmp-&gt;t_igmp_query_timer);</a>
<a name="ln1182">      pim_time_timer_to_hhmmss(other_hhmmss, sizeof(other_hhmmss), igmp-&gt;t_other_querier_timer);</a>
<a name="ln1183"> </a>
<a name="ln1184">      vty_out(vty, &quot;%-9s %-15s %-7s %10d %11s %11s%s&quot;,</a>
<a name="ln1185">	      ifp-&gt;name,</a>
<a name="ln1186">	      inet_ntoa(igmp-&gt;ifaddr),</a>
<a name="ln1187">	      igmp-&gt;t_igmp_query_timer ? &quot;THIS&quot; : &quot;OTHER&quot;,</a>
<a name="ln1188">	      igmp-&gt;startup_query_count,</a>
<a name="ln1189">	      query_hhmmss,</a>
<a name="ln1190">	      other_hhmmss,</a>
<a name="ln1191">	      VTY_NEWLINE);</a>
<a name="ln1192">    }</a>
<a name="ln1193">  }</a>
<a name="ln1194">}</a>
<a name="ln1195"> </a>
<a name="ln1196">static void igmp_show_groups(struct vty *vty)</a>
<a name="ln1197">{</a>
<a name="ln1198">  struct listnode  *ifnode;</a>
<a name="ln1199">  struct interface *ifp;</a>
<a name="ln1200">  time_t            now;</a>
<a name="ln1201"> </a>
<a name="ln1202">  now = pim_time_monotonic_sec();</a>
<a name="ln1203"> </a>
<a name="ln1204">  vty_out(vty, &quot;Interface Address         Group           Mode Timer    Srcs V Uptime  %s&quot;, VTY_NEWLINE);</a>
<a name="ln1205"> </a>
<a name="ln1206">  /* scan interfaces */</a>
<a name="ln1207">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln1208">    struct pim_interface *pim_ifp = ifp-&gt;info;</a>
<a name="ln1209">    struct listnode  *sock_node;</a>
<a name="ln1210">    struct igmp_sock *igmp;</a>
<a name="ln1211">    </a>
<a name="ln1212">    if (!pim_ifp)</a>
<a name="ln1213">      continue;</a>
<a name="ln1214">    </a>
<a name="ln1215">    /* scan igmp sockets */</a>
<a name="ln1216">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln1217">      char ifaddr_str[100];</a>
<a name="ln1218">      struct listnode *grpnode;</a>
<a name="ln1219">      struct igmp_group *grp;</a>
<a name="ln1220"> </a>
<a name="ln1221">      pim_inet4_dump(&quot;&lt;ifaddr?&gt;&quot;, igmp-&gt;ifaddr, ifaddr_str, sizeof(ifaddr_str));</a>
<a name="ln1222"> </a>
<a name="ln1223">      /* scan igmp groups */</a>
<a name="ln1224">      for (ALL_LIST_ELEMENTS_RO(igmp-&gt;igmp_group_list, grpnode, grp)) {</a>
<a name="ln1225">	char group_str[100];</a>
<a name="ln1226">	char hhmmss[10];</a>
<a name="ln1227">	char uptime[10];</a>
<a name="ln1228"> </a>
<a name="ln1229">	pim_inet4_dump(&quot;&lt;group?&gt;&quot;, grp-&gt;group_addr, group_str, sizeof(group_str));</a>
<a name="ln1230">	pim_time_timer_to_hhmmss(hhmmss, sizeof(hhmmss), grp-&gt;t_group_timer);</a>
<a name="ln1231">	pim_time_uptime(uptime, sizeof(uptime), now - grp-&gt;group_creation);</a>
<a name="ln1232"> </a>
<a name="ln1233">	vty_out(vty, &quot;%-9s %-15s %-15s %4s %8s %4d %d %8s%s&quot;,</a>
<a name="ln1234">		ifp-&gt;name,</a>
<a name="ln1235">		ifaddr_str,</a>
<a name="ln1236">		group_str,</a>
<a name="ln1237">		grp-&gt;group_filtermode_isexcl ? &quot;EXCL&quot; : &quot;INCL&quot;,</a>
<a name="ln1238">		hhmmss,</a>
<a name="ln1239">		grp-&gt;group_source_list ? listcount(grp-&gt;group_source_list) : 0,</a>
<a name="ln1240">		igmp_group_compat_mode(igmp, grp),</a>
<a name="ln1241">		uptime,</a>
<a name="ln1242">		VTY_NEWLINE);</a>
<a name="ln1243"> </a>
<a name="ln1244">      } /* scan igmp groups */</a>
<a name="ln1245">    } /* scan igmp sockets */</a>
<a name="ln1246">  } /* scan interfaces */</a>
<a name="ln1247">}</a>
<a name="ln1248"> </a>
<a name="ln1249">static void igmp_show_group_retransmission(struct vty *vty)</a>
<a name="ln1250">{</a>
<a name="ln1251">  struct listnode  *ifnode;</a>
<a name="ln1252">  struct interface *ifp;</a>
<a name="ln1253"> </a>
<a name="ln1254">  vty_out(vty, &quot;Interface Address         Group           RetTimer Counter RetSrcs%s&quot;, VTY_NEWLINE);</a>
<a name="ln1255"> </a>
<a name="ln1256">  /* scan interfaces */</a>
<a name="ln1257">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln1258">    struct pim_interface *pim_ifp = ifp-&gt;info;</a>
<a name="ln1259">    struct listnode  *sock_node;</a>
<a name="ln1260">    struct igmp_sock *igmp;</a>
<a name="ln1261">    </a>
<a name="ln1262">    if (!pim_ifp)</a>
<a name="ln1263">      continue;</a>
<a name="ln1264">    </a>
<a name="ln1265">    /* scan igmp sockets */</a>
<a name="ln1266">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln1267">      char ifaddr_str[100];</a>
<a name="ln1268">      struct listnode *grpnode;</a>
<a name="ln1269">      struct igmp_group *grp;</a>
<a name="ln1270"> </a>
<a name="ln1271">      pim_inet4_dump(&quot;&lt;ifaddr?&gt;&quot;, igmp-&gt;ifaddr, ifaddr_str, sizeof(ifaddr_str));</a>
<a name="ln1272"> </a>
<a name="ln1273">      /* scan igmp groups */</a>
<a name="ln1274">      for (ALL_LIST_ELEMENTS_RO(igmp-&gt;igmp_group_list, grpnode, grp)) {</a>
<a name="ln1275">	char group_str[100];</a>
<a name="ln1276">	char grp_retr_mmss[10];</a>
<a name="ln1277">	struct listnode    *src_node;</a>
<a name="ln1278">	struct igmp_source *src;</a>
<a name="ln1279">	int grp_retr_sources = 0;</a>
<a name="ln1280"> </a>
<a name="ln1281">	pim_inet4_dump(&quot;&lt;group?&gt;&quot;, grp-&gt;group_addr, group_str, sizeof(group_str));</a>
<a name="ln1282">	pim_time_timer_to_mmss(grp_retr_mmss, sizeof(grp_retr_mmss), grp-&gt;t_group_query_retransmit_timer);</a>
<a name="ln1283"> </a>
<a name="ln1284"> </a>
<a name="ln1285">	/* count group sources with retransmission state */</a>
<a name="ln1286">	for (ALL_LIST_ELEMENTS_RO(grp-&gt;group_source_list, src_node, src)) {</a>
<a name="ln1287">	  if (src-&gt;source_query_retransmit_count &gt; 0) {</a>
<a name="ln1288">	    ++grp_retr_sources;</a>
<a name="ln1289">	  }</a>
<a name="ln1290">	}</a>
<a name="ln1291"> </a>
<a name="ln1292">	vty_out(vty, &quot;%-9s %-15s %-15s %-8s %7d %7d%s&quot;,</a>
<a name="ln1293">		ifp-&gt;name,</a>
<a name="ln1294">		ifaddr_str,</a>
<a name="ln1295">		group_str,</a>
<a name="ln1296">		grp_retr_mmss,</a>
<a name="ln1297">		grp-&gt;group_specific_query_retransmit_count,</a>
<a name="ln1298">		grp_retr_sources,</a>
<a name="ln1299">		VTY_NEWLINE);</a>
<a name="ln1300"> </a>
<a name="ln1301">      } /* scan igmp groups */</a>
<a name="ln1302">    } /* scan igmp sockets */</a>
<a name="ln1303">  } /* scan interfaces */</a>
<a name="ln1304">}</a>
<a name="ln1305"> </a>
<a name="ln1306">static void igmp_show_parameters(struct vty *vty)</a>
<a name="ln1307">{</a>
<a name="ln1308">  struct listnode  *ifnode;</a>
<a name="ln1309">  struct interface *ifp;</a>
<a name="ln1310"> </a>
<a name="ln1311">  vty_out(vty,</a>
<a name="ln1312">	  &quot;QRV: Robustness Variable             SQI: Startup Query Interval%s&quot;</a>
<a name="ln1313">	  &quot;QQI: Query Interval                  OQPI: Other Querier Present Interval%s&quot;</a>
<a name="ln1314">	  &quot;QRI: Query Response Interval         LMQT: Last Member Query Time%s&quot;</a>
<a name="ln1315">	  &quot;GMI: Group Membership Interval       OHPI: Older Host Present Interval%s%s&quot;,</a>
<a name="ln1316">	  VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE, VTY_NEWLINE);</a>
<a name="ln1317"> </a>
<a name="ln1318">  vty_out(vty,</a>
<a name="ln1319">	  &quot;Interface Address         QRV QQI QRI   GMI   SQI OQPI  LMQT  OHPI %s&quot;,</a>
<a name="ln1320">	  VTY_NEWLINE);</a>
<a name="ln1321"> </a>
<a name="ln1322">  /* scan interfaces */</a>
<a name="ln1323">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln1324">    struct pim_interface *pim_ifp = ifp-&gt;info;</a>
<a name="ln1325">    struct listnode  *sock_node;</a>
<a name="ln1326">    struct igmp_sock *igmp;</a>
<a name="ln1327">    </a>
<a name="ln1328">    if (!pim_ifp)</a>
<a name="ln1329">      continue;</a>
<a name="ln1330">    </a>
<a name="ln1331">    /* scan igmp sockets */</a>
<a name="ln1332">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln1333">      char ifaddr_str[100];</a>
<a name="ln1334">      long gmi_dsec;  /* Group Membership Interval */</a>
<a name="ln1335">      long oqpi_dsec; /* Other Querier Present Interval */</a>
<a name="ln1336">      int  sqi;</a>
<a name="ln1337">      long lmqt_dsec;</a>
<a name="ln1338">      long ohpi_dsec;</a>
<a name="ln1339">      long qri_dsec;</a>
<a name="ln1340"> </a>
<a name="ln1341">      pim_inet4_dump(&quot;&lt;ifaddr?&gt;&quot;, igmp-&gt;ifaddr, ifaddr_str, sizeof(ifaddr_str));</a>
<a name="ln1342"> </a>
<a name="ln1343">      gmi_dsec = PIM_IGMP_GMI_MSEC(igmp-&gt;querier_robustness_variable,</a>
<a name="ln1344">				   igmp-&gt;querier_query_interval,</a>
<a name="ln1345">				   pim_ifp-&gt;igmp_query_max_response_time_dsec) / 100;</a>
<a name="ln1346"> </a>
<a name="ln1347">      sqi = PIM_IGMP_SQI(pim_ifp-&gt;igmp_default_query_interval);</a>
<a name="ln1348"> </a>
<a name="ln1349">      oqpi_dsec = PIM_IGMP_OQPI_MSEC(igmp-&gt;querier_robustness_variable,</a>
<a name="ln1350">				     igmp-&gt;querier_query_interval,</a>
<a name="ln1351">				     pim_ifp-&gt;igmp_query_max_response_time_dsec) / 100;</a>
<a name="ln1352"> </a>
<a name="ln1353">      lmqt_dsec = PIM_IGMP_LMQT_MSEC(pim_ifp-&gt;igmp_query_max_response_time_dsec,</a>
<a name="ln1354">				     igmp-&gt;querier_robustness_variable) / 100;</a>
<a name="ln1355"> </a>
<a name="ln1356">      ohpi_dsec = PIM_IGMP_OHPI_DSEC(igmp-&gt;querier_robustness_variable,</a>
<a name="ln1357">				     igmp-&gt;querier_query_interval,</a>
<a name="ln1358">				     pim_ifp-&gt;igmp_query_max_response_time_dsec);</a>
<a name="ln1359"> </a>
<a name="ln1360">      qri_dsec = pim_ifp-&gt;igmp_query_max_response_time_dsec;</a>
<a name="ln1361"> </a>
<a name="ln1362">      vty_out(vty,</a>
<a name="ln1363">	      &quot;%-9s %-15s %3d %3d %3ld.%ld %3ld.%ld %3d %3ld.%ld %3ld.%ld %3ld.%ld%s&quot;,</a>
<a name="ln1364">	      ifp-&gt;name,</a>
<a name="ln1365">	      ifaddr_str,</a>
<a name="ln1366">	      igmp-&gt;querier_robustness_variable,</a>
<a name="ln1367">	      igmp-&gt;querier_query_interval,</a>
<a name="ln1368">	      qri_dsec / 10, qri_dsec % 10,</a>
<a name="ln1369">	      gmi_dsec / 10, gmi_dsec % 10,</a>
<a name="ln1370">	      sqi,</a>
<a name="ln1371">	      oqpi_dsec / 10, oqpi_dsec % 10,</a>
<a name="ln1372">	      lmqt_dsec / 10, lmqt_dsec % 10,</a>
<a name="ln1373">	      ohpi_dsec / 10, ohpi_dsec % 10,</a>
<a name="ln1374">	      VTY_NEWLINE);</a>
<a name="ln1375"> </a>
<a name="ln1376">    } /* scan igmp sockets */</a>
<a name="ln1377">  } /* scan interfaces */</a>
<a name="ln1378">}</a>
<a name="ln1379"> </a>
<a name="ln1380">static void igmp_show_sources(struct vty *vty)</a>
<a name="ln1381">{</a>
<a name="ln1382">  struct listnode  *ifnode;</a>
<a name="ln1383">  struct interface *ifp;</a>
<a name="ln1384">  time_t            now;</a>
<a name="ln1385"> </a>
<a name="ln1386">  now = pim_time_monotonic_sec();</a>
<a name="ln1387"> </a>
<a name="ln1388">  vty_out(vty, &quot;Interface Address         Group           Source          Timer Fwd Uptime  %s&quot;, VTY_NEWLINE);</a>
<a name="ln1389"> </a>
<a name="ln1390">  /* scan interfaces */</a>
<a name="ln1391">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln1392">    struct pim_interface *pim_ifp = ifp-&gt;info;</a>
<a name="ln1393">    struct listnode  *sock_node;</a>
<a name="ln1394">    struct igmp_sock *igmp;</a>
<a name="ln1395">    </a>
<a name="ln1396">    if (!pim_ifp)</a>
<a name="ln1397">      continue;</a>
<a name="ln1398">    </a>
<a name="ln1399">    /* scan igmp sockets */</a>
<a name="ln1400">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln1401">      char ifaddr_str[100];</a>
<a name="ln1402">      struct listnode   *grpnode;</a>
<a name="ln1403">      struct igmp_group *grp;</a>
<a name="ln1404"> </a>
<a name="ln1405">      pim_inet4_dump(&quot;&lt;ifaddr?&gt;&quot;, igmp-&gt;ifaddr, ifaddr_str, sizeof(ifaddr_str));</a>
<a name="ln1406"> </a>
<a name="ln1407">      /* scan igmp groups */</a>
<a name="ln1408">      for (ALL_LIST_ELEMENTS_RO(igmp-&gt;igmp_group_list, grpnode, grp)) {</a>
<a name="ln1409">	char group_str[100];</a>
<a name="ln1410">	struct listnode    *srcnode;</a>
<a name="ln1411">	struct igmp_source *src;</a>
<a name="ln1412"> </a>
<a name="ln1413">	pim_inet4_dump(&quot;&lt;group?&gt;&quot;, grp-&gt;group_addr, group_str, sizeof(group_str));</a>
<a name="ln1414">	</a>
<a name="ln1415">	/* scan group sources */</a>
<a name="ln1416">	for (ALL_LIST_ELEMENTS_RO(grp-&gt;group_source_list, srcnode, src)) {</a>
<a name="ln1417">	  char source_str[100];</a>
<a name="ln1418">	  char mmss[10];</a>
<a name="ln1419">	  char uptime[10];</a>
<a name="ln1420"> </a>
<a name="ln1421">	  pim_inet4_dump(&quot;&lt;source?&gt;&quot;, src-&gt;source_addr, source_str, sizeof(source_str));</a>
<a name="ln1422"> </a>
<a name="ln1423">	  pim_time_timer_to_mmss(mmss, sizeof(mmss), src-&gt;t_source_timer);</a>
<a name="ln1424"> </a>
<a name="ln1425">	  pim_time_uptime(uptime, sizeof(uptime), now - src-&gt;source_creation);</a>
<a name="ln1426"> </a>
<a name="ln1427">	  vty_out(vty, &quot;%-9s %-15s %-15s %-15s %5s %3s %8s%s&quot;,</a>
<a name="ln1428">		  ifp-&gt;name,</a>
<a name="ln1429">		  ifaddr_str,</a>
<a name="ln1430">		  group_str,</a>
<a name="ln1431">		  source_str,</a>
<a name="ln1432">		  mmss,</a>
<a name="ln1433">		  IGMP_SOURCE_TEST_FORWARDING(src-&gt;source_flags) ? &quot;Y&quot; : &quot;N&quot;,</a>
<a name="ln1434">		  uptime,</a>
<a name="ln1435">		  VTY_NEWLINE);</a>
<a name="ln1436">	  </a>
<a name="ln1437">	} /* scan group sources */</a>
<a name="ln1438">      } /* scan igmp groups */</a>
<a name="ln1439">    } /* scan igmp sockets */</a>
<a name="ln1440">  } /* scan interfaces */</a>
<a name="ln1441">}</a>
<a name="ln1442"> </a>
<a name="ln1443">static void igmp_show_source_retransmission(struct vty *vty)</a>
<a name="ln1444">{</a>
<a name="ln1445">  struct listnode  *ifnode;</a>
<a name="ln1446">  struct interface *ifp;</a>
<a name="ln1447"> </a>
<a name="ln1448">  vty_out(vty, &quot;Interface Address         Group           Source          Counter%s&quot;, VTY_NEWLINE);</a>
<a name="ln1449"> </a>
<a name="ln1450">  /* scan interfaces */</a>
<a name="ln1451">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln1452">    struct pim_interface *pim_ifp = ifp-&gt;info;</a>
<a name="ln1453">    struct listnode  *sock_node;</a>
<a name="ln1454">    struct igmp_sock *igmp;</a>
<a name="ln1455">    </a>
<a name="ln1456">    if (!pim_ifp)</a>
<a name="ln1457">      continue;</a>
<a name="ln1458">    </a>
<a name="ln1459">    /* scan igmp sockets */</a>
<a name="ln1460">    for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln1461">      char ifaddr_str[100];</a>
<a name="ln1462">      struct listnode   *grpnode;</a>
<a name="ln1463">      struct igmp_group *grp;</a>
<a name="ln1464"> </a>
<a name="ln1465">      pim_inet4_dump(&quot;&lt;ifaddr?&gt;&quot;, igmp-&gt;ifaddr, ifaddr_str, sizeof(ifaddr_str));</a>
<a name="ln1466"> </a>
<a name="ln1467">      /* scan igmp groups */</a>
<a name="ln1468">      for (ALL_LIST_ELEMENTS_RO(igmp-&gt;igmp_group_list, grpnode, grp)) {</a>
<a name="ln1469">	char group_str[100];</a>
<a name="ln1470">	struct listnode    *srcnode;</a>
<a name="ln1471">	struct igmp_source *src;</a>
<a name="ln1472"> </a>
<a name="ln1473">	pim_inet4_dump(&quot;&lt;group?&gt;&quot;, grp-&gt;group_addr, group_str, sizeof(group_str));</a>
<a name="ln1474">	</a>
<a name="ln1475">	/* scan group sources */</a>
<a name="ln1476">	for (ALL_LIST_ELEMENTS_RO(grp-&gt;group_source_list, srcnode, src)) {</a>
<a name="ln1477">	  char source_str[100];</a>
<a name="ln1478"> </a>
<a name="ln1479">	  pim_inet4_dump(&quot;&lt;source?&gt;&quot;, src-&gt;source_addr, source_str, sizeof(source_str));</a>
<a name="ln1480"> </a>
<a name="ln1481">	  vty_out(vty, &quot;%-9s %-15s %-15s %-15s %7d%s&quot;,</a>
<a name="ln1482">		  ifp-&gt;name,</a>
<a name="ln1483">		  ifaddr_str,</a>
<a name="ln1484">		  group_str,</a>
<a name="ln1485">		  source_str,</a>
<a name="ln1486">		  src-&gt;source_query_retransmit_count,</a>
<a name="ln1487">		  VTY_NEWLINE);</a>
<a name="ln1488">	  </a>
<a name="ln1489">	} /* scan group sources */</a>
<a name="ln1490">      } /* scan igmp groups */</a>
<a name="ln1491">    } /* scan igmp sockets */</a>
<a name="ln1492">  } /* scan interfaces */</a>
<a name="ln1493">}</a>
<a name="ln1494"> </a>
<a name="ln1495">static void clear_igmp_interfaces()</a>
<a name="ln1496">{</a>
<a name="ln1497">  struct listnode  *ifnode;</a>
<a name="ln1498">  struct listnode  *ifnextnode;</a>
<a name="ln1499">  struct interface *ifp;</a>
<a name="ln1500"> </a>
<a name="ln1501">  for (ALL_LIST_ELEMENTS(iflist, ifnode, ifnextnode, ifp)) {</a>
<a name="ln1502">    pim_if_addr_del_all_igmp(ifp);</a>
<a name="ln1503">  }</a>
<a name="ln1504"> </a>
<a name="ln1505">  for (ALL_LIST_ELEMENTS(iflist, ifnode, ifnextnode, ifp)) {</a>
<a name="ln1506">    pim_if_addr_add_all(ifp);</a>
<a name="ln1507">  }</a>
<a name="ln1508">}</a>
<a name="ln1509"> </a>
<a name="ln1510">static void clear_pim_interfaces()</a>
<a name="ln1511">{</a>
<a name="ln1512">  struct listnode  *ifnode;</a>
<a name="ln1513">  struct listnode  *ifnextnode;</a>
<a name="ln1514">  struct interface *ifp;</a>
<a name="ln1515"> </a>
<a name="ln1516">  for (ALL_LIST_ELEMENTS(iflist, ifnode, ifnextnode, ifp)) {</a>
<a name="ln1517">    if (ifp-&gt;info) {</a>
<a name="ln1518">      pim_neighbor_delete_all(ifp, &quot;interface cleared&quot;);</a>
<a name="ln1519">    }</a>
<a name="ln1520">  }</a>
<a name="ln1521">}</a>
<a name="ln1522"> </a>
<a name="ln1523">static void clear_interfaces()</a>
<a name="ln1524">{</a>
<a name="ln1525">  clear_igmp_interfaces();</a>
<a name="ln1526">  clear_pim_interfaces();</a>
<a name="ln1527">}</a>
<a name="ln1528"> </a>
<a name="ln1529">DEFUN (pim_interface,</a>
<a name="ln1530">       pim_interface_cmd,</a>
<a name="ln1531">       &quot;interface IFNAME&quot;,</a>
<a name="ln1532">       &quot;Select an interface to configure\n&quot;</a>
<a name="ln1533">       &quot;Interface's name\n&quot;)</a>
<a name="ln1534">{</a>
<a name="ln1535">  struct interface *ifp;</a>
<a name="ln1536">  const char *ifname = argv[0];</a>
<a name="ln1537">  size_t sl;</a>
<a name="ln1538"> </a>
<a name="ln1539">  sl = strlen(ifname);</a>
<a name="ln1540">  if (sl &gt; INTERFACE_NAMSIZ) {</a>
<a name="ln1541">    vty_out(vty, &quot;%% Interface name %s is invalid: length exceeds &quot;</a>
<a name="ln1542">	    &quot;%d characters%s&quot;,</a>
<a name="ln1543">	    ifname, INTERFACE_NAMSIZ, VTY_NEWLINE);</a>
<a name="ln1544">    return CMD_WARNING;</a>
<a name="ln1545">  }</a>
<a name="ln1546"> </a>
<a name="ln1547">  ifp = if_lookup_by_name_len(ifname, sl);</a>
<a name="ln1548">  if (!ifp) {</a>
<a name="ln1549">    vty_out(vty, &quot;%% Interface %s does not exist%s&quot;, ifname, VTY_NEWLINE);</a>
<a name="ln1550"> </a>
<a name="ln1551">    /* Returning here would prevent pimd from booting when there are</a>
<a name="ln1552">       interface commands in pimd.conf, since all interfaces are</a>
<a name="ln1553">       unknown at pimd boot time (the zebra daemon has not been</a>
<a name="ln1554">       contacted for interface discovery). */</a>
<a name="ln1555">    </a>
<a name="ln1556">    ifp = if_get_by_name_len(ifname, sl);</a>
<a name="ln1557">    if (!ifp) {</a>
<a name="ln1558">      vty_out(vty, &quot;%% Could not create interface %s%s&quot;, ifname, VTY_NEWLINE);</a>
<a name="ln1559">      return CMD_WARNING;</a>
<a name="ln1560">    }</a>
<a name="ln1561">  }</a>
<a name="ln1562"> </a>
<a name="ln1563">  vty-&gt;index = ifp;</a>
<a name="ln1564">  vty-&gt;node = INTERFACE_NODE;</a>
<a name="ln1565"> </a>
<a name="ln1566">  return CMD_SUCCESS;</a>
<a name="ln1567">}</a>
<a name="ln1568"> </a>
<a name="ln1569">DEFUN (clear_ip_interfaces,</a>
<a name="ln1570">       clear_ip_interfaces_cmd,</a>
<a name="ln1571">       &quot;clear ip interfaces&quot;,</a>
<a name="ln1572">       CLEAR_STR</a>
<a name="ln1573">       IP_STR</a>
<a name="ln1574">       &quot;Reset interfaces\n&quot;)</a>
<a name="ln1575">{</a>
<a name="ln1576">  clear_interfaces();</a>
<a name="ln1577"> </a>
<a name="ln1578">  return CMD_SUCCESS;</a>
<a name="ln1579">}</a>
<a name="ln1580"> </a>
<a name="ln1581">DEFUN (clear_ip_igmp_interfaces,</a>
<a name="ln1582">       clear_ip_igmp_interfaces_cmd,</a>
<a name="ln1583">       &quot;clear ip igmp interfaces&quot;,</a>
<a name="ln1584">       CLEAR_STR</a>
<a name="ln1585">       IP_STR</a>
<a name="ln1586">       CLEAR_IP_IGMP_STR</a>
<a name="ln1587">       &quot;Reset IGMP interfaces\n&quot;)</a>
<a name="ln1588">{</a>
<a name="ln1589">  clear_igmp_interfaces();</a>
<a name="ln1590"> </a>
<a name="ln1591">  return CMD_SUCCESS;</a>
<a name="ln1592">}</a>
<a name="ln1593"> </a>
<a name="ln1594">static void mroute_add_all()</a>
<a name="ln1595">{</a>
<a name="ln1596">  struct listnode    *node;</a>
<a name="ln1597">  struct channel_oil *c_oil;</a>
<a name="ln1598"> </a>
<a name="ln1599">  for (ALL_LIST_ELEMENTS_RO(qpim_channel_oil_list, node, c_oil)) {</a>
<a name="ln1600">    if (pim_mroute_add(&amp;c_oil-&gt;oil)) {</a>
<a name="ln1601">      /* just log warning */</a>
<a name="ln1602">      char source_str[100];</a>
<a name="ln1603">      char group_str[100];</a>
<a name="ln1604">      pim_inet4_dump(&quot;&lt;source?&gt;&quot;, c_oil-&gt;oil.mfcc_origin, source_str, sizeof(source_str));</a>
<a name="ln1605">      pim_inet4_dump(&quot;&lt;group?&gt;&quot;, c_oil-&gt;oil.mfcc_mcastgrp, group_str, sizeof(group_str));</a>
<a name="ln1606">      zlog_warn(&quot;%s %s: (S,G)=(%s,%s) failure writing MFC&quot;,</a>
<a name="ln1607">                __FILE__, __PRETTY_FUNCTION__,</a>
<a name="ln1608">                source_str, group_str);</a>
<a name="ln1609">    }</a>
<a name="ln1610">  }</a>
<a name="ln1611">}</a>
<a name="ln1612"> </a>
<a name="ln1613">static void mroute_del_all()</a>
<a name="ln1614">{</a>
<a name="ln1615">  struct listnode    *node;</a>
<a name="ln1616">  struct channel_oil *c_oil;</a>
<a name="ln1617"> </a>
<a name="ln1618">  for (ALL_LIST_ELEMENTS_RO(qpim_channel_oil_list, node, c_oil)) {</a>
<a name="ln1619">    if (pim_mroute_del(&amp;c_oil-&gt;oil)) {</a>
<a name="ln1620">      /* just log warning */</a>
<a name="ln1621">      char source_str[100];</a>
<a name="ln1622">      char group_str[100];</a>
<a name="ln1623">      pim_inet4_dump(&quot;&lt;source?&gt;&quot;, c_oil-&gt;oil.mfcc_origin, source_str, sizeof(source_str));</a>
<a name="ln1624">      pim_inet4_dump(&quot;&lt;group?&gt;&quot;, c_oil-&gt;oil.mfcc_mcastgrp, group_str, sizeof(group_str));</a>
<a name="ln1625">      zlog_warn(&quot;%s %s: (S,G)=(%s,%s) failure clearing MFC&quot;,</a>
<a name="ln1626">                __FILE__, __PRETTY_FUNCTION__,</a>
<a name="ln1627">                source_str, group_str);</a>
<a name="ln1628">    }</a>
<a name="ln1629">  }</a>
<a name="ln1630">}</a>
<a name="ln1631"> </a>
<a name="ln1632">static void static_mroute_add_all()</a>
<a name="ln1633">{</a>
<a name="ln1634">  struct listnode     *node;</a>
<a name="ln1635">  struct static_route *s_route;</a>
<a name="ln1636"> </a>
<a name="ln1637">  for (ALL_LIST_ELEMENTS_RO(qpim_static_route_list, node, s_route)) {</a>
<a name="ln1638">    if (pim_mroute_add(&amp;s_route-&gt;mc)) {</a>
<a name="ln1639">      /* just log warning */</a>
<a name="ln1640">      char source_str[100];</a>
<a name="ln1641">      char group_str[100];</a>
<a name="ln1642">      pim_inet4_dump(&quot;&lt;source?&gt;&quot;, s_route-&gt;mc.mfcc_origin, source_str, sizeof(source_str));</a>
<a name="ln1643">      pim_inet4_dump(&quot;&lt;group?&gt;&quot;, s_route-&gt;mc.mfcc_mcastgrp, group_str, sizeof(group_str));</a>
<a name="ln1644">      zlog_warn(&quot;%s %s: (S,G)=(%s,%s) failure writing MFC&quot;,</a>
<a name="ln1645">      __FILE__, __PRETTY_FUNCTION__,</a>
<a name="ln1646">      source_str, group_str);</a>
<a name="ln1647">    }</a>
<a name="ln1648">  }</a>
<a name="ln1649">}</a>
<a name="ln1650"> </a>
<a name="ln1651">static void static_mroute_del_all()</a>
<a name="ln1652">{</a>
<a name="ln1653">   struct listnode     *node;</a>
<a name="ln1654">   struct static_route *s_route;</a>
<a name="ln1655"> </a>
<a name="ln1656">   for (ALL_LIST_ELEMENTS_RO(qpim_static_route_list, node, s_route)) {</a>
<a name="ln1657">     if (pim_mroute_del(&amp;s_route-&gt;mc)) {</a>
<a name="ln1658">       /* just log warning */</a>
<a name="ln1659">       char source_str[100];</a>
<a name="ln1660">       char group_str[100];</a>
<a name="ln1661">       pim_inet4_dump(&quot;&lt;source?&gt;&quot;, s_route-&gt;mc.mfcc_origin, source_str, sizeof(source_str));</a>
<a name="ln1662">       pim_inet4_dump(&quot;&lt;group?&gt;&quot;, s_route-&gt;mc.mfcc_mcastgrp, group_str, sizeof(group_str));</a>
<a name="ln1663">       zlog_warn(&quot;%s %s: (S,G)=(%s,%s) failure clearing MFC&quot;,</a>
<a name="ln1664">       __FILE__, __PRETTY_FUNCTION__,</a>
<a name="ln1665">       source_str, group_str);</a>
<a name="ln1666">     }</a>
<a name="ln1667">   }</a>
<a name="ln1668">}</a>
<a name="ln1669"> </a>
<a name="ln1670">DEFUN (clear_ip_mroute,</a>
<a name="ln1671">       clear_ip_mroute_cmd,</a>
<a name="ln1672">       &quot;clear ip mroute&quot;,</a>
<a name="ln1673">       CLEAR_STR</a>
<a name="ln1674">       IP_STR</a>
<a name="ln1675">       &quot;Reset multicast routes\n&quot;)</a>
<a name="ln1676">{</a>
<a name="ln1677">  mroute_del_all();</a>
<a name="ln1678">  mroute_add_all();</a>
<a name="ln1679"> </a>
<a name="ln1680">  return CMD_SUCCESS;</a>
<a name="ln1681">}</a>
<a name="ln1682"> </a>
<a name="ln1683">DEFUN (clear_ip_pim_interfaces,</a>
<a name="ln1684">       clear_ip_pim_interfaces_cmd,</a>
<a name="ln1685">       &quot;clear ip pim interfaces&quot;,</a>
<a name="ln1686">       CLEAR_STR</a>
<a name="ln1687">       IP_STR</a>
<a name="ln1688">       CLEAR_IP_PIM_STR</a>
<a name="ln1689">       &quot;Reset PIM interfaces\n&quot;)</a>
<a name="ln1690">{</a>
<a name="ln1691">  clear_pim_interfaces();</a>
<a name="ln1692"> </a>
<a name="ln1693">  return CMD_SUCCESS;</a>
<a name="ln1694">}</a>
<a name="ln1695"> </a>
<a name="ln1696">DEFUN (clear_ip_pim_oil,</a>
<a name="ln1697">       clear_ip_pim_oil_cmd,</a>
<a name="ln1698">       &quot;clear ip pim oil&quot;,</a>
<a name="ln1699">       CLEAR_STR</a>
<a name="ln1700">       IP_STR</a>
<a name="ln1701">       CLEAR_IP_PIM_STR</a>
<a name="ln1702">       &quot;Rescan PIM OIL (output interface list)\n&quot;)</a>
<a name="ln1703">{</a>
<a name="ln1704">  pim_scan_oil();</a>
<a name="ln1705"> </a>
<a name="ln1706">  return CMD_SUCCESS;</a>
<a name="ln1707">}</a>
<a name="ln1708"> </a>
<a name="ln1709">DEFUN (show_ip_igmp_interface,</a>
<a name="ln1710">       show_ip_igmp_interface_cmd,</a>
<a name="ln1711">       &quot;show ip igmp interface&quot;,</a>
<a name="ln1712">       SHOW_STR</a>
<a name="ln1713">       IP_STR</a>
<a name="ln1714">       IGMP_STR</a>
<a name="ln1715">       &quot;IGMP interface information\n&quot;)</a>
<a name="ln1716">{</a>
<a name="ln1717">  igmp_show_interfaces(vty);</a>
<a name="ln1718"> </a>
<a name="ln1719">  return CMD_SUCCESS;</a>
<a name="ln1720">}</a>
<a name="ln1721"> </a>
<a name="ln1722">DEFUN (show_ip_igmp_join,</a>
<a name="ln1723">       show_ip_igmp_join_cmd,</a>
<a name="ln1724">       &quot;show ip igmp join&quot;,</a>
<a name="ln1725">       SHOW_STR</a>
<a name="ln1726">       IP_STR</a>
<a name="ln1727">       IGMP_STR</a>
<a name="ln1728">       &quot;IGMP static join information\n&quot;)</a>
<a name="ln1729">{</a>
<a name="ln1730">  igmp_show_interface_join(vty);</a>
<a name="ln1731"> </a>
<a name="ln1732">  return CMD_SUCCESS;</a>
<a name="ln1733">}</a>
<a name="ln1734"> </a>
<a name="ln1735">DEFUN (show_ip_igmp_groups,</a>
<a name="ln1736">       show_ip_igmp_groups_cmd,</a>
<a name="ln1737">       &quot;show ip igmp groups&quot;,</a>
<a name="ln1738">       SHOW_STR</a>
<a name="ln1739">       IP_STR</a>
<a name="ln1740">       IGMP_STR</a>
<a name="ln1741">       IGMP_GROUP_STR)</a>
<a name="ln1742">{</a>
<a name="ln1743">  igmp_show_groups(vty);</a>
<a name="ln1744"> </a>
<a name="ln1745">  return CMD_SUCCESS;</a>
<a name="ln1746">}</a>
<a name="ln1747"> </a>
<a name="ln1748">DEFUN (show_ip_igmp_groups_retransmissions,</a>
<a name="ln1749">       show_ip_igmp_groups_retransmissions_cmd,</a>
<a name="ln1750">       &quot;show ip igmp groups retransmissions&quot;,</a>
<a name="ln1751">       SHOW_STR</a>
<a name="ln1752">       IP_STR</a>
<a name="ln1753">       IGMP_STR</a>
<a name="ln1754">       IGMP_GROUP_STR</a>
<a name="ln1755">       &quot;IGMP group retransmissions\n&quot;)</a>
<a name="ln1756">{</a>
<a name="ln1757">  igmp_show_group_retransmission(vty);</a>
<a name="ln1758"> </a>
<a name="ln1759">  return CMD_SUCCESS;</a>
<a name="ln1760">}</a>
<a name="ln1761"> </a>
<a name="ln1762">DEFUN (show_ip_igmp_parameters,</a>
<a name="ln1763">       show_ip_igmp_parameters_cmd,</a>
<a name="ln1764">       &quot;show ip igmp parameters&quot;,</a>
<a name="ln1765">       SHOW_STR</a>
<a name="ln1766">       IP_STR</a>
<a name="ln1767">       IGMP_STR</a>
<a name="ln1768">       &quot;IGMP parameters information\n&quot;)</a>
<a name="ln1769">{</a>
<a name="ln1770">  igmp_show_parameters(vty);</a>
<a name="ln1771"> </a>
<a name="ln1772">  return CMD_SUCCESS;</a>
<a name="ln1773">}</a>
<a name="ln1774"> </a>
<a name="ln1775">DEFUN (show_ip_igmp_sources,</a>
<a name="ln1776">       show_ip_igmp_sources_cmd,</a>
<a name="ln1777">       &quot;show ip igmp sources&quot;,</a>
<a name="ln1778">       SHOW_STR</a>
<a name="ln1779">       IP_STR</a>
<a name="ln1780">       IGMP_STR</a>
<a name="ln1781">       IGMP_SOURCE_STR)</a>
<a name="ln1782">{</a>
<a name="ln1783">  igmp_show_sources(vty);</a>
<a name="ln1784"> </a>
<a name="ln1785">  return CMD_SUCCESS;</a>
<a name="ln1786">}</a>
<a name="ln1787"> </a>
<a name="ln1788">DEFUN (show_ip_igmp_sources_retransmissions,</a>
<a name="ln1789">       show_ip_igmp_sources_retransmissions_cmd,</a>
<a name="ln1790">       &quot;show ip igmp sources retransmissions&quot;,</a>
<a name="ln1791">       SHOW_STR</a>
<a name="ln1792">       IP_STR</a>
<a name="ln1793">       IGMP_STR</a>
<a name="ln1794">       IGMP_SOURCE_STR</a>
<a name="ln1795">       &quot;IGMP source retransmissions\n&quot;)</a>
<a name="ln1796">{</a>
<a name="ln1797">  igmp_show_source_retransmission(vty);</a>
<a name="ln1798"> </a>
<a name="ln1799">  return CMD_SUCCESS;</a>
<a name="ln1800">}</a>
<a name="ln1801"> </a>
<a name="ln1802">DEFUN (show_ip_igmp_querier,</a>
<a name="ln1803">       show_ip_igmp_querier_cmd,</a>
<a name="ln1804">       &quot;show ip igmp querier&quot;,</a>
<a name="ln1805">       SHOW_STR</a>
<a name="ln1806">       IP_STR</a>
<a name="ln1807">       IGMP_STR</a>
<a name="ln1808">       &quot;IGMP querier information\n&quot;)</a>
<a name="ln1809">{</a>
<a name="ln1810">  igmp_show_querier(vty);</a>
<a name="ln1811"> </a>
<a name="ln1812">  return CMD_SUCCESS;</a>
<a name="ln1813">}</a>
<a name="ln1814"> </a>
<a name="ln1815">DEFUN (show_ip_pim_address,</a>
<a name="ln1816">       show_ip_pim_address_cmd,</a>
<a name="ln1817">       &quot;show ip pim address&quot;,</a>
<a name="ln1818">       SHOW_STR</a>
<a name="ln1819">       IP_STR</a>
<a name="ln1820">       PIM_STR</a>
<a name="ln1821">       &quot;PIM interface address\n&quot;)</a>
<a name="ln1822">{</a>
<a name="ln1823">  show_interface_address(vty);</a>
<a name="ln1824"> </a>
<a name="ln1825">  return CMD_SUCCESS;</a>
<a name="ln1826">}</a>
<a name="ln1827"> </a>
<a name="ln1828">DEFUN (show_ip_pim_assert,</a>
<a name="ln1829">       show_ip_pim_assert_cmd,</a>
<a name="ln1830">       &quot;show ip pim assert&quot;,</a>
<a name="ln1831">       SHOW_STR</a>
<a name="ln1832">       IP_STR</a>
<a name="ln1833">       PIM_STR</a>
<a name="ln1834">       &quot;PIM interface assert\n&quot;)</a>
<a name="ln1835">{</a>
<a name="ln1836">  pim_show_assert(vty);</a>
<a name="ln1837"> </a>
<a name="ln1838">  return CMD_SUCCESS;</a>
<a name="ln1839">}</a>
<a name="ln1840"> </a>
<a name="ln1841">DEFUN (show_ip_pim_assert_internal,</a>
<a name="ln1842">       show_ip_pim_assert_internal_cmd,</a>
<a name="ln1843">       &quot;show ip pim assert-internal&quot;,</a>
<a name="ln1844">       SHOW_STR</a>
<a name="ln1845">       IP_STR</a>
<a name="ln1846">       PIM_STR</a>
<a name="ln1847">       &quot;PIM interface internal assert state\n&quot;)</a>
<a name="ln1848">{</a>
<a name="ln1849">  pim_show_assert_internal(vty);</a>
<a name="ln1850"> </a>
<a name="ln1851">  return CMD_SUCCESS;</a>
<a name="ln1852">}</a>
<a name="ln1853"> </a>
<a name="ln1854">DEFUN (show_ip_pim_assert_metric,</a>
<a name="ln1855">       show_ip_pim_assert_metric_cmd,</a>
<a name="ln1856">       &quot;show ip pim assert-metric&quot;,</a>
<a name="ln1857">       SHOW_STR</a>
<a name="ln1858">       IP_STR</a>
<a name="ln1859">       PIM_STR</a>
<a name="ln1860">       &quot;PIM interface assert metric\n&quot;)</a>
<a name="ln1861">{</a>
<a name="ln1862">  pim_show_assert_metric(vty);</a>
<a name="ln1863"> </a>
<a name="ln1864">  return CMD_SUCCESS;</a>
<a name="ln1865">}</a>
<a name="ln1866"> </a>
<a name="ln1867">DEFUN (show_ip_pim_assert_winner_metric,</a>
<a name="ln1868">       show_ip_pim_assert_winner_metric_cmd,</a>
<a name="ln1869">       &quot;show ip pim assert-winner-metric&quot;,</a>
<a name="ln1870">       SHOW_STR</a>
<a name="ln1871">       IP_STR</a>
<a name="ln1872">       PIM_STR</a>
<a name="ln1873">       &quot;PIM interface assert winner metric\n&quot;)</a>
<a name="ln1874">{</a>
<a name="ln1875">  pim_show_assert_winner_metric(vty);</a>
<a name="ln1876"> </a>
<a name="ln1877">  return CMD_SUCCESS;</a>
<a name="ln1878">}</a>
<a name="ln1879"> </a>
<a name="ln1880">DEFUN (show_ip_pim_dr,</a>
<a name="ln1881">       show_ip_pim_dr_cmd,</a>
<a name="ln1882">       &quot;show ip pim designated-router&quot;,</a>
<a name="ln1883">       SHOW_STR</a>
<a name="ln1884">       IP_STR</a>
<a name="ln1885">       PIM_STR</a>
<a name="ln1886">       &quot;PIM interface designated router\n&quot;)</a>
<a name="ln1887">{</a>
<a name="ln1888">  pim_show_dr(vty);</a>
<a name="ln1889"> </a>
<a name="ln1890">  return CMD_SUCCESS;</a>
<a name="ln1891">}</a>
<a name="ln1892"> </a>
<a name="ln1893">DEFUN (show_ip_pim_hello,</a>
<a name="ln1894">       show_ip_pim_hello_cmd,</a>
<a name="ln1895">       &quot;show ip pim hello&quot;,</a>
<a name="ln1896">       SHOW_STR</a>
<a name="ln1897">       IP_STR</a>
<a name="ln1898">       PIM_STR</a>
<a name="ln1899">       &quot;PIM interface hello information\n&quot;)</a>
<a name="ln1900">{</a>
<a name="ln1901">  pim_show_hello(vty);</a>
<a name="ln1902"> </a>
<a name="ln1903">  return CMD_SUCCESS;</a>
<a name="ln1904">}</a>
<a name="ln1905"> </a>
<a name="ln1906">DEFUN (show_ip_pim_interface,</a>
<a name="ln1907">       show_ip_pim_interface_cmd,</a>
<a name="ln1908">       &quot;show ip pim interface&quot;,</a>
<a name="ln1909">       SHOW_STR</a>
<a name="ln1910">       IP_STR</a>
<a name="ln1911">       PIM_STR</a>
<a name="ln1912">       &quot;PIM interface information\n&quot;)</a>
<a name="ln1913">{</a>
<a name="ln1914">  pim_show_interfaces(vty);</a>
<a name="ln1915"> </a>
<a name="ln1916">  return CMD_SUCCESS;</a>
<a name="ln1917">}</a>
<a name="ln1918"> </a>
<a name="ln1919">DEFUN (show_ip_pim_join,</a>
<a name="ln1920">       show_ip_pim_join_cmd,</a>
<a name="ln1921">       &quot;show ip pim join&quot;,</a>
<a name="ln1922">       SHOW_STR</a>
<a name="ln1923">       IP_STR</a>
<a name="ln1924">       PIM_STR</a>
<a name="ln1925">       &quot;PIM interface join information\n&quot;)</a>
<a name="ln1926">{</a>
<a name="ln1927">  pim_show_join(vty);</a>
<a name="ln1928"> </a>
<a name="ln1929">  return CMD_SUCCESS;</a>
<a name="ln1930">}</a>
<a name="ln1931"> </a>
<a name="ln1932">DEFUN (show_ip_pim_lan_prune_delay,</a>
<a name="ln1933">       show_ip_pim_lan_prune_delay_cmd,</a>
<a name="ln1934">       &quot;show ip pim lan-prune-delay&quot;,</a>
<a name="ln1935">       SHOW_STR</a>
<a name="ln1936">       IP_STR</a>
<a name="ln1937">       PIM_STR</a>
<a name="ln1938">       &quot;PIM neighbors LAN prune delay parameters\n&quot;)</a>
<a name="ln1939">{</a>
<a name="ln1940">  pim_show_lan_prune_delay(vty);</a>
<a name="ln1941"> </a>
<a name="ln1942">  return CMD_SUCCESS;</a>
<a name="ln1943">}</a>
<a name="ln1944"> </a>
<a name="ln1945">DEFUN (show_ip_pim_local_membership,</a>
<a name="ln1946">       show_ip_pim_local_membership_cmd,</a>
<a name="ln1947">       &quot;show ip pim local-membership&quot;,</a>
<a name="ln1948">       SHOW_STR</a>
<a name="ln1949">       IP_STR</a>
<a name="ln1950">       PIM_STR</a>
<a name="ln1951">       &quot;PIM interface local-membership\n&quot;)</a>
<a name="ln1952">{</a>
<a name="ln1953">  pim_show_membership(vty);</a>
<a name="ln1954"> </a>
<a name="ln1955">  return CMD_SUCCESS;</a>
<a name="ln1956">}</a>
<a name="ln1957"> </a>
<a name="ln1958">DEFUN (show_ip_pim_jp_override_interval,</a>
<a name="ln1959">       show_ip_pim_jp_override_interval_cmd,</a>
<a name="ln1960">       &quot;show ip pim jp-override-interval&quot;,</a>
<a name="ln1961">       SHOW_STR</a>
<a name="ln1962">       IP_STR</a>
<a name="ln1963">       PIM_STR</a>
<a name="ln1964">       &quot;PIM interface J/P override interval\n&quot;)</a>
<a name="ln1965">{</a>
<a name="ln1966">  pim_show_jp_override_interval(vty);</a>
<a name="ln1967"> </a>
<a name="ln1968">  return CMD_SUCCESS;</a>
<a name="ln1969">}</a>
<a name="ln1970"> </a>
<a name="ln1971">DEFUN (show_ip_pim_neighbor,</a>
<a name="ln1972">       show_ip_pim_neighbor_cmd,</a>
<a name="ln1973">       &quot;show ip pim neighbor&quot;,</a>
<a name="ln1974">       SHOW_STR</a>
<a name="ln1975">       IP_STR</a>
<a name="ln1976">       PIM_STR</a>
<a name="ln1977">       &quot;PIM neighbor information\n&quot;)</a>
<a name="ln1978">{</a>
<a name="ln1979">  pim_show_neighbors(vty);</a>
<a name="ln1980"> </a>
<a name="ln1981">  return CMD_SUCCESS;</a>
<a name="ln1982">}</a>
<a name="ln1983"> </a>
<a name="ln1984">DEFUN (show_ip_pim_secondary,</a>
<a name="ln1985">       show_ip_pim_secondary_cmd,</a>
<a name="ln1986">       &quot;show ip pim secondary&quot;,</a>
<a name="ln1987">       SHOW_STR</a>
<a name="ln1988">       IP_STR</a>
<a name="ln1989">       PIM_STR</a>
<a name="ln1990">       &quot;PIM neighbor addresses\n&quot;)</a>
<a name="ln1991">{</a>
<a name="ln1992">  pim_show_neighbors_secondary(vty);</a>
<a name="ln1993"> </a>
<a name="ln1994">  return CMD_SUCCESS;</a>
<a name="ln1995">}</a>
<a name="ln1996"> </a>
<a name="ln1997">DEFUN (show_ip_pim_upstream,</a>
<a name="ln1998">       show_ip_pim_upstream_cmd,</a>
<a name="ln1999">       &quot;show ip pim upstream&quot;,</a>
<a name="ln2000">       SHOW_STR</a>
<a name="ln2001">       IP_STR</a>
<a name="ln2002">       PIM_STR</a>
<a name="ln2003">       &quot;PIM upstream information\n&quot;)</a>
<a name="ln2004">{</a>
<a name="ln2005">  pim_show_upstream(vty);</a>
<a name="ln2006"> </a>
<a name="ln2007">  return CMD_SUCCESS;</a>
<a name="ln2008">}</a>
<a name="ln2009"> </a>
<a name="ln2010">DEFUN (show_ip_pim_upstream_join_desired,</a>
<a name="ln2011">       show_ip_pim_upstream_join_desired_cmd,</a>
<a name="ln2012">       &quot;show ip pim upstream-join-desired&quot;,</a>
<a name="ln2013">       SHOW_STR</a>
<a name="ln2014">       IP_STR</a>
<a name="ln2015">       PIM_STR</a>
<a name="ln2016">       &quot;PIM upstream join-desired\n&quot;)</a>
<a name="ln2017">{</a>
<a name="ln2018">  pim_show_join_desired(vty);</a>
<a name="ln2019"> </a>
<a name="ln2020">  return CMD_SUCCESS;</a>
<a name="ln2021">}</a>
<a name="ln2022"> </a>
<a name="ln2023">DEFUN (show_ip_pim_upstream_rpf,</a>
<a name="ln2024">       show_ip_pim_upstream_rpf_cmd,</a>
<a name="ln2025">       &quot;show ip pim upstream-rpf&quot;,</a>
<a name="ln2026">       SHOW_STR</a>
<a name="ln2027">       IP_STR</a>
<a name="ln2028">       PIM_STR</a>
<a name="ln2029">       &quot;PIM upstream source rpf\n&quot;)</a>
<a name="ln2030">{</a>
<a name="ln2031">  pim_show_upstream_rpf(vty);</a>
<a name="ln2032"> </a>
<a name="ln2033">  return CMD_SUCCESS;</a>
<a name="ln2034">}</a>
<a name="ln2035"> </a>
<a name="ln2036">DEFUN (show_ip_pim_rpf,</a>
<a name="ln2037">       show_ip_pim_rpf_cmd,</a>
<a name="ln2038">       &quot;show ip pim rpf&quot;,</a>
<a name="ln2039">       SHOW_STR</a>
<a name="ln2040">       IP_STR</a>
<a name="ln2041">       PIM_STR</a>
<a name="ln2042">       &quot;PIM cached source rpf information\n&quot;)</a>
<a name="ln2043">{</a>
<a name="ln2044">  pim_show_rpf(vty);</a>
<a name="ln2045"> </a>
<a name="ln2046">  return CMD_SUCCESS;</a>
<a name="ln2047">}</a>
<a name="ln2048"> </a>
<a name="ln2049">static void show_multicast_interfaces(struct vty *vty)</a>
<a name="ln2050">{</a>
<a name="ln2051">  struct listnode  *node;</a>
<a name="ln2052">  struct interface *ifp;</a>
<a name="ln2053"> </a>
<a name="ln2054">  vty_out(vty, &quot;%s&quot;, VTY_NEWLINE);</a>
<a name="ln2055">  </a>
<a name="ln2056">  vty_out(vty, &quot;Interface Address         ifi Vif  PktsIn PktsOut    BytesIn   BytesOut%s&quot;,</a>
<a name="ln2057">	  VTY_NEWLINE);</a>
<a name="ln2058"> </a>
<a name="ln2059">  for (ALL_LIST_ELEMENTS_RO(iflist, node, ifp)) {</a>
<a name="ln2060">    struct pim_interface *pim_ifp;</a>
<a name="ln2061">    struct in_addr ifaddr;</a>
<a name="ln2062">    struct sioc_vif_req vreq;</a>
<a name="ln2063"> </a>
<a name="ln2064">    pim_ifp = ifp-&gt;info;</a>
<a name="ln2065">    </a>
<a name="ln2066">    if (!pim_ifp)</a>
<a name="ln2067">      continue;</a>
<a name="ln2068"> </a>
<a name="ln2069">    memset(&amp;vreq, 0, sizeof(vreq));</a>
<a name="ln2070">    vreq.vifi = pim_ifp-&gt;mroute_vif_index;</a>
<a name="ln2071"> </a>
<a name="ln2072">    if (ioctl(qpim_mroute_socket_fd, SIOCGETVIFCNT, &amp;vreq)) {</a>
<a name="ln2073">      zlog_warn(&quot;ioctl(SIOCGETVIFCNT=%lu) failure for interface %s vif_index=%d: errno=%d: %s%s&quot;,</a>
<a name="ln2074">		(unsigned long)SIOCGETVIFCNT,</a>
<a name="ln2075">		ifp-&gt;name,</a>
<a name="ln2076">		pim_ifp-&gt;mroute_vif_index,</a>
<a name="ln2077">		errno,</a>
<a name="ln2078">		safe_strerror(errno),</a>
<a name="ln2079">		VTY_NEWLINE);</a>
<a name="ln2080">    }</a>
<a name="ln2081"> </a>
<a name="ln2082">    ifaddr = pim_ifp-&gt;primary_address;</a>
<a name="ln2083"> </a>
<a name="ln2084">    vty_out(vty, &quot;%-9s %-15s %3d %3d %7lu %7lu %10lu %10lu%s&quot;,</a>
<a name="ln2085">	    ifp-&gt;name,</a>
<a name="ln2086">	    inet_ntoa(ifaddr),</a>
<a name="ln2087">	    ifp-&gt;ifindex,</a>
<a name="ln2088">	    pim_ifp-&gt;mroute_vif_index,</a>
<a name="ln2089">	    vreq.icount,</a>
<a name="ln2090">	    vreq.ocount,</a>
<a name="ln2091">	    vreq.ibytes,</a>
<a name="ln2092">	    vreq.obytes,</a>
<a name="ln2093">	    VTY_NEWLINE);</a>
<a name="ln2094">  }</a>
<a name="ln2095">}</a>
<a name="ln2096"> </a>
<a name="ln2097">DEFUN (show_ip_multicast,</a>
<a name="ln2098">       show_ip_multicast_cmd,</a>
<a name="ln2099">       &quot;show ip multicast&quot;,</a>
<a name="ln2100">       SHOW_STR</a>
<a name="ln2101">       IP_STR</a>
<a name="ln2102">       &quot;Multicast global information\n&quot;)</a>
<a name="ln2103">{</a>
<a name="ln2104">  time_t now = pim_time_monotonic_sec();</a>
<a name="ln2105"> </a>
<a name="ln2106">  if (PIM_MROUTE_IS_ENABLED) {</a>
<a name="ln2107">    char uptime[10];</a>
<a name="ln2108"> </a>
<a name="ln2109">    vty_out(vty, &quot;Mroute socket descriptor: %d%s&quot;,</a>
<a name="ln2110">	    qpim_mroute_socket_fd,</a>
<a name="ln2111">	    VTY_NEWLINE);</a>
<a name="ln2112"> </a>
<a name="ln2113">    pim_time_uptime(uptime, sizeof(uptime), now - qpim_mroute_socket_creation);</a>
<a name="ln2114">    vty_out(vty, &quot;Mroute socket uptime: %s%s&quot;,</a>
<a name="ln2115">	    uptime,</a>
<a name="ln2116">	    VTY_NEWLINE);</a>
<a name="ln2117">  }</a>
<a name="ln2118">  else {</a>
<a name="ln2119">    vty_out(vty, &quot;Multicast disabled%s&quot;,</a>
<a name="ln2120">	    VTY_NEWLINE);</a>
<a name="ln2121">  }</a>
<a name="ln2122"> </a>
<a name="ln2123">  vty_out(vty, &quot;%s&quot;, VTY_NEWLINE);</a>
<a name="ln2124">  vty_out(vty, &quot;Zclient update socket: &quot;);</a>
<a name="ln2125">  if (qpim_zclient_update) {</a>
<a name="ln2126">    vty_out(vty, &quot;%d failures=%d%s&quot;, qpim_zclient_update-&gt;sock,</a>
<a name="ln2127">	    qpim_zclient_update-&gt;fail, VTY_NEWLINE);</a>
<a name="ln2128">  }</a>
<a name="ln2129">  else {</a>
<a name="ln2130">    vty_out(vty, &quot;&lt;null zclient&gt;%s&quot;, VTY_NEWLINE);</a>
<a name="ln2131">  }</a>
<a name="ln2132">  vty_out(vty, &quot;Zclient lookup socket: &quot;);</a>
<a name="ln2133">  if (qpim_zclient_lookup) {</a>
<a name="ln2134">    vty_out(vty, &quot;%d failures=%d%s&quot;, qpim_zclient_lookup-&gt;sock,</a>
<a name="ln2135">	    qpim_zclient_lookup-&gt;fail, VTY_NEWLINE);</a>
<a name="ln2136">  }</a>
<a name="ln2137">  else {</a>
<a name="ln2138">    vty_out(vty, &quot;&lt;null zclient&gt;%s&quot;, VTY_NEWLINE);</a>
<a name="ln2139">  }</a>
<a name="ln2140"> </a>
<a name="ln2141">  vty_out(vty, &quot;%s&quot;, VTY_NEWLINE);</a>
<a name="ln2142">  vty_out(vty, &quot;Current highest VifIndex: %d%s&quot;,</a>
<a name="ln2143">	  qpim_mroute_oif_highest_vif_index,</a>
<a name="ln2144">	  VTY_NEWLINE);</a>
<a name="ln2145">  vty_out(vty, &quot;Maximum highest VifIndex: %d%s&quot;,</a>
<a name="ln2146">	  MAXVIFS - 1,</a>
<a name="ln2147">	  VTY_NEWLINE);</a>
<a name="ln2148"> </a>
<a name="ln2149">  vty_out(vty, &quot;%s&quot;, VTY_NEWLINE);</a>
<a name="ln2150">  vty_out(vty, &quot;Upstream Join Timer: %d secs%s&quot;,</a>
<a name="ln2151">	  qpim_t_periodic,</a>
<a name="ln2152">	  VTY_NEWLINE);</a>
<a name="ln2153">  vty_out(vty, &quot;Join/Prune Holdtime: %d secs%s&quot;,</a>
<a name="ln2154">	  PIM_JP_HOLDTIME,</a>
<a name="ln2155">	  VTY_NEWLINE);</a>
<a name="ln2156"> </a>
<a name="ln2157">  vty_out(vty, &quot;%s&quot;, VTY_NEWLINE);</a>
<a name="ln2158"> </a>
<a name="ln2159">  show_rpf_refresh_stats(vty, now);</a>
<a name="ln2160"> </a>
<a name="ln2161">  vty_out(vty, &quot;%s&quot;, VTY_NEWLINE);</a>
<a name="ln2162"> </a>
<a name="ln2163">  show_scan_oil_stats(vty, now);</a>
<a name="ln2164"> </a>
<a name="ln2165">  show_multicast_interfaces(vty);</a>
<a name="ln2166">  </a>
<a name="ln2167">  return CMD_SUCCESS;</a>
<a name="ln2168">}</a>
<a name="ln2169"> </a>
<a name="ln2170">static void show_mroute(struct vty *vty)</a>
<a name="ln2171">{</a>
<a name="ln2172">  struct listnode    *node;</a>
<a name="ln2173">  struct channel_oil *c_oil;</a>
<a name="ln2174">  struct static_route *s_route;</a>
<a name="ln2175">  time_t              now;</a>
<a name="ln2176"> </a>
<a name="ln2177">  vty_out(vty, &quot;Proto: I=IGMP P=PIM S=STATIC%s%s&quot;, VTY_NEWLINE, VTY_NEWLINE);</a>
<a name="ln2178">  </a>
<a name="ln2179">  vty_out(vty, &quot;Source          Group           Proto Input iVifI Output oVifI TTL Uptime  %s&quot;,</a>
<a name="ln2180">	  VTY_NEWLINE);</a>
<a name="ln2181"> </a>
<a name="ln2182">  now = pim_time_monotonic_sec();</a>
<a name="ln2183"> </a>
<a name="ln2184">  /* print list of PIM and IGMP routes */</a>
<a name="ln2185">  for (ALL_LIST_ELEMENTS_RO(qpim_channel_oil_list, node, c_oil)) {</a>
<a name="ln2186">    char group_str[100]; </a>
<a name="ln2187">    char source_str[100];</a>
<a name="ln2188">    int oif_vif_index;</a>
<a name="ln2189"> </a>
<a name="ln2190">    pim_inet4_dump(&quot;&lt;group?&gt;&quot;, c_oil-&gt;oil.mfcc_mcastgrp, group_str, sizeof(group_str));</a>
<a name="ln2191">    pim_inet4_dump(&quot;&lt;source?&gt;&quot;, c_oil-&gt;oil.mfcc_origin, source_str, sizeof(source_str));</a>
<a name="ln2192">    </a>
<a name="ln2193">    for (oif_vif_index = 0; oif_vif_index &lt; MAXVIFS; ++oif_vif_index) {</a>
<a name="ln2194">      struct interface *ifp_in;</a>
<a name="ln2195">      struct interface *ifp_out;</a>
<a name="ln2196">      char oif_uptime[10];</a>
<a name="ln2197">      int ttl;</a>
<a name="ln2198">      char proto[5];</a>
<a name="ln2199"> </a>
<a name="ln2200">      ttl = c_oil-&gt;oil.mfcc_ttls[oif_vif_index];</a>
<a name="ln2201">      if (ttl &lt; 1)</a>
<a name="ln2202">	continue;</a>
<a name="ln2203"> </a>
<a name="ln2204">      ifp_in  = pim_if_find_by_vif_index(c_oil-&gt;oil.mfcc_parent);</a>
<a name="ln2205">      ifp_out = pim_if_find_by_vif_index(oif_vif_index);</a>
<a name="ln2206"> </a>
<a name="ln2207">      pim_time_uptime(oif_uptime, sizeof(oif_uptime), now - c_oil-&gt;oif_creation[oif_vif_index]);</a>
<a name="ln2208"> </a>
<a name="ln2209">      proto[0] = '\0';</a>
<a name="ln2210">      if (c_oil-&gt;oif_flags[oif_vif_index] &amp; PIM_OIF_FLAG_PROTO_PIM) {</a>
<a name="ln2211">	strcat(proto, &quot;P&quot;);</a>
<a name="ln2212">      }</a>
<a name="ln2213">      if (c_oil-&gt;oif_flags[oif_vif_index] &amp; PIM_OIF_FLAG_PROTO_IGMP) {</a>
<a name="ln2214">	strcat(proto, &quot;I&quot;);</a>
<a name="ln2215">      }</a>
<a name="ln2216"> </a>
<a name="ln2217">      vty_out(vty, &quot;%-15s %-15s %-5s %-5s %5d %-6s %5d %3d %8s %s&quot;,</a>
<a name="ln2218">	      source_str,</a>
<a name="ln2219">	      group_str,</a>
<a name="ln2220">	      proto,</a>
<a name="ln2221">	      ifp_in ? ifp_in-&gt;name : &quot;&lt;iif?&gt;&quot;,</a>
<a name="ln2222">	      c_oil-&gt;oil.mfcc_parent,</a>
<a name="ln2223">	      ifp_out ? ifp_out-&gt;name : &quot;&lt;oif?&gt;&quot;,</a>
<a name="ln2224">	      oif_vif_index,</a>
<a name="ln2225">	      ttl,</a>
<a name="ln2226">	      oif_uptime,</a>
<a name="ln2227">	      VTY_NEWLINE);</a>
<a name="ln2228">    }</a>
<a name="ln2229">  }</a>
<a name="ln2230"> </a>
<a name="ln2231">  /* Print list of static routes */</a>
<a name="ln2232">  for (ALL_LIST_ELEMENTS_RO(qpim_static_route_list, node, s_route)) {</a>
<a name="ln2233">    char group_str[100];</a>
<a name="ln2234">    char source_str[100];</a>
<a name="ln2235">    int oif_vif_index;</a>
<a name="ln2236"> </a>
<a name="ln2237">    pim_inet4_dump(&quot;&lt;group?&gt;&quot;, s_route-&gt;group, group_str, sizeof(group_str));</a>
<a name="ln2238">    pim_inet4_dump(&quot;&lt;source?&gt;&quot;, s_route-&gt;source, source_str, sizeof(source_str));</a>
<a name="ln2239"> </a>
<a name="ln2240">    for (oif_vif_index = 0; oif_vif_index &lt; MAXVIFS; ++oif_vif_index) {</a>
<a name="ln2241">      struct interface *ifp_in;</a>
<a name="ln2242">      struct interface *ifp_out;</a>
<a name="ln2243">      char oif_uptime[10];</a>
<a name="ln2244">      int ttl;</a>
<a name="ln2245">      char proto[5];</a>
<a name="ln2246"> </a>
<a name="ln2247">      ttl = s_route-&gt;oif_ttls[oif_vif_index];</a>
<a name="ln2248">      if (ttl &lt; 1)</a>
<a name="ln2249">         continue;</a>
<a name="ln2250"> </a>
<a name="ln2251">      ifp_in  = pim_if_find_by_vif_index(s_route-&gt;iif);</a>
<a name="ln2252">      ifp_out = pim_if_find_by_vif_index(oif_vif_index);</a>
<a name="ln2253"> </a>
<a name="ln2254">      pim_time_uptime(oif_uptime, sizeof(oif_uptime), now - s_route-&gt;creation[oif_vif_index]);</a>
<a name="ln2255"> </a>
<a name="ln2256">      proto[0] = '\0';</a>
<a name="ln2257">      strcat(proto, &quot;S&quot;);</a>
<a name="ln2258"> </a>
<a name="ln2259">      vty_out(vty, &quot;%-15s %-15s %-5s %-5s %5d %-6s %5d %3d %8s %s&quot;,</a>
<a name="ln2260">         source_str,</a>
<a name="ln2261">         group_str,</a>
<a name="ln2262">         proto,</a>
<a name="ln2263">         ifp_in ? ifp_in-&gt;name : &quot;&lt;iif?&gt;&quot;,</a>
<a name="ln2264">         s_route-&gt;iif,</a>
<a name="ln2265">         ifp_out ? ifp_out-&gt;name : &quot;&lt;oif?&gt;&quot;,</a>
<a name="ln2266">         oif_vif_index,</a>
<a name="ln2267">         ttl,</a>
<a name="ln2268">         oif_uptime,</a>
<a name="ln2269">         VTY_NEWLINE);</a>
<a name="ln2270">    }</a>
<a name="ln2271">  }</a>
<a name="ln2272">}</a>
<a name="ln2273"> </a>
<a name="ln2274">DEFUN (show_ip_mroute,</a>
<a name="ln2275">       show_ip_mroute_cmd,</a>
<a name="ln2276">       &quot;show ip mroute&quot;,</a>
<a name="ln2277">       SHOW_STR</a>
<a name="ln2278">       IP_STR</a>
<a name="ln2279">       MROUTE_STR)</a>
<a name="ln2280">{</a>
<a name="ln2281">  show_mroute(vty);</a>
<a name="ln2282">  return CMD_SUCCESS;</a>
<a name="ln2283">}</a>
<a name="ln2284"> </a>
<a name="ln2285">static void show_mroute_count(struct vty *vty)</a>
<a name="ln2286">{</a>
<a name="ln2287">  struct listnode    *node;</a>
<a name="ln2288">  struct channel_oil *c_oil;</a>
<a name="ln2289">  struct static_route *s_route;</a>
<a name="ln2290"> </a>
<a name="ln2291">  vty_out(vty, &quot;%s&quot;, VTY_NEWLINE);</a>
<a name="ln2292">  </a>
<a name="ln2293">  vty_out(vty, &quot;Source          Group           Packets      Bytes WrongIf  %s&quot;,</a>
<a name="ln2294">	  VTY_NEWLINE);</a>
<a name="ln2295"> </a>
<a name="ln2296">  /* Print PIM and IGMP route counts */</a>
<a name="ln2297">  for (ALL_LIST_ELEMENTS_RO(qpim_channel_oil_list, node, c_oil)) {</a>
<a name="ln2298">    char group_str[100]; </a>
<a name="ln2299">    char source_str[100];</a>
<a name="ln2300">    struct sioc_sg_req sgreq;</a>
<a name="ln2301"> </a>
<a name="ln2302">    memset(&amp;sgreq, 0, sizeof(sgreq));</a>
<a name="ln2303">    sgreq.src = c_oil-&gt;oil.mfcc_origin;</a>
<a name="ln2304">    sgreq.grp = c_oil-&gt;oil.mfcc_mcastgrp;</a>
<a name="ln2305"> </a>
<a name="ln2306">    pim_inet4_dump(&quot;&lt;group?&gt;&quot;, c_oil-&gt;oil.mfcc_mcastgrp, group_str, sizeof(group_str));</a>
<a name="ln2307">    pim_inet4_dump(&quot;&lt;source?&gt;&quot;, c_oil-&gt;oil.mfcc_origin, source_str, sizeof(source_str));</a>
<a name="ln2308"> </a>
<a name="ln2309">    if (ioctl(qpim_mroute_socket_fd, SIOCGETSGCNT, &amp;sgreq)) {</a>
<a name="ln2310">      int e = errno;</a>
<a name="ln2311">      vty_out(vty,</a>
<a name="ln2312">	      &quot;ioctl(SIOCGETSGCNT=%lu) failure for (S,G)=(%s,%s): errno=%d: %s%s&quot;,</a>
<a name="ln2313">	      (unsigned long)SIOCGETSGCNT,</a>
<a name="ln2314">	      source_str,</a>
<a name="ln2315">	      group_str,</a>
<a name="ln2316">	      e,</a>
<a name="ln2317">	      safe_strerror(e),</a>
<a name="ln2318">	      VTY_NEWLINE);	      </a>
<a name="ln2319">      continue;</a>
<a name="ln2320">    }</a>
<a name="ln2321">    </a>
<a name="ln2322">    vty_out(vty, &quot;%-15s %-15s %7ld %10ld %7ld %s&quot;,</a>
<a name="ln2323">	    source_str,</a>
<a name="ln2324">	    group_str,</a>
<a name="ln2325">	    sgreq.pktcnt,</a>
<a name="ln2326">	    sgreq.bytecnt,</a>
<a name="ln2327">	    sgreq.wrong_if,</a>
<a name="ln2328">	    VTY_NEWLINE);</a>
<a name="ln2329">  }</a>
<a name="ln2330"> </a>
<a name="ln2331">   /* Print static route counts */</a>
<a name="ln2332">  for (ALL_LIST_ELEMENTS_RO(qpim_static_route_list, node, s_route)) {</a>
<a name="ln2333">    char group_str[100];</a>
<a name="ln2334">    char source_str[100];</a>
<a name="ln2335">    struct sioc_sg_req sgreq;</a>
<a name="ln2336"> </a>
<a name="ln2337">    memset(&amp;sgreq, 0, sizeof(sgreq));</a>
<a name="ln2338">    sgreq.src = s_route-&gt;mc.mfcc_origin;</a>
<a name="ln2339">    sgreq.grp = s_route-&gt;mc.mfcc_mcastgrp;</a>
<a name="ln2340"> </a>
<a name="ln2341">    pim_inet4_dump(&quot;&lt;group?&gt;&quot;, s_route-&gt;mc.mfcc_mcastgrp, group_str, sizeof(group_str));</a>
<a name="ln2342">    pim_inet4_dump(&quot;&lt;source?&gt;&quot;, s_route-&gt;mc.mfcc_origin, source_str, sizeof(source_str));</a>
<a name="ln2343"> </a>
<a name="ln2344">    if (ioctl(qpim_mroute_socket_fd, SIOCGETSGCNT, &amp;sgreq)) {</a>
<a name="ln2345">      int e = errno;</a>
<a name="ln2346">      vty_out(vty,</a>
<a name="ln2347">         &quot;ioctl(SIOCGETSGCNT=%lu) failure for (S,G)=(%s,%s): errno=%d: %s%s&quot;,</a>
<a name="ln2348">         /* note that typeof ioctl defs can vary across platforms, from</a>
<a name="ln2349">          * int, to unsigned int, to long unsigned int</a>
<a name="ln2350">          */</a>
<a name="ln2351">         (unsigned long)SIOCGETSGCNT,</a>
<a name="ln2352">         source_str,</a>
<a name="ln2353">         group_str,</a>
<a name="ln2354">         e,</a>
<a name="ln2355">         safe_strerror(e),</a>
<a name="ln2356">         VTY_NEWLINE);</a>
<a name="ln2357">      continue;</a>
<a name="ln2358">    }</a>
<a name="ln2359"> </a>
<a name="ln2360">    vty_out(vty, &quot;%-15s %-15s %7ld %10ld %7ld %s&quot;,</a>
<a name="ln2361">       source_str,</a>
<a name="ln2362">       group_str,</a>
<a name="ln2363">       sgreq.pktcnt,</a>
<a name="ln2364">       sgreq.bytecnt,</a>
<a name="ln2365">       sgreq.wrong_if,</a>
<a name="ln2366">       VTY_NEWLINE);</a>
<a name="ln2367">  }</a>
<a name="ln2368">}</a>
<a name="ln2369"> </a>
<a name="ln2370">DEFUN (show_ip_mroute_count,</a>
<a name="ln2371">       show_ip_mroute_count_cmd,</a>
<a name="ln2372">       &quot;show ip mroute count&quot;,</a>
<a name="ln2373">       SHOW_STR</a>
<a name="ln2374">       IP_STR</a>
<a name="ln2375">       MROUTE_STR</a>
<a name="ln2376">       &quot;Route and packet count data\n&quot;)</a>
<a name="ln2377">{</a>
<a name="ln2378">  show_mroute_count(vty);</a>
<a name="ln2379">  return CMD_SUCCESS;</a>
<a name="ln2380">}</a>
<a name="ln2381"> </a>
<a name="ln2382">DEFUN (show_ip_rib,</a>
<a name="ln2383">       show_ip_rib_cmd,</a>
<a name="ln2384">       &quot;show ip rib A.B.C.D&quot;,</a>
<a name="ln2385">       SHOW_STR</a>
<a name="ln2386">       IP_STR</a>
<a name="ln2387">       RIB_STR</a>
<a name="ln2388">       &quot;Unicast address\n&quot;)</a>
<a name="ln2389">{</a>
<a name="ln2390">  struct in_addr addr;</a>
<a name="ln2391">  const char *addr_str;</a>
<a name="ln2392">  struct pim_nexthop nexthop;</a>
<a name="ln2393">  char nexthop_addr_str[100];</a>
<a name="ln2394">  int result;</a>
<a name="ln2395"> </a>
<a name="ln2396">  addr_str = argv[0];</a>
<a name="ln2397">  result = inet_pton(AF_INET, addr_str, &amp;addr);</a>
<a name="ln2398">  if (result &lt;= 0) {</a>
<a name="ln2399">    vty_out(vty, &quot;Bad unicast address %s: errno=%d: %s%s&quot;,</a>
<a name="ln2400">	    addr_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln2401">    return CMD_WARNING;</a>
<a name="ln2402">  }</a>
<a name="ln2403"> </a>
<a name="ln2404">  if (pim_nexthop_lookup(&amp;nexthop, addr)) {</a>
<a name="ln2405">    vty_out(vty, &quot;Failure querying RIB nexthop for unicast address %s%s&quot;,</a>
<a name="ln2406">	    addr_str, VTY_NEWLINE);</a>
<a name="ln2407">    return CMD_WARNING;</a>
<a name="ln2408">  }</a>
<a name="ln2409"> </a>
<a name="ln2410">  vty_out(vty, &quot;Address         NextHop         Interface Metric Preference%s&quot;,</a>
<a name="ln2411">	  VTY_NEWLINE);</a>
<a name="ln2412"> </a>
<a name="ln2413">  pim_inet4_dump(&quot;&lt;nexthop?&gt;&quot;, nexthop.mrib_nexthop_addr,</a>
<a name="ln2414">		 nexthop_addr_str, sizeof(nexthop_addr_str));</a>
<a name="ln2415"> </a>
<a name="ln2416">  vty_out(vty, &quot;%-15s %-15s %-9s %6d %10d%s&quot;,</a>
<a name="ln2417">	  addr_str,</a>
<a name="ln2418">	  nexthop_addr_str,</a>
<a name="ln2419">	  nexthop.interface ? nexthop.interface-&gt;name : &quot;&lt;ifname?&gt;&quot;,</a>
<a name="ln2420">	  nexthop.mrib_route_metric,</a>
<a name="ln2421">	  nexthop.mrib_metric_preference,</a>
<a name="ln2422">	  VTY_NEWLINE);</a>
<a name="ln2423"> </a>
<a name="ln2424">  return CMD_SUCCESS;</a>
<a name="ln2425">}</a>
<a name="ln2426"> </a>
<a name="ln2427">static void show_ssmpingd(struct vty *vty)</a>
<a name="ln2428">{</a>
<a name="ln2429">  struct listnode      *node;</a>
<a name="ln2430">  struct ssmpingd_sock *ss;</a>
<a name="ln2431">  time_t                now;</a>
<a name="ln2432"> </a>
<a name="ln2433">  vty_out(vty, &quot;Source          Socket Address          Port Uptime   Requests%s&quot;,</a>
<a name="ln2434">	  VTY_NEWLINE);</a>
<a name="ln2435"> </a>
<a name="ln2436">  if (!qpim_ssmpingd_list)</a>
<a name="ln2437">    return;</a>
<a name="ln2438"> </a>
<a name="ln2439">  now = pim_time_monotonic_sec();</a>
<a name="ln2440"> </a>
<a name="ln2441">  for (ALL_LIST_ELEMENTS_RO(qpim_ssmpingd_list, node, ss)) {</a>
<a name="ln2442">    char source_str[100];</a>
<a name="ln2443">    char ss_uptime[10];</a>
<a name="ln2444">    struct sockaddr_in bind_addr;</a>
<a name="ln2445">    socklen_t len = sizeof(bind_addr);</a>
<a name="ln2446">    char bind_addr_str[100];</a>
<a name="ln2447"> </a>
<a name="ln2448">    pim_inet4_dump(&quot;&lt;src?&gt;&quot;, ss-&gt;source_addr, source_str, sizeof(source_str));</a>
<a name="ln2449"> </a>
<a name="ln2450">    if (pim_socket_getsockname(ss-&gt;sock_fd, (struct sockaddr *) &amp;bind_addr, &amp;len)) {</a>
<a name="ln2451">      vty_out(vty, &quot;%% Failure reading socket name for ssmpingd source %s on fd=%d%s&quot;,</a>
<a name="ln2452">	      source_str, ss-&gt;sock_fd, VTY_NEWLINE);</a>
<a name="ln2453">    }</a>
<a name="ln2454"> </a>
<a name="ln2455">    pim_inet4_dump(&quot;&lt;addr?&gt;&quot;, bind_addr.sin_addr, bind_addr_str, sizeof(bind_addr_str));</a>
<a name="ln2456">    pim_time_uptime(ss_uptime, sizeof(ss_uptime), now - ss-&gt;creation);</a>
<a name="ln2457"> </a>
<a name="ln2458">    vty_out(vty, &quot;%-15s %6d %-15s %5d %8s %8lld%s&quot;,</a>
<a name="ln2459">	    source_str,</a>
<a name="ln2460">	    ss-&gt;sock_fd,</a>
<a name="ln2461">	    bind_addr_str,</a>
<a name="ln2462">	    ntohs(bind_addr.sin_port),</a>
<a name="ln2463">	    ss_uptime,</a>
<a name="ln2464">	    (long long)ss-&gt;requests,</a>
<a name="ln2465">	    VTY_NEWLINE);</a>
<a name="ln2466">  }</a>
<a name="ln2467">}</a>
<a name="ln2468"> </a>
<a name="ln2469">DEFUN (show_ip_ssmpingd,</a>
<a name="ln2470">       show_ip_ssmpingd_cmd,</a>
<a name="ln2471">       &quot;show ip ssmpingd&quot;,</a>
<a name="ln2472">       SHOW_STR</a>
<a name="ln2473">       IP_STR</a>
<a name="ln2474">       SHOW_SSMPINGD_STR)</a>
<a name="ln2475">{</a>
<a name="ln2476">  show_ssmpingd(vty);</a>
<a name="ln2477">  return CMD_SUCCESS;</a>
<a name="ln2478">}</a>
<a name="ln2479"> </a>
<a name="ln2480">DEFUN (ip_multicast_routing,</a>
<a name="ln2481">       ip_multicast_routing_cmd,</a>
<a name="ln2482">       PIM_CMD_IP_MULTICAST_ROUTING,</a>
<a name="ln2483">       IP_STR</a>
<a name="ln2484">       &quot;Enable IP multicast forwarding\n&quot;)</a>
<a name="ln2485">{</a>
<a name="ln2486">  pim_mroute_socket_enable();</a>
<a name="ln2487">  pim_if_add_vif_all();</a>
<a name="ln2488">  mroute_add_all();</a>
<a name="ln2489">  static_mroute_add_all();</a>
<a name="ln2490">  return CMD_SUCCESS;</a>
<a name="ln2491">}</a>
<a name="ln2492"> </a>
<a name="ln2493">DEFUN (no_ip_multicast_routing,</a>
<a name="ln2494">       no_ip_multicast_routing_cmd,</a>
<a name="ln2495">       PIM_CMD_NO &quot; &quot; PIM_CMD_IP_MULTICAST_ROUTING,</a>
<a name="ln2496">       NO_STR</a>
<a name="ln2497">       IP_STR</a>
<a name="ln2498">       &quot;Global IP configuration subcommands\n&quot;</a>
<a name="ln2499">       &quot;Enable IP multicast forwarding\n&quot;)</a>
<a name="ln2500">{</a>
<a name="ln2501">  mroute_del_all();</a>
<a name="ln2502">  static_mroute_del_all();</a>
<a name="ln2503">  pim_if_del_vif_all();</a>
<a name="ln2504">  pim_mroute_socket_disable();</a>
<a name="ln2505">  return CMD_SUCCESS;</a>
<a name="ln2506">}</a>
<a name="ln2507"> </a>
<a name="ln2508">DEFUN (ip_ssmpingd,</a>
<a name="ln2509">       ip_ssmpingd_cmd,</a>
<a name="ln2510">       &quot;ip ssmpingd [A.B.C.D]&quot;,</a>
<a name="ln2511">       IP_STR</a>
<a name="ln2512">       CONF_SSMPINGD_STR</a>
<a name="ln2513">       &quot;Source address\n&quot;)</a>
<a name="ln2514">{</a>
<a name="ln2515">  int result;</a>
<a name="ln2516">  struct in_addr source_addr;</a>
<a name="ln2517">  const char *source_str = (argc &gt; 0) ? argv[0] : &quot;0.0.0.0&quot;;</a>
<a name="ln2518"> </a>
<a name="ln2519">  result = inet_pton(AF_INET, source_str, &amp;source_addr);</a>
<a name="ln2520">  if (result &lt;= 0) {</a>
<a name="ln2521">    vty_out(vty, &quot;%% Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln2522">	    source_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln2523">    return CMD_WARNING;</a>
<a name="ln2524">  }</a>
<a name="ln2525"> </a>
<a name="ln2526">  result = pim_ssmpingd_start(source_addr);</a>
<a name="ln2527">  if (result) {</a>
<a name="ln2528">    vty_out(vty, &quot;%% Failure starting ssmpingd for source %s: %d%s&quot;,</a>
<a name="ln2529">	    source_str, result, VTY_NEWLINE);</a>
<a name="ln2530">    return CMD_WARNING;</a>
<a name="ln2531">  }</a>
<a name="ln2532"> </a>
<a name="ln2533">  return CMD_SUCCESS;</a>
<a name="ln2534">}</a>
<a name="ln2535"> </a>
<a name="ln2536">DEFUN (no_ip_ssmpingd,</a>
<a name="ln2537">       no_ip_ssmpingd_cmd,</a>
<a name="ln2538">       &quot;no ip ssmpingd [A.B.C.D]&quot;,</a>
<a name="ln2539">       NO_STR</a>
<a name="ln2540">       IP_STR</a>
<a name="ln2541">       CONF_SSMPINGD_STR</a>
<a name="ln2542">       &quot;Source address\n&quot;)</a>
<a name="ln2543">{</a>
<a name="ln2544">  int result;</a>
<a name="ln2545">  struct in_addr source_addr;</a>
<a name="ln2546">  const char *source_str = (argc &gt; 0) ? argv[0] : &quot;0.0.0.0&quot;;</a>
<a name="ln2547"> </a>
<a name="ln2548">  result = inet_pton(AF_INET, source_str, &amp;source_addr);</a>
<a name="ln2549">  if (result &lt;= 0) {</a>
<a name="ln2550">    vty_out(vty, &quot;%% Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln2551">	    source_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln2552">    return CMD_WARNING;</a>
<a name="ln2553">  }</a>
<a name="ln2554"> </a>
<a name="ln2555">  result = pim_ssmpingd_stop(source_addr);</a>
<a name="ln2556">  if (result) {</a>
<a name="ln2557">    vty_out(vty, &quot;%% Failure stopping ssmpingd for source %s: %d%s&quot;,</a>
<a name="ln2558">	    source_str, result, VTY_NEWLINE);</a>
<a name="ln2559">    return CMD_WARNING;</a>
<a name="ln2560">  }</a>
<a name="ln2561"> </a>
<a name="ln2562">  return CMD_SUCCESS;</a>
<a name="ln2563">}</a>
<a name="ln2564"> </a>
<a name="ln2565">DEFUN (interface_ip_igmp,</a>
<a name="ln2566">       interface_ip_igmp_cmd,</a>
<a name="ln2567">       &quot;ip igmp&quot;,</a>
<a name="ln2568">       IP_STR</a>
<a name="ln2569">       IFACE_IGMP_STR)</a>
<a name="ln2570">{</a>
<a name="ln2571">  struct interface *ifp;</a>
<a name="ln2572">  struct pim_interface *pim_ifp;</a>
<a name="ln2573"> </a>
<a name="ln2574">  ifp = vty-&gt;index;</a>
<a name="ln2575">  pim_ifp = ifp-&gt;info;</a>
<a name="ln2576"> </a>
<a name="ln2577">  if (!pim_ifp) {</a>
<a name="ln2578">    pim_ifp = pim_if_new(ifp, 1 /* igmp=true */, 0 /* pim=false */);</a>
<a name="ln2579">    if (!pim_ifp) {</a>
<a name="ln2580">      vty_out(vty, &quot;Could not enable IGMP on interface %s%s&quot;,</a>
<a name="ln2581">	      ifp-&gt;name, VTY_NEWLINE);</a>
<a name="ln2582">      return CMD_WARNING;</a>
<a name="ln2583">    }</a>
<a name="ln2584">  }</a>
<a name="ln2585">  else {</a>
<a name="ln2586">    PIM_IF_DO_IGMP(pim_ifp-&gt;options);</a>
<a name="ln2587">  }</a>
<a name="ln2588"> </a>
<a name="ln2589">  pim_if_addr_add_all(ifp);</a>
<a name="ln2590">  pim_if_membership_refresh(ifp);</a>
<a name="ln2591"> </a>
<a name="ln2592">  return CMD_SUCCESS;</a>
<a name="ln2593">}</a>
<a name="ln2594"> </a>
<a name="ln2595">DEFUN (interface_no_ip_igmp,</a>
<a name="ln2596">       interface_no_ip_igmp_cmd,</a>
<a name="ln2597">       &quot;no ip igmp&quot;,</a>
<a name="ln2598">       NO_STR</a>
<a name="ln2599">       IP_STR</a>
<a name="ln2600">       IFACE_IGMP_STR)</a>
<a name="ln2601">{</a>
<a name="ln2602">  struct interface *ifp;</a>
<a name="ln2603">  struct pim_interface *pim_ifp;</a>
<a name="ln2604"> </a>
<a name="ln2605">  ifp = vty-&gt;index;</a>
<a name="ln2606">  pim_ifp = ifp-&gt;info;</a>
<a name="ln2607">  if (!pim_ifp)</a>
<a name="ln2608">    return CMD_SUCCESS;</a>
<a name="ln2609"> </a>
<a name="ln2610">  PIM_IF_DONT_IGMP(pim_ifp-&gt;options);</a>
<a name="ln2611"> </a>
<a name="ln2612">  pim_if_membership_clear(ifp);</a>
<a name="ln2613"> </a>
<a name="ln2614">  pim_if_addr_del_all_igmp(ifp);</a>
<a name="ln2615"> </a>
<a name="ln2616">  if (!PIM_IF_TEST_PIM(pim_ifp-&gt;options)) {</a>
<a name="ln2617">    pim_if_delete(ifp);</a>
<a name="ln2618">  }</a>
<a name="ln2619"> </a>
<a name="ln2620">  return CMD_SUCCESS;</a>
<a name="ln2621">}</a>
<a name="ln2622"> </a>
<a name="ln2623">DEFUN (interface_ip_igmp_join,</a>
<a name="ln2624">       interface_ip_igmp_join_cmd,</a>
<a name="ln2625">       &quot;ip igmp join A.B.C.D A.B.C.D&quot;,</a>
<a name="ln2626">       IP_STR</a>
<a name="ln2627">       IFACE_IGMP_STR</a>
<a name="ln2628">       &quot;IGMP join multicast group\n&quot;</a>
<a name="ln2629">       &quot;Multicast group address\n&quot;</a>
<a name="ln2630">       &quot;Source address\n&quot;)</a>
<a name="ln2631">{</a>
<a name="ln2632">  struct interface *ifp;</a>
<a name="ln2633">  const char *group_str;</a>
<a name="ln2634">  const char *source_str;</a>
<a name="ln2635">  struct in_addr group_addr;</a>
<a name="ln2636">  struct in_addr source_addr;</a>
<a name="ln2637">  int result;</a>
<a name="ln2638"> </a>
<a name="ln2639">  ifp = vty-&gt;index;</a>
<a name="ln2640"> </a>
<a name="ln2641">  /* Group address */</a>
<a name="ln2642">  group_str = argv[0];</a>
<a name="ln2643">  result = inet_pton(AF_INET, group_str, &amp;group_addr);</a>
<a name="ln2644">  if (result &lt;= 0) {</a>
<a name="ln2645">    vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln2646">	    group_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln2647">    return CMD_WARNING;</a>
<a name="ln2648">  }</a>
<a name="ln2649"> </a>
<a name="ln2650">  /* Source address */</a>
<a name="ln2651">  source_str = argv[1];</a>
<a name="ln2652">  result = inet_pton(AF_INET, source_str, &amp;source_addr);</a>
<a name="ln2653">  if (result &lt;= 0) {</a>
<a name="ln2654">    vty_out(vty, &quot;Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln2655">	    source_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln2656">    return CMD_WARNING;</a>
<a name="ln2657">  }</a>
<a name="ln2658"> </a>
<a name="ln2659">  result = pim_if_igmp_join_add(ifp, group_addr, source_addr);</a>
<a name="ln2660">  if (result) {</a>
<a name="ln2661">    vty_out(vty, &quot;%% Failure joining IGMP group %s source %s on interface %s: %d%s&quot;,</a>
<a name="ln2662">	    group_str, source_str, ifp-&gt;name, result, VTY_NEWLINE);</a>
<a name="ln2663">    return CMD_WARNING;</a>
<a name="ln2664">  }</a>
<a name="ln2665"> </a>
<a name="ln2666">  return CMD_SUCCESS;</a>
<a name="ln2667">}</a>
<a name="ln2668"> </a>
<a name="ln2669">DEFUN (interface_no_ip_igmp_join,</a>
<a name="ln2670">       interface_no_ip_igmp_join_cmd,</a>
<a name="ln2671">       &quot;no ip igmp join A.B.C.D A.B.C.D&quot;,</a>
<a name="ln2672">       NO_STR</a>
<a name="ln2673">       IP_STR</a>
<a name="ln2674">       IFACE_IGMP_STR</a>
<a name="ln2675">       &quot;IGMP join multicast group\n&quot;</a>
<a name="ln2676">       &quot;Multicast group address\n&quot;</a>
<a name="ln2677">       &quot;Source address\n&quot;)</a>
<a name="ln2678">{</a>
<a name="ln2679">  struct interface *ifp;</a>
<a name="ln2680">  const char *group_str;</a>
<a name="ln2681">  const char *source_str;</a>
<a name="ln2682">  struct in_addr group_addr;</a>
<a name="ln2683">  struct in_addr source_addr;</a>
<a name="ln2684">  int result;</a>
<a name="ln2685"> </a>
<a name="ln2686">  ifp = vty-&gt;index;</a>
<a name="ln2687"> </a>
<a name="ln2688">  /* Group address */</a>
<a name="ln2689">  group_str = argv[0];</a>
<a name="ln2690">  result = inet_pton(AF_INET, group_str, &amp;group_addr);</a>
<a name="ln2691">  if (result &lt;= 0) {</a>
<a name="ln2692">    vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln2693">	    group_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln2694">    return CMD_WARNING;</a>
<a name="ln2695">  }</a>
<a name="ln2696"> </a>
<a name="ln2697">  /* Source address */</a>
<a name="ln2698">  source_str = argv[1];</a>
<a name="ln2699">  result = inet_pton(AF_INET, source_str, &amp;source_addr);</a>
<a name="ln2700">  if (result &lt;= 0) {</a>
<a name="ln2701">    vty_out(vty, &quot;Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln2702">	    source_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln2703">    return CMD_WARNING;</a>
<a name="ln2704">  }</a>
<a name="ln2705"> </a>
<a name="ln2706">  result = pim_if_igmp_join_del(ifp, group_addr, source_addr);</a>
<a name="ln2707">  if (result) {</a>
<a name="ln2708">    vty_out(vty, &quot;%% Failure leaving IGMP group %s source %s on interface %s: %d%s&quot;,</a>
<a name="ln2709">	    group_str, source_str, ifp-&gt;name, result, VTY_NEWLINE);</a>
<a name="ln2710">    return CMD_WARNING;</a>
<a name="ln2711">  }</a>
<a name="ln2712"> </a>
<a name="ln2713">  return CMD_SUCCESS;</a>
<a name="ln2714">}</a>
<a name="ln2715"> </a>
<a name="ln2716">/*</a>
<a name="ln2717">  CLI reconfiguration affects the interface level (struct pim_interface).</a>
<a name="ln2718">  This function propagates the reconfiguration to every active socket</a>
<a name="ln2719">  for that interface.</a>
<a name="ln2720"> */</a>
<a name="ln2721">static void igmp_sock_query_interval_reconfig(struct igmp_sock *igmp)</a>
<a name="ln2722">{</a>
<a name="ln2723">  struct interface *ifp;</a>
<a name="ln2724">  struct pim_interface *pim_ifp;</a>
<a name="ln2725"> </a>
<a name="ln2726">  zassert(igmp);</a>
<a name="ln2727"> </a>
<a name="ln2728">  /* other querier present? */</a>
<a name="ln2729"> </a>
<a name="ln2730">  if (igmp-&gt;t_other_querier_timer)</a>
<a name="ln2731">    return;</a>
<a name="ln2732"> </a>
<a name="ln2733">  /* this is the querier */</a>
<a name="ln2734"> </a>
<a name="ln2735">  zassert(igmp-&gt;interface);</a>
<a name="ln2736">  zassert(igmp-&gt;interface-&gt;info);</a>
<a name="ln2737"> </a>
<a name="ln2738">  ifp = igmp-&gt;interface;</a>
<a name="ln2739">  pim_ifp = ifp-&gt;info;</a>
<a name="ln2740"> </a>
<a name="ln2741">  if (PIM_DEBUG_IGMP_TRACE) {</a>
<a name="ln2742">    char ifaddr_str[100];</a>
<a name="ln2743">    pim_inet4_dump(&quot;&lt;ifaddr?&gt;&quot;, igmp-&gt;ifaddr, ifaddr_str, sizeof(ifaddr_str));</a>
<a name="ln2744">    zlog_debug(&quot;%s: Querier %s on %s reconfig query_interval=%d&quot;,</a>
<a name="ln2745">	       __PRETTY_FUNCTION__,</a>
<a name="ln2746">	       ifaddr_str,</a>
<a name="ln2747">	       ifp-&gt;name,</a>
<a name="ln2748">	       pim_ifp-&gt;igmp_default_query_interval);</a>
<a name="ln2749">  }</a>
<a name="ln2750"> </a>
<a name="ln2751">  /*</a>
<a name="ln2752">    igmp_startup_mode_on() will reset QQI:</a>
<a name="ln2753"> </a>
<a name="ln2754">    igmp-&gt;querier_query_interval = pim_ifp-&gt;igmp_default_query_interval;</a>
<a name="ln2755">  */</a>
<a name="ln2756">  igmp_startup_mode_on(igmp);</a>
<a name="ln2757">}</a>
<a name="ln2758"> </a>
<a name="ln2759">static void igmp_sock_query_reschedule(struct igmp_sock *igmp)</a>
<a name="ln2760">{</a>
<a name="ln2761">  if (igmp-&gt;t_igmp_query_timer) {</a>
<a name="ln2762">    /* other querier present */</a>
<a name="ln2763">    zassert(igmp-&gt;t_igmp_query_timer);</a>
<a name="ln2764">    zassert(!igmp-&gt;t_other_querier_timer);</a>
<a name="ln2765"> </a>
<a name="ln2766">    pim_igmp_general_query_off(igmp);</a>
<a name="ln2767">    pim_igmp_general_query_on(igmp);</a>
<a name="ln2768"> </a>
<a name="ln2769">    zassert(igmp-&gt;t_igmp_query_timer);</a>
<a name="ln2770">    zassert(!igmp-&gt;t_other_querier_timer);</a>
<a name="ln2771">  }</a>
<a name="ln2772">  else {</a>
<a name="ln2773">    /* this is the querier */</a>
<a name="ln2774"> </a>
<a name="ln2775">    zassert(!igmp-&gt;t_igmp_query_timer);</a>
<a name="ln2776">    zassert(igmp-&gt;t_other_querier_timer);</a>
<a name="ln2777"> </a>
<a name="ln2778">    pim_igmp_other_querier_timer_off(igmp);</a>
<a name="ln2779">    pim_igmp_other_querier_timer_on(igmp);</a>
<a name="ln2780"> </a>
<a name="ln2781">    zassert(!igmp-&gt;t_igmp_query_timer);</a>
<a name="ln2782">    zassert(igmp-&gt;t_other_querier_timer);</a>
<a name="ln2783">  }</a>
<a name="ln2784">}</a>
<a name="ln2785"> </a>
<a name="ln2786">static void change_query_interval(struct pim_interface *pim_ifp,</a>
<a name="ln2787">				  int query_interval)</a>
<a name="ln2788">{</a>
<a name="ln2789">  struct listnode  *sock_node;</a>
<a name="ln2790">  struct igmp_sock *igmp;</a>
<a name="ln2791"> </a>
<a name="ln2792">  pim_ifp-&gt;igmp_default_query_interval = query_interval;</a>
<a name="ln2793"> </a>
<a name="ln2794">  for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln2795">    igmp_sock_query_interval_reconfig(igmp);</a>
<a name="ln2796">    igmp_sock_query_reschedule(igmp);</a>
<a name="ln2797">  }</a>
<a name="ln2798">}</a>
<a name="ln2799"> </a>
<a name="ln2800">static void change_query_max_response_time(struct pim_interface *pim_ifp,</a>
<a name="ln2801">					   int query_max_response_time_dsec)</a>
<a name="ln2802">{</a>
<a name="ln2803">  struct listnode  *sock_node;</a>
<a name="ln2804">  struct igmp_sock *igmp;</a>
<a name="ln2805"> </a>
<a name="ln2806">  pim_ifp-&gt;igmp_query_max_response_time_dsec = query_max_response_time_dsec;</a>
<a name="ln2807"> </a>
<a name="ln2808">  /*</a>
<a name="ln2809">    Below we modify socket/group/source timers in order to quickly</a>
<a name="ln2810">    reflect the change. Otherwise, those timers would eventually catch</a>
<a name="ln2811">    up.</a>
<a name="ln2812">   */</a>
<a name="ln2813"> </a>
<a name="ln2814">  /* scan all sockets */</a>
<a name="ln2815">  for (ALL_LIST_ELEMENTS_RO(pim_ifp-&gt;igmp_socket_list, sock_node, igmp)) {</a>
<a name="ln2816">    struct listnode   *grp_node;</a>
<a name="ln2817">    struct igmp_group *grp;</a>
<a name="ln2818"> </a>
<a name="ln2819">    /* reschedule socket general query */</a>
<a name="ln2820">    igmp_sock_query_reschedule(igmp);</a>
<a name="ln2821"> </a>
<a name="ln2822">    /* scan socket groups */</a>
<a name="ln2823">    for (ALL_LIST_ELEMENTS_RO(igmp-&gt;igmp_group_list, grp_node, grp)) {</a>
<a name="ln2824">      struct listnode    *src_node;</a>
<a name="ln2825">      struct igmp_source *src;</a>
<a name="ln2826"> </a>
<a name="ln2827">      /* reset group timers for groups in EXCLUDE mode */</a>
<a name="ln2828">      if (grp-&gt;group_filtermode_isexcl) {</a>
<a name="ln2829">	igmp_group_reset_gmi(grp);</a>
<a name="ln2830">      }</a>
<a name="ln2831"> </a>
<a name="ln2832">      /* scan group sources */</a>
<a name="ln2833">      for (ALL_LIST_ELEMENTS_RO(grp-&gt;group_source_list, src_node, src)) {</a>
<a name="ln2834"> </a>
<a name="ln2835">	/* reset source timers for sources with running timers */</a>
<a name="ln2836">	if (src-&gt;t_source_timer) {</a>
<a name="ln2837">	  igmp_source_reset_gmi(igmp, grp, src);</a>
<a name="ln2838">	}</a>
<a name="ln2839">      }</a>
<a name="ln2840">    }</a>
<a name="ln2841">  }</a>
<a name="ln2842">}</a>
<a name="ln2843"> </a>
<a name="ln2844">#define IGMP_QUERY_INTERVAL_MIN (1)</a>
<a name="ln2845">#define IGMP_QUERY_INTERVAL_MAX (1800)</a>
<a name="ln2846"> </a>
<a name="ln2847">DEFUN (interface_ip_igmp_query_interval,</a>
<a name="ln2848">       interface_ip_igmp_query_interval_cmd,</a>
<a name="ln2849">       PIM_CMD_IP_IGMP_QUERY_INTERVAL &quot; &lt;1-1800&gt;&quot;,</a>
<a name="ln2850">       IP_STR</a>
<a name="ln2851">       IFACE_IGMP_STR</a>
<a name="ln2852">       IFACE_IGMP_QUERY_INTERVAL_STR</a>
<a name="ln2853">       &quot;Query interval in seconds\n&quot;)</a>
<a name="ln2854">{</a>
<a name="ln2855">  struct interface *ifp;</a>
<a name="ln2856">  struct pim_interface *pim_ifp;</a>
<a name="ln2857">  int query_interval;</a>
<a name="ln2858">  int query_interval_dsec;</a>
<a name="ln2859"> </a>
<a name="ln2860">  ifp = vty-&gt;index;</a>
<a name="ln2861">  pim_ifp = ifp-&gt;info;</a>
<a name="ln2862"> </a>
<a name="ln2863">  if (!pim_ifp) {</a>
<a name="ln2864">    vty_out(vty,</a>
<a name="ln2865">	    &quot;IGMP not enabled on interface %s. Please enable IGMP first.%s&quot;,</a>
<a name="ln2866">	    ifp-&gt;name,</a>
<a name="ln2867">	    VTY_NEWLINE);</a>
<a name="ln2868">    return CMD_WARNING;</a>
<a name="ln2869">  }</a>
<a name="ln2870"> </a>
<a name="ln2871">  query_interval = atoi(argv[0]);</a>
<a name="ln2872">  query_interval_dsec = 10 * query_interval;</a>
<a name="ln2873"> </a>
<a name="ln2874">  /*</a>
<a name="ln2875">    It seems we don't need to check bounds since command.c does it</a>
<a name="ln2876">    already, but we verify them anyway for extra safety.</a>
<a name="ln2877">  */</a>
<a name="ln2878">  if (query_interval &lt; IGMP_QUERY_INTERVAL_MIN) {</a>
<a name="ln2879">    vty_out(vty, &quot;General query interval %d lower than minimum %d%s&quot;,</a>
<a name="ln2880">	    query_interval,</a>
<a name="ln2881">	    IGMP_QUERY_INTERVAL_MIN,</a>
<a name="ln2882">	    VTY_NEWLINE);</a>
<a name="ln2883">    return CMD_WARNING;</a>
<a name="ln2884">  }</a>
<a name="ln2885">  if (query_interval &gt; IGMP_QUERY_INTERVAL_MAX) {</a>
<a name="ln2886">    vty_out(vty, &quot;General query interval %d higher than maximum %d%s&quot;,</a>
<a name="ln2887">	    query_interval,</a>
<a name="ln2888">	    IGMP_QUERY_INTERVAL_MAX,</a>
<a name="ln2889">	    VTY_NEWLINE);</a>
<a name="ln2890">    return CMD_WARNING;</a>
<a name="ln2891">  }</a>
<a name="ln2892"> </a>
<a name="ln2893">  if (query_interval_dsec &lt;= pim_ifp-&gt;igmp_query_max_response_time_dsec) {</a>
<a name="ln2894">    vty_out(vty,</a>
<a name="ln2895">	    &quot;Can't set general query interval %d dsec &lt;= query max response time %d dsec.%s&quot;,</a>
<a name="ln2896">	    query_interval_dsec, pim_ifp-&gt;igmp_query_max_response_time_dsec,</a>
<a name="ln2897">	    VTY_NEWLINE);</a>
<a name="ln2898">    return CMD_WARNING;</a>
<a name="ln2899">  }</a>
<a name="ln2900"> </a>
<a name="ln2901">  change_query_interval(pim_ifp, query_interval);</a>
<a name="ln2902"> </a>
<a name="ln2903">  return CMD_SUCCESS;</a>
<a name="ln2904">}</a>
<a name="ln2905"> </a>
<a name="ln2906">DEFUN (interface_no_ip_igmp_query_interval,</a>
<a name="ln2907">       interface_no_ip_igmp_query_interval_cmd,</a>
<a name="ln2908">       PIM_CMD_NO &quot; &quot; PIM_CMD_IP_IGMP_QUERY_INTERVAL,</a>
<a name="ln2909">       NO_STR</a>
<a name="ln2910">       IP_STR</a>
<a name="ln2911">       IFACE_IGMP_STR</a>
<a name="ln2912">       IFACE_IGMP_QUERY_INTERVAL_STR)</a>
<a name="ln2913">{</a>
<a name="ln2914">  struct interface *ifp;</a>
<a name="ln2915">  struct pim_interface *pim_ifp;</a>
<a name="ln2916">  int default_query_interval_dsec;</a>
<a name="ln2917"> </a>
<a name="ln2918">  ifp = vty-&gt;index;</a>
<a name="ln2919">  pim_ifp = ifp-&gt;info;</a>
<a name="ln2920"> </a>
<a name="ln2921">  if (!pim_ifp)</a>
<a name="ln2922">    return CMD_SUCCESS;</a>
<a name="ln2923"> </a>
<a name="ln2924">  default_query_interval_dsec = IGMP_GENERAL_QUERY_INTERVAL * 10;</a>
<a name="ln2925"> </a>
<a name="ln2926">  if (default_query_interval_dsec &lt;= pim_ifp-&gt;igmp_query_max_response_time_dsec) {</a>
<a name="ln2927">    vty_out(vty,</a>
<a name="ln2928">	    &quot;Can't set default general query interval %d dsec &lt;= query max response time %d dsec.%s&quot;,</a>
<a name="ln2929">	    default_query_interval_dsec, pim_ifp-&gt;igmp_query_max_response_time_dsec,</a>
<a name="ln2930">	    VTY_NEWLINE);</a>
<a name="ln2931">    return CMD_WARNING;</a>
<a name="ln2932">  }</a>
<a name="ln2933"> </a>
<a name="ln2934">  change_query_interval(pim_ifp, IGMP_GENERAL_QUERY_INTERVAL);</a>
<a name="ln2935"> </a>
<a name="ln2936">  return CMD_SUCCESS;</a>
<a name="ln2937">}</a>
<a name="ln2938"> </a>
<a name="ln2939">#define IGMP_QUERY_MAX_RESPONSE_TIME_MIN (1)</a>
<a name="ln2940">#define IGMP_QUERY_MAX_RESPONSE_TIME_MAX (25)</a>
<a name="ln2941"> </a>
<a name="ln2942">DEFUN (interface_ip_igmp_query_max_response_time,</a>
<a name="ln2943">       interface_ip_igmp_query_max_response_time_cmd,</a>
<a name="ln2944">       PIM_CMD_IP_IGMP_QUERY_MAX_RESPONSE_TIME &quot; &lt;1-25&gt;&quot;,</a>
<a name="ln2945">       IP_STR</a>
<a name="ln2946">       IFACE_IGMP_STR</a>
<a name="ln2947">       IFACE_IGMP_QUERY_MAX_RESPONSE_TIME_STR</a>
<a name="ln2948">       &quot;Query response value in seconds\n&quot;)</a>
<a name="ln2949">{</a>
<a name="ln2950">  struct interface *ifp;</a>
<a name="ln2951">  struct pim_interface *pim_ifp;</a>
<a name="ln2952">  int query_max_response_time;</a>
<a name="ln2953"> </a>
<a name="ln2954">  ifp = vty-&gt;index;</a>
<a name="ln2955">  pim_ifp = ifp-&gt;info;</a>
<a name="ln2956"> </a>
<a name="ln2957">  if (!pim_ifp) {</a>
<a name="ln2958">    vty_out(vty,</a>
<a name="ln2959">	    &quot;IGMP not enabled on interface %s. Please enable IGMP first.%s&quot;,</a>
<a name="ln2960">	    ifp-&gt;name,</a>
<a name="ln2961">	    VTY_NEWLINE);</a>
<a name="ln2962">    return CMD_WARNING;</a>
<a name="ln2963">  }</a>
<a name="ln2964"> </a>
<a name="ln2965">  query_max_response_time = atoi(argv[0]);</a>
<a name="ln2966"> </a>
<a name="ln2967">  /*</a>
<a name="ln2968">    It seems we don't need to check bounds since command.c does it</a>
<a name="ln2969">    already, but we verify them anyway for extra safety.</a>
<a name="ln2970">  */</a>
<a name="ln2971">  if (query_max_response_time &lt; IGMP_QUERY_MAX_RESPONSE_TIME_MIN) {</a>
<a name="ln2972">    vty_out(vty, &quot;Query max response time %d sec lower than minimum %d sec%s&quot;,</a>
<a name="ln2973">	    query_max_response_time,</a>
<a name="ln2974">	    IGMP_QUERY_MAX_RESPONSE_TIME_MIN,</a>
<a name="ln2975">	    VTY_NEWLINE);</a>
<a name="ln2976">    return CMD_WARNING;</a>
<a name="ln2977">  }</a>
<a name="ln2978">  if (query_max_response_time &gt; IGMP_QUERY_MAX_RESPONSE_TIME_MAX) {</a>
<a name="ln2979">    vty_out(vty, &quot;Query max response time %d sec higher than maximum %d sec%s&quot;,</a>
<a name="ln2980">	    query_max_response_time,</a>
<a name="ln2981">	    IGMP_QUERY_MAX_RESPONSE_TIME_MAX,</a>
<a name="ln2982">	    VTY_NEWLINE);</a>
<a name="ln2983">    return CMD_WARNING;</a>
<a name="ln2984">  }</a>
<a name="ln2985"> </a>
<a name="ln2986">  if (query_max_response_time &gt;= pim_ifp-&gt;igmp_default_query_interval) {</a>
<a name="ln2987">    vty_out(vty,</a>
<a name="ln2988">	    &quot;Can't set query max response time %d sec &gt;= general query interval %d sec%s&quot;,</a>
<a name="ln2989">	    query_max_response_time, pim_ifp-&gt;igmp_default_query_interval,</a>
<a name="ln2990">	    VTY_NEWLINE);</a>
<a name="ln2991">    return CMD_WARNING;</a>
<a name="ln2992">  }</a>
<a name="ln2993"> </a>
<a name="ln2994">  change_query_max_response_time(pim_ifp, 10 * query_max_response_time);</a>
<a name="ln2995"> </a>
<a name="ln2996">  return CMD_SUCCESS;</a>
<a name="ln2997">}</a>
<a name="ln2998"> </a>
<a name="ln2999">DEFUN (interface_no_ip_igmp_query_max_response_time,</a>
<a name="ln3000">       interface_no_ip_igmp_query_max_response_time_cmd,</a>
<a name="ln3001">       PIM_CMD_NO &quot; &quot; PIM_CMD_IP_IGMP_QUERY_MAX_RESPONSE_TIME,</a>
<a name="ln3002">       NO_STR</a>
<a name="ln3003">       IP_STR</a>
<a name="ln3004">       IFACE_IGMP_STR</a>
<a name="ln3005">       IFACE_IGMP_QUERY_MAX_RESPONSE_TIME_STR)</a>
<a name="ln3006">{</a>
<a name="ln3007">  struct interface *ifp;</a>
<a name="ln3008">  struct pim_interface *pim_ifp;</a>
<a name="ln3009">  int default_query_interval_dsec;</a>
<a name="ln3010"> </a>
<a name="ln3011">  ifp = vty-&gt;index;</a>
<a name="ln3012">  pim_ifp = ifp-&gt;info;</a>
<a name="ln3013"> </a>
<a name="ln3014">  if (!pim_ifp)</a>
<a name="ln3015">    return CMD_SUCCESS;</a>
<a name="ln3016"> </a>
<a name="ln3017">  default_query_interval_dsec = 10 * pim_ifp-&gt;igmp_default_query_interval;</a>
<a name="ln3018"> </a>
<a name="ln3019">  if (IGMP_QUERY_MAX_RESPONSE_TIME_DSEC &gt;= default_query_interval_dsec) {</a>
<a name="ln3020">    vty_out(vty,</a>
<a name="ln3021">	    &quot;Can't set default query max response time %d dsec &gt;= general query interval %d dsec.%s&quot;,</a>
<a name="ln3022">	    IGMP_QUERY_MAX_RESPONSE_TIME_DSEC, default_query_interval_dsec,</a>
<a name="ln3023">	    VTY_NEWLINE);</a>
<a name="ln3024">    return CMD_WARNING;</a>
<a name="ln3025">  }</a>
<a name="ln3026"> </a>
<a name="ln3027">  change_query_max_response_time(pim_ifp, IGMP_QUERY_MAX_RESPONSE_TIME_DSEC);</a>
<a name="ln3028"> </a>
<a name="ln3029">  return CMD_SUCCESS;</a>
<a name="ln3030">}</a>
<a name="ln3031"> </a>
<a name="ln3032">#define IGMP_QUERY_MAX_RESPONSE_TIME_MIN_DSEC (10)</a>
<a name="ln3033">#define IGMP_QUERY_MAX_RESPONSE_TIME_MAX_DSEC (250)</a>
<a name="ln3034"> </a>
<a name="ln3035">DEFUN (interface_ip_igmp_query_max_response_time_dsec,</a>
<a name="ln3036">       interface_ip_igmp_query_max_response_time_dsec_cmd,</a>
<a name="ln3037">       PIM_CMD_IP_IGMP_QUERY_MAX_RESPONSE_TIME_DSEC &quot; &lt;10-250&gt;&quot;,</a>
<a name="ln3038">       IP_STR</a>
<a name="ln3039">       IFACE_IGMP_STR</a>
<a name="ln3040">       IFACE_IGMP_QUERY_MAX_RESPONSE_TIME_DSEC_STR</a>
<a name="ln3041">       &quot;Query response value in deciseconds\n&quot;)</a>
<a name="ln3042">{</a>
<a name="ln3043">  struct interface *ifp;</a>
<a name="ln3044">  struct pim_interface *pim_ifp;</a>
<a name="ln3045">  int query_max_response_time_dsec;</a>
<a name="ln3046">  int default_query_interval_dsec;</a>
<a name="ln3047"> </a>
<a name="ln3048">  ifp = vty-&gt;index;</a>
<a name="ln3049">  pim_ifp = ifp-&gt;info;</a>
<a name="ln3050"> </a>
<a name="ln3051">  if (!pim_ifp) {</a>
<a name="ln3052">    vty_out(vty,</a>
<a name="ln3053">	    &quot;IGMP not enabled on interface %s. Please enable IGMP first.%s&quot;,</a>
<a name="ln3054">	    ifp-&gt;name,</a>
<a name="ln3055">	    VTY_NEWLINE);</a>
<a name="ln3056">    return CMD_WARNING;</a>
<a name="ln3057">  }</a>
<a name="ln3058"> </a>
<a name="ln3059">  query_max_response_time_dsec = atoi(argv[0]);</a>
<a name="ln3060"> </a>
<a name="ln3061">  /*</a>
<a name="ln3062">    It seems we don't need to check bounds since command.c does it</a>
<a name="ln3063">    already, but we verify them anyway for extra safety.</a>
<a name="ln3064">  */</a>
<a name="ln3065">  if (query_max_response_time_dsec &lt; IGMP_QUERY_MAX_RESPONSE_TIME_MIN_DSEC) {</a>
<a name="ln3066">    vty_out(vty, &quot;Query max response time %d dsec lower than minimum %d dsec%s&quot;,</a>
<a name="ln3067">	    query_max_response_time_dsec,</a>
<a name="ln3068">	    IGMP_QUERY_MAX_RESPONSE_TIME_MIN_DSEC,</a>
<a name="ln3069">	    VTY_NEWLINE);</a>
<a name="ln3070">    return CMD_WARNING;</a>
<a name="ln3071">  }</a>
<a name="ln3072">  if (query_max_response_time_dsec &gt; IGMP_QUERY_MAX_RESPONSE_TIME_MAX_DSEC) {</a>
<a name="ln3073">    vty_out(vty, &quot;Query max response time %d dsec higher than maximum %d dsec%s&quot;,</a>
<a name="ln3074">	    query_max_response_time_dsec,</a>
<a name="ln3075">	    IGMP_QUERY_MAX_RESPONSE_TIME_MAX_DSEC,</a>
<a name="ln3076">	    VTY_NEWLINE);</a>
<a name="ln3077">    return CMD_WARNING;</a>
<a name="ln3078">  }</a>
<a name="ln3079"> </a>
<a name="ln3080">  default_query_interval_dsec = 10 * pim_ifp-&gt;igmp_default_query_interval;</a>
<a name="ln3081"> </a>
<a name="ln3082">  if (query_max_response_time_dsec &gt;= default_query_interval_dsec) {</a>
<a name="ln3083">    vty_out(vty,</a>
<a name="ln3084">	    &quot;Can't set query max response time %d dsec &gt;= general query interval %d dsec%s&quot;,</a>
<a name="ln3085">	    query_max_response_time_dsec, default_query_interval_dsec,</a>
<a name="ln3086">	    VTY_NEWLINE);</a>
<a name="ln3087">    return CMD_WARNING;</a>
<a name="ln3088">  }</a>
<a name="ln3089"> </a>
<a name="ln3090">  change_query_max_response_time(pim_ifp, query_max_response_time_dsec);</a>
<a name="ln3091"> </a>
<a name="ln3092">  return CMD_SUCCESS;</a>
<a name="ln3093">}</a>
<a name="ln3094"> </a>
<a name="ln3095">DEFUN (interface_no_ip_igmp_query_max_response_time_dsec,</a>
<a name="ln3096">       interface_no_ip_igmp_query_max_response_time_dsec_cmd,</a>
<a name="ln3097">       PIM_CMD_NO &quot; &quot; PIM_CMD_IP_IGMP_QUERY_MAX_RESPONSE_TIME_DSEC,</a>
<a name="ln3098">       NO_STR</a>
<a name="ln3099">       IP_STR</a>
<a name="ln3100">       IFACE_IGMP_STR</a>
<a name="ln3101">       IFACE_IGMP_QUERY_MAX_RESPONSE_TIME_DSEC_STR)</a>
<a name="ln3102">{</a>
<a name="ln3103">  struct interface *ifp;</a>
<a name="ln3104">  struct pim_interface *pim_ifp;</a>
<a name="ln3105">  int default_query_interval_dsec;</a>
<a name="ln3106"> </a>
<a name="ln3107">  ifp = vty-&gt;index;</a>
<a name="ln3108">  pim_ifp = ifp-&gt;info;</a>
<a name="ln3109"> </a>
<a name="ln3110">  if (!pim_ifp)</a>
<a name="ln3111">    return CMD_SUCCESS;</a>
<a name="ln3112"> </a>
<a name="ln3113">  default_query_interval_dsec = 10 * pim_ifp-&gt;igmp_default_query_interval;</a>
<a name="ln3114"> </a>
<a name="ln3115">  if (IGMP_QUERY_MAX_RESPONSE_TIME_DSEC &gt;= default_query_interval_dsec) {</a>
<a name="ln3116">    vty_out(vty,</a>
<a name="ln3117">	    &quot;Can't set default query max response time %d dsec &gt;= general query interval %d dsec.%s&quot;,</a>
<a name="ln3118">	    IGMP_QUERY_MAX_RESPONSE_TIME_DSEC, default_query_interval_dsec,</a>
<a name="ln3119">	    VTY_NEWLINE);</a>
<a name="ln3120">    return CMD_WARNING;</a>
<a name="ln3121">  }</a>
<a name="ln3122"> </a>
<a name="ln3123">  change_query_max_response_time(pim_ifp, IGMP_QUERY_MAX_RESPONSE_TIME_DSEC);</a>
<a name="ln3124"> </a>
<a name="ln3125">  return CMD_SUCCESS;</a>
<a name="ln3126">}</a>
<a name="ln3127"> </a>
<a name="ln3128">DEFUN (interface_ip_pim_drprio,</a>
<a name="ln3129">       interface_ip_pim_drprio_cmd,</a>
<a name="ln3130">       &quot;ip pim drpriority &lt;1-4294967295&gt;&quot;,</a>
<a name="ln3131">       IP_STR</a>
<a name="ln3132">       PIM_STR</a>
<a name="ln3133">       &quot;Set the Designated Router Election Priority\n&quot;</a>
<a name="ln3134">       &quot;Value of the new DR Priority\n&quot;)</a>
<a name="ln3135">{</a>
<a name="ln3136">  struct interface *ifp;</a>
<a name="ln3137">  struct pim_interface *pim_ifp;</a>
<a name="ln3138">  uint32_t old_dr_prio;</a>
<a name="ln3139"> </a>
<a name="ln3140">  ifp = vty-&gt;index;</a>
<a name="ln3141">  pim_ifp = ifp-&gt;info;</a>
<a name="ln3142"> </a>
<a name="ln3143">  if (!pim_ifp) {</a>
<a name="ln3144">    vty_out(vty, &quot;Please enable PIM on interface, first%s&quot;, VTY_NEWLINE);</a>
<a name="ln3145">    return CMD_WARNING;</a>
<a name="ln3146">  }</a>
<a name="ln3147"> </a>
<a name="ln3148">  old_dr_prio = pim_ifp-&gt;pim_dr_priority;</a>
<a name="ln3149"> </a>
<a name="ln3150">  pim_ifp-&gt;pim_dr_priority = strtol(argv[0], NULL, 10);</a>
<a name="ln3151"> </a>
<a name="ln3152">  if (old_dr_prio != pim_ifp-&gt;pim_dr_priority) {</a>
<a name="ln3153">    if (pim_if_dr_election(ifp))</a>
<a name="ln3154">      pim_hello_restart_now(ifp);</a>
<a name="ln3155">  }</a>
<a name="ln3156"> </a>
<a name="ln3157">  return CMD_SUCCESS;</a>
<a name="ln3158">}</a>
<a name="ln3159"> </a>
<a name="ln3160">DEFUN (interface_no_ip_pim_drprio,</a>
<a name="ln3161">       interface_no_ip_pim_drprio_cmd,</a>
<a name="ln3162">       &quot;no ip pim drpriority {&lt;1-4294967295&gt;}&quot;,</a>
<a name="ln3163">       IP_STR</a>
<a name="ln3164">       PIM_STR</a>
<a name="ln3165">       &quot;Revert the Designated Router Priority to default\n&quot;</a>
<a name="ln3166">       &quot;Old Value of the Priority\n&quot;)</a>
<a name="ln3167">{</a>
<a name="ln3168">  struct interface *ifp;</a>
<a name="ln3169">  struct pim_interface *pim_ifp;</a>
<a name="ln3170"> </a>
<a name="ln3171">  ifp = vty-&gt;index;</a>
<a name="ln3172">  pim_ifp = ifp-&gt;info;</a>
<a name="ln3173"> </a>
<a name="ln3174">  if (!pim_ifp) {</a>
<a name="ln3175">    vty_out(vty, &quot;Pim not enabled on this interface%s&quot;, VTY_NEWLINE);</a>
<a name="ln3176">    return CMD_WARNING;</a>
<a name="ln3177">  }</a>
<a name="ln3178"> </a>
<a name="ln3179">  if (pim_ifp-&gt;pim_dr_priority != PIM_DEFAULT_DR_PRIORITY) {</a>
<a name="ln3180">    pim_ifp-&gt;pim_dr_priority = PIM_DEFAULT_DR_PRIORITY;</a>
<a name="ln3181">    if (pim_if_dr_election(ifp))</a>
<a name="ln3182">      pim_hello_restart_now(ifp);</a>
<a name="ln3183">  }</a>
<a name="ln3184"> </a>
<a name="ln3185">  return CMD_SUCCESS;</a>
<a name="ln3186">}</a>
<a name="ln3187"> </a>
<a name="ln3188">DEFUN (interface_ip_pim_ssm,</a>
<a name="ln3189">       interface_ip_pim_ssm_cmd,</a>
<a name="ln3190">       &quot;ip pim ssm&quot;,</a>
<a name="ln3191">       IP_STR</a>
<a name="ln3192">       PIM_STR</a>
<a name="ln3193">       IFACE_PIM_STR)</a>
<a name="ln3194">{</a>
<a name="ln3195">  struct interface *ifp;</a>
<a name="ln3196">  struct pim_interface *pim_ifp;</a>
<a name="ln3197"> </a>
<a name="ln3198">  ifp = vty-&gt;index;</a>
<a name="ln3199">  pim_ifp = ifp-&gt;info;</a>
<a name="ln3200"> </a>
<a name="ln3201">  if (!pim_ifp) {</a>
<a name="ln3202">    pim_ifp = pim_if_new(ifp, 0 /* igmp=false */, 1 /* pim=true */);</a>
<a name="ln3203">    if (!pim_ifp) {</a>
<a name="ln3204">      vty_out(vty, &quot;Could not enable PIM on interface%s&quot;, VTY_NEWLINE);</a>
<a name="ln3205">      return CMD_WARNING;</a>
<a name="ln3206">    }</a>
<a name="ln3207">  }</a>
<a name="ln3208">  else {</a>
<a name="ln3209">    PIM_IF_DO_PIM(pim_ifp-&gt;options);</a>
<a name="ln3210">  }</a>
<a name="ln3211"> </a>
<a name="ln3212">  pim_if_addr_add_all(ifp);</a>
<a name="ln3213">  pim_if_membership_refresh(ifp);</a>
<a name="ln3214"> </a>
<a name="ln3215">  return CMD_SUCCESS;</a>
<a name="ln3216">}</a>
<a name="ln3217"> </a>
<a name="ln3218">DEFUN (interface_no_ip_pim_ssm,</a>
<a name="ln3219">       interface_no_ip_pim_ssm_cmd,</a>
<a name="ln3220">       &quot;no ip pim ssm&quot;,</a>
<a name="ln3221">       NO_STR</a>
<a name="ln3222">       IP_STR</a>
<a name="ln3223">       PIM_STR</a>
<a name="ln3224">       IFACE_PIM_STR)</a>
<a name="ln3225">{</a>
<a name="ln3226">  struct interface *ifp;</a>
<a name="ln3227">  struct pim_interface *pim_ifp;</a>
<a name="ln3228"> </a>
<a name="ln3229">  ifp = vty-&gt;index;</a>
<a name="ln3230">  pim_ifp = ifp-&gt;info;</a>
<a name="ln3231">  if (!pim_ifp)</a>
<a name="ln3232">    return CMD_SUCCESS;</a>
<a name="ln3233"> </a>
<a name="ln3234">  PIM_IF_DONT_PIM(pim_ifp-&gt;options);</a>
<a name="ln3235"> </a>
<a name="ln3236">  pim_if_membership_clear(ifp);</a>
<a name="ln3237"> </a>
<a name="ln3238">  /*</a>
<a name="ln3239">    pim_if_addr_del_all() removes all sockets from</a>
<a name="ln3240">    pim_ifp-&gt;igmp_socket_list.</a>
<a name="ln3241">   */</a>
<a name="ln3242">  pim_if_addr_del_all(ifp);</a>
<a name="ln3243"> </a>
<a name="ln3244">  /*</a>
<a name="ln3245">    pim_sock_delete() removes all neighbors from</a>
<a name="ln3246">    pim_ifp-&gt;pim_neighbor_list.</a>
<a name="ln3247">   */</a>
<a name="ln3248">  pim_sock_delete(ifp, &quot;pim unconfigured on interface&quot;);</a>
<a name="ln3249"> </a>
<a name="ln3250">  if (!PIM_IF_TEST_IGMP(pim_ifp-&gt;options)) {</a>
<a name="ln3251">    pim_if_delete(ifp);</a>
<a name="ln3252">  }</a>
<a name="ln3253"> </a>
<a name="ln3254">  return CMD_SUCCESS;</a>
<a name="ln3255">}</a>
<a name="ln3256"> </a>
<a name="ln3257">DEFUN (interface_ip_mroute,</a>
<a name="ln3258">       interface_ip_mroute_cmd,</a>
<a name="ln3259">       &quot;ip mroute INTERFACE A.B.C.D&quot;,</a>
<a name="ln3260">       IP_STR</a>
<a name="ln3261">       &quot;Add multicast route\n&quot;</a>
<a name="ln3262">       &quot;Outgoing interface name\n&quot;</a>
<a name="ln3263">       &quot;Group address\n&quot;)</a>
<a name="ln3264">{</a>
<a name="ln3265">   struct interface *iif;</a>
<a name="ln3266">   struct interface *oif;</a>
<a name="ln3267">   const char       *oifname;</a>
<a name="ln3268">   const char       *grp_str;</a>
<a name="ln3269">   struct in_addr    grp_addr;</a>
<a name="ln3270">   struct in_addr    src_addr;</a>
<a name="ln3271">   int               result;</a>
<a name="ln3272"> </a>
<a name="ln3273">   iif = vty-&gt;index;</a>
<a name="ln3274"> </a>
<a name="ln3275">   oifname = argv[0];</a>
<a name="ln3276">   oif = if_lookup_by_name(oifname);</a>
<a name="ln3277">   if (!oif) {</a>
<a name="ln3278">     vty_out(vty, &quot;No such interface name %s%s&quot;,</a>
<a name="ln3279">        oifname, VTY_NEWLINE);</a>
<a name="ln3280">     return CMD_WARNING;</a>
<a name="ln3281">   }</a>
<a name="ln3282"> </a>
<a name="ln3283">   grp_str = argv[1];</a>
<a name="ln3284">   result = inet_pton(AF_INET, grp_str, &amp;grp_addr);</a>
<a name="ln3285">   if (result &lt;= 0) {</a>
<a name="ln3286">     vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln3287">        grp_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln3288">     return CMD_WARNING;</a>
<a name="ln3289">   }</a>
<a name="ln3290"> </a>
<a name="ln3291">   src_addr.s_addr = INADDR_ANY;</a>
<a name="ln3292"> </a>
<a name="ln3293">   if (pim_static_add(iif, oif, grp_addr, src_addr)) {</a>
<a name="ln3294">      vty_out(vty, &quot;Failed to add route%s&quot;, VTY_NEWLINE);</a>
<a name="ln3295">      return CMD_WARNING;</a>
<a name="ln3296">   }</a>
<a name="ln3297"> </a>
<a name="ln3298">   return CMD_SUCCESS;</a>
<a name="ln3299">}</a>
<a name="ln3300"> </a>
<a name="ln3301">DEFUN (interface_ip_mroute_source,</a>
<a name="ln3302">       interface_ip_mroute_source_cmd,</a>
<a name="ln3303">       &quot;ip mroute INTERFACE A.B.C.D A.B.C.D&quot;,</a>
<a name="ln3304">       IP_STR</a>
<a name="ln3305">       &quot;Add multicast route\n&quot;</a>
<a name="ln3306">       &quot;Outgoing interface name\n&quot;</a>
<a name="ln3307">       &quot;Group address\n&quot;</a>
<a name="ln3308">       &quot;Source address\n&quot;)</a>
<a name="ln3309">{</a>
<a name="ln3310">   struct interface *iif;</a>
<a name="ln3311">   struct interface *oif;</a>
<a name="ln3312">   const char       *oifname;</a>
<a name="ln3313">   const char       *grp_str;</a>
<a name="ln3314">   struct in_addr    grp_addr;</a>
<a name="ln3315">   const char       *src_str;</a>
<a name="ln3316">   struct in_addr    src_addr;</a>
<a name="ln3317">   int               result;</a>
<a name="ln3318"> </a>
<a name="ln3319">   iif = vty-&gt;index;</a>
<a name="ln3320"> </a>
<a name="ln3321">   oifname = argv[0];</a>
<a name="ln3322">   oif = if_lookup_by_name(oifname);</a>
<a name="ln3323">   if (!oif) {</a>
<a name="ln3324">     vty_out(vty, &quot;No such interface name %s%s&quot;,</a>
<a name="ln3325">        oifname, VTY_NEWLINE);</a>
<a name="ln3326">     return CMD_WARNING;</a>
<a name="ln3327">   }</a>
<a name="ln3328"> </a>
<a name="ln3329">   grp_str = argv[1];</a>
<a name="ln3330">   result = inet_pton(AF_INET, grp_str, &amp;grp_addr);</a>
<a name="ln3331">   if (result &lt;= 0) {</a>
<a name="ln3332">     vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln3333">        grp_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln3334">     return CMD_WARNING;</a>
<a name="ln3335">   }</a>
<a name="ln3336"> </a>
<a name="ln3337">   src_str = argv[2];</a>
<a name="ln3338">   result = inet_pton(AF_INET, src_str, &amp;src_addr);</a>
<a name="ln3339">   if (result &lt;= 0) {</a>
<a name="ln3340">     vty_out(vty, &quot;Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln3341">        src_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln3342">     return CMD_WARNING;</a>
<a name="ln3343">   }</a>
<a name="ln3344"> </a>
<a name="ln3345">   if (pim_static_add(iif, oif, grp_addr, src_addr)) {</a>
<a name="ln3346">      vty_out(vty, &quot;Failed to add route%s&quot;, VTY_NEWLINE);</a>
<a name="ln3347">      return CMD_WARNING;</a>
<a name="ln3348">   }</a>
<a name="ln3349"> </a>
<a name="ln3350">   return CMD_SUCCESS;</a>
<a name="ln3351">}</a>
<a name="ln3352"> </a>
<a name="ln3353">DEFUN (interface_no_ip_mroute,</a>
<a name="ln3354">       interface_no_ip_mroute_cmd,</a>
<a name="ln3355">       &quot;no ip mroute INTERFACE A.B.C.D&quot;,</a>
<a name="ln3356">       NO_STR</a>
<a name="ln3357">       IP_STR</a>
<a name="ln3358">       &quot;Add multicast route\n&quot;</a>
<a name="ln3359">       &quot;Outgoing interface name\n&quot;</a>
<a name="ln3360">       &quot;Group Address\n&quot;)</a>
<a name="ln3361">{</a>
<a name="ln3362">   struct interface *iif;</a>
<a name="ln3363">   struct interface *oif;</a>
<a name="ln3364">   const char       *oifname;</a>
<a name="ln3365">   const char       *grp_str;</a>
<a name="ln3366">   struct in_addr    grp_addr;</a>
<a name="ln3367">   struct in_addr    src_addr;</a>
<a name="ln3368">   int               result;</a>
<a name="ln3369"> </a>
<a name="ln3370">   iif = vty-&gt;index;</a>
<a name="ln3371"> </a>
<a name="ln3372">   oifname = argv[0];</a>
<a name="ln3373">   oif = if_lookup_by_name(oifname);</a>
<a name="ln3374">   if (!oif) {</a>
<a name="ln3375">     vty_out(vty, &quot;No such interface name %s%s&quot;,</a>
<a name="ln3376">        oifname, VTY_NEWLINE);</a>
<a name="ln3377">     return CMD_WARNING;</a>
<a name="ln3378">   }</a>
<a name="ln3379"> </a>
<a name="ln3380">   grp_str = argv[1];</a>
<a name="ln3381">   result = inet_pton(AF_INET, grp_str, &amp;grp_addr);</a>
<a name="ln3382">   if (result &lt;= 0) {</a>
<a name="ln3383">     vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln3384">        grp_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln3385">     return CMD_WARNING;</a>
<a name="ln3386">   }</a>
<a name="ln3387"> </a>
<a name="ln3388">   src_addr.s_addr = INADDR_ANY;</a>
<a name="ln3389"> </a>
<a name="ln3390">   if (pim_static_del(iif, oif, grp_addr, src_addr)) {</a>
<a name="ln3391">      vty_out(vty, &quot;Failed to remove route%s&quot;, VTY_NEWLINE);</a>
<a name="ln3392">      return CMD_WARNING;</a>
<a name="ln3393">   }</a>
<a name="ln3394"> </a>
<a name="ln3395">   return CMD_SUCCESS;</a>
<a name="ln3396">}</a>
<a name="ln3397"> </a>
<a name="ln3398">DEFUN (interface_no_ip_mroute_source,</a>
<a name="ln3399">       interface_no_ip_mroute_source_cmd,</a>
<a name="ln3400">       &quot;no ip mroute INTERFACE A.B.C.D A.B.C.D&quot;,</a>
<a name="ln3401">       NO_STR</a>
<a name="ln3402">       IP_STR</a>
<a name="ln3403">       &quot;Add multicast route\n&quot;</a>
<a name="ln3404">       &quot;Outgoing interface name\n&quot;</a>
<a name="ln3405">       &quot;Group Address\n&quot;</a>
<a name="ln3406">       &quot;Source Address\n&quot;)</a>
<a name="ln3407">{</a>
<a name="ln3408">   struct interface *iif;</a>
<a name="ln3409">   struct interface *oif;</a>
<a name="ln3410">   const char       *oifname;</a>
<a name="ln3411">   const char       *grp_str;</a>
<a name="ln3412">   struct in_addr    grp_addr;</a>
<a name="ln3413">   const char       *src_str;</a>
<a name="ln3414">   struct in_addr    src_addr;</a>
<a name="ln3415">   int               result;</a>
<a name="ln3416"> </a>
<a name="ln3417">   iif = vty-&gt;index;</a>
<a name="ln3418"> </a>
<a name="ln3419">   oifname = argv[0];</a>
<a name="ln3420">   oif = if_lookup_by_name(oifname);</a>
<a name="ln3421">   if (!oif) {</a>
<a name="ln3422">     vty_out(vty, &quot;No such interface name %s%s&quot;,</a>
<a name="ln3423">        oifname, VTY_NEWLINE);</a>
<a name="ln3424">     return CMD_WARNING;</a>
<a name="ln3425">   }</a>
<a name="ln3426"> </a>
<a name="ln3427">   grp_str = argv[1];</a>
<a name="ln3428">   result = inet_pton(AF_INET, grp_str, &amp;grp_addr);</a>
<a name="ln3429">   if (result &lt;= 0) {</a>
<a name="ln3430">     vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln3431">        grp_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln3432">     return CMD_WARNING;</a>
<a name="ln3433">   }</a>
<a name="ln3434"> </a>
<a name="ln3435">   src_str = argv[2];</a>
<a name="ln3436">   result = inet_pton(AF_INET, src_str, &amp;src_addr);</a>
<a name="ln3437">   if (result &lt;= 0) {</a>
<a name="ln3438">     vty_out(vty, &quot;Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln3439">        src_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln3440">     return CMD_WARNING;</a>
<a name="ln3441">   }</a>
<a name="ln3442"> </a>
<a name="ln3443">   if (pim_static_del(iif, oif, grp_addr, src_addr)) {</a>
<a name="ln3444">      vty_out(vty, &quot;Failed to remove route%s&quot;, VTY_NEWLINE);</a>
<a name="ln3445">      return CMD_WARNING;</a>
<a name="ln3446">   }</a>
<a name="ln3447"> </a>
<a name="ln3448">   return CMD_SUCCESS;</a>
<a name="ln3449">}</a>
<a name="ln3450"> </a>
<a name="ln3451">DEFUN (interface_ip_pim_hello,</a>
<a name="ln3452">       interface_ip_pim_hello_cmd,</a>
<a name="ln3453">       &quot;ip pim hello &lt;1-180&gt;&quot;,</a>
<a name="ln3454">       IP_STR</a>
<a name="ln3455">       PIM_STR</a>
<a name="ln3456">       IFACE_PIM_HELLO_STR</a>
<a name="ln3457">       IFACE_PIM_HELLO_TIME_STR)</a>
<a name="ln3458">{</a>
<a name="ln3459">  struct interface *ifp;</a>
<a name="ln3460">  struct pim_interface *pim_ifp;</a>
<a name="ln3461"> </a>
<a name="ln3462">  ifp = vty-&gt;index;</a>
<a name="ln3463">  pim_ifp = ifp-&gt;info;</a>
<a name="ln3464"> </a>
<a name="ln3465">  if (!pim_ifp) {</a>
<a name="ln3466">    vty_out(vty, &quot;Pim not enabled on this interface%s&quot;, VTY_NEWLINE);</a>
<a name="ln3467">    return CMD_WARNING;</a>
<a name="ln3468">  }</a>
<a name="ln3469"> </a>
<a name="ln3470">  pim_ifp-&gt;pim_hello_period = strtol(argv[0], NULL, 10);</a>
<a name="ln3471"> </a>
<a name="ln3472">  if (argc == 2)</a>
<a name="ln3473">    pim_ifp-&gt;pim_default_holdtime = strtol(argv[1], NULL, 10);</a>
<a name="ln3474"> </a>
<a name="ln3475">  return CMD_SUCCESS;</a>
<a name="ln3476">}</a>
<a name="ln3477"> </a>
<a name="ln3478">ALIAS (interface_ip_pim_hello,</a>
<a name="ln3479">       interface_ip_pim_hello_hold_cmd,</a>
<a name="ln3480">       &quot;ip pim hello &lt;1-180&gt; &lt;1-180&gt;&quot;,</a>
<a name="ln3481">       IP_STR</a>
<a name="ln3482">       PIM_STR</a>
<a name="ln3483">       IFACE_PIM_HELLO_STR</a>
<a name="ln3484">       IFACE_PIM_HELLO_TIME_STR</a>
<a name="ln3485">       IFACE_PIM_HELLO_HOLD_STR)</a>
<a name="ln3486"> </a>
<a name="ln3487"> </a>
<a name="ln3488">DEFUN (interface_no_ip_pim_hello,</a>
<a name="ln3489">       interface_no_ip_pim_hello_cmd,</a>
<a name="ln3490">       &quot;no ip pim hello {&lt;1-180&gt; &lt;1-180&gt;}&quot;,</a>
<a name="ln3491">       NO_STR</a>
<a name="ln3492">       IP_STR</a>
<a name="ln3493">       PIM_STR</a>
<a name="ln3494">       IFACE_PIM_HELLO_STR</a>
<a name="ln3495">       IFACE_PIM_HELLO_TIME_STR</a>
<a name="ln3496">       IFACE_PIM_HELLO_HOLD_STR)</a>
<a name="ln3497">{</a>
<a name="ln3498">  struct interface *ifp;</a>
<a name="ln3499">  struct pim_interface *pim_ifp;</a>
<a name="ln3500"> </a>
<a name="ln3501">  ifp = vty-&gt;index;</a>
<a name="ln3502">  pim_ifp = ifp-&gt;info;</a>
<a name="ln3503"> </a>
<a name="ln3504">  if (!pim_ifp) {</a>
<a name="ln3505">    vty_out(vty, &quot;Pim not enabled on this interface%s&quot;, VTY_NEWLINE);</a>
<a name="ln3506">    return CMD_WARNING;</a>
<a name="ln3507">  }</a>
<a name="ln3508"> </a>
<a name="ln3509">  pim_ifp-&gt;pim_hello_period     = PIM_DEFAULT_HELLO_PERIOD;</a>
<a name="ln3510">  pim_ifp-&gt;pim_default_holdtime = -1;</a>
<a name="ln3511"> </a>
<a name="ln3512">  return CMD_SUCCESS;</a>
<a name="ln3513">}</a>
<a name="ln3514"> </a>
<a name="ln3515">DEFUN (debug_igmp,</a>
<a name="ln3516">       debug_igmp_cmd,</a>
<a name="ln3517">       &quot;debug igmp&quot;,</a>
<a name="ln3518">       DEBUG_STR</a>
<a name="ln3519">       DEBUG_IGMP_STR)</a>
<a name="ln3520">{</a>
<a name="ln3521">  PIM_DO_DEBUG_IGMP_EVENTS;</a>
<a name="ln3522">  PIM_DO_DEBUG_IGMP_PACKETS;</a>
<a name="ln3523">  PIM_DO_DEBUG_IGMP_TRACE;</a>
<a name="ln3524">  return CMD_SUCCESS;</a>
<a name="ln3525">}</a>
<a name="ln3526"> </a>
<a name="ln3527">DEFUN (no_debug_igmp,</a>
<a name="ln3528">       no_debug_igmp_cmd,</a>
<a name="ln3529">       &quot;no debug igmp&quot;,</a>
<a name="ln3530">       NO_STR</a>
<a name="ln3531">       DEBUG_STR</a>
<a name="ln3532">       DEBUG_IGMP_STR)</a>
<a name="ln3533">{</a>
<a name="ln3534">  PIM_DONT_DEBUG_IGMP_EVENTS;</a>
<a name="ln3535">  PIM_DONT_DEBUG_IGMP_PACKETS;</a>
<a name="ln3536">  PIM_DONT_DEBUG_IGMP_TRACE;</a>
<a name="ln3537">  return CMD_SUCCESS;</a>
<a name="ln3538">}</a>
<a name="ln3539"> </a>
<a name="ln3540">ALIAS (no_debug_igmp,</a>
<a name="ln3541">       undebug_igmp_cmd,</a>
<a name="ln3542">       &quot;undebug igmp&quot;,</a>
<a name="ln3543">       UNDEBUG_STR</a>
<a name="ln3544">       DEBUG_IGMP_STR)</a>
<a name="ln3545"> </a>
<a name="ln3546">DEFUN (debug_igmp_events,</a>
<a name="ln3547">       debug_igmp_events_cmd,</a>
<a name="ln3548">       &quot;debug igmp events&quot;,</a>
<a name="ln3549">       DEBUG_STR</a>
<a name="ln3550">       DEBUG_IGMP_STR</a>
<a name="ln3551">       DEBUG_IGMP_EVENTS_STR)</a>
<a name="ln3552">{</a>
<a name="ln3553">  PIM_DO_DEBUG_IGMP_EVENTS;</a>
<a name="ln3554">  return CMD_SUCCESS;</a>
<a name="ln3555">}</a>
<a name="ln3556"> </a>
<a name="ln3557">DEFUN (no_debug_igmp_events,</a>
<a name="ln3558">       no_debug_igmp_events_cmd,</a>
<a name="ln3559">       &quot;no debug igmp events&quot;,</a>
<a name="ln3560">       NO_STR</a>
<a name="ln3561">       DEBUG_STR</a>
<a name="ln3562">       DEBUG_IGMP_STR</a>
<a name="ln3563">       DEBUG_IGMP_EVENTS_STR)</a>
<a name="ln3564">{</a>
<a name="ln3565">  PIM_DONT_DEBUG_IGMP_EVENTS;</a>
<a name="ln3566">  return CMD_SUCCESS;</a>
<a name="ln3567">}</a>
<a name="ln3568"> </a>
<a name="ln3569">ALIAS (no_debug_igmp_events,</a>
<a name="ln3570">       undebug_igmp_events_cmd,</a>
<a name="ln3571">       &quot;undebug igmp events&quot;,</a>
<a name="ln3572">       UNDEBUG_STR</a>
<a name="ln3573">       DEBUG_IGMP_STR</a>
<a name="ln3574">       DEBUG_IGMP_EVENTS_STR)</a>
<a name="ln3575"> </a>
<a name="ln3576">DEFUN (debug_igmp_packets,</a>
<a name="ln3577">       debug_igmp_packets_cmd,</a>
<a name="ln3578">       &quot;debug igmp packets&quot;,</a>
<a name="ln3579">       DEBUG_STR</a>
<a name="ln3580">       DEBUG_IGMP_STR</a>
<a name="ln3581">       DEBUG_IGMP_PACKETS_STR)</a>
<a name="ln3582">{</a>
<a name="ln3583">  PIM_DO_DEBUG_IGMP_PACKETS;</a>
<a name="ln3584">  return CMD_SUCCESS;</a>
<a name="ln3585">}</a>
<a name="ln3586"> </a>
<a name="ln3587">DEFUN (no_debug_igmp_packets,</a>
<a name="ln3588">       no_debug_igmp_packets_cmd,</a>
<a name="ln3589">       &quot;no debug igmp packets&quot;,</a>
<a name="ln3590">       NO_STR</a>
<a name="ln3591">       DEBUG_STR</a>
<a name="ln3592">       DEBUG_IGMP_STR</a>
<a name="ln3593">       DEBUG_IGMP_PACKETS_STR)</a>
<a name="ln3594">{</a>
<a name="ln3595">  PIM_DONT_DEBUG_IGMP_PACKETS;</a>
<a name="ln3596">  return CMD_SUCCESS;</a>
<a name="ln3597">}</a>
<a name="ln3598"> </a>
<a name="ln3599">ALIAS (no_debug_igmp_packets,</a>
<a name="ln3600">       undebug_igmp_packets_cmd,</a>
<a name="ln3601">       &quot;undebug igmp packets&quot;,</a>
<a name="ln3602">       UNDEBUG_STR</a>
<a name="ln3603">       DEBUG_IGMP_STR</a>
<a name="ln3604">       DEBUG_IGMP_PACKETS_STR)</a>
<a name="ln3605"> </a>
<a name="ln3606">DEFUN (debug_igmp_trace,</a>
<a name="ln3607">       debug_igmp_trace_cmd,</a>
<a name="ln3608">       &quot;debug igmp trace&quot;,</a>
<a name="ln3609">       DEBUG_STR</a>
<a name="ln3610">       DEBUG_IGMP_STR</a>
<a name="ln3611">       DEBUG_IGMP_TRACE_STR)</a>
<a name="ln3612">{</a>
<a name="ln3613">  PIM_DO_DEBUG_IGMP_TRACE;</a>
<a name="ln3614">  return CMD_SUCCESS;</a>
<a name="ln3615">}</a>
<a name="ln3616"> </a>
<a name="ln3617">DEFUN (no_debug_igmp_trace,</a>
<a name="ln3618">       no_debug_igmp_trace_cmd,</a>
<a name="ln3619">       &quot;no debug igmp trace&quot;,</a>
<a name="ln3620">       NO_STR</a>
<a name="ln3621">       DEBUG_STR</a>
<a name="ln3622">       DEBUG_IGMP_STR</a>
<a name="ln3623">       DEBUG_IGMP_TRACE_STR)</a>
<a name="ln3624">{</a>
<a name="ln3625">  PIM_DONT_DEBUG_IGMP_TRACE;</a>
<a name="ln3626">  return CMD_SUCCESS;</a>
<a name="ln3627">}</a>
<a name="ln3628"> </a>
<a name="ln3629">ALIAS (no_debug_igmp_trace,</a>
<a name="ln3630">       undebug_igmp_trace_cmd,</a>
<a name="ln3631">       &quot;undebug igmp trace&quot;,</a>
<a name="ln3632">       UNDEBUG_STR</a>
<a name="ln3633">       DEBUG_IGMP_STR</a>
<a name="ln3634">       DEBUG_IGMP_TRACE_STR)</a>
<a name="ln3635"> </a>
<a name="ln3636">DEFUN (debug_mroute,</a>
<a name="ln3637">       debug_mroute_cmd,</a>
<a name="ln3638">       &quot;debug mroute&quot;,</a>
<a name="ln3639">       DEBUG_STR</a>
<a name="ln3640">       DEBUG_MROUTE_STR)</a>
<a name="ln3641">{</a>
<a name="ln3642">  PIM_DO_DEBUG_MROUTE;</a>
<a name="ln3643">  return CMD_SUCCESS;</a>
<a name="ln3644">}</a>
<a name="ln3645"> </a>
<a name="ln3646">DEFUN (no_debug_mroute,</a>
<a name="ln3647">       no_debug_mroute_cmd,</a>
<a name="ln3648">       &quot;no debug mroute&quot;,</a>
<a name="ln3649">       NO_STR</a>
<a name="ln3650">       DEBUG_STR</a>
<a name="ln3651">       DEBUG_MROUTE_STR)</a>
<a name="ln3652">{</a>
<a name="ln3653">  PIM_DONT_DEBUG_MROUTE;</a>
<a name="ln3654">  return CMD_SUCCESS;</a>
<a name="ln3655">}</a>
<a name="ln3656"> </a>
<a name="ln3657">ALIAS (no_debug_mroute,</a>
<a name="ln3658">       undebug_mroute_cmd,</a>
<a name="ln3659">       &quot;undebug mroute&quot;,</a>
<a name="ln3660">       UNDEBUG_STR</a>
<a name="ln3661">       DEBUG_MROUTE_STR)</a>
<a name="ln3662"> </a>
<a name="ln3663">DEFUN (debug_static,</a>
<a name="ln3664">       debug_static_cmd,</a>
<a name="ln3665">       &quot;debug static&quot;,</a>
<a name="ln3666">       DEBUG_STR</a>
<a name="ln3667">       DEBUG_STATIC_STR)</a>
<a name="ln3668">{</a>
<a name="ln3669">  PIM_DO_DEBUG_STATIC;</a>
<a name="ln3670">  return CMD_SUCCESS;</a>
<a name="ln3671">}</a>
<a name="ln3672"> </a>
<a name="ln3673">DEFUN (no_debug_static,</a>
<a name="ln3674">       no_debug_static_cmd,</a>
<a name="ln3675">       &quot;no debug static&quot;,</a>
<a name="ln3676">       NO_STR</a>
<a name="ln3677">       DEBUG_STR</a>
<a name="ln3678">       DEBUG_STATIC_STR)</a>
<a name="ln3679">{</a>
<a name="ln3680">  PIM_DONT_DEBUG_STATIC;</a>
<a name="ln3681">  return CMD_SUCCESS;</a>
<a name="ln3682">}</a>
<a name="ln3683"> </a>
<a name="ln3684">ALIAS (no_debug_static,</a>
<a name="ln3685">       undebug_static_cmd,</a>
<a name="ln3686">       &quot;undebug static&quot;,</a>
<a name="ln3687">       UNDEBUG_STR</a>
<a name="ln3688">       DEBUG_STATIC_STR)</a>
<a name="ln3689"> </a>
<a name="ln3690">DEFUN (debug_pim,</a>
<a name="ln3691">       debug_pim_cmd,</a>
<a name="ln3692">       &quot;debug pim&quot;,</a>
<a name="ln3693">       DEBUG_STR</a>
<a name="ln3694">       DEBUG_PIM_STR)</a>
<a name="ln3695">{</a>
<a name="ln3696">  PIM_DO_DEBUG_PIM_EVENTS;</a>
<a name="ln3697">  PIM_DO_DEBUG_PIM_PACKETS;</a>
<a name="ln3698">  PIM_DO_DEBUG_PIM_TRACE;</a>
<a name="ln3699">  return CMD_SUCCESS;</a>
<a name="ln3700">}</a>
<a name="ln3701"> </a>
<a name="ln3702">DEFUN (no_debug_pim,</a>
<a name="ln3703">       no_debug_pim_cmd,</a>
<a name="ln3704">       &quot;no debug pim&quot;,</a>
<a name="ln3705">       NO_STR</a>
<a name="ln3706">       DEBUG_STR</a>
<a name="ln3707">       DEBUG_PIM_STR)</a>
<a name="ln3708">{</a>
<a name="ln3709">  PIM_DONT_DEBUG_PIM_EVENTS;</a>
<a name="ln3710">  PIM_DONT_DEBUG_PIM_PACKETS;</a>
<a name="ln3711">  PIM_DONT_DEBUG_PIM_TRACE;</a>
<a name="ln3712"> </a>
<a name="ln3713">  PIM_DONT_DEBUG_PIM_PACKETDUMP_SEND;</a>
<a name="ln3714">  PIM_DONT_DEBUG_PIM_PACKETDUMP_RECV;</a>
<a name="ln3715"> </a>
<a name="ln3716">  return CMD_SUCCESS;</a>
<a name="ln3717">}</a>
<a name="ln3718"> </a>
<a name="ln3719">ALIAS (no_debug_pim,</a>
<a name="ln3720">       undebug_pim_cmd,</a>
<a name="ln3721">       &quot;undebug pim&quot;,</a>
<a name="ln3722">       UNDEBUG_STR</a>
<a name="ln3723">       DEBUG_PIM_STR)</a>
<a name="ln3724"> </a>
<a name="ln3725">DEFUN (debug_pim_events,</a>
<a name="ln3726">       debug_pim_events_cmd,</a>
<a name="ln3727">       &quot;debug pim events&quot;,</a>
<a name="ln3728">       DEBUG_STR</a>
<a name="ln3729">       DEBUG_PIM_STR</a>
<a name="ln3730">       DEBUG_PIM_EVENTS_STR)</a>
<a name="ln3731">{</a>
<a name="ln3732">  PIM_DO_DEBUG_PIM_EVENTS;</a>
<a name="ln3733">  return CMD_SUCCESS;</a>
<a name="ln3734">}</a>
<a name="ln3735"> </a>
<a name="ln3736">DEFUN (no_debug_pim_events,</a>
<a name="ln3737">       no_debug_pim_events_cmd,</a>
<a name="ln3738">       &quot;no debug pim events&quot;,</a>
<a name="ln3739">       NO_STR</a>
<a name="ln3740">       DEBUG_STR</a>
<a name="ln3741">       DEBUG_PIM_STR</a>
<a name="ln3742">       DEBUG_PIM_EVENTS_STR)</a>
<a name="ln3743">{</a>
<a name="ln3744">  PIM_DONT_DEBUG_PIM_EVENTS;</a>
<a name="ln3745">  return CMD_SUCCESS;</a>
<a name="ln3746">}</a>
<a name="ln3747"> </a>
<a name="ln3748">ALIAS (no_debug_pim_events,</a>
<a name="ln3749">       undebug_pim_events_cmd,</a>
<a name="ln3750">       &quot;undebug pim events&quot;,</a>
<a name="ln3751">       UNDEBUG_STR</a>
<a name="ln3752">       DEBUG_PIM_STR</a>
<a name="ln3753">       DEBUG_PIM_EVENTS_STR)</a>
<a name="ln3754"> </a>
<a name="ln3755">DEFUN (debug_pim_packets,</a>
<a name="ln3756">       debug_pim_packets_cmd,</a>
<a name="ln3757">       &quot;debug pim packets&quot;,</a>
<a name="ln3758">       DEBUG_STR</a>
<a name="ln3759">       DEBUG_PIM_STR</a>
<a name="ln3760">       DEBUG_PIM_PACKETS_STR)</a>
<a name="ln3761">{</a>
<a name="ln3762">    PIM_DO_DEBUG_PIM_PACKETS;</a>
<a name="ln3763">    vty_out (vty, &quot;PIM Packet debugging is on %s&quot;, VTY_NEWLINE);</a>
<a name="ln3764">    return CMD_SUCCESS;</a>
<a name="ln3765">}</a>
<a name="ln3766"> </a>
<a name="ln3767">DEFUN (debug_pim_packets_filter,</a>
<a name="ln3768">       debug_pim_packets_filter_cmd,</a>
<a name="ln3769">       &quot;debug pim packets (hello|joins)&quot;,</a>
<a name="ln3770">       DEBUG_STR</a>
<a name="ln3771">       DEBUG_PIM_STR</a>
<a name="ln3772">       DEBUG_PIM_PACKETS_STR</a>
<a name="ln3773">       DEBUG_PIM_HELLO_PACKETS_STR</a>
<a name="ln3774">       DEBUG_PIM_J_P_PACKETS_STR)</a>
<a name="ln3775">{</a>
<a name="ln3776">    if (strncmp(argv[0],&quot;h&quot;,1) == 0) </a>
<a name="ln3777">    {</a>
<a name="ln3778">      PIM_DO_DEBUG_PIM_HELLO;</a>
<a name="ln3779">      vty_out (vty, &quot;PIM Hello debugging is on %s&quot;, VTY_NEWLINE);</a>
<a name="ln3780">    }</a>
<a name="ln3781">    else if (strncmp(argv[0],&quot;j&quot;,1) == 0)</a>
<a name="ln3782">    {</a>
<a name="ln3783">      PIM_DO_DEBUG_PIM_J_P;</a>
<a name="ln3784">      vty_out (vty, &quot;PIM Join/Prune debugging is on %s&quot;, VTY_NEWLINE);</a>
<a name="ln3785">    }</a>
<a name="ln3786">  return CMD_SUCCESS;</a>
<a name="ln3787">}</a>
<a name="ln3788"> </a>
<a name="ln3789">DEFUN (no_debug_pim_packets,</a>
<a name="ln3790">       no_debug_pim_packets_cmd,</a>
<a name="ln3791">       &quot;no debug pim packets&quot;,</a>
<a name="ln3792">       NO_STR</a>
<a name="ln3793">       DEBUG_STR</a>
<a name="ln3794">       DEBUG_PIM_STR</a>
<a name="ln3795">       DEBUG_PIM_PACKETS_STR</a>
<a name="ln3796">       DEBUG_PIM_HELLO_PACKETS_STR</a>
<a name="ln3797">       DEBUG_PIM_J_P_PACKETS_STR)</a>
<a name="ln3798">{</a>
<a name="ln3799">  PIM_DONT_DEBUG_PIM_PACKETS;</a>
<a name="ln3800">  vty_out (vty, &quot;PIM Packet debugging is off %s&quot;, VTY_NEWLINE);</a>
<a name="ln3801">  return CMD_SUCCESS;</a>
<a name="ln3802">}</a>
<a name="ln3803"> </a>
<a name="ln3804">DEFUN (no_debug_pim_packets_filter,</a>
<a name="ln3805">       no_debug_pim_packets_filter_cmd,</a>
<a name="ln3806">       &quot;no debug pim packets (hello|joins)&quot;,</a>
<a name="ln3807">       NO_STR</a>
<a name="ln3808">       DEBUG_STR</a>
<a name="ln3809">       DEBUG_PIM_STR</a>
<a name="ln3810">       DEBUG_PIM_PACKETS_STR</a>
<a name="ln3811">       DEBUG_PIM_HELLO_PACKETS_STR</a>
<a name="ln3812">       DEBUG_PIM_J_P_PACKETS_STR)</a>
<a name="ln3813">{</a>
<a name="ln3814">    if (strncmp(argv[0],&quot;h&quot;,1) == 0) </a>
<a name="ln3815">    {</a>
<a name="ln3816">      PIM_DONT_DEBUG_PIM_HELLO;</a>
<a name="ln3817">      vty_out (vty, &quot;PIM Hello debugging is off %s&quot;, VTY_NEWLINE);</a>
<a name="ln3818">    }</a>
<a name="ln3819">    else if (strncmp(argv[0],&quot;j&quot;,1) == 0)</a>
<a name="ln3820">    {</a>
<a name="ln3821">      PIM_DONT_DEBUG_PIM_J_P;</a>
<a name="ln3822">      vty_out (vty, &quot;PIM Join/Prune debugging is off %s&quot;, VTY_NEWLINE);</a>
<a name="ln3823">    }</a>
<a name="ln3824">    return CMD_SUCCESS;</a>
<a name="ln3825">}</a>
<a name="ln3826"> </a>
<a name="ln3827">ALIAS (no_debug_pim_packets,</a>
<a name="ln3828">       undebug_pim_packets_cmd,</a>
<a name="ln3829">       &quot;undebug pim packets&quot;,</a>
<a name="ln3830">       UNDEBUG_STR</a>
<a name="ln3831">       DEBUG_PIM_STR</a>
<a name="ln3832">       DEBUG_PIM_PACKETS_STR)</a>
<a name="ln3833"> </a>
<a name="ln3834">DEFUN (debug_pim_packetdump_send,</a>
<a name="ln3835">       debug_pim_packetdump_send_cmd,</a>
<a name="ln3836">       &quot;debug pim packet-dump send&quot;,</a>
<a name="ln3837">       DEBUG_STR</a>
<a name="ln3838">       DEBUG_PIM_STR</a>
<a name="ln3839">       DEBUG_PIM_PACKETDUMP_STR</a>
<a name="ln3840">       DEBUG_PIM_PACKETDUMP_SEND_STR)</a>
<a name="ln3841">{</a>
<a name="ln3842">  PIM_DO_DEBUG_PIM_PACKETDUMP_SEND;</a>
<a name="ln3843">  return CMD_SUCCESS;</a>
<a name="ln3844">}</a>
<a name="ln3845"> </a>
<a name="ln3846">DEFUN (no_debug_pim_packetdump_send,</a>
<a name="ln3847">       no_debug_pim_packetdump_send_cmd,</a>
<a name="ln3848">       &quot;no debug pim packet-dump send&quot;,</a>
<a name="ln3849">       NO_STR</a>
<a name="ln3850">       DEBUG_STR</a>
<a name="ln3851">       DEBUG_PIM_STR</a>
<a name="ln3852">       DEBUG_PIM_PACKETDUMP_STR</a>
<a name="ln3853">       DEBUG_PIM_PACKETDUMP_SEND_STR)</a>
<a name="ln3854">{</a>
<a name="ln3855">  PIM_DONT_DEBUG_PIM_PACKETDUMP_SEND;</a>
<a name="ln3856">  return CMD_SUCCESS;</a>
<a name="ln3857">}</a>
<a name="ln3858"> </a>
<a name="ln3859">ALIAS (no_debug_pim_packetdump_send,</a>
<a name="ln3860">       undebug_pim_packetdump_send_cmd,</a>
<a name="ln3861">       &quot;undebug pim packet-dump send&quot;,</a>
<a name="ln3862">       UNDEBUG_STR</a>
<a name="ln3863">       DEBUG_PIM_STR</a>
<a name="ln3864">       DEBUG_PIM_PACKETDUMP_STR</a>
<a name="ln3865">       DEBUG_PIM_PACKETDUMP_SEND_STR)</a>
<a name="ln3866"> </a>
<a name="ln3867">DEFUN (debug_pim_packetdump_recv,</a>
<a name="ln3868">       debug_pim_packetdump_recv_cmd,</a>
<a name="ln3869">       &quot;debug pim packet-dump receive&quot;,</a>
<a name="ln3870">       DEBUG_STR</a>
<a name="ln3871">       DEBUG_PIM_STR</a>
<a name="ln3872">       DEBUG_PIM_PACKETDUMP_STR</a>
<a name="ln3873">       DEBUG_PIM_PACKETDUMP_RECV_STR)</a>
<a name="ln3874">{</a>
<a name="ln3875">  PIM_DO_DEBUG_PIM_PACKETDUMP_RECV;</a>
<a name="ln3876">  return CMD_SUCCESS;</a>
<a name="ln3877">}</a>
<a name="ln3878"> </a>
<a name="ln3879">DEFUN (no_debug_pim_packetdump_recv,</a>
<a name="ln3880">       no_debug_pim_packetdump_recv_cmd,</a>
<a name="ln3881">       &quot;no debug pim packet-dump receive&quot;,</a>
<a name="ln3882">       NO_STR</a>
<a name="ln3883">       DEBUG_STR</a>
<a name="ln3884">       DEBUG_PIM_STR</a>
<a name="ln3885">       DEBUG_PIM_PACKETDUMP_STR</a>
<a name="ln3886">       DEBUG_PIM_PACKETDUMP_RECV_STR)</a>
<a name="ln3887">{</a>
<a name="ln3888">  PIM_DONT_DEBUG_PIM_PACKETDUMP_RECV;</a>
<a name="ln3889">  return CMD_SUCCESS;</a>
<a name="ln3890">}</a>
<a name="ln3891"> </a>
<a name="ln3892">ALIAS (no_debug_pim_packetdump_recv,</a>
<a name="ln3893">       undebug_pim_packetdump_recv_cmd,</a>
<a name="ln3894">       &quot;undebug pim packet-dump receive&quot;,</a>
<a name="ln3895">       UNDEBUG_STR</a>
<a name="ln3896">       DEBUG_PIM_STR</a>
<a name="ln3897">       DEBUG_PIM_PACKETDUMP_STR</a>
<a name="ln3898">       DEBUG_PIM_PACKETDUMP_RECV_STR)</a>
<a name="ln3899"> </a>
<a name="ln3900">DEFUN (debug_pim_trace,</a>
<a name="ln3901">       debug_pim_trace_cmd,</a>
<a name="ln3902">       &quot;debug pim trace&quot;,</a>
<a name="ln3903">       DEBUG_STR</a>
<a name="ln3904">       DEBUG_PIM_STR</a>
<a name="ln3905">       DEBUG_PIM_TRACE_STR)</a>
<a name="ln3906">{</a>
<a name="ln3907">  PIM_DO_DEBUG_PIM_TRACE;</a>
<a name="ln3908">  return CMD_SUCCESS;</a>
<a name="ln3909">}</a>
<a name="ln3910"> </a>
<a name="ln3911">DEFUN (no_debug_pim_trace,</a>
<a name="ln3912">       no_debug_pim_trace_cmd,</a>
<a name="ln3913">       &quot;no debug pim trace&quot;,</a>
<a name="ln3914">       NO_STR</a>
<a name="ln3915">       DEBUG_STR</a>
<a name="ln3916">       DEBUG_PIM_STR</a>
<a name="ln3917">       DEBUG_PIM_TRACE_STR)</a>
<a name="ln3918">{</a>
<a name="ln3919">  PIM_DONT_DEBUG_PIM_TRACE;</a>
<a name="ln3920">  return CMD_SUCCESS;</a>
<a name="ln3921">}</a>
<a name="ln3922"> </a>
<a name="ln3923">ALIAS (no_debug_pim_trace,</a>
<a name="ln3924">       undebug_pim_trace_cmd,</a>
<a name="ln3925">       &quot;undebug pim trace&quot;,</a>
<a name="ln3926">       UNDEBUG_STR</a>
<a name="ln3927">       DEBUG_PIM_STR</a>
<a name="ln3928">       DEBUG_PIM_TRACE_STR)</a>
<a name="ln3929"> </a>
<a name="ln3930">DEFUN (debug_ssmpingd,</a>
<a name="ln3931">       debug_ssmpingd_cmd,</a>
<a name="ln3932">       &quot;debug ssmpingd&quot;,</a>
<a name="ln3933">       DEBUG_STR</a>
<a name="ln3934">       DEBUG_PIM_STR</a>
<a name="ln3935">       DEBUG_SSMPINGD_STR)</a>
<a name="ln3936">{</a>
<a name="ln3937">  PIM_DO_DEBUG_SSMPINGD;</a>
<a name="ln3938">  return CMD_SUCCESS;</a>
<a name="ln3939">}</a>
<a name="ln3940"> </a>
<a name="ln3941">DEFUN (no_debug_ssmpingd,</a>
<a name="ln3942">       no_debug_ssmpingd_cmd,</a>
<a name="ln3943">       &quot;no debug ssmpingd&quot;,</a>
<a name="ln3944">       NO_STR</a>
<a name="ln3945">       DEBUG_STR</a>
<a name="ln3946">       DEBUG_PIM_STR</a>
<a name="ln3947">       DEBUG_SSMPINGD_STR)</a>
<a name="ln3948">{</a>
<a name="ln3949">  PIM_DONT_DEBUG_SSMPINGD;</a>
<a name="ln3950">  return CMD_SUCCESS;</a>
<a name="ln3951">}</a>
<a name="ln3952"> </a>
<a name="ln3953">ALIAS (no_debug_ssmpingd,</a>
<a name="ln3954">       undebug_ssmpingd_cmd,</a>
<a name="ln3955">       &quot;undebug ssmpingd&quot;,</a>
<a name="ln3956">       UNDEBUG_STR</a>
<a name="ln3957">       DEBUG_PIM_STR</a>
<a name="ln3958">       DEBUG_SSMPINGD_STR)</a>
<a name="ln3959"> </a>
<a name="ln3960">DEFUN (debug_pim_zebra,</a>
<a name="ln3961">       debug_pim_zebra_cmd,</a>
<a name="ln3962">       &quot;debug pim zebra&quot;,</a>
<a name="ln3963">       DEBUG_STR</a>
<a name="ln3964">       DEBUG_PIM_STR</a>
<a name="ln3965">       DEBUG_PIM_ZEBRA_STR)</a>
<a name="ln3966">{</a>
<a name="ln3967">  PIM_DO_DEBUG_ZEBRA;</a>
<a name="ln3968">  return CMD_SUCCESS;</a>
<a name="ln3969">}</a>
<a name="ln3970"> </a>
<a name="ln3971">DEFUN (no_debug_pim_zebra,</a>
<a name="ln3972">       no_debug_pim_zebra_cmd,</a>
<a name="ln3973">       &quot;no debug pim zebra&quot;,</a>
<a name="ln3974">       NO_STR</a>
<a name="ln3975">       DEBUG_STR</a>
<a name="ln3976">       DEBUG_PIM_STR</a>
<a name="ln3977">       DEBUG_PIM_ZEBRA_STR)</a>
<a name="ln3978">{</a>
<a name="ln3979">  PIM_DONT_DEBUG_ZEBRA;</a>
<a name="ln3980">  return CMD_SUCCESS;</a>
<a name="ln3981">}</a>
<a name="ln3982"> </a>
<a name="ln3983">ALIAS (no_debug_pim_zebra,</a>
<a name="ln3984">       undebug_pim_zebra_cmd,</a>
<a name="ln3985">       &quot;undebug pim zebra&quot;,</a>
<a name="ln3986">       UNDEBUG_STR</a>
<a name="ln3987">       DEBUG_PIM_STR</a>
<a name="ln3988">       DEBUG_PIM_ZEBRA_STR)</a>
<a name="ln3989"> </a>
<a name="ln3990">DEFUN (show_debugging_pim,</a>
<a name="ln3991">       show_debugging_pim_cmd,</a>
<a name="ln3992">       &quot;show debugging pim&quot;,</a>
<a name="ln3993">       SHOW_STR</a>
<a name="ln3994">       DEBUG_STR</a>
<a name="ln3995">       PIM_STR)</a>
<a name="ln3996">{</a>
<a name="ln3997">  pim_debug_config_write(vty);</a>
<a name="ln3998">  return CMD_SUCCESS;</a>
<a name="ln3999">}</a>
<a name="ln4000"> </a>
<a name="ln4001">static struct igmp_sock *find_igmp_sock_by_fd(int fd)</a>
<a name="ln4002">{</a>
<a name="ln4003">  struct listnode  *ifnode;</a>
<a name="ln4004">  struct interface *ifp;</a>
<a name="ln4005"> </a>
<a name="ln4006">  /* scan all interfaces */</a>
<a name="ln4007">  for (ALL_LIST_ELEMENTS_RO(iflist, ifnode, ifp)) {</a>
<a name="ln4008">    struct pim_interface *pim_ifp;</a>
<a name="ln4009">    struct igmp_sock     *igmp;</a>
<a name="ln4010">    </a>
<a name="ln4011">    if (!ifp-&gt;info)</a>
<a name="ln4012">      continue;</a>
<a name="ln4013"> </a>
<a name="ln4014">    pim_ifp = ifp-&gt;info;</a>
<a name="ln4015"> </a>
<a name="ln4016">    /* lookup igmp socket under current interface */</a>
<a name="ln4017">    igmp = igmp_sock_lookup_by_fd(pim_ifp-&gt;igmp_socket_list, fd);</a>
<a name="ln4018">    if (igmp)</a>
<a name="ln4019">      return igmp;</a>
<a name="ln4020">  }</a>
<a name="ln4021"> </a>
<a name="ln4022">  return 0;</a>
<a name="ln4023">}</a>
<a name="ln4024"> </a>
<a name="ln4025">DEFUN (test_igmp_receive_report,</a>
<a name="ln4026">       test_igmp_receive_report_cmd,</a>
<a name="ln4027">       &quot;test igmp receive report &lt;0-65535&gt; A.B.C.D &lt;1-6&gt; .LINE&quot;,</a>
<a name="ln4028">       &quot;Test\n&quot;</a>
<a name="ln4029">       &quot;Test IGMP protocol\n&quot;</a>
<a name="ln4030">       &quot;Test IGMP message\n&quot;</a>
<a name="ln4031">       &quot;Test IGMP report\n&quot;</a>
<a name="ln4032">       &quot;Socket\n&quot;</a>
<a name="ln4033">       &quot;IGMP group address\n&quot;</a>
<a name="ln4034">       &quot;Record type\n&quot;</a>
<a name="ln4035">       &quot;Sources\n&quot;)</a>
<a name="ln4036">{</a>
<a name="ln4037">  char              buf[1000];</a>
<a name="ln4038">  char             *igmp_msg;</a>
<a name="ln4039">  struct ip        *ip_hdr;</a>
<a name="ln4040">  size_t            ip_hlen; /* ip header length in bytes */</a>
<a name="ln4041">  int               ip_msg_len;</a>
<a name="ln4042">  int               igmp_msg_len;</a>
<a name="ln4043">  const char       *socket;</a>
<a name="ln4044">  int               socket_fd;</a>
<a name="ln4045">  const char       *grp_str;</a>
<a name="ln4046">  struct in_addr    grp_addr;</a>
<a name="ln4047">  const char       *record_type_str;</a>
<a name="ln4048">  int               record_type;</a>
<a name="ln4049">  const char       *src_str;</a>
<a name="ln4050">  int               result;</a>
<a name="ln4051">  struct igmp_sock *igmp;</a>
<a name="ln4052">  char             *group_record;</a>
<a name="ln4053">  int               num_sources;</a>
<a name="ln4054">  struct in_addr   *sources;</a>
<a name="ln4055">  struct in_addr   *src_addr;</a>
<a name="ln4056">  int               argi;</a>
<a name="ln4057"> </a>
<a name="ln4058">  socket = argv[0];</a>
<a name="ln4059">  socket_fd = atoi(socket);</a>
<a name="ln4060">  igmp = find_igmp_sock_by_fd(socket_fd);</a>
<a name="ln4061">  if (!igmp) {</a>
<a name="ln4062">    vty_out(vty, &quot;Could not find IGMP socket %s: fd=%d%s&quot;,</a>
<a name="ln4063">	    socket, socket_fd, VTY_NEWLINE);</a>
<a name="ln4064">    return CMD_WARNING;</a>
<a name="ln4065">  }</a>
<a name="ln4066"> </a>
<a name="ln4067">  grp_str = argv[1];</a>
<a name="ln4068">  result = inet_pton(AF_INET, grp_str, &amp;grp_addr);</a>
<a name="ln4069">  if (result &lt;= 0) {</a>
<a name="ln4070">    vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4071">	    grp_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4072">    return CMD_WARNING;</a>
<a name="ln4073">  }</a>
<a name="ln4074"> </a>
<a name="ln4075">  record_type_str = argv[2];</a>
<a name="ln4076">  record_type = atoi(record_type_str);</a>
<a name="ln4077"> </a>
<a name="ln4078">  /*</a>
<a name="ln4079">    Tweak IP header</a>
<a name="ln4080">   */</a>
<a name="ln4081">  ip_hdr = (struct ip *) buf;</a>
<a name="ln4082">  ip_hdr-&gt;ip_p = PIM_IP_PROTO_IGMP;</a>
<a name="ln4083">  ip_hlen = PIM_IP_HEADER_MIN_LEN; /* ip header length in bytes */</a>
<a name="ln4084">  ip_hdr-&gt;ip_hl = ip_hlen &gt;&gt; 2;    /* ip header length in 4-byte words */</a>
<a name="ln4085">  ip_hdr-&gt;ip_src = igmp-&gt;ifaddr;</a>
<a name="ln4086">  ip_hdr-&gt;ip_dst = igmp-&gt;ifaddr;</a>
<a name="ln4087"> </a>
<a name="ln4088">  /*</a>
<a name="ln4089">    Build IGMP v3 report message</a>
<a name="ln4090">   */</a>
<a name="ln4091">  igmp_msg = buf + ip_hlen;</a>
<a name="ln4092">  group_record = igmp_msg + IGMP_V3_REPORT_GROUPPRECORD_OFFSET;</a>
<a name="ln4093">  *igmp_msg = PIM_IGMP_V3_MEMBERSHIP_REPORT; /* type */</a>
<a name="ln4094">  *(uint16_t *)      (igmp_msg + IGMP_V3_CHECKSUM_OFFSET) = 0; /* for computing checksum */</a>
<a name="ln4095">  *(uint16_t *)      (igmp_msg + IGMP_V3_REPORT_NUMGROUPS_OFFSET) = htons(1); /* one group record */</a>
<a name="ln4096">  *(uint8_t  *)      (group_record + IGMP_V3_GROUP_RECORD_TYPE_OFFSET) = record_type;</a>
<a name="ln4097">  memcpy(group_record + IGMP_V3_GROUP_RECORD_GROUP_OFFSET, &amp;grp_addr, sizeof(struct in_addr));</a>
<a name="ln4098"> </a>
<a name="ln4099">  /* Scan LINE sources */</a>
<a name="ln4100">  sources = (struct in_addr *) (group_record + IGMP_V3_GROUP_RECORD_SOURCE_OFFSET);</a>
<a name="ln4101">  src_addr = sources;</a>
<a name="ln4102">  for (argi = 3; argi &lt; argc; ++argi,++src_addr) {</a>
<a name="ln4103">    src_str = argv[argi];</a>
<a name="ln4104">    result = inet_pton(AF_INET, src_str, src_addr);</a>
<a name="ln4105">    if (result &lt;= 0) {</a>
<a name="ln4106">      vty_out(vty, &quot;Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4107">	      src_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4108">      return CMD_WARNING;</a>
<a name="ln4109">    }</a>
<a name="ln4110">  }</a>
<a name="ln4111">  num_sources = src_addr - sources;</a>
<a name="ln4112"> </a>
<a name="ln4113">  *(uint16_t *)(group_record + IGMP_V3_GROUP_RECORD_NUMSOURCES_OFFSET) = htons(num_sources);</a>
<a name="ln4114"> </a>
<a name="ln4115">  igmp_msg_len = IGMP_V3_MSG_MIN_SIZE + (num_sources &lt;&lt; 4);   /* v3 report for one single group record */</a>
<a name="ln4116"> </a>
<a name="ln4117">  /* compute checksum */</a>
<a name="ln4118">  *(uint16_t *)(igmp_msg + IGMP_V3_CHECKSUM_OFFSET) = in_cksum(igmp_msg, igmp_msg_len);</a>
<a name="ln4119"> </a>
<a name="ln4120">  /* &quot;receive&quot; message */</a>
<a name="ln4121"> </a>
<a name="ln4122">  ip_msg_len = ip_hlen + igmp_msg_len;</a>
<a name="ln4123">  result = pim_igmp_packet(igmp, buf, ip_msg_len);</a>
<a name="ln4124">  if (result) {</a>
<a name="ln4125">    vty_out(vty, &quot;pim_igmp_packet(len=%d) returned: %d%s&quot;,</a>
<a name="ln4126">	    ip_msg_len, result, VTY_NEWLINE);</a>
<a name="ln4127">    return CMD_WARNING;</a>
<a name="ln4128">  }</a>
<a name="ln4129"> </a>
<a name="ln4130">  return CMD_SUCCESS;</a>
<a name="ln4131">}</a>
<a name="ln4132"> </a>
<a name="ln4133">static int hexval(uint8_t ch)</a>
<a name="ln4134">{</a>
<a name="ln4135">  return isdigit(ch) ? (ch - '0') : (10 + tolower(ch) - 'a');</a>
<a name="ln4136">}</a>
<a name="ln4137"> </a>
<a name="ln4138">DEFUN (test_pim_receive_dump,</a>
<a name="ln4139">       test_pim_receive_dump_cmd,</a>
<a name="ln4140">       &quot;test pim receive dump INTERFACE A.B.C.D .LINE&quot;,</a>
<a name="ln4141">       &quot;Test\n&quot;</a>
<a name="ln4142">       &quot;Test PIM protocol\n&quot;</a>
<a name="ln4143">       &quot;Test PIM message reception\n&quot;</a>
<a name="ln4144">       &quot;Test PIM packet dump reception from neighbor\n&quot;</a>
<a name="ln4145">       &quot;Interface\n&quot;</a>
<a name="ln4146">       &quot;Neighbor address\n&quot;</a>
<a name="ln4147">       &quot;Packet dump\n&quot;)</a>
<a name="ln4148">{</a>
<a name="ln4149">  uint8_t           buf[1000];</a>
<a name="ln4150">  uint8_t          *pim_msg;</a>
<a name="ln4151">  struct ip        *ip_hdr;</a>
<a name="ln4152">  size_t            ip_hlen; /* ip header length in bytes */</a>
<a name="ln4153">  int               ip_msg_len;</a>
<a name="ln4154">  int               pim_msg_size;</a>
<a name="ln4155">  const char       *neigh_str;</a>
<a name="ln4156">  struct in_addr    neigh_addr;</a>
<a name="ln4157">  const char       *ifname;</a>
<a name="ln4158">  struct interface *ifp;</a>
<a name="ln4159">  int               argi;</a>
<a name="ln4160">  int               result;</a>
<a name="ln4161"> </a>
<a name="ln4162">  /* Find interface */</a>
<a name="ln4163">  ifname = argv[0];</a>
<a name="ln4164">  ifp = if_lookup_by_name(ifname);</a>
<a name="ln4165">  if (!ifp) {</a>
<a name="ln4166">    vty_out(vty, &quot;No such interface name %s%s&quot;,</a>
<a name="ln4167">	    ifname, VTY_NEWLINE);</a>
<a name="ln4168">    return CMD_WARNING;</a>
<a name="ln4169">  }</a>
<a name="ln4170"> </a>
<a name="ln4171">  /* Neighbor address */</a>
<a name="ln4172">  neigh_str = argv[1];</a>
<a name="ln4173">  result = inet_pton(AF_INET, neigh_str, &amp;neigh_addr);</a>
<a name="ln4174">  if (result &lt;= 0) {</a>
<a name="ln4175">    vty_out(vty, &quot;Bad neighbor address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4176">	    neigh_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4177">    return CMD_WARNING;</a>
<a name="ln4178">  }</a>
<a name="ln4179"> </a>
<a name="ln4180">  /*</a>
<a name="ln4181">    Tweak IP header</a>
<a name="ln4182">   */</a>
<a name="ln4183">  ip_hdr = (struct ip *) buf;</a>
<a name="ln4184">  ip_hdr-&gt;ip_p = PIM_IP_PROTO_PIM;</a>
<a name="ln4185">  ip_hlen = PIM_IP_HEADER_MIN_LEN; /* ip header length in bytes */</a>
<a name="ln4186">  ip_hdr-&gt;ip_hl = ip_hlen &gt;&gt; 2;    /* ip header length in 4-byte words */</a>
<a name="ln4187">  ip_hdr-&gt;ip_src = neigh_addr;</a>
<a name="ln4188">  ip_hdr-&gt;ip_dst = qpim_all_pim_routers_addr;</a>
<a name="ln4189"> </a>
<a name="ln4190">  /*</a>
<a name="ln4191">    Build PIM hello message</a>
<a name="ln4192">  */</a>
<a name="ln4193">  pim_msg = buf + ip_hlen;</a>
<a name="ln4194">  pim_msg_size = 0;</a>
<a name="ln4195"> </a>
<a name="ln4196">  /* Scan LINE dump into buffer */</a>
<a name="ln4197">  for (argi = 2; argi &lt; argc; ++argi) {</a>
<a name="ln4198">    const char *str = argv[argi];</a>
<a name="ln4199">    int str_len = strlen(str);</a>
<a name="ln4200">    int str_last = str_len - 1;</a>
<a name="ln4201">    int i;</a>
<a name="ln4202"> </a>
<a name="ln4203">    if (str_len % 2) {</a>
<a name="ln4204">      vty_out(vty, &quot;%% Uneven hex array arg %d=%s%s&quot;,</a>
<a name="ln4205">	      argi, str, VTY_NEWLINE);</a>
<a name="ln4206">      return CMD_WARNING;</a>
<a name="ln4207">    }</a>
<a name="ln4208"> </a>
<a name="ln4209">    for (i = 0; i &lt; str_last; i += 2) {</a>
<a name="ln4210">      uint8_t octet;</a>
<a name="ln4211">      int left;</a>
<a name="ln4212">      uint8_t h1 = str[i];</a>
<a name="ln4213">      uint8_t h2 = str[i + 1];</a>
<a name="ln4214"> </a>
<a name="ln4215">      if (!isxdigit(h1) || !isxdigit(h2)) {</a>
<a name="ln4216">	vty_out(vty, &quot;%% Non-hex octet %c%c at hex array arg %d=%s%s&quot;,</a>
<a name="ln4217">		h1, h2, argi, str, VTY_NEWLINE);</a>
<a name="ln4218">	return CMD_WARNING;</a>
<a name="ln4219">      }</a>
<a name="ln4220">      octet = (hexval(h1) &lt;&lt; 4) + hexval(h2);</a>
<a name="ln4221"> </a>
<a name="ln4222">      left = sizeof(buf) - ip_hlen - pim_msg_size;</a>
<a name="ln4223">      if (left &lt; 1) {</a>
<a name="ln4224">	vty_out(vty, &quot;%% Overflow buf_size=%zu buf_left=%d at hex array arg %d=%s octet %02x%s&quot;,</a>
<a name="ln4225">		sizeof(buf), left, argi, str, octet, VTY_NEWLINE);</a>
<a name="ln4226">	return CMD_WARNING;</a>
<a name="ln4227">      }</a>
<a name="ln4228">      </a>
<a name="ln4229">      pim_msg[pim_msg_size++] = octet;</a>
<a name="ln4230">    }</a>
<a name="ln4231">  }</a>
<a name="ln4232"> </a>
<a name="ln4233">  ip_msg_len = ip_hlen + pim_msg_size;</a>
<a name="ln4234"> </a>
<a name="ln4235">  vty_out(vty, &quot;Receiving: buf_size=%zu ip_msg_size=%d pim_msg_size=%d%s&quot;,</a>
<a name="ln4236">	  sizeof(buf), ip_msg_len, pim_msg_size, VTY_NEWLINE);</a>
<a name="ln4237"> </a>
<a name="ln4238">  /* &quot;receive&quot; message */</a>
<a name="ln4239"> </a>
<a name="ln4240">  result = pim_pim_packet(ifp, buf, ip_msg_len);</a>
<a name="ln4241">  if (result) {</a>
<a name="ln4242">    vty_out(vty, &quot;%% pim_pim_packet(len=%d) returned failure: %d%s&quot;,</a>
<a name="ln4243">	    ip_msg_len, result, VTY_NEWLINE);</a>
<a name="ln4244">    return CMD_WARNING;</a>
<a name="ln4245">  }</a>
<a name="ln4246"> </a>
<a name="ln4247">  return CMD_SUCCESS;</a>
<a name="ln4248">}</a>
<a name="ln4249"> </a>
<a name="ln4250">DEFUN (test_pim_receive_hello,</a>
<a name="ln4251">       test_pim_receive_hello_cmd,</a>
<a name="ln4252">       &quot;test pim receive hello INTERFACE A.B.C.D &lt;0-65535&gt; &lt;0-65535&gt; &lt;0-65535&gt; &lt;0-32767&gt; &lt;0-65535&gt; &lt;0-1&gt;[LINE]&quot;,</a>
<a name="ln4253">       &quot;Test\n&quot;</a>
<a name="ln4254">       &quot;Test PIM protocol\n&quot;</a>
<a name="ln4255">       &quot;Test PIM message reception\n&quot;</a>
<a name="ln4256">       &quot;Test PIM hello reception from neighbor\n&quot;</a>
<a name="ln4257">       &quot;Interface\n&quot;</a>
<a name="ln4258">       &quot;Neighbor address\n&quot;</a>
<a name="ln4259">       &quot;Neighbor holdtime\n&quot;</a>
<a name="ln4260">       &quot;Neighbor DR priority\n&quot;</a>
<a name="ln4261">       &quot;Neighbor generation ID\n&quot;</a>
<a name="ln4262">       &quot;Neighbor propagation delay (msec)\n&quot;</a>
<a name="ln4263">       &quot;Neighbor override interval (msec)\n&quot;</a>
<a name="ln4264">       &quot;Neighbor LAN prune delay T-bit\n&quot;</a>
<a name="ln4265">       &quot;Neighbor secondary addresses\n&quot;)</a>
<a name="ln4266">{</a>
<a name="ln4267">  uint8_t           buf[1000];</a>
<a name="ln4268">  uint8_t          *pim_msg;</a>
<a name="ln4269">  struct ip        *ip_hdr;</a>
<a name="ln4270">  size_t            ip_hlen; /* ip header length in bytes */</a>
<a name="ln4271">  int               ip_msg_len;</a>
<a name="ln4272">  int               pim_tlv_size;</a>
<a name="ln4273">  int               pim_msg_size;</a>
<a name="ln4274">  const char       *neigh_str;</a>
<a name="ln4275">  struct in_addr    neigh_addr;</a>
<a name="ln4276">  const char       *ifname;</a>
<a name="ln4277">  struct interface *ifp;</a>
<a name="ln4278">  uint16_t          neigh_holdtime;</a>
<a name="ln4279">  uint16_t          neigh_propagation_delay;</a>
<a name="ln4280">  uint16_t          neigh_override_interval;</a>
<a name="ln4281">  int               neigh_can_disable_join_suppression;</a>
<a name="ln4282">  uint32_t          neigh_dr_priority;</a>
<a name="ln4283">  uint32_t          neigh_generation_id;</a>
<a name="ln4284">  int               argi;</a>
<a name="ln4285">  int               result;</a>
<a name="ln4286"> </a>
<a name="ln4287">  /* Find interface */</a>
<a name="ln4288">  ifname = argv[0];</a>
<a name="ln4289">  ifp = if_lookup_by_name(ifname);</a>
<a name="ln4290">  if (!ifp) {</a>
<a name="ln4291">    vty_out(vty, &quot;No such interface name %s%s&quot;,</a>
<a name="ln4292">	    ifname, VTY_NEWLINE);</a>
<a name="ln4293">    return CMD_WARNING;</a>
<a name="ln4294">  }</a>
<a name="ln4295"> </a>
<a name="ln4296">  /* Neighbor address */</a>
<a name="ln4297">  neigh_str = argv[1];</a>
<a name="ln4298">  result = inet_pton(AF_INET, neigh_str, &amp;neigh_addr);</a>
<a name="ln4299">  if (result &lt;= 0) {</a>
<a name="ln4300">    vty_out(vty, &quot;Bad neighbor address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4301">	    neigh_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4302">    return CMD_WARNING;</a>
<a name="ln4303">  }</a>
<a name="ln4304"> </a>
<a name="ln4305">  neigh_holdtime                     = atoi(argv[2]);</a>
<a name="ln4306">  neigh_dr_priority                  = atoi(argv[3]);</a>
<a name="ln4307">  neigh_generation_id                = atoi(argv[4]);</a>
<a name="ln4308">  neigh_propagation_delay            = atoi(argv[5]);</a>
<a name="ln4309">  neigh_override_interval            = atoi(argv[6]);</a>
<a name="ln4310">  neigh_can_disable_join_suppression = atoi(argv[7]);</a>
<a name="ln4311"> </a>
<a name="ln4312">  /*</a>
<a name="ln4313">    Tweak IP header</a>
<a name="ln4314">   */</a>
<a name="ln4315">  ip_hdr = (struct ip *) buf;</a>
<a name="ln4316">  ip_hdr-&gt;ip_p = PIM_IP_PROTO_PIM;</a>
<a name="ln4317">  ip_hlen = PIM_IP_HEADER_MIN_LEN; /* ip header length in bytes */</a>
<a name="ln4318">  ip_hdr-&gt;ip_hl = ip_hlen &gt;&gt; 2;    /* ip header length in 4-byte words */</a>
<a name="ln4319">  ip_hdr-&gt;ip_src = neigh_addr;</a>
<a name="ln4320">  ip_hdr-&gt;ip_dst = qpim_all_pim_routers_addr;</a>
<a name="ln4321"> </a>
<a name="ln4322">  /*</a>
<a name="ln4323">    Build PIM hello message</a>
<a name="ln4324">  */</a>
<a name="ln4325">  pim_msg = buf + ip_hlen;</a>
<a name="ln4326"> </a>
<a name="ln4327">  /* Scan LINE addresses */</a>
<a name="ln4328">  for (argi = 8; argi &lt; argc; ++argi) {</a>
<a name="ln4329">    const char *sec_str = argv[argi];</a>
<a name="ln4330">    struct in_addr sec_addr;</a>
<a name="ln4331">    result = inet_pton(AF_INET, sec_str, &amp;sec_addr);</a>
<a name="ln4332">    if (result &lt;= 0) {</a>
<a name="ln4333">      vty_out(vty, &quot;Bad neighbor secondary address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4334">	      sec_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4335">      return CMD_WARNING;</a>
<a name="ln4336">    }</a>
<a name="ln4337"> </a>
<a name="ln4338">    vty_out(vty,</a>
<a name="ln4339">	    &quot;FIXME WRITEME consider neighbor secondary address %s%s&quot;,</a>
<a name="ln4340">	    sec_str, VTY_NEWLINE);</a>
<a name="ln4341">  }</a>
<a name="ln4342"> </a>
<a name="ln4343">  pim_tlv_size = pim_hello_build_tlv(ifp-&gt;name,</a>
<a name="ln4344">				     pim_msg + PIM_PIM_MIN_LEN,</a>
<a name="ln4345">				     sizeof(buf) - ip_hlen - PIM_PIM_MIN_LEN,</a>
<a name="ln4346">				     neigh_holdtime,</a>
<a name="ln4347">				     neigh_dr_priority,</a>
<a name="ln4348">				     neigh_generation_id,</a>
<a name="ln4349">				     neigh_propagation_delay,</a>
<a name="ln4350">				     neigh_override_interval,</a>
<a name="ln4351">				     neigh_can_disable_join_suppression,</a>
<a name="ln4352">				     0 /* FIXME secondary address list */);</a>
<a name="ln4353">  if (pim_tlv_size &lt; 0) {</a>
<a name="ln4354">    vty_out(vty, &quot;pim_hello_build_tlv() returned failure: %d%s&quot;,</a>
<a name="ln4355">	    pim_tlv_size, VTY_NEWLINE);</a>
<a name="ln4356">    return CMD_WARNING;</a>
<a name="ln4357">  }</a>
<a name="ln4358"> </a>
<a name="ln4359">  pim_msg_size = pim_tlv_size + PIM_PIM_MIN_LEN;</a>
<a name="ln4360"> </a>
<a name="ln4361">  pim_msg_build_header(pim_msg, pim_msg_size,</a>
<a name="ln4362">		       PIM_MSG_TYPE_HELLO);</a>
<a name="ln4363"> </a>
<a name="ln4364">  /* &quot;receive&quot; message */</a>
<a name="ln4365"> </a>
<a name="ln4366">  ip_msg_len = ip_hlen + pim_msg_size;</a>
<a name="ln4367">  result = pim_pim_packet(ifp, buf, ip_msg_len);</a>
<a name="ln4368">  if (result) {</a>
<a name="ln4369">    vty_out(vty, &quot;pim_pim_packet(len=%d) returned failure: %d%s&quot;,</a>
<a name="ln4370">	    ip_msg_len, result, VTY_NEWLINE);</a>
<a name="ln4371">    return CMD_WARNING;</a>
<a name="ln4372">  }</a>
<a name="ln4373"> </a>
<a name="ln4374">  return CMD_SUCCESS;</a>
<a name="ln4375">}</a>
<a name="ln4376"> </a>
<a name="ln4377">DEFUN (test_pim_receive_assert,</a>
<a name="ln4378">       test_pim_receive_assert_cmd,</a>
<a name="ln4379">       &quot;test pim receive assert INTERFACE A.B.C.D A.B.C.D A.B.C.D &lt;0-65535&gt; &lt;0-65535&gt; &lt;0-1&gt;&quot;,</a>
<a name="ln4380">       &quot;Test\n&quot;</a>
<a name="ln4381">       &quot;Test PIM protocol\n&quot;</a>
<a name="ln4382">       &quot;Test PIM message reception\n&quot;</a>
<a name="ln4383">       &quot;Test reception of PIM assert\n&quot;</a>
<a name="ln4384">       &quot;Interface\n&quot;</a>
<a name="ln4385">       &quot;Neighbor address\n&quot;</a>
<a name="ln4386">       &quot;Assert multicast group address\n&quot;</a>
<a name="ln4387">       &quot;Assert unicast source address\n&quot;</a>
<a name="ln4388">       &quot;Assert metric preference\n&quot;</a>
<a name="ln4389">       &quot;Assert route metric\n&quot;</a>
<a name="ln4390">       &quot;Assert RPT bit flag\n&quot;)</a>
<a name="ln4391">{</a>
<a name="ln4392">  uint8_t           buf[1000];</a>
<a name="ln4393">  uint8_t          *buf_pastend = buf + sizeof(buf);</a>
<a name="ln4394">  uint8_t          *pim_msg;</a>
<a name="ln4395">  struct ip        *ip_hdr;</a>
<a name="ln4396">  size_t            ip_hlen; /* ip header length in bytes */</a>
<a name="ln4397">  int               ip_msg_len;</a>
<a name="ln4398">  int               pim_msg_size;</a>
<a name="ln4399">  const char       *neigh_str;</a>
<a name="ln4400">  struct in_addr    neigh_addr;</a>
<a name="ln4401">  const char       *group_str;</a>
<a name="ln4402">  struct in_addr    group_addr;</a>
<a name="ln4403">  const char       *source_str;</a>
<a name="ln4404">  struct in_addr    source_addr;</a>
<a name="ln4405">  const char       *ifname;</a>
<a name="ln4406">  struct interface *ifp;</a>
<a name="ln4407">  uint32_t          assert_metric_preference;</a>
<a name="ln4408">  uint32_t          assert_route_metric;</a>
<a name="ln4409">  uint32_t          assert_rpt_bit_flag;</a>
<a name="ln4410">  int               remain;</a>
<a name="ln4411">  int               result;</a>
<a name="ln4412"> </a>
<a name="ln4413">  /* Find interface */</a>
<a name="ln4414">  ifname = argv[0];</a>
<a name="ln4415">  ifp = if_lookup_by_name(ifname);</a>
<a name="ln4416">  if (!ifp) {</a>
<a name="ln4417">    vty_out(vty, &quot;No such interface name %s%s&quot;,</a>
<a name="ln4418">	    ifname, VTY_NEWLINE);</a>
<a name="ln4419">    return CMD_WARNING;</a>
<a name="ln4420">  }</a>
<a name="ln4421"> </a>
<a name="ln4422">  /* Neighbor address */</a>
<a name="ln4423">  neigh_str = argv[1];</a>
<a name="ln4424">  result = inet_pton(AF_INET, neigh_str, &amp;neigh_addr);</a>
<a name="ln4425">  if (result &lt;= 0) {</a>
<a name="ln4426">    vty_out(vty, &quot;Bad neighbor address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4427">	    neigh_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4428">    return CMD_WARNING;</a>
<a name="ln4429">  }</a>
<a name="ln4430"> </a>
<a name="ln4431">  /* Group address */</a>
<a name="ln4432">  group_str = argv[2];</a>
<a name="ln4433">  result = inet_pton(AF_INET, group_str, &amp;group_addr);</a>
<a name="ln4434">  if (result &lt;= 0) {</a>
<a name="ln4435">    vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4436">	    group_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4437">    return CMD_WARNING;</a>
<a name="ln4438">  }</a>
<a name="ln4439"> </a>
<a name="ln4440">  /* Source address */</a>
<a name="ln4441">  source_str = argv[3];</a>
<a name="ln4442">  result = inet_pton(AF_INET, source_str, &amp;source_addr);</a>
<a name="ln4443">  if (result &lt;= 0) {</a>
<a name="ln4444">    vty_out(vty, &quot;Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4445">	    source_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4446">    return CMD_WARNING;</a>
<a name="ln4447">  }</a>
<a name="ln4448"> </a>
<a name="ln4449">  assert_metric_preference = atoi(argv[4]);</a>
<a name="ln4450">  assert_route_metric      = atoi(argv[5]);</a>
<a name="ln4451">  assert_rpt_bit_flag      = atoi(argv[6]);</a>
<a name="ln4452"> </a>
<a name="ln4453">  remain = buf_pastend - buf;</a>
<a name="ln4454">  if (remain &lt; (int) sizeof(struct ip)) {</a>
<a name="ln4455">    vty_out(vty, &quot;No room for ip header: buf_size=%d &lt; ip_header_size=%zu%s&quot;,</a>
<a name="ln4456">	    remain, sizeof(struct ip), VTY_NEWLINE);</a>
<a name="ln4457">    return CMD_WARNING;</a>
<a name="ln4458">  }</a>
<a name="ln4459"> </a>
<a name="ln4460">  /*</a>
<a name="ln4461">    Tweak IP header</a>
<a name="ln4462">   */</a>
<a name="ln4463">  ip_hdr = (struct ip *) buf;</a>
<a name="ln4464">  ip_hdr-&gt;ip_p = PIM_IP_PROTO_PIM;</a>
<a name="ln4465">  ip_hlen = PIM_IP_HEADER_MIN_LEN; /* ip header length in bytes */</a>
<a name="ln4466">  ip_hdr-&gt;ip_hl = ip_hlen &gt;&gt; 2;    /* ip header length in 4-byte words */</a>
<a name="ln4467">  ip_hdr-&gt;ip_src = neigh_addr;</a>
<a name="ln4468">  ip_hdr-&gt;ip_dst = qpim_all_pim_routers_addr;</a>
<a name="ln4469"> </a>
<a name="ln4470">  /*</a>
<a name="ln4471">    Build PIM assert message</a>
<a name="ln4472">  */</a>
<a name="ln4473">  pim_msg = buf + ip_hlen; /* skip ip header */</a>
<a name="ln4474"> </a>
<a name="ln4475">  pim_msg_size = pim_assert_build_msg(pim_msg, buf_pastend - pim_msg, ifp,</a>
<a name="ln4476">				      group_addr, source_addr,</a>
<a name="ln4477">				      assert_metric_preference,</a>
<a name="ln4478">				      assert_route_metric,</a>
<a name="ln4479">				      assert_rpt_bit_flag);</a>
<a name="ln4480">  if (pim_msg_size &lt; 0) {</a>
<a name="ln4481">    vty_out(vty, &quot;Failure building PIM assert message: size=%d%s&quot;,</a>
<a name="ln4482">	    pim_msg_size, VTY_NEWLINE);</a>
<a name="ln4483">    return CMD_WARNING;</a>
<a name="ln4484">  }</a>
<a name="ln4485"> </a>
<a name="ln4486">  /* &quot;receive&quot; message */</a>
<a name="ln4487"> </a>
<a name="ln4488">  ip_msg_len = ip_hlen + pim_msg_size;</a>
<a name="ln4489">  result = pim_pim_packet(ifp, buf, ip_msg_len);</a>
<a name="ln4490">  if (result) {</a>
<a name="ln4491">    vty_out(vty, &quot;pim_pim_packet(len=%d) returned failure: %d%s&quot;,</a>
<a name="ln4492">	    ip_msg_len, result, VTY_NEWLINE);</a>
<a name="ln4493">    return CMD_WARNING;</a>
<a name="ln4494">  }</a>
<a name="ln4495"> </a>
<a name="ln4496">  return CMD_SUCCESS;</a>
<a name="ln4497">}</a>
<a name="ln4498"> </a>
<a name="ln4499">static int recv_joinprune(struct vty *vty,</a>
<a name="ln4500">			  const char *argv[],</a>
<a name="ln4501">			  int src_is_join)</a>
<a name="ln4502">{</a>
<a name="ln4503">  uint8_t           buf[1000];</a>
<a name="ln4504">  const uint8_t    *buf_pastend = buf + sizeof(buf);</a>
<a name="ln4505">  uint8_t          *pim_msg;</a>
<a name="ln4506">  uint8_t          *pim_msg_curr;</a>
<a name="ln4507">  int               pim_msg_size;</a>
<a name="ln4508">  struct ip        *ip_hdr;</a>
<a name="ln4509">  size_t            ip_hlen; /* ip header length in bytes */</a>
<a name="ln4510">  int               ip_msg_len;</a>
<a name="ln4511">  uint16_t          neigh_holdtime;</a>
<a name="ln4512">  const char       *neigh_dst_str;</a>
<a name="ln4513">  struct in_addr    neigh_dst_addr;</a>
<a name="ln4514">  const char       *neigh_src_str;</a>
<a name="ln4515">  struct in_addr    neigh_src_addr;</a>
<a name="ln4516">  const char       *group_str;</a>
<a name="ln4517">  struct in_addr    group_addr;</a>
<a name="ln4518">  const char       *source_str;</a>
<a name="ln4519">  struct in_addr    source_addr;</a>
<a name="ln4520">  const char       *ifname;</a>
<a name="ln4521">  struct interface *ifp;</a>
<a name="ln4522">  int               result;</a>
<a name="ln4523">  int               remain;</a>
<a name="ln4524">  uint16_t          num_joined;</a>
<a name="ln4525">  uint16_t          num_pruned;</a>
<a name="ln4526"> </a>
<a name="ln4527">  /* Find interface */</a>
<a name="ln4528">  ifname = argv[0];</a>
<a name="ln4529">  ifp = if_lookup_by_name(ifname);</a>
<a name="ln4530">  if (!ifp) {</a>
<a name="ln4531">    vty_out(vty, &quot;No such interface name %s%s&quot;,</a>
<a name="ln4532">	    ifname, VTY_NEWLINE);</a>
<a name="ln4533">    return CMD_WARNING;</a>
<a name="ln4534">  }</a>
<a name="ln4535"> </a>
<a name="ln4536">  neigh_holdtime = atoi(argv[1]);</a>
<a name="ln4537"> </a>
<a name="ln4538">  /* Neighbor destination address */</a>
<a name="ln4539">  neigh_dst_str = argv[2];</a>
<a name="ln4540">  result = inet_pton(AF_INET, neigh_dst_str, &amp;neigh_dst_addr);</a>
<a name="ln4541">  if (result &lt;= 0) {</a>
<a name="ln4542">    vty_out(vty, &quot;Bad neighbor destination address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4543">	    neigh_dst_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4544">    return CMD_WARNING;</a>
<a name="ln4545">  }</a>
<a name="ln4546"> </a>
<a name="ln4547">  /* Neighbor source address */</a>
<a name="ln4548">  neigh_src_str = argv[3];</a>
<a name="ln4549">  result = inet_pton(AF_INET, neigh_src_str, &amp;neigh_src_addr);</a>
<a name="ln4550">  if (result &lt;= 0) {</a>
<a name="ln4551">    vty_out(vty, &quot;Bad neighbor source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4552">	    neigh_src_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4553">    return CMD_WARNING;</a>
<a name="ln4554">  }</a>
<a name="ln4555"> </a>
<a name="ln4556">  /* Multicast group address */</a>
<a name="ln4557">  group_str = argv[4];</a>
<a name="ln4558">  result = inet_pton(AF_INET, group_str, &amp;group_addr);</a>
<a name="ln4559">  if (result &lt;= 0) {</a>
<a name="ln4560">    vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4561">	    group_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4562">    return CMD_WARNING;</a>
<a name="ln4563">  }</a>
<a name="ln4564"> </a>
<a name="ln4565">  /* Multicast source address */</a>
<a name="ln4566">  source_str = argv[5];</a>
<a name="ln4567">  result = inet_pton(AF_INET, source_str, &amp;source_addr);</a>
<a name="ln4568">  if (result &lt;= 0) {</a>
<a name="ln4569">    vty_out(vty, &quot;Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4570">	    source_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4571">    return CMD_WARNING;</a>
<a name="ln4572">  }</a>
<a name="ln4573"> </a>
<a name="ln4574">  /*</a>
<a name="ln4575">    Tweak IP header</a>
<a name="ln4576">   */</a>
<a name="ln4577">  ip_hdr = (struct ip *) buf;</a>
<a name="ln4578">  ip_hdr-&gt;ip_p = PIM_IP_PROTO_PIM;</a>
<a name="ln4579">  ip_hlen = PIM_IP_HEADER_MIN_LEN; /* ip header length in bytes */</a>
<a name="ln4580">  ip_hdr-&gt;ip_hl = ip_hlen &gt;&gt; 2;    /* ip header length in 4-byte words */</a>
<a name="ln4581">  ip_hdr-&gt;ip_src = neigh_src_addr;</a>
<a name="ln4582">  ip_hdr-&gt;ip_dst = qpim_all_pim_routers_addr;</a>
<a name="ln4583"> </a>
<a name="ln4584">  /*</a>
<a name="ln4585">    Build PIM message</a>
<a name="ln4586">  */</a>
<a name="ln4587">  pim_msg = buf + ip_hlen;</a>
<a name="ln4588"> </a>
<a name="ln4589">  /* skip room for pim header */</a>
<a name="ln4590">  pim_msg_curr = pim_msg + PIM_MSG_HEADER_LEN;</a>
<a name="ln4591"> </a>
<a name="ln4592">  remain = buf_pastend - pim_msg_curr;</a>
<a name="ln4593">  pim_msg_curr = pim_msg_addr_encode_ipv4_ucast(pim_msg_curr,</a>
<a name="ln4594">						remain,</a>
<a name="ln4595">						neigh_dst_addr);</a>
<a name="ln4596">  if (!pim_msg_curr) {</a>
<a name="ln4597">    vty_out(vty, &quot;Failure encoding destination address %s: space left=%d%s&quot;,</a>
<a name="ln4598">	    neigh_dst_str, remain, VTY_NEWLINE);</a>
<a name="ln4599">    return CMD_WARNING;</a>
<a name="ln4600">  }</a>
<a name="ln4601"> </a>
<a name="ln4602">  remain = buf_pastend - pim_msg_curr;</a>
<a name="ln4603">  if (remain &lt; 4) {</a>
<a name="ln4604">    vty_out(vty, &quot;Group will not fit: space left=%d%s&quot;,</a>
<a name="ln4605">	    remain, VTY_NEWLINE);</a>
<a name="ln4606">    return CMD_WARNING;</a>
<a name="ln4607">  }</a>
<a name="ln4608"> </a>
<a name="ln4609">  *pim_msg_curr = 0; /* reserved */</a>
<a name="ln4610">  ++pim_msg_curr;</a>
<a name="ln4611">  *pim_msg_curr = 1; /* number of groups */</a>
<a name="ln4612">  ++pim_msg_curr;</a>
<a name="ln4613">  *((uint16_t *) pim_msg_curr) = htons(neigh_holdtime);</a>
<a name="ln4614">  ++pim_msg_curr;</a>
<a name="ln4615">  ++pim_msg_curr;</a>
<a name="ln4616"> </a>
<a name="ln4617">  remain = buf_pastend - pim_msg_curr;</a>
<a name="ln4618">  pim_msg_curr = pim_msg_addr_encode_ipv4_group(pim_msg_curr,</a>
<a name="ln4619">						remain,</a>
<a name="ln4620">						group_addr);</a>
<a name="ln4621">  if (!pim_msg_curr) {</a>
<a name="ln4622">    vty_out(vty, &quot;Failure encoding group address %s: space left=%d%s&quot;,</a>
<a name="ln4623">	    group_str, remain, VTY_NEWLINE);</a>
<a name="ln4624">    return CMD_WARNING;</a>
<a name="ln4625">  }</a>
<a name="ln4626"> </a>
<a name="ln4627">  remain = buf_pastend - pim_msg_curr;</a>
<a name="ln4628">  if (remain &lt; 4) {</a>
<a name="ln4629">    vty_out(vty, &quot;Sources will not fit: space left=%d%s&quot;,</a>
<a name="ln4630">	    remain, VTY_NEWLINE);</a>
<a name="ln4631">    return CMD_WARNING;</a>
<a name="ln4632">  }</a>
<a name="ln4633"> </a>
<a name="ln4634">  if (src_is_join) {</a>
<a name="ln4635">    num_joined = 1;</a>
<a name="ln4636">    num_pruned = 0;</a>
<a name="ln4637">  }</a>
<a name="ln4638">  else {</a>
<a name="ln4639">    num_joined = 0;</a>
<a name="ln4640">    num_pruned = 1;</a>
<a name="ln4641">  }</a>
<a name="ln4642"> </a>
<a name="ln4643">  /* number of joined sources */</a>
<a name="ln4644">  *((uint16_t *) pim_msg_curr) = htons(num_joined);</a>
<a name="ln4645">  ++pim_msg_curr;</a>
<a name="ln4646">  ++pim_msg_curr;</a>
<a name="ln4647"> </a>
<a name="ln4648">  /* number of pruned sources */</a>
<a name="ln4649">  *((uint16_t *) pim_msg_curr) = htons(num_pruned);</a>
<a name="ln4650">  ++pim_msg_curr;</a>
<a name="ln4651">  ++pim_msg_curr;</a>
<a name="ln4652"> </a>
<a name="ln4653">  remain = buf_pastend - pim_msg_curr;</a>
<a name="ln4654">  pim_msg_curr = pim_msg_addr_encode_ipv4_source(pim_msg_curr,</a>
<a name="ln4655">						 remain,</a>
<a name="ln4656">						 source_addr);</a>
<a name="ln4657">  if (!pim_msg_curr) {</a>
<a name="ln4658">    vty_out(vty, &quot;Failure encoding source address %s: space left=%d%s&quot;,</a>
<a name="ln4659">	    source_str, remain, VTY_NEWLINE);</a>
<a name="ln4660">    return CMD_WARNING;</a>
<a name="ln4661">  }</a>
<a name="ln4662"> </a>
<a name="ln4663">  /* Add PIM header */</a>
<a name="ln4664"> </a>
<a name="ln4665">  pim_msg_size = pim_msg_curr - pim_msg;</a>
<a name="ln4666"> </a>
<a name="ln4667">  pim_msg_build_header(pim_msg, pim_msg_size,</a>
<a name="ln4668">		       PIM_MSG_TYPE_JOIN_PRUNE);</a>
<a name="ln4669"> </a>
<a name="ln4670">  /*</a>
<a name="ln4671">    &quot;Receive&quot; message</a>
<a name="ln4672">  */</a>
<a name="ln4673"> </a>
<a name="ln4674">  ip_msg_len = ip_hlen + pim_msg_size;</a>
<a name="ln4675">  result = pim_pim_packet(ifp, buf, ip_msg_len);</a>
<a name="ln4676">  if (result) {</a>
<a name="ln4677">    vty_out(vty, &quot;pim_pim_packet(len=%d) returned failure: %d%s&quot;,</a>
<a name="ln4678">	    ip_msg_len, result, VTY_NEWLINE);</a>
<a name="ln4679">    return CMD_WARNING;</a>
<a name="ln4680">  }</a>
<a name="ln4681"> </a>
<a name="ln4682">  return CMD_SUCCESS;</a>
<a name="ln4683">}</a>
<a name="ln4684"> </a>
<a name="ln4685">DEFUN (test_pim_receive_join,</a>
<a name="ln4686">       test_pim_receive_join_cmd,</a>
<a name="ln4687">       &quot;test pim receive join INTERFACE &lt;0-65535&gt; A.B.C.D A.B.C.D A.B.C.D A.B.C.D&quot;,</a>
<a name="ln4688">       &quot;Test\n&quot;</a>
<a name="ln4689">       &quot;Test PIM protocol\n&quot;</a>
<a name="ln4690">       &quot;Test PIM message reception\n&quot;</a>
<a name="ln4691">       &quot;Test PIM join reception from neighbor\n&quot;</a>
<a name="ln4692">       &quot;Interface\n&quot;</a>
<a name="ln4693">       &quot;Neighbor holdtime\n&quot;</a>
<a name="ln4694">       &quot;Upstream neighbor unicast destination address\n&quot;</a>
<a name="ln4695">       &quot;Downstream neighbor unicast source address\n&quot;</a>
<a name="ln4696">       &quot;Multicast group address\n&quot;</a>
<a name="ln4697">       &quot;Unicast source address\n&quot;)</a>
<a name="ln4698">{</a>
<a name="ln4699">  return recv_joinprune(vty, argv, 1 /* src_is_join=true */);</a>
<a name="ln4700">}</a>
<a name="ln4701"> </a>
<a name="ln4702">DEFUN (test_pim_receive_prune,</a>
<a name="ln4703">       test_pim_receive_prune_cmd,</a>
<a name="ln4704">       &quot;test pim receive prune INTERFACE &lt;0-65535&gt; A.B.C.D A.B.C.D A.B.C.D A.B.C.D&quot;,</a>
<a name="ln4705">       &quot;Test\n&quot;</a>
<a name="ln4706">       &quot;Test PIM protocol\n&quot;</a>
<a name="ln4707">       &quot;Test PIM message reception\n&quot;</a>
<a name="ln4708">       &quot;Test PIM prune reception from neighbor\n&quot;</a>
<a name="ln4709">       &quot;Interface\n&quot;</a>
<a name="ln4710">       &quot;Neighbor holdtime\n&quot;</a>
<a name="ln4711">       &quot;Upstream neighbor unicast destination address\n&quot;</a>
<a name="ln4712">       &quot;Downstream neighbor unicast source address\n&quot;</a>
<a name="ln4713">       &quot;Multicast group address\n&quot;</a>
<a name="ln4714">       &quot;Unicast source address\n&quot;)</a>
<a name="ln4715">{</a>
<a name="ln4716">  return recv_joinprune(vty, argv, 0 /* src_is_join=false */);</a>
<a name="ln4717">}</a>
<a name="ln4718"> </a>
<a name="ln4719">DEFUN (test_pim_receive_upcall,</a>
<a name="ln4720">       test_pim_receive_upcall_cmd,</a>
<a name="ln4721">       &quot;test pim receive upcall (nocache|wrongvif|wholepkt) &lt;0-65535&gt; A.B.C.D A.B.C.D&quot;,</a>
<a name="ln4722">       &quot;Test\n&quot;</a>
<a name="ln4723">       &quot;Test PIM protocol\n&quot;</a>
<a name="ln4724">       &quot;Test PIM message reception\n&quot;</a>
<a name="ln4725">       &quot;Test reception of kernel upcall\n&quot;</a>
<a name="ln4726">       &quot;NOCACHE kernel upcall\n&quot;</a>
<a name="ln4727">       &quot;WRONGVIF kernel upcall\n&quot;</a>
<a name="ln4728">       &quot;WHOLEPKT kernel upcall\n&quot;</a>
<a name="ln4729">       &quot;Input interface vif index\n&quot;</a>
<a name="ln4730">       &quot;Multicast group address\n&quot;</a>
<a name="ln4731">       &quot;Multicast source address\n&quot;)</a>
<a name="ln4732">{</a>
<a name="ln4733">  struct igmpmsg msg;</a>
<a name="ln4734">  const char *upcall_type;</a>
<a name="ln4735">  const char *group_str;</a>
<a name="ln4736">  const char *source_str;</a>
<a name="ln4737">  int result;</a>
<a name="ln4738"> </a>
<a name="ln4739">  upcall_type = argv[0];</a>
<a name="ln4740"> </a>
<a name="ln4741">  if (upcall_type[0] == 'n')</a>
<a name="ln4742">    msg.im_msgtype = IGMPMSG_NOCACHE;</a>
<a name="ln4743">  else if (upcall_type[1] == 'r')</a>
<a name="ln4744">    msg.im_msgtype = IGMPMSG_WRONGVIF;</a>
<a name="ln4745">  else if (upcall_type[1] == 'h')</a>
<a name="ln4746">    msg.im_msgtype = IGMPMSG_WHOLEPKT;</a>
<a name="ln4747">  else {</a>
<a name="ln4748">    vty_out(vty, &quot;Unknown kernel upcall type: %s%s&quot;,</a>
<a name="ln4749">	    upcall_type, VTY_NEWLINE);</a>
<a name="ln4750">    return CMD_WARNING;</a>
<a name="ln4751">  }</a>
<a name="ln4752"> </a>
<a name="ln4753">  msg.im_vif = atoi(argv[1]);</a>
<a name="ln4754"> </a>
<a name="ln4755">  /* Group address */</a>
<a name="ln4756">  group_str = argv[2];</a>
<a name="ln4757">  result = inet_pton(AF_INET, group_str, &amp;msg.im_dst);</a>
<a name="ln4758">  if (result &lt;= 0) {</a>
<a name="ln4759">    vty_out(vty, &quot;Bad group address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4760">	    group_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4761">    return CMD_WARNING;</a>
<a name="ln4762">  }</a>
<a name="ln4763"> </a>
<a name="ln4764">  /* Source address */</a>
<a name="ln4765">  source_str = argv[3];</a>
<a name="ln4766">  result = inet_pton(AF_INET, source_str, &amp;msg.im_src);</a>
<a name="ln4767">  if (result &lt;= 0) {</a>
<a name="ln4768">    vty_out(vty, &quot;Bad source address %s: errno=%d: %s%s&quot;,</a>
<a name="ln4769">	    source_str, errno, safe_strerror(errno), VTY_NEWLINE);</a>
<a name="ln4770">    return CMD_WARNING;</a>
<a name="ln4771">  }</a>
<a name="ln4772"> </a>
<a name="ln4773">  msg.im_mbz = 0; /* Must be zero */</a>
<a name="ln4774"> </a>
<a name="ln4775">  result = pim_mroute_msg(-1, (char *) &amp;msg, sizeof(msg));</a>
<a name="ln4776">  if (result) {</a>
<a name="ln4777">    vty_out(vty, &quot;pim_mroute_msg(len=%zu) returned failure: %d%s&quot;,</a>
<a name="ln4778">	    sizeof(msg), result, VTY_NEWLINE);</a>
<a name="ln4779">    return CMD_WARNING;</a>
<a name="ln4780">  }</a>
<a name="ln4781"> </a>
<a name="ln4782">  return CMD_SUCCESS;</a>
<a name="ln4783">}</a>
<a name="ln4784"> </a>
<a name="ln4785">void pim_cmd_init()</a>
<a name="ln4786">{</a>
<a name="ln4787">  install_node (&amp;pim_global_node, pim_global_config_write);       /* PIM_NODE */</a>
<a name="ln4788">  install_node (&amp;interface_node, pim_interface_config_write); /* INTERFACE_NODE */</a>
<a name="ln4789"> </a>
<a name="ln4790">  install_element (CONFIG_NODE, &amp;ip_multicast_routing_cmd);</a>
<a name="ln4791">  install_element (CONFIG_NODE, &amp;no_ip_multicast_routing_cmd);</a>
<a name="ln4792">  install_element (CONFIG_NODE, &amp;ip_ssmpingd_cmd);</a>
<a name="ln4793">  install_element (CONFIG_NODE, &amp;no_ip_ssmpingd_cmd); </a>
<a name="ln4794">#if 0</a>
<a name="ln4795">  install_element (CONFIG_NODE, &amp;interface_cmd); /* from if.h */</a>
<a name="ln4796">#else</a>
<a name="ln4797">  install_element (CONFIG_NODE, &amp;pim_interface_cmd);</a>
<a name="ln4798">#endif</a>
<a name="ln4799">  install_element (CONFIG_NODE, &amp;no_interface_cmd); /* from if.h */</a>
<a name="ln4800"> </a>
<a name="ln4801">  install_default (INTERFACE_NODE);</a>
<a name="ln4802">  install_element (INTERFACE_NODE, &amp;interface_ip_igmp_cmd);</a>
<a name="ln4803">  install_element (INTERFACE_NODE, &amp;interface_no_ip_igmp_cmd); </a>
<a name="ln4804">  install_element (INTERFACE_NODE, &amp;interface_ip_igmp_join_cmd);</a>
<a name="ln4805">  install_element (INTERFACE_NODE, &amp;interface_no_ip_igmp_join_cmd); </a>
<a name="ln4806">  install_element (INTERFACE_NODE, &amp;interface_ip_igmp_query_interval_cmd);</a>
<a name="ln4807">  install_element (INTERFACE_NODE, &amp;interface_no_ip_igmp_query_interval_cmd); </a>
<a name="ln4808">  install_element (INTERFACE_NODE, &amp;interface_ip_igmp_query_max_response_time_cmd);</a>
<a name="ln4809">  install_element (INTERFACE_NODE, &amp;interface_no_ip_igmp_query_max_response_time_cmd); </a>
<a name="ln4810">  install_element (INTERFACE_NODE, &amp;interface_ip_igmp_query_max_response_time_dsec_cmd);</a>
<a name="ln4811">  install_element (INTERFACE_NODE, &amp;interface_no_ip_igmp_query_max_response_time_dsec_cmd); </a>
<a name="ln4812">  install_element (INTERFACE_NODE, &amp;interface_ip_pim_ssm_cmd);</a>
<a name="ln4813">  install_element (INTERFACE_NODE, &amp;interface_no_ip_pim_ssm_cmd);</a>
<a name="ln4814">  install_element (INTERFACE_NODE, &amp;interface_ip_pim_drprio_cmd);</a>
<a name="ln4815">  install_element (INTERFACE_NODE, &amp;interface_no_ip_pim_drprio_cmd);</a>
<a name="ln4816">  install_element (INTERFACE_NODE, &amp;interface_ip_pim_hello_cmd);</a>
<a name="ln4817">  install_element (INTERFACE_NODE, &amp;interface_ip_pim_hello_hold_cmd);</a>
<a name="ln4818">  install_element (INTERFACE_NODE, &amp;interface_no_ip_pim_hello_cmd);</a>
<a name="ln4819"> </a>
<a name="ln4820">  // Static mroutes NEB</a>
<a name="ln4821">  install_element (INTERFACE_NODE, &amp;interface_ip_mroute_cmd);</a>
<a name="ln4822">  install_element (INTERFACE_NODE, &amp;interface_ip_mroute_source_cmd);</a>
<a name="ln4823">  install_element (INTERFACE_NODE, &amp;interface_no_ip_mroute_cmd);</a>
<a name="ln4824">  install_element (INTERFACE_NODE, &amp;interface_no_ip_mroute_source_cmd);</a>
<a name="ln4825"> </a>
<a name="ln4826">  install_element (VIEW_NODE, &amp;show_ip_igmp_interface_cmd);</a>
<a name="ln4827">  install_element (VIEW_NODE, &amp;show_ip_igmp_join_cmd);</a>
<a name="ln4828">  install_element (VIEW_NODE, &amp;show_ip_igmp_parameters_cmd);</a>
<a name="ln4829">  install_element (VIEW_NODE, &amp;show_ip_igmp_groups_cmd);</a>
<a name="ln4830">  install_element (VIEW_NODE, &amp;show_ip_igmp_groups_retransmissions_cmd);</a>
<a name="ln4831">  install_element (VIEW_NODE, &amp;show_ip_igmp_sources_cmd);</a>
<a name="ln4832">  install_element (VIEW_NODE, &amp;show_ip_igmp_sources_retransmissions_cmd);</a>
<a name="ln4833">  install_element (VIEW_NODE, &amp;show_ip_igmp_querier_cmd);</a>
<a name="ln4834">  install_element (VIEW_NODE, &amp;show_ip_pim_assert_cmd);</a>
<a name="ln4835">  install_element (VIEW_NODE, &amp;show_ip_pim_assert_internal_cmd);</a>
<a name="ln4836">  install_element (VIEW_NODE, &amp;show_ip_pim_assert_metric_cmd);</a>
<a name="ln4837">  install_element (VIEW_NODE, &amp;show_ip_pim_assert_winner_metric_cmd);</a>
<a name="ln4838">  install_element (VIEW_NODE, &amp;show_ip_pim_dr_cmd);</a>
<a name="ln4839">  install_element (VIEW_NODE, &amp;show_ip_pim_hello_cmd);</a>
<a name="ln4840">  install_element (VIEW_NODE, &amp;show_ip_pim_interface_cmd);</a>
<a name="ln4841">  install_element (VIEW_NODE, &amp;show_ip_pim_join_cmd);</a>
<a name="ln4842">  install_element (VIEW_NODE, &amp;show_ip_pim_jp_override_interval_cmd);</a>
<a name="ln4843">  install_element (VIEW_NODE, &amp;show_ip_pim_lan_prune_delay_cmd);</a>
<a name="ln4844">  install_element (VIEW_NODE, &amp;show_ip_pim_local_membership_cmd);</a>
<a name="ln4845">  install_element (VIEW_NODE, &amp;show_ip_pim_neighbor_cmd);</a>
<a name="ln4846">  install_element (VIEW_NODE, &amp;show_ip_pim_rpf_cmd);</a>
<a name="ln4847">  install_element (VIEW_NODE, &amp;show_ip_pim_secondary_cmd);</a>
<a name="ln4848">  install_element (VIEW_NODE, &amp;show_ip_pim_upstream_cmd);</a>
<a name="ln4849">  install_element (VIEW_NODE, &amp;show_ip_pim_upstream_join_desired_cmd);</a>
<a name="ln4850">  install_element (VIEW_NODE, &amp;show_ip_pim_upstream_rpf_cmd);</a>
<a name="ln4851">  install_element (VIEW_NODE, &amp;show_ip_multicast_cmd);</a>
<a name="ln4852">  install_element (VIEW_NODE, &amp;show_ip_mroute_cmd);</a>
<a name="ln4853">  install_element (VIEW_NODE, &amp;show_ip_mroute_count_cmd);</a>
<a name="ln4854">  install_element (VIEW_NODE, &amp;show_ip_rib_cmd);</a>
<a name="ln4855">  install_element (VIEW_NODE, &amp;show_ip_ssmpingd_cmd);</a>
<a name="ln4856">  install_element (VIEW_NODE, &amp;show_debugging_pim_cmd);</a>
<a name="ln4857"> </a>
<a name="ln4858">  install_element (ENABLE_NODE, &amp;clear_ip_interfaces_cmd);</a>
<a name="ln4859">  install_element (ENABLE_NODE, &amp;clear_ip_igmp_interfaces_cmd);</a>
<a name="ln4860">  install_element (ENABLE_NODE, &amp;clear_ip_mroute_cmd);</a>
<a name="ln4861">  install_element (ENABLE_NODE, &amp;clear_ip_pim_interfaces_cmd);</a>
<a name="ln4862">  install_element (ENABLE_NODE, &amp;clear_ip_pim_oil_cmd);</a>
<a name="ln4863"> </a>
<a name="ln4864">  install_element (ENABLE_NODE, &amp;test_igmp_receive_report_cmd);</a>
<a name="ln4865">  install_element (ENABLE_NODE, &amp;test_pim_receive_assert_cmd);</a>
<a name="ln4866">  install_element (ENABLE_NODE, &amp;test_pim_receive_dump_cmd);</a>
<a name="ln4867">  install_element (ENABLE_NODE, &amp;test_pim_receive_hello_cmd);</a>
<a name="ln4868">  install_element (ENABLE_NODE, &amp;test_pim_receive_join_cmd);</a>
<a name="ln4869">  install_element (ENABLE_NODE, &amp;test_pim_receive_prune_cmd);</a>
<a name="ln4870">  install_element (ENABLE_NODE, &amp;test_pim_receive_upcall_cmd);</a>
<a name="ln4871"> </a>
<a name="ln4872">  install_element (ENABLE_NODE, &amp;debug_igmp_cmd);</a>
<a name="ln4873">  install_element (ENABLE_NODE, &amp;no_debug_igmp_cmd);</a>
<a name="ln4874">  install_element (ENABLE_NODE, &amp;undebug_igmp_cmd);</a>
<a name="ln4875">  install_element (ENABLE_NODE, &amp;debug_igmp_events_cmd);</a>
<a name="ln4876">  install_element (ENABLE_NODE, &amp;no_debug_igmp_events_cmd);</a>
<a name="ln4877">  install_element (ENABLE_NODE, &amp;undebug_igmp_events_cmd);</a>
<a name="ln4878">  install_element (ENABLE_NODE, &amp;debug_igmp_packets_cmd);</a>
<a name="ln4879">  install_element (ENABLE_NODE, &amp;no_debug_igmp_packets_cmd);</a>
<a name="ln4880">  install_element (ENABLE_NODE, &amp;undebug_igmp_packets_cmd);</a>
<a name="ln4881">  install_element (ENABLE_NODE, &amp;debug_igmp_trace_cmd);</a>
<a name="ln4882">  install_element (ENABLE_NODE, &amp;no_debug_igmp_trace_cmd);</a>
<a name="ln4883">  install_element (ENABLE_NODE, &amp;undebug_igmp_trace_cmd);</a>
<a name="ln4884">  install_element (ENABLE_NODE, &amp;debug_mroute_cmd);</a>
<a name="ln4885">  install_element (ENABLE_NODE, &amp;no_debug_mroute_cmd);</a>
<a name="ln4886">  install_element (ENABLE_NODE, &amp;debug_static_cmd);</a>
<a name="ln4887">  install_element (ENABLE_NODE, &amp;no_debug_static_cmd);</a>
<a name="ln4888">  install_element (ENABLE_NODE, &amp;debug_pim_cmd);</a>
<a name="ln4889">  install_element (ENABLE_NODE, &amp;no_debug_pim_cmd);</a>
<a name="ln4890">  install_element (ENABLE_NODE, &amp;undebug_pim_cmd);</a>
<a name="ln4891">  install_element (ENABLE_NODE, &amp;debug_pim_events_cmd);</a>
<a name="ln4892">  install_element (ENABLE_NODE, &amp;no_debug_pim_events_cmd);</a>
<a name="ln4893">  install_element (ENABLE_NODE, &amp;undebug_pim_events_cmd);</a>
<a name="ln4894">  install_element (ENABLE_NODE, &amp;debug_pim_packets_cmd);</a>
<a name="ln4895">  install_element (ENABLE_NODE, &amp;debug_pim_packets_filter_cmd);</a>
<a name="ln4896">  install_element (ENABLE_NODE, &amp;no_debug_pim_packets_cmd);</a>
<a name="ln4897">  install_element (ENABLE_NODE, &amp;no_debug_pim_packets_filter_cmd);</a>
<a name="ln4898">  install_element (ENABLE_NODE, &amp;undebug_pim_packets_cmd);</a>
<a name="ln4899">  install_element (ENABLE_NODE, &amp;debug_pim_packetdump_send_cmd);</a>
<a name="ln4900">  install_element (ENABLE_NODE, &amp;no_debug_pim_packetdump_send_cmd);</a>
<a name="ln4901">  install_element (ENABLE_NODE, &amp;undebug_pim_packetdump_send_cmd);</a>
<a name="ln4902">  install_element (ENABLE_NODE, &amp;debug_pim_packetdump_recv_cmd);</a>
<a name="ln4903">  install_element (ENABLE_NODE, &amp;no_debug_pim_packetdump_recv_cmd);</a>
<a name="ln4904">  install_element (ENABLE_NODE, &amp;undebug_pim_packetdump_recv_cmd);</a>
<a name="ln4905">  install_element (ENABLE_NODE, &amp;debug_pim_trace_cmd);</a>
<a name="ln4906">  install_element (ENABLE_NODE, &amp;no_debug_pim_trace_cmd);</a>
<a name="ln4907">  install_element (ENABLE_NODE, &amp;undebug_pim_trace_cmd);</a>
<a name="ln4908">  install_element (ENABLE_NODE, &amp;debug_ssmpingd_cmd);</a>
<a name="ln4909">  install_element (ENABLE_NODE, &amp;no_debug_ssmpingd_cmd);</a>
<a name="ln4910">  install_element (ENABLE_NODE, &amp;undebug_ssmpingd_cmd);</a>
<a name="ln4911">  install_element (ENABLE_NODE, &amp;debug_pim_zebra_cmd);</a>
<a name="ln4912">  install_element (ENABLE_NODE, &amp;no_debug_pim_zebra_cmd);</a>
<a name="ln4913">  install_element (ENABLE_NODE, &amp;undebug_pim_zebra_cmd);</a>
<a name="ln4914"> </a>
<a name="ln4915">  install_element (CONFIG_NODE, &amp;debug_igmp_cmd);</a>
<a name="ln4916">  install_element (CONFIG_NODE, &amp;no_debug_igmp_cmd);</a>
<a name="ln4917">  install_element (CONFIG_NODE, &amp;undebug_igmp_cmd);</a>
<a name="ln4918">  install_element (CONFIG_NODE, &amp;debug_igmp_events_cmd);</a>
<a name="ln4919">  install_element (CONFIG_NODE, &amp;no_debug_igmp_events_cmd);</a>
<a name="ln4920">  install_element (CONFIG_NODE, &amp;undebug_igmp_events_cmd);</a>
<a name="ln4921">  install_element (CONFIG_NODE, &amp;debug_igmp_packets_cmd);</a>
<a name="ln4922">  install_element (CONFIG_NODE, &amp;no_debug_igmp_packets_cmd);</a>
<a name="ln4923">  install_element (CONFIG_NODE, &amp;undebug_igmp_packets_cmd);</a>
<a name="ln4924">  install_element (CONFIG_NODE, &amp;debug_igmp_trace_cmd);</a>
<a name="ln4925">  install_element (CONFIG_NODE, &amp;no_debug_igmp_trace_cmd);</a>
<a name="ln4926">  install_element (CONFIG_NODE, &amp;undebug_igmp_trace_cmd);</a>
<a name="ln4927">  install_element (CONFIG_NODE, &amp;debug_mroute_cmd);</a>
<a name="ln4928">  install_element (CONFIG_NODE, &amp;no_debug_mroute_cmd);</a>
<a name="ln4929">  install_element (CONFIG_NODE, &amp;debug_static_cmd);</a>
<a name="ln4930">  install_element (CONFIG_NODE, &amp;no_debug_static_cmd);</a>
<a name="ln4931">  install_element (CONFIG_NODE, &amp;debug_pim_cmd);</a>
<a name="ln4932">  install_element (CONFIG_NODE, &amp;no_debug_pim_cmd);</a>
<a name="ln4933">  install_element (CONFIG_NODE, &amp;undebug_pim_cmd);</a>
<a name="ln4934">  install_element (CONFIG_NODE, &amp;debug_pim_events_cmd);</a>
<a name="ln4935">  install_element (CONFIG_NODE, &amp;no_debug_pim_events_cmd);</a>
<a name="ln4936">  install_element (CONFIG_NODE, &amp;undebug_pim_events_cmd);</a>
<a name="ln4937">  install_element (CONFIG_NODE, &amp;debug_pim_packets_cmd);</a>
<a name="ln4938">  install_element (CONFIG_NODE, &amp;debug_pim_packets_filter_cmd);</a>
<a name="ln4939">  install_element (CONFIG_NODE, &amp;no_debug_pim_packets_cmd);</a>
<a name="ln4940">  install_element (CONFIG_NODE, &amp;no_debug_pim_packets_filter_cmd);</a>
<a name="ln4941">  install_element (CONFIG_NODE, &amp;undebug_pim_packets_cmd);</a>
<a name="ln4942">  install_element (CONFIG_NODE, &amp;debug_pim_trace_cmd);</a>
<a name="ln4943">  install_element (CONFIG_NODE, &amp;no_debug_pim_trace_cmd);</a>
<a name="ln4944">  install_element (CONFIG_NODE, &amp;undebug_pim_trace_cmd);</a>
<a name="ln4945">  install_element (CONFIG_NODE, &amp;debug_ssmpingd_cmd);</a>
<a name="ln4946">  install_element (CONFIG_NODE, &amp;no_debug_ssmpingd_cmd);</a>
<a name="ln4947">  install_element (CONFIG_NODE, &amp;undebug_ssmpingd_cmd);</a>
<a name="ln4948">  install_element (CONFIG_NODE, &amp;debug_pim_zebra_cmd);</a>
<a name="ln4949">  install_element (CONFIG_NODE, &amp;no_debug_pim_zebra_cmd);</a>
<a name="ln4950">  install_element (CONFIG_NODE, &amp;undebug_pim_zebra_cmd);</a>
<a name="ln4951">}</a>

</code></pre>
<div class="balloon" rel="6"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>
<div class="balloon" rel="4081"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buf' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="4094"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'igmp_msg' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="4100"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'group_record' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="4183"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buf' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="4315"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buf' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="4463"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buf' is cast to a more strictly aligned pointer type.</p></div>
<div class="balloon" rel="4577"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1032/" target="_blank">V1032</a> The pointer 'buf' is cast to a more strictly aligned pointer type.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
