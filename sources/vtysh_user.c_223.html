
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>vtysh_user.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/* User authentication for vtysh.</a>
<a name="ln2"> * Copyright (C) 2000 Kunihiro Ishiguro</a>
<a name="ln3"> *</a>
<a name="ln4"> * This file is part of GNU Zebra.</a>
<a name="ln5"> *</a>
<a name="ln6"> * GNU Zebra is free software; you can redistribute it and/or modify it</a>
<a name="ln7"> * under the terms of the GNU General Public License as published by the</a>
<a name="ln8"> * Free Software Foundation; either version 2, or (at your option) any</a>
<a name="ln9"> * later version.</a>
<a name="ln10"> *</a>
<a name="ln11"> * GNU Zebra is distributed in the hope that it will be useful, but</a>
<a name="ln12"> * WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln13"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</a>
<a name="ln14"> * General Public License for more details.</a>
<a name="ln15"> *</a>
<a name="ln16"> * You should have received a copy of the GNU General Public License</a>
<a name="ln17"> * along with GNU Zebra; see the file COPYING.  If not, write to the Free</a>
<a name="ln18"> * Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</a>
<a name="ln19"> * 02111-1307, USA.  </a>
<a name="ln20"> */</a>
<a name="ln21"> </a>
<a name="ln22">#include &lt;zebra.h&gt;</a>
<a name="ln23">#include &lt;lib/version.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">#include &lt;pwd.h&gt;</a>
<a name="ln26"> </a>
<a name="ln27">#ifdef USE_PAM</a>
<a name="ln28">#include &lt;security/pam_appl.h&gt;</a>
<a name="ln29">#ifdef HAVE_PAM_MISC_H</a>
<a name="ln30">#include &lt;security/pam_misc.h&gt;</a>
<a name="ln31">#endif</a>
<a name="ln32">#ifdef HAVE_OPENPAM_H</a>
<a name="ln33">#include &lt;security/openpam.h&gt;</a>
<a name="ln34">#endif</a>
<a name="ln35">#endif /* USE_PAM */</a>
<a name="ln36"> </a>
<a name="ln37">#include &quot;memory.h&quot;</a>
<a name="ln38">#include &quot;linklist.h&quot;</a>
<a name="ln39">#include &quot;command.h&quot;</a>
<a name="ln40">#include &quot;vtysh_user.h&quot;</a>
<a name="ln41"> </a>
<a name="ln42">#ifdef USE_PAM</a>
<a name="ln43">static struct pam_conv conv = </a>
<a name="ln44">{</a>
<a name="ln45">  PAM_CONV_FUNC,</a>
<a name="ln46">  NULL</a>
<a name="ln47">};</a>
<a name="ln48"> </a>
<a name="ln49">static int</a>
<a name="ln50">vtysh_pam (const char *user)</a>
<a name="ln51">{</a>
<a name="ln52">  int ret;</a>
<a name="ln53">  pam_handle_t *pamh = NULL;</a>
<a name="ln54"> </a>
<a name="ln55">  /* Start PAM. */</a>
<a name="ln56">  ret = pam_start(QUAGGA_PROGNAME, user, &amp;conv, &amp;pamh);</a>
<a name="ln57">  /* printf (&quot;ret %d\n&quot;, ret); */</a>
<a name="ln58"> </a>
<a name="ln59">  /* Is user really user? */</a>
<a name="ln60">  if (ret == PAM_SUCCESS)</a>
<a name="ln61">    ret = pam_authenticate (pamh, 0);</a>
<a name="ln62">  if (ret != PAM_SUCCESS)</a>
<a name="ln63">    printf(&quot;Not authenticated. Check /etc/pam.d/quagga.\n&quot;);</a>
<a name="ln64">  /* printf (&quot;ret %d\n&quot;, ret); */</a>
<a name="ln65">  </a>
<a name="ln66">#if 0</a>
<a name="ln67">  /* Permitted access? */</a>
<a name="ln68">  if (ret == PAM_SUCCESS)</a>
<a name="ln69">    ret = pam_acct_mgmt (pamh, 0);</a>
<a name="ln70">  printf (&quot;ret %d\n&quot;, ret);</a>
<a name="ln71"> </a>
<a name="ln72">  if (ret == PAM_AUTHINFO_UNAVAIL)</a>
<a name="ln73">    ret = PAM_SUCCESS;</a>
<a name="ln74">#endif /* 0 */</a>
<a name="ln75">  </a>
<a name="ln76">  /* This is where we have been authorized or not. */</a>
<a name="ln77">#ifdef DEBUG</a>
<a name="ln78">  if (ret == PAM_SUCCESS)</a>
<a name="ln79">    printf(&quot;Authenticated\n&quot;);</a>
<a name="ln80">  else</a>
<a name="ln81">    printf(&quot;Not Authenticated\n&quot;);</a>
<a name="ln82">#endif /* DEBUG */</a>
<a name="ln83"> </a>
<a name="ln84">  /* close Linux-PAM */</a>
<a name="ln85">  if (pam_end (pamh, ret) != PAM_SUCCESS) </a>
<a name="ln86">    {</a>
<a name="ln87">      pamh = NULL;</a>
<a name="ln88">      fprintf(stderr, &quot;vtysh_pam: failed to release authenticator\n&quot;);</a>
<a name="ln89">      exit(1);</a>
<a name="ln90">    }</a>
<a name="ln91"> </a>
<a name="ln92">  return ret == PAM_SUCCESS ? 0 : 1;</a>
<a name="ln93">}</a>
<a name="ln94">#endif /* USE_PAM */</a>
<a name="ln95"> </a>
<a name="ln96">struct vtysh_user</a>
<a name="ln97">{</a>
<a name="ln98">  char *name;</a>
<a name="ln99">  u_char nopassword;</a>
<a name="ln100">};</a>
<a name="ln101"> </a>
<a name="ln102">struct list *userlist;</a>
<a name="ln103"> </a>
<a name="ln104">static struct vtysh_user *</a>
<a name="ln105">user_new ()</a>
<a name="ln106">{</a>
<a name="ln107">  return XCALLOC (MTYPE_TMP, sizeof (struct vtysh_user));</a>
<a name="ln108">}</a>
<a name="ln109"> </a>
<a name="ln110">#if 0</a>
<a name="ln111">static void</a>
<a name="ln112">user_free (struct vtysh_user *user)</a>
<a name="ln113">{</a>
<a name="ln114">  XFREE (0, user);</a>
<a name="ln115">}</a>
<a name="ln116">#endif</a>
<a name="ln117"> </a>
<a name="ln118">static struct vtysh_user *</a>
<a name="ln119">user_lookup (const char *name)</a>
<a name="ln120">{</a>
<a name="ln121">  struct listnode *node, *nnode;</a>
<a name="ln122">  struct vtysh_user *user;</a>
<a name="ln123"> </a>
<a name="ln124">  for (ALL_LIST_ELEMENTS (userlist, node, nnode, user))</a>
<a name="ln125">    {</a>
<a name="ln126">      if (strcmp (user-&gt;name, name) == 0)</a>
<a name="ln127">	return user;</a>
<a name="ln128">    }</a>
<a name="ln129">  return NULL;</a>
<a name="ln130">}</a>
<a name="ln131"> </a>
<a name="ln132">#if 0</a>
<a name="ln133">static void</a>
<a name="ln134">user_config_write ()</a>
<a name="ln135">{</a>
<a name="ln136">  struct listnode *node, *nnode;</a>
<a name="ln137">  struct vtysh_user *user;</a>
<a name="ln138"> </a>
<a name="ln139">  for (ALL_LIST_ELEMENTS (userlist, node, nnode, user))</a>
<a name="ln140">    {</a>
<a name="ln141">      if (user-&gt;nopassword)</a>
<a name="ln142">	printf (&quot; username %s nopassword\n&quot;, user-&gt;name);</a>
<a name="ln143">    }</a>
<a name="ln144">}</a>
<a name="ln145">#endif</a>
<a name="ln146"> </a>
<a name="ln147">static struct vtysh_user *</a>
<a name="ln148">user_get (const char *name)</a>
<a name="ln149">{</a>
<a name="ln150">  struct vtysh_user *user;</a>
<a name="ln151">  user = user_lookup (name);</a>
<a name="ln152">  if (user)</a>
<a name="ln153">    return user;</a>
<a name="ln154"> </a>
<a name="ln155">  user = user_new ();</a>
<a name="ln156">  user-&gt;name = strdup (name);</a>
<a name="ln157">  listnode_add (userlist, user);</a>
<a name="ln158"> </a>
<a name="ln159">  return user;</a>
<a name="ln160">}</a>
<a name="ln161"> </a>
<a name="ln162">DEFUN (username_nopassword,</a>
<a name="ln163">       username_nopassword_cmd,</a>
<a name="ln164">       &quot;username WORD nopassword&quot;,</a>
<a name="ln165">       &quot;\n&quot;</a>
<a name="ln166">       &quot;\n&quot;</a>
<a name="ln167">       &quot;\n&quot;)</a>
<a name="ln168">{</a>
<a name="ln169">  struct vtysh_user *user;</a>
<a name="ln170">  user = user_get (argv[0]);</a>
<a name="ln171">  user-&gt;nopassword = 1;</a>
<a name="ln172">  return CMD_SUCCESS;</a>
<a name="ln173">}</a>
<a name="ln174"> </a>
<a name="ln175">int</a>
<a name="ln176">vtysh_auth (void)</a>
<a name="ln177">{</a>
<a name="ln178">  struct vtysh_user *user;</a>
<a name="ln179">  struct passwd *passwd;</a>
<a name="ln180"> </a>
<a name="ln181">  if ((passwd = getpwuid (geteuid ())) == NULL)</a>
<a name="ln182">  {</a>
<a name="ln183">    fprintf (stderr, &quot;could not lookup user ID %d\n&quot;, (int) geteuid());</a>
<a name="ln184">    exit (1);</a>
<a name="ln185">  }</a>
<a name="ln186"> </a>
<a name="ln187">  user = user_lookup (passwd-&gt;pw_name);</a>
<a name="ln188">  if (user &amp;&amp; user-&gt;nopassword)</a>
<a name="ln189">    /* Pass through */;</a>
<a name="ln190">  else</a>
<a name="ln191">    {</a>
<a name="ln192">#ifdef USE_PAM</a>
<a name="ln193">      if (vtysh_pam (passwd-&gt;pw_name))</a>
<a name="ln194">	exit (0);</a>
<a name="ln195">#endif /* USE_PAM */</a>
<a name="ln196">    }</a>
<a name="ln197">  return 0;</a>
<a name="ln198">}</a>
<a name="ln199"> </a>
<a name="ln200">char *</a>
<a name="ln201">vtysh_get_home (void)</a>
<a name="ln202">{</a>
<a name="ln203">  struct passwd *passwd;</a>
<a name="ln204"> </a>
<a name="ln205">  passwd = getpwuid (getuid ());</a>
<a name="ln206"> </a>
<a name="ln207">  return passwd ? passwd-&gt;pw_dir : NULL;</a>
<a name="ln208">}</a>
<a name="ln209"> </a>
<a name="ln210">void</a>
<a name="ln211">vtysh_user_init (void)</a>
<a name="ln212">{</a>
<a name="ln213">  userlist = list_new ();</a>
<a name="ln214">  install_element (CONFIG_NODE, &amp;username_nopassword_cmd);</a>
<a name="ln215">}</a>

</code></pre>
<div class="balloon" rel="7"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
